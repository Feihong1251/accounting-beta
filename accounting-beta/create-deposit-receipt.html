<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>หน้าสร้างใบรับเงินมัดจำ</title>
    <link rel="stylesheet" href="main.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
</head>
<body>
    <div class="head-box"> <!--กล่องใหญ่-->
        <div id="sidemenuacc"></div>
        <div class="main-project"><!--กล่อง main-->
            <div class="navbar">
                <div style="width: 100%;height: 100%; padding: 24px;">
                    <div style=" width: 100%; height: 100%;display: flex;justify-content: space-between; ">
                        <div style="width: 361px; height: 40px; padding: 6.5px 0;">
                            <div class="nav-menu">
                                <div style="background-color: #FFFFFF; display: flex;width: 226px; border-radius: 32px;height: 100%;display: flex;align-items: center;justify-content: center; gap: 8px;">
                                <div class="text-nav">หน้าหลัก</div>
                                <img src="picture/arrow-right-nav.png" style="width: 12px;height: 12px;">
                                <div class="text-nav">ขาย</div>
                                <img src="picture/arrow-right-nav.png" style="width: 12px;height: 12px;">
                                <div class="text-nav">ใบรับเงินมัดจำ</div>
                                </div>
                                <div style="width: 135px;display: flex;justify-content: center;align-items: center;">
                                    <div style="color: #FFFFFF; font-weight: 700; font-size: 14px;">สร้างใบรับเงินมัดจำ</div>
                                </div>
                            </div>
                        </div>
                        <div style=" width: 30%; height: 100%; display: flex; justify-content: end; gap: 8px;">
                            <div class="nav-pic-right"><img src="picture/load.png"  class="nav-pic"></div>
                        </div>
                    </div>
                    
                </div>
            </div>
            <div class="head-work">
                <div class="work">
                    <!-- khaow -->
                    <div class="information"> <!--กล่องใหญ่กรอกข้อมูล-->
                        <div class="navbar-information"><!--กร่องบาร์กรอกข้อมูล-->
                            <div class="deposit-receipt">สร้างใบรับเงินมัดจำ</div> <!--กล่องใบเงินมัดจำ-->
                            <div class="deposit-number"> <!--กล่องเลขมัดจำ-->
                                <div class="word-deposit-number">เลขที่ใบรับเงินมัดจำ</div><!--กล่องเลขใบรับเงิน -->
                                <div class="number-input-deposit"><!--กล่องครุมเลข ต้องเปลี่ยน -->
                                    <input type="text" class="word-input-deposit" id="customerDepositReceiptNumber" placeholder="QT-202501130001" readonly>
                
                                </div>
                            </div>
                        </div><!--กร่องบาร์กรอกข้อมูล-->
                        <div class="Customer-information-and-documents"> <!--กล่องข้อมูลลูกค้าและเอกสาร-->
                            <div class="Customer-information"> <!--กล่องข้อมูลลูกค้า-->
                                <div class="bar-Customer-information"> <!--บาร์ข้อมูลลูกค้า-->
                                    <div class="word-bar-Customer-information">ข้อมูลลูกค้า</div> <!--ข้อความในบาร์-->
                                </div>
                                <div class="Customer-name-and-code"> <!--กล่องของลูกค้าและรหัสลูกค้า-->
                                    <div class="Customer-name"> <!--กล่องลูกค้า-->
                                        <div class="text-label">ชื่อลูกค้า <span class="moonflower-red">*</span></div><!--กล่องข้อความลูกค้า-->
                                        <div class="autocomplete-container">
                                            <input class="input-customer" id="customerName" type="text"
                                                placeholder="ชื่อลูกค้า" autocomplete="off"><!--กล่อง input ความลูกค้า-->
                                            <div class="autocomplete-dropdown" id="customerDropdown"></div>
                                        </div>
                                    </div>
                                    <div class="Customer-code"><!--กล่องรหัสลูกค้า-->
                                        <div class="text-label">รหัสลูกค้า <span class="moonflower-red">*</span></div><!--กล่องข้อรหัสลูกค้า-->
                                        <input class="input-customer" id="customerCode" type="text" placeholder="รหัสลูกค้า"><!--กล่องinputข้อรหัสลูกค้า-->
                                    </div>
                                </div>
                                <div class="supplier-info"><!--กล่องใหญ่ที่อยู่ผู้จำหน่าย-->
                                    <div class="supplier-address"><!--กล่องที่อยู่ผู้จำหน่าย-->
                                        <div class="text-label4">ที่อยู่ลูกค้า <span class="moonflower-red">*</span>
                                        </div>
                                        <!--กล่องข้อความ ที่อยู่ผู้จำหน่าย-->
                                        <textarea class="input-field1" id="customerAddress" placeholder="ที่อยู่ผู้จำหน่าย"></textarea><!--กล่องinputข้อความ-->
                                    </div>
                                    <div class="supplier-contact"><!--กล่องใหญ่ที่เบอร์โทรกับที่ตั้งธุรกิจ-->
                                        <div class="box-text-label">
                                            <div class="text-label5">เบอร์โทร <span class="moonflower-red">*</span>
                                            </div><!--กล่องข้อความเบอร์โทร-->
                                            <input class="input-field" type="text" id="customerPhone" placeholder="เบอร์โทร"><!--กล่องinput-->
                                        </div>
                                        <div class="box-text-label1">
                                            <div class="text-label5">ที่ตั้งธุรกิจ <span class="moonflower-red">*</span>
                                            </div><!--กล่องข้อที่ตั้งธุรกิจ-->
                                            <input class="input-field" type="text" id="customerHeadOffice" placeholder="ที่ตั้งธุรกิจ"><!--กล่องinput-->
                                        </div>
                                    </div>
                                </div>
                                <div class="Customer-gmai-and-namecall"> <!--กล่องของลูกค้าและรหัสลูกค้า-->
                                    <div class="Customer-name"> <!--กล่องลูกค้า-->
                                        <div class="text-label" >อีเมล <span class="moonflower-red">*</span></div>
                                        <!--กล่องข้อความลูกค้า-->
                                        <input class="input-customer" type="text" id="customerGmail" placeholder="อีเมล"><!--กล่อง input ความลูกค้า-->
                                    </div>
                                    <div class="Customer-code"><!--กล่องรหัสลูกค้า-->
                                        <div class="text-label">ชื่อผู้ติดต่อ</div><!--กล่องข้อรหัสลูกค้า-->
                                        <input class="input-customer" type="text" id="customerContactName" placeholder="ชื่อที่อยู่ผู้ติดต่อ"><!--กล่องinputข้อรหัสลูกค้า-->
                                    </div>
                                </div>
                                <div class="refer">
                                    <div class="title"><b>อ้างอิง</b></div>
                                    <div style="width: 100%;">
                                        <input class="refer-input" id="customerRefer" type="text" placeholder="อ้างอิง">
                                    </div>
                                </div>
                                <div class="office">
                                    <div class="head-office"><b>สำนักงาน/สาขา <span class="moonflower-red">*</span></b>
                                    </div>
                                    <!--กล่องของ สำนักงาน-->
                                    <div class="button-input">
                                        <!--ปุ่มradio-->
                                        <div class="office-label">
                                            <div class="office-option-big">
                                                <label class="custom-radio">
                                                    <input type="radio" id="big-office" name="fav_language"
                                                        value="สำนักงานใหญ่" checked>
                                                    <span class="radio-btn"></span>
                                                    <div class="word-big-office">สำนักงานใหญ่</div>
                                                </label>
                                            </div>
                                            <div class="office-option-small">
                                                <label class="custom-radio">
                                                    <input type="radio" id="small-office" name="fav_language"
                                                        value="สาขาย่อย">
                                                    <span class="radio-btn"></span>
                                                    <div class="word-small-office">สาขาย่อย</div>
                                                </label>
                                            </div>
                                        </div>
                                        <!--ปุ่มradio-->
                                        <!-- Input fields -->
                                        <div class="office-input">
                                            <input type="text" class="input-office" id="customerBranchCode" placeholder="รหัสสาขา">
                                            <input type="text" class="input-office branch-name" id="customerBranchName"  placeholder="ชื่อสาขา">
                                        </div>
                                        <!-- Input fields -->
                                    </div>
                                    <!--กล่องของ สำนักงาน-->
                                </div>
                            </div>
                            <div class="documents-information">
                                <div class="bar-documents-information"> 
                                    <div class="word-bar-Customer-information">ข้อมูลเอกสาร</div> 
                                </div>
                                <!-- <div class="bar-documents-information"> บาร์ข้อมูลลูกค้า -->
                                    <!-- <div class="word-bar-documents-information">ข้อมูลเอกสาร</div> ข้อความในบาร์ -->
                                <!-- </div> -->
                                <div class="head-select-refer">
                                    <div class="box-select-refe-slip">
                                        <div class="word-select-refer">อ้างอิงใบสั่งขาย</div>
                                            <div class="input-upload">
                                            <div class="input-select-refer"><input type="text" class="input-credit" id="salesOrderCodeInput"
                                                    placeholder="ใบสั่งขาย" readonly></div>
                                            <div class="openPopupBtnsalesorder"> 
                                            <div class="select-refer-modal">เลือกใบอ้างอิง</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            <div class="credit-day">
                                    <div class="box-credit">
                                        <div class="word-credit">เครดิตจากประวัติชำระเงินของ</div>
                                        <input class="input-credit" type="text" placeholder="บริษัท ตัวอย่าง จำจัด" id="customerCredithistory">
                                    </div>
                                    <div class="box-day">
                                        <div class="word-credit">เครดิต(วัน)</div>
                                        <div class="box-input-credit"><input class="input-credit-new" type="number" placeholder="2"  id="customerDueDate" ></div>
                                    </div>
                                </div>
                                <div class="data-dat">
                                    <div class="boxdata-day-item">
                                        <div class="word-department">วันที่</div>
                                        <input type="date" class="input-data-day"  id="customerDay">
                                    </div>
                                    <div class="boxdata-Due-item">
                                        <div class="word-department">ครบกำหนด</div>
                                        <input type="date" class="input-data-day" id="customerDayfully">
                                    </div>
                                </div>
                                <div class="twain-day">
                                    <div class="head-day">
                                        <div class="word-department">แผนก</div>
                                        <select name="myDropdown" id="customerDepartment" class="dropdown">
                                            <option value="">แผนก</option>
                                            <option value="แผนกบัญชี">แผนกบัญชี</option>
                                            <option value="แผนกฝ่ายบุคคล">แผนกฝ่ายบุคคล</option>
                                            <option value="แผนก IT">แผนก IT</option>
                                        </select>
                                    </div>
                                    <div class="head-day">
                                        <div class="word-department"  >พนักงานขาย</div>
                                        <select name="myDropdown" id="customerSalesperson" class="dropdown">
                                            <option value="">พนักงานขาย</option>
                                            <option value="พนักงานขาย 1">พนักงานขาย 1</option>
                                            <option value="พนักงานขาย 2">พนักงานขาย 2</option>
                                            <option value="พนักงานขาย 3">พนักงานขาย 3</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="twain-day">
                                    <div class="head-day">
                                        <div class="word-department">ข้อมูลราคาและภาษี</div>
                                        <select name="myDropdown" id="customerPriceandTax" class="dropdown">
                                            <option value="">แยกภาษี</option>
                                            <option value="ภาษีส่วนบุคคล">ภาษีส่วนบุคคล</option>
                                            <option value="ภาษีมูลค่าเพิ่ม">ภาษีมูลค่าเพิ่ม</option>
                                            <option value="ภาษีถูกหัก">ภาษีถูกหัก</option>
                                        </select>
                                    </div>
                                    <div class="head-day">
                                        <div class="word-department">สกุลเงิน</div>
                                        <select name="myDropdown" id="customerCurrency" class="dropdown">
                                            <option value="">เลือกสกุลเงิน</option>
                                            <option value="ดอลลาร์">ดอลลาร์</option>
                                            <option value="บาท">บาท</option>
                                            <option value="ยูโร">ยูโร</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="tax-invoice">
                                    <div class="boebutton-invoice">
                                        <div class="word-invoice">การออกใบกำกับภาษี</div>
                                        <label class="toggle-switch">
                                            <input type="checkbox" id="toggle-btn-2">
                                            <span class="slider round"></span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="boxmain-list"><!--ส่วนกล่อง รายการ กล่องที่ 2-->
                            <!--รายการ-->
                            <div class="list">
                                <div class="head-list">รายการ</div><!--กล่องไว้ใส่หัวข้อ-->
                                <div class="word-list">สินค้า/บริการ</div><!--หัวข้อ-->
                                <div class="list-label"><!--กล่องใหญ่ของ radio-->
                                    <!--ปุ่มradio-->
                                    <div class="office-label">
                                        <div class="office-option-big">
                                            <label class="custom-radio">
                                                <input type="radio" name="fav_language_1" value="product">
                                                <span class="radio-btn"></span>
                                                <div class="word-big-office">สินค้า</div>
                                            </label>
                                        </div>
                                        <div class="office-option-small">
                                            <label class="custom-radio">
                                                <input type="radio" name="fav_language_1" value="service" checked>
                                                <span class="radio-btn"></span>
                                                <div class="word-small-office">บริการ</div>
                                            </label>
                                        </div>
                                    </div>
                                    <!--ปุ่มradio-->
                                    <!-- Input fields -->
                                    <div class="office-input">
                                        <input type="text" class="input-office invisible-one" placeholder="รหัสสาขา">
                                        <input type="text" class="input-office invisible-one" placeholder="ชื่อสาขา">
                                    </div>
                                </div>
                                <!--กล่องที่เวลากดปุ่มจะสลับเรื่อย-->
                                <!-- ไม่มีข้อมูล -->
                                <div class="class-product">
                                    <table class="data-table-createssalenone">
                                        <thead>
                                            <tr>
                                                    <th>ลำดับ</th>
                                                    <th>เอกสารที่ตัด</th>
                                                    <th>ชื่อรายการ</th>
                                                    <th>รายละเอียด</th>
                                                    <th>ยอดหลังหักส่วนลด</th>
                                                    <th>ราคามัดจำ</th>
                                                    <th></th>
                                                </tr>
                                        </thead>
                                        <tbody>
                                        </tbody>
                                    </table>
                                    <div class="box-picture-Create-data-table2">
                                        <div class="picture-Create-data-table1">
                                            <div class="picture-Create-data"><img src="picture/Subtract.png"></div>
                                            <div class="word-in-picture-Create-data">ยังไม่มีข้อมูล</div>
                                        </div>
                                    </div>
                                <div class="one-button1"> 
                                        <div class="receipt-button">
                                            <div class="word-receipt">เพิ่มรายการ</div>
                                        </div>
                                    </div>
                                    <!-- ไม่มีข้อมูล -->
                                    <!-- มีข้อมูล -->
                                    <!-- <div class="data5-table">
                                        <table class="data-table-serve">
                                            <thead>
                                                <tr>
                                                    <th>ลำดับ</th>
                                                    <th>รหัส</th>
                                                    <th>ชื่อรายการ</th>
                                                    <th>รายละเอียด</th>
                                                    <th>จำนวน</th>
                                                    <th>หน่วย</th>
                                                    <th>ราคา/หน่วย</th>
                                                    <th>ส่วนลด</th>
                                                    <th>ราคารวม</th>
                                                    <th></th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr class="data-row">
                                                    <td>1</td>
                                                    <td>AA-12340000</td>
                                                    <td>ระบบจัดเก็บข้อมูลลู...</td>
                                                    <td>Software สำหรับจัดเก็บข้อม...</td>
                                                    <td>1</td>
                                                    <td>รายการ</td>
                                                    <td>43,200.00</td>
                                                    <td>100.00</td>
                                                    <td>43,100.00</td>
                                                    <td>
                                                        <div class="action-icons">
                                                            <div id="openPopupBtn3">
                                                                <div class="ac-icon"><img src="picture/eye.png"></div>
                                                            </div>
                                                            <div id="openPopupBtn2">
                                                                <div class="ac-icon"><img src="picture/pen.png"></div>
                                                            </div>
                                                            <div class="ac-icon"><img src="picture/bin.png"></div>
                                                        </div>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                <div class="pagination">
                                        <span class="page-info">1 of 5 pages</span>
                                        <a class="active" href="#">1</a>
                                        <a href="#">2</a>
                                        <a href="#">3</a>
                                        <span class="dots">...</span>
                                        <a href="#">5</a>
                                        <a href="#" class="next"><img
                                                src="picture/subtract-1--button-delete-buttons-subtract-horizontal-remove-line-add-mathematics-math-minus.png"></a>
                                    </div>
                                        <div id="openPopupBtn4">
                                        <div class="one-button2">
                                            <div class="receipt-button">
                                                <div class="word-receipt">เพิ่มรายการ</div>
                                            </div>
                                        </div>
                                    </div> -->
                                    <!-- มีข้อมูล -->
                                </div>
                                <!-- ไม่มีข้อมูล -->
                                <!-- บริการ -->
                                <div class="class-serve">
                                    <!-- ไม่มีข้อมูล -->
                                <div id="noDataSection">
                                    <table class="data-table-createssalenone">
                                        <thead>
                                            <tr>
                                                <th>ลำดับ</th>
                                                <th>เอกสารที่ตัด</th>
                                                <th>ชื่อรายการ</th>
                                                <th>รายละเอียด</th>
                                                <th>ยอดหลังหักส่วนลด</th>
                                                <th>ราคามัดจำ</th>
                                                <th></th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                        </tbody>
                                    </table>
                                    <div  class="box-picture-Create-data-table2">
                                        <div class="picture-Create-data-table1">
                                            <div class="picture-Create-data"><img src="picture/Subtract.png"></div>
                                            <div class="word-in-picture-Create-data">ยังไม่มีข้อมูล</div>
                                        </div>
                                    </div> 
                                    </div>
                                    <!-- ไม่มีข้อมูล -->
                                    <!-- มีข้อมูล -->
                                    <div class="data5-table">
                                    <div id="myPopupview" style="display: none;">
                                        <table  class="data-table-createssale">
                                            <thead>
                                                <tr>
                                                    <th>ลำดับ</th>
                                                    <th>เอกสารที่ตัด</th>
                                                    <th>ชื่อรายการ</th>
                                                    <th>รายละเอียด</th>
                                                    <th>ยอดหลังหักส่วนลด</th>
                                                    <th>ราคามัดจำ</th>
                                                    <th></th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr class="data-row">
                                                    <td>1</td>
                                                    <td>SO-202501100001</td>
                                                    <td>ระบบจัดเก็บข้อมูลภายในสำนักงาน</td>
                                                    <td>รับเงินมัดจำล่วงหน้า</td>
                                                    <td>43,100.00</td>
                                                    <td>20,000.00</td>
                                                    <td>
                                                        <div class="action-icons">
                                                            <div class="openPopupBtnview">
                                                                <div class="ac-icon"><img src="picture/eye.png"></div>
                                                            </div>
                                                            <div class="myPopupaddsmallpen">
                                                                <div class="ac-icon"><img src="picture/pen.png"></div>
                                                            </div>
                                                            <div class="ac-icon"><img src="picture/bin.png"></div>
                                                        </div>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    </div>
                                    <div class="pagination" style="display: none;">
                                        <span class="page-info"><!--1 of 1 pages--></span>
                                    </div>
                                    <div id="myPopupview" class="popup-container">
                                        <div class="popup-content3">
                                            <div style="width: 100%;">
                                                <div class="bold">รายการ</div>
                                            </div>
                                            <div style="width: 100%;">
                                                <div class="password-unit-price-unit">
                                                    <div class="password-unit-price-unit-box-view">
                                                        <div class="password-view">
                                                            <div class="password-title-view">รหัส</div>
                                                            <div class="password-box">
                                                                <div class="password-box-title">AA-12340000</div>
                                                            </div>
                                                        </div>
                                                        <div class="unit">
                                                            <div class="model-all">
                                                                <div class="password-title-view">หน่วย</div>
                                                            </div>
                                                            <div class="password-box-title">รายการ</div>
                                                        </div>
                                                        <div class="price-unit-view">
                                                            <div class="model-all">
                                                                <div class="password-title-view">ราคา/หน่วย</div>
                                                            </div>
                                                            <div class="password-box-title">43,200.00</div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div style="width: 100%;height: 65px;">
                                                    <div class="model-all-name">
                                                        <div class="password-title-view">ชื่อรายการ</div>
                                                    </div>
                                                    <div class="password-box-title">ระบบจัดเก็บข้อมูลภายในสำนักงาน</div>
                                                </div>
                                                <div style="width: 100%;">
                                                    <div class="model-all-name">
                                                        <div class="password-title-view">รายละเอียด</div>
                                                    </div>
                                                    <div class="password-box-title-long">
                                                        ปุ่มแตะบัตรสมาชิกให้ได้รับค่าแค่การแต่บัตร
                                                        ไม่รับค่าจากการพิมพ์(ห้ามพิมพ์) (ต้องนำเสนอ Solution
                                                        เนื่องจากตัวอ่านไม่สามารถตรวจจับแยกประเภท Hardware ได้
                                                        ต้องปรับเพื่อให้ได้ ผลลัพธ์ใกล้เคียง)
                                                        <br>-กรณี Pop up รับค่าเลขที่บัตร และให้ปิดตัวลงหลังจาก x
                                                        วินาทีเพื่อไม่ให้ได้รับค่าจาก Keyboard
                                                        เพ่อป้องกัน โดยสามารถ comfig เวลารับของ pop upได้
                                                        <br>-สามารถ Config การล็อกเวลา ให้คีย์ภายในกี่วินาทีก่อน pop
                                                        upในการรับปิดไป (ตั้ง Delay Time
                                                        out)
                                                    </div>
                                                </div>
                                                <div class="line-texarea"></div>
                                                <div class="price-all">
                                                    <div class="price-unit">
                                                        <div class="model-all">
                                                            <div class="password-title-view">จำนวน</div>
                                                        </div>
                                                        <div class="password-box-title-box">1</div>
                                                    </div>
                                                    <div class="price-unit">
                                                        <div class="model-all">
                                                            <div class="password-title-view">ส่วนลด</div>
                                                        </div>
                                                        <div class="password-box-title-box">100.00</div>
                                                    </div>
                                                    <div class="price-unit">
                                                        <div class="model-all">
                                                            <div class="password-title-view">ราคารวม</div>
                                                        </div>
                                                        <div class="password-box-title-box">43,100.00</div>
                                                    </div>
                                                </div>
                                                <div class="cancel-save-under">
                                                    <div class="box-cancel-save">
                                                        <div class="save" id="cancelPopupBtn3">กลับ</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- <div id="myPopuppenview" class="popup-container">
                                        <div class="popup-content3-add">
                                            <div style="width: 100%;">
                                                <div class="bold">แก้ไขรายการ</div>
                                                <div class="regular">รายละเอียด และจำนวน</div>
                                            </div>
                                            <div style="width: 100%;">
                                                <div class="password-unit-price-unit">
                                                    <div class="password-unit-price-unit-box">
                                                        <div class="password">
                                                            <div class="password-title">รหัส</div>
                                                            <div class="password-box">
                                                                <input type="text" class="code-edit-box"
                                                                    placeholder="AA-12340000">
                                                            </div>
                                                        </div>
                                                        <div class="unit">
                                                            <div class="model-all">
                                                                <div class="unit-title">หน่วย</div>
                                                                <div class="red-dot">*</div>
                                                            </div>
                                                            <select class="modal-select-black">
                                                                <option selected>รายการ</option>
                                                                <option>1</option>
                                                                <option>2</option>
                                                                <option>3</option>
                                                            </select>
                                                        </div>
                                                        <div class="price-unit">
                                                            <div class="model-all">
                                                                <div class="price-unit-title">ราคา/หน่วย</div>
                                                                <div class="red-dot">*</div>
                                                            </div>
                                                            <input type="number" placeholder="43,200.00"
                                                                class="price-unit-class-black">
                                                        </div>
                                                    </div>
                                                </div>
                                                <div style="width: 100%;height: 65px;">
                                                    <div class="model-all-name-add-modal">
                                                        <div class="unit-title-add-modal">ชื่อรายการ</div>
                                                    </div>
                                                    <div><input type="text" class="input-add-name"
                                                            placeholder="ระบบจัดเก็บข้อมูลภายในสำนักงาน" disabled></div>
                                                </div>
                                                <div style="width: 100%;height: 146px;">
                                                    <div class="model-all-name">
                                                        <div class="unit-title-add-modal">รายละเอียด</div>
                                                        <div class="red-dot-name">*</div>
                                                    </div>
                                                    <textarea class="textarea-add-name-new"
                                                        placeholder="Software พื้นที่จัดเก็บข้อมูล พร้อมติดตั้งและจัดอบรม"></textarea>
                                                </div>
                                                <hr class="line-modal">
                                                <div class="price-all">
                                                    <div class="price-unit">
                                                        <div class="model-all">
                                                            <div class="price-unit-title">จำนวน</div>
                                                            <div class="red-dot">*</div>
                                                        </div>
                                                        <input type="number" placeholder="1"
                                                            class="price-unit-class-number">
                                                    </div>
                                                    <div class="price-unit">
                                                        <div class="model-all">
                                                            <div class="price-unit-title">ส่วนลด</div>
                                                            <div class="red-dot">*</div>
                                                        </div>
                                                        <input type="number" placeholder="100.00"
                                                            class="price-unit-class-black">
                                                    </div>
                                                    <div class="price-unit">
                                                        <div class="model-all">
                                                            <div class="price-unit-title">ราคารวม</div>
                                                        </div>
                                                        <input type="text" placeholder="43,200.00"
                                                            class="price-unit-class-dis-black" disabled>
                                                    </div>
                                                </div>
                                                <div class="cancel-save-under">
                                                    <div class="box-cancel-save">
                                                        <div class="cancel" id="cancelPopupBtn2">ยกเลิก</div>
                                                        <div class="save" id="addAndHideBtn2">เพิ่ม</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div> -->
                                    <!-- editsmall -->
                                <div class="popup-container myPopupaddsmallpen">
                                    <div class="popup-content-adddeposit-add-modal">
                                            <div style="width: 100%;">
                                                <div class="bold">แก้ไขรายการ</div>
                                                <div class="regular-nomarginbottom">รายละเอียด และจำนวน</div>
                                            </div>
                                
                                            <div class="add-modal-deposit" style="width: 100%; margin-top: 8px;">
                                                <div style="width: 100%;">
                                                    <div style="margin-bottom: 8px;">เอกสารที่ตัด</div>
                                                    <div><input type="text" placeholder="เอกสารที่ตัด" class="input-add-modal-deposit" id="editsodesheet" style="width: 100%;" readonly ></div>
                                                </div>
                                                
                                            </div>
                                            <div>
                                                <div class="bold-16">ชื่อรายการ</div>
                                                <div><input type="text" class="password-title-view-add-modal" placeholder="ชื่อรายการ" id="editnamesheet"></div>
                                            </div>
                                
                                            <div class="bold-16">รายละเอียด</div>
                                            <textarea placeholder="รับเงินมัดจำล่วงหน้า" class="textarea-add-name-gray-upload" id="editdetailsheet"></textarea>
                                
                                            <div class="add-modal-under">
                                                <div>
                                                    <div class="bold-16-nomargin">ยอดหลังหักส่วนลด</div>
                                                    <div><input type="number" class="password-title-view-add-modal-under-gray" placeholder="43,100.00"  id="editmoneyunitsheet" readonly>
                                                    </div>
                                                </div>
                                                <div>
                                                    <div class="bold-16-nomargin">ราคามัดจำ</div>
                                                    <div><input type="number" class="password-title-view-add-modal-under" placeholder="20,000.00"  id="editdeposit_price"></div>
                                                </div>
                                            </div>
                                
                                            <div class="cancel-save-under">
                                                <div class="box-cancel-save">
                                                    <div class="cancel cancelPopupBtnaddsmallpen">ยกเลิก</div>
                                                    <div class="save addAndHideBtnaddsmallpen">เพิ่ม</div>
                                                </div>
                                            </div>
                                
                                        </div>
                                </div>
                                    <div class="openPopupBtndeopsit">
                                        <div class="one-button2"> <!--กล่องปุ่มออกใบเสร็จ-->
                                            <div class="receipt-button"><!--ปุ่มออกใบเสร็จ-->
                                                <div class="word-receipt">เพิ่มรายการเอกสาร</div>
                                            </div>
                                        </div>
                                        </div>
                                </div>
                                <div class="Main-box-below">
                                    <div class="signature">
                                        <div class="checkbox-main">
                                            <div class="checkbox-list-box-3">
                                                <input type="checkbox" name="visits" id="list-tax-data-3"
                                                    class="checkbox-list-input-3">
                                                <label for="list-tax-data-3">ลายเซ็นต์อิเล็กทรอนิกและตรายาง</label>
                                            </div>
                                        </div>
                                        <div class="Under-Bill-number">
                                            <div class="title-period">หมายเหตุ</div>
                                            <textarea class="period-text" type="text" placeholder="หมายเหตุ" id="customerNoteunder"></textarea>
                                        </div>
                                        
                                        <div class="box-Load-file">
                                            <div class="head-lode">แนบไฟล์</div>
                                            <div id="showUploadFiles">
                                                <!--กล่องอัปโหลดไฟล์แล้วจะแสดงที่นี่ด้วย-->
                                            </div>
                                                <div class="upload-file-box">
                                                    <div class="openPopupBtnupload">
                                                    <div class="upload-file-box-in">
                                                        <div><img src="picture/save.png" class="upload-green"></div>
                                                        อัปโหลดไฟล์
                                                    </div>
                                                    </div>
                                                </div>
                                            

                                            <div class="title-upload">(ขนาดไฟล์เอกสาร pdf, jpg, xls, doc ไม่เกิน 40 MB /
                                                ไฟล์)</div>
                                        </div>
                                    </div>
                                    <div id="myPopupeditpen" class="popup-container">
                                        <div class="popup-content-edit-sum">
                                            <div style="width: 100%;">
                                                <div class="bold">แก้ไขมูลค่าสุทธิ</div>
                                                <div class="regular">จำนวนเงิน</div>
                                            </div>
                                            <div style="width: 100%;">
                                                <div class="password-unit-price-unit">
                                                    <div class="password-unit-price-unit-box">
                                                        <div class="password">
                                                            <div class="password-title">จำนวนเงิน</div>
                                                            <div class="password-box">
                                                                <input type="text" class="code-edit-box-sum"
                                                                    placeholder="43,200.00" disabled>
                                                            </div>
                                                        </div>
                                                        <div class="unit">
                                                            <div class="model-all">
                                                                <div class="unit-title">ส่วนลด</div>
                                                            </div>
                                                            <div class="dropdown-unit">
                                                                <div class="dropdown-box-unit">
                                                                    <input type="text" class="code-edit-box-sum"
                                                                        placeholder="100.00" disabled>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="price-unit">
                                                            <div class="model-all">
                                                                <div class="price-unit-title">ยอดหลังหักส่วนลด</div>
                                                            </div>
                                                            <input type="text" class="code-edit-box-sum"
                                                                placeholder="43,100.00" disabled>
                                                        </div>
                                                    </div>
                                                </div>
                                                <hr class="line-modal">
                                                <div class="model-all-name-sum ">
                                                    <div class="regular-sum">จำนวนภาษี</div>
                                                </div>
                                                <div class="password-title">ภาษีมูลค่าเพิ่ม 7%</div>
                                                <div><input type="text" placeholder="3,017.00" class="code-edit-box-sum"
                                                        disabled></div>
                                                <div class="checkbox-list-box-sum">
                                                    <div class="edit-sum">
                                                        <input type="checkbox" name="visits" id="list-tax-data-modal1"
                                                            class="checkbox-list-input-modal" checked>
                                                        <label for="list-tax-data-modal1">รายการที่ 1:
                                                            ระบบจัดเก็บข้อมูลภายในสำนักงาน</label>
                                                    </div>
                                                    <div>เปล่าๆ</div>
                                                </div>
                                                <div class="checkbox-list-box-sum">
                                                    <div class="edit-sum">
                                                        <input type="checkbox" name="visits" id="list-tax-data-modal2"
                                                            class="checkbox-list-input-modal2">
                                                        <label for="list-tax-data-modal2">รายการที่ 2: ทดสอบ1</label>
                                                    </div>
                                                    <div><input type="text" placeholder="0000.00"
                                                            class="code-edit-box-sum-edit-dis"></div>
                                                </div>
                                                <div class="checkbox-list-box-sum">
                                                    <div class="edit-sum">
                                                        <input type="checkbox" name="visits" id="list-tax-data-modal3"
                                                            class="checkbox-list-input-modal checkbox-list-input-modal3"
                                                            checked>
                                                        <label for="list-tax-data-modal3">รายการที่ 3: ทดสอบ1</label>
                                                    </div>
                                                    <div><input type="text" placeholder="300.00"
                                                            class="code-edit-box-sum-edit"></div>
                                                </div>
                                                <div class="checkbox-list-box-sum">
                                                    <div class="edit-sum">
                                                        <input type="checkbox" name="visits" id="list-tax-data-modal4"
                                                            class="checkbox-list-input-modal checkbox-list-input-modal4">
                                                        <label for="list-tax-data-modal4">รายการที่ 4: ทดสอบ1</label>
                                                    </div>
                                                    <div><input type="text" placeholder="0000.00"
                                                            class="code-edit-box-sum-edit-dis"></div>
                                                </div>
                                                <div class="checkbox-list-box-sum">
                                                    <div class="edit-sum">
                                                        <input type="checkbox" name="visits" id="list-tax-data-modal5"
                                                            class="checkbox-list-input-modal checkbox-list-input-modal5">
                                                        <label for="list-tax-data-modal5">รายการที่ 5: ทดสอบ1</label>
                                                    </div>
                                                    <div><input type="text" placeholder="0000.00"
                                                            class="code-edit-box-sum-edit-dis"></div>
                                                </div>
                                            </div>
                                            <div class="under-search-sum-edit">
                                                <div class="under-page">1 of 40 pages</div>
                                                <div class="under-page1">1</div>
                                                <div class="number-green">2</div>
                                                <div class="number-green">3</div>
                                                <div class="number-green-dot">...</div>
                                                <div class="number-green-40">40</div>
                                                <div class="arrow-container"><img src="picture/arrow-right.png"
                                                        class="arrow"></div>
                                            </div>
                                            <div class="all-tax-under">
                                                <div class="left">
                                                    <div class="password-title">ภาษีหัก ณ ที่จ่าย</div>
                                                    <div><input type="text" placeholder="0000.00"
                                                            class="code-edit-box-sum" disabled></div>
                                                </div>
                                                <div class="right">
                                                    <div class="password-title">%</div>
                                                    <div>
                                                        <select class="right-under">
                                                            <option>0.00</option>
                                                            <option>1.5</option>
                                                            <option>3.0</option>
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="checkbox-list-box-sum">
                                                <div class="edit-sum">
                                                    <input type="checkbox" name="visits" id="list-tax-data-6"
                                                        class="checkbox-list-input checkbox-list-input-6">
                                                    <label for="list-tax-data-6">รายการที่ 1:
                                                        ระบบจัดเก็บข้อมูลภายในสำนักงาน</label>
                                                </div>
                                                <div><input type="text" placeholder="0000.00"
                                                        class="code-edit-box-sum-edit-dis"></div>
                                            </div>
                                            <div class="sum-under-total">
                                                <div class="name-sum-total">จำนวนเงินรวมทั้งสิ้น</div>
                                                <div class="money-baht">
                                                    <div class="money-sum-total">46,117.00</div>
                                                    <div class="baht-sum-total">บาท</div>
                                                </div>
                                            </div>
                                            <div class="cancel-save-under">
                                                <div class="box-cancel-save">
                                                    <div class="cancel" id="cancelPopupBtn5">ยกเลิก</div>
                                                    <div class="save" id="addAndHideBtn">เพิ่ม</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="conclude">
                                        <div class="bar-conclude">
                                            <div class="head-conclude">สรุปมูลค่าสุทธิ</div>
                                            <div class="openPopupBtneditpen">
                                            <div class="icon"><img src="picture/pen.png"></div>
                                            </div>
                                        </div>
                                        <div class="Amount-of-money">
                                            <div class="word-Amount">จำนวนเงิน</div>
                                            <div class="number-money">
                                                <div class="word-number" id="total-allproduct">0.00</div>
                                                <div class="word-money">บาท</div>
                                            </div>
                                        </div>
                                        
                                        <div class="Amount-of-money">
                                            <div class="checkbox-main">
                                                <div class="checkbox-list-box">
                                                    <input type="checkbox" name="visits" id="list-tax-data"
                                                        class="checkbox-list-input-new">
                                                    <label
                                                        for="list-tax-data">ภาษีมูลค่าเพิ่ม&nbsp;&nbsp;7%</label>
                                                </div>
                                            </div>
                                            <div class="number-money">
                                                <!-- <div class="word-number" id="total-vat7">1,400.00</div> -->
                                                <div class="word-number" id="total-vat7">0.00</div>
                                                <div class="word-money">บาท</div>
                                            </div>
                                        </div>
                                        <div class="Amount-of-money">
                                            <div class="checkbox-main">
                                                <div class="checkbox-list-box-2">
                                                    <input type="checkbox" name="visits" id="list-tax-data-2"
                                                        class="checkbox-list-input-2" >
                                                    <label for="list-tax-data-2">ภาษีถูกหัก ณ
                                                        ที่จ่าย</label>
                                                    <!-- <div class="dropdown-unit">
                                                        <div class="dropdown-box-unit">
                                                            <select name="unit-persen" id="unit-items">
                                                                <option hidden selected>0.0</option>
                                                                <option value="1.00">1%</option>
                                                                <option value="2.00">3%</option>
                                                                <option value="3.00">5%</option>
                                                            </select>
                                                        </div>
                                                    </div> -->
                                                </div>
                                            </div>
                                            <div class="number-money">
                                                <!-- <div class="word-number" id="total-vat-unit">300.00</div> -->
                                                <div class="word-number" id="total-vat-unit">0.00</div>
                                                <div class="word-money">บาท</div>
                                            </div>
                                        </div>
                                        <div class="Amount-of-money">
                                            <div class="word-Amount">ตัดมัดจำเรียบร้อย</div>
                                            <div class="number-money">
                                                <label class="toggle-switch">
                                                    <input type="checkbox" id="toggleBox" >
                                                    <span class="slider round"></span>
                                                </label>
                                            </div>
                                        </div>
                                        <div class="Payment-amount">
                                            <div class="word-Amount">ยอดชำระจริง</div>
                                            <div class="number-money">
                                                <!-- <div class="word-number" id="total-all">21,000.00</div> -->
                                                <div class="word-number" id="total-all">0.00</div>
                                                <div class="word-money">บาท</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                    </div>
                    <div id="myBox" class="my-box ">
                        <div class="box-list-deposit">
                            <div class="box-list-deposit-in">
                                <div class="list-deposit">รายการตัดเงินมัดจำ</div>
                                <div class="payment">การชำระครั้งที่1</div>
                            </div>
                            <div class="date-input-wrapper">
                                <div class="date-payment">วันที่</div>
                                <input type="date" class="input-date-payment" id="depositCutDate">
                            </div>
                        </div>
                        <div class="radio-box">
                            <div class="radio-box-in">
                                <div class="radio-box-cash">ช่องทางการชำระเงิน</div>
                                <div
                                    class="radio-box-hub">
                                    <label for="cash" class="custom-radio">
                                        <input type="radio" id="cash" value="page1" name="pageSelection"
                                            class="radio-cash" checked><span class="radio-btn"></span> เงินสด
                                    </label>
                                    <label for="bank" class="custom-radio">
                                        <input type="radio" id="bank" value="page2" name="pageSelection"
                                            class="radio-cash" ><span class="radio-btn"></span>ธนาคาร
                                    </label>
                                    <label for="promptpay" class="custom-radio">
                                        <input type="radio" id="promptpay" value="page3" name="pageSelection"
                                            class="radio-cash"><span class="radio-btn"></span>พร้อมเพย์ QR Code
                                    </label>
                                    <label for="Reserve" class="custom-radio">
                                        <input type="radio" id="Reserve" value="page4" name="pageSelection"
                                            class="radio-cash"> <span class="radio-btn"></span>สำรองรับ/จ่าย
                                    </label>
                                </div>
                            </div>
                        </div>
                        <!-- หน้าที่1-->
                        <div id="page1" class="page active">
                            <div
                                class="page1-hub">
                                <div class="page1-left">
                                    <div class="depositdeductions"> <!--กล่องของลูกค้าและรหัสลูกค้า-->
                                        <div class="Customer-payeename"> <!--กล่องลูกค้า-->
                                            <div class="payeename">ชื่อผู้รับเงิน</div><!--กล่องข้อความลูกค้า-->
                                            <input class="payeename-text" type="text" id="paymentPayeeName"
                                                placeholder="ตัวอย่างข้อความ"><!--กล่อง input ความลูกค้า-->
                                        </div>
                                        <div class="Customer-paymentamount"><!--กล่องรหัสลูกค้า-->
                                            <div class="paymentamount">จำนวนเงินรับชำระ (บาท)</div>
                                            <!--กล่องข้อรหัสลูกค้า-->
                                            <input class="paymentamount-text" type="number" id="paymentAmount"
                                                placeholder="0000000000000.00"><!--กล่องinputข้อรหัสลูกค้า-->
                                        </div>
                                    </div>
                                    <div class="Description">คำอธิบายช่องทางการเงิน</div>
                                    <textarea class="Description-textarea" id="paymentDescription" placeholder="ระบุหมายเหตุ"></textarea>
                                    <div class="depositdeductions"> <!--กล่องของลูกค้าและรหัสลูกค้า-->
                                        <div class="deposit-date"> <!--กล่องลูกค้า-->
                                            <div class="payeename">วันที่ชำระ</div><!--กล่องข้อความลูกค้า-->
                                            <input class="deposit-date-text" type="date" id="paymentDate"><!--กล่อง input ความลูกค้า-->
                                        </div>
                                        <div class="deposit-time"><!--กล่องรหัสลูกค้า-->
                                            <div class="paymentamount">เวลา</div><!--กล่องข้อรหัสลูกค้า-->
                                            <input class="deposit-time-text" type="time" id="paymentTime"
                                                placeholder="0000000000000.00"><!--กล่องinputข้อรหัสลูกค้า-->
                                        </div>
                                    </div>
                                </div>
                                <div class="page1-right">
                                    <div class="all-margin">
                                        <div class="Summary-payment">สรุปยอดรับชำระ</div>
                                    </div>
                                    <div class="all-margin">
                                        <div class="tex-payment">มูลค่ารวมภาษี</div>
                                        <div class="all-gap">
                                            <div class="money" id="cut-total"></div>
                                            <div class="baht">บาท</div>
                                        </div>
                                    </div>
                                    <div class="all-margin">
                                        <div class="tex-payment">ภาษีถูกหัก ณ ที่จ่าย</div>
                                        <div class="all-gap">
                                            <div class="money" id="cut-vat"></div>
                                            <div class="baht">บาท</div>
                                        </div>
                                    </div>
                                    <div class="all-margin">
                                        <div class="tex-payment">ยอดคงค้าง</div>
                                        <div class="all-gap">
                                            <div class="money" id="cut-paid"></div>
                                            <div class="baht">บาท</div>
                                        </div>
                                    </div>
                                    <div class="all-margin">
                                        <div class="tex-payment">ยอดที่ตัดไปแล้ว</div>
                                        <div class="all-gap">
                                            <div class="money" id=""></div>
                                            <div class="baht">บาท</div>
                                        </div>
                                    </div>
                                    <div class="summery">
                                        <div class="tex-payment-sum">ชำระรวมทั้งสิ้น</div>
                                        <div class="money-baht">
                                            <div class="money-sum" id="cut-total-sum"></div>
                                            <div class="baht-sum">บาท</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- หน้าที่2-->
                        <div id="page2" class="page">
                            <div
                                class="page2-hub">
                                <div class="page2-left">
                                    <div class="depositdeductions"> <!--กล่องของลูกค้าและรหัสลูกค้า-->
                                        <div class="Customer-paymentamount1"><!--กล่องรหัสลูกค้า-->
                                            <div class="paymentamount">จำนวนเงินรับชำระ (บาท)</div>
                                            <!--กล่องข้อรหัสลูกค้า-->
                                            <input class="paymentamount-text" type="number" id="bankPaymentAmount"
                                                placeholder="0000000000000.00"><!--กล่องinputข้อรหัสลูกค้า-->
                                        </div>
                                    </div>
                                    <div style="display: flex;gap: 16px;">
                                        <div class="Customer-payeename"> <!--กล่องลูกค้า-->
                                            <div class="payeename-bank">ธนาคาร</div>
                                            <!--กล่องข้อความลูกค้า-->
                                            <div style="width: 100%;height: 100%;">
                                                <select name="bankDropdown" id="bankDropdown" class="dropdown-new1">
                                                    <option value="">ชื่อธนาคาร</option>
                                                    <option value="option1">ธ.ไทยพาณิชย์</option>
                                                    <option value="option2">ธ.กสิกรไทย</option>
                                                    <option value="option3">ธ.กรุงไทย</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="Customer-paymentamount"><!--กล่องรหัสลูกค้า-->
                                            <div class="paymentamount-bank">เลขบัญชี</div>
                                            <!--กล่องข้อรหัสลูกค้า-->
                                            <input class="paymentamount-text" type="text" id="bankAccountNumber"
                                                placeholder="xxxx-xxxx-xxxx-xxxx"><!--กล่องinputข้อรหัสลูกค้า-->
                                        </div>
                                    </div>
                                    <div class="depositdeductions"> <!--กล่องของลูกค้าและรหัสลูกค้า-->
                                        <div class="deposit-date"> <!--กล่องลูกค้า-->
                                            <div class="payeename-date-bank">วันที่ชำระ</div><!--กล่องข้อความลูกค้า-->
                                            <input class="deposit-date-text" type="date" id="bankPaymentDate"><!--กล่อง input ความลูกค้า-->
                                        </div>
                                        <div class="deposit-time"><!--กล่องรหัสลูกค้า-->
                                            <div class="paymentamount-time-bank">เวลา</div><!--กล่องข้อรหัสลูกค้า-->
                                            <input class="deposit-time-text" type="time" id="bankPaymentTime"
                                                placeholder="0000000000000.00"><!--กล่องinputข้อรหัสลูกค้า-->
                                        </div>
                                    </div>
                                    <div>
                                        <div class="Attach-slip">แนบรูปสลิป</div>
                                        <div class="upload-file-box">
                                            <div class="upload-file-box-in">
                                                <img src="picture/save.png" class="img-save" alt="ไอคอนบันทึก">
                                                <span id="upload-button-text">อัพโหลดไฟล์</span>
                                            </div>
                                        </div>
                                        <input type="file" id="upload-slip" class="hidden-input-file"
                                            accept="image/jpeg,application/pdf">
                                        <div style="display: flex; margin-top: 8px;gap: 8px;">
                                            <div id="file-name-display" class="selected-file-info"></div>
                                            <div id="file-size-display"></div>
                                            <div class="additional-images">
                                                <img src="picture/eye.png" id="image1" alt="รูปภาพเพิ่มเติม 1">
                                                <img src="picture/bin.png" id="image2" alt="รูปภาพเพิ่มเติม 2">
                                            </div>
                                        </div>
                                        <div id="after-selection-message" class="selected-file-info"></div>
                                        <div class="file-detail">(ขนาดไฟล์เอกสาร pdf, jpg ไม่เกิน 40 MB)</div>
                                    </div>
                                </div>
                                <div class="page2-right">
                                    <div style="display: flex; justify-content: space-between;">
                                        <div class="Summary-payment">สรุปยอดรับชำระ</div>
                                    </div>
                                    <div class="all-margin">
                                        <div class="tex-payment">มูลค่ารวมภาษี</div>
                                        <div class="all-gap">
                                            <div class="money" id="cut-total-bank"></div>
                                            <div class="baht">บาท</div>
                                        </div>
                                    </div>
                                    <div class="all-margin">
                                        <div class="tex-payment">ภาษีถูกหัก ณ ที่จ่าย</div>
                                        <div class="all-gap">
                                            <div class="money" id="cut-vat-bank"></div>
                                            <div class="baht">บาท</div>
                                        </div>
                                    </div>
                                    <div class="all-margin">
                                        <div class="tex-payment">ยอดคงค้าง</div>
                                        <div class="all-gap">
                                            <div class="money" id="cut-paid-bank"></div>
                                            <div class="baht">บาท</div>
                                        </div>
                                    </div>
                                    <div class="all-margin">
                                        <div class="tex-payment">ยอดที่ตัดไปแล้ว</div>
                                        <div class="all-gap">
                                            <div class="money" id=""></div>
                                            <div class="baht">บาท</div>
                                        </div>
                                    </div>
                                    <div class="summery">
                                        <div class="tex-payment-sum">ชำระรวมทั้งสิ้น</div>
                                        <div class="money-baht">
                                            <div class="money-sum" id="cut-total-sum-bank"></div>
                                            <div class="baht-sum">บาท</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- หน้าที่3-->
                        <div id="page3" class="page">
                            <div
                                class="page3-hub">
                                <div class="page3-left">
                                    <div class="depositdeductions"> <!--กล่องของลูกค้าและรหัสลูกค้า-->
                                        <div class="Customer-paymentamount1"><!--กล่องรหัสลูกค้า-->
                                            <div class="paymentamount">จำนวนเงินรับชำระ (บาท)</div>
                                            <!--กล่องข้อรหัสลูกค้า-->
                                            <input class="paymentamount-text-qr" type="number"
                                                placeholder="0000000000000.00"><!--กล่องinputข้อรหัสลูกค้า-->
                                        </div>
                                    </div>
                                    <div class="depositdeductions"> <!--กล่องของลูกค้าและรหัสลูกค้า-->
                                        <div class="deposit-date"> <!--กล่องลูกค้า-->
                                            <div class="payeename-date-bank">วันที่ชำระ</div><!--กล่องข้อความลูกค้า-->
                                            <input class="deposit-date-text" type="date"><!--กล่อง input ความลูกค้า-->
                                        </div>
                                        <div class="deposit-time"><!--กล่องรหัสลูกค้า-->
                                            <div class="paymentamount-time-bank">เวลา</div><!--กล่องข้อรหัสลูกค้า-->
                                            <input class="deposit-time-text" type="time"
                                                placeholder="0000000000000.00"><!--กล่องinputข้อรหัสลูกค้า-->
                                        </div>
                                    </div>
                                    <div>
                                        <div class="Attach-slip">แนบรูปสลิป</div>
                                        <div class="upload-file-box">
                                            <div class="upload-file-box-in">
                                                <img src="picture/save.png" class="img-save" alt="ไอคอนบันทึก">
                                                <span id="upload-button-text1">อัพโหลดไฟล์</span>
                                            </div>
                                        </div>
                                        <input type="file" id="upload-slip1" class="hidden-input-file"
                                            accept="image/jpeg,application/pdf">
                                        <div style="display: flex; margin-top: 8px;gap: 8px;">
                                            <div id="file-name-display1" class="selected-file-info1"></div>
                                            <div id="file-size-display1"></div>
                                            <div class="additional-images">
                                                <img src="picture/eye.png" id="image11" data-image-type="eye"
                                                    alt="รูปภาพเพิ่มเติม 1">
                                                <img src="picture/bin.png" id="image21" data-image-type="bin"
                                                    alt="รูปภาพเพิ่มเติม 2">
                                            </div>
                                        </div>
                                        <div id="after-selection-message1" class="selected-file-info"></div>
                                        <div class="file-detail">
                                            (ขนาดไฟล์เอกสาร pdf, jpg ไม่เกิน 40 MB)
                                        </div>
                                    </div>
                                </div>
                                <div class="page3-right">
                                    <div class="all-margin">
                                        <div class="Summary-payment">สรุปยอดรับชำระ</div>
                                    </div>
                                    <div class="all-margin">
                                        <div class="tex-payment">มูลค่ารวมภาษี</div>
                                        <div class="all-gap">
                                            <div class="money">21,400.00</div>
                                            <div class="baht">บาท</div>
                                        </div>
                                    </div>
                                    <div class="all-margin">
                                        <div class="tex-payment">ภาษีถูกหัก ณ ที่จ่าย 1.5%</div>
                                        <div class="all-gap">
                                            <div class="money">300.00</div>
                                            <div class="baht">บาท</div>
                                        </div>
                                    </div>
                                    <div class="all-margin">
                                        <div class="tex-payment">ยอดคงค้าง</div>
                                        <div class="all-gap">
                                            <div class="money">20,000.00</div>
                                            <div class="baht">บาท</div>
                                        </div>
                                    </div>
                                    <div class="all-margin">
                                        <div class="tex-payment">ยอดที่ตัดไปแล้ว</div>
                                        <div class="all-gap">
                                            <div class="money">20,000.00</div>
                                            <div class="baht">บาท</div>
                                        </div>
                                    </div>
                                    <div class="summery">
                                        <div class="tex-payment-sum">ชำระรวมทั้งสิ้น</div>
                                        <div class="money-baht">
                                            <div class="money-sum">21,100.00</div>
                                            <div class="baht-sum">บาท</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- หน้าที่4-->
                        <div id="page4" class="page">
                            <div
                                class="page4-hub">
                                <div class="page4-left">
                                    <div class="depositdeductions"> <!--กล่องของลูกค้าและรหัสลูกค้า-->
                                        <div class="Customer-payeename"> <!--กล่องลูกค้า-->
                                            <div class="payeename">ชื่อผู้ที่สำรองจ่าย</div><!--กล่องข้อความลูกค้า-->
                                            <div style="width: 100%;height: 100%;">
                                                <select name="myDropdown" id="myDropdown" class="dropdown-new1">
                                                    <option value="">ชื่อผู้ที่สำรองจ่าย</option>
                                                    <option value="option1">ชื่อผู้ที่สำรองจ่าย1</option>
                                                    <option value="option2">ชื่อผู้ที่สำรองจ่าย2</option>
                                                    <option value="option3">ชื่อผู้ที่สำรองจ่าย3</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="Customer-paymentamount"><!--กล่องรหัสลูกค้า-->
                                            <div class="paymentamount">จำนวนเงินรับชำระ (บาท)</div>
                                            <!--กล่องข้อรหัสลูกค้า-->
                                            <input class="paymentamount-text" type="number"
                                                placeholder="0000000000000.00"><!--กล่องinputข้อรหัสลูกค้า-->
                                        </div>
                                    </div>
                                    <div class="Description">คำอธิบายช่องทางการเงิน</div>
                                    <textarea class="Description-textarea" placeholder="ระบุหมายเหตุ"></textarea>
                                    <div class="checkbox-container">
                                        <div class="checkbox-item">
                                            <input type="checkbox" name="visits" id="not-show-name"
                                                class="my-checkbox-input">
                                            <label for="not-show-name" class="tex-payment">ตัดมัดจำเรียบร้อย</label>
                                        </div>
                                    </div>
                                    <div class="depositdeductions"> <!--กล่องของลูกค้าและรหัสลูกค้า-->
                                        <div class="deposit-date"> <!--กล่องลูกค้า-->
                                            <div class="payeename">วันที่ชำระ</div><!--กล่องข้อความลูกค้า-->
                                            <input class="deposit-date-text" type="date"><!--กล่อง input ความลูกค้า-->
                                        </div>
                                        <div class="deposit-time"><!--กล่องรหัสลูกค้า-->
                                            <div class="paymentamount">เวลา</div><!--กล่องข้อรหัสลูกค้า-->
                                            <input class="deposit-time-text" type="time"
                                                placeholder="0000000000000.00"><!--กล่องinputข้อรหัสลูกค้า-->
                                        </div>
                                    </div>
                                </div>
                                <div class="page4-right">
                                    <div class="all-margin">
                                        <div class="Summary-payment">สรุปยอดรับชำระ</div>
                                    </div>
                                    <div class="all-margin">
                                        <div class="tex-payment">มูลค่ารวมภาษี</div>
                                        <div class="all-gap">
                                            <div class="money">21,400.00</div>
                                            <div class="baht">บาท</div>
                                        </div>
                                    </div>
                                    <div class="all-margin">
                                        <div class="tex-payment">ภาษีถูกหัก ณ ที่จ่าย 1.5%</div>
                                        <div class="all-gap">
                                            <div class="money">300.00</div>
                                            <div class="baht">บาท</div>
                                        </div>
                                    </div>
                                    <div class="all-margin">
                                        <div class="tex-payment">ยอดคงค้าง</div>
                                        <div  class="all-gap">
                                            <div class="money">20,000.00</div>
                                            <div class="baht">บาท</div>
                                        </div>
                                    </div>
                                    <div class="all-margin">
                                        <div class="tex-payment">ยอดที่ตัดไปแล้ว</div>
                                        <div class="all-gap">
                                            <div class="money">20,000.00</div>
                                            <div class="baht">บาท</div>
                                        </div>
                                    </div>
                                    <div class="summery">
                                        <div class="tex-payment-sum">ชำระรวมทั้งสิ้น</div>
                                        <div class="money-baht">
                                            <div class="money-sum">21,100.00</div>
                                            <div class="baht-sum">บาท</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="box-2" class="my-box">
                        <div class="head-Part-3-Invoice">
                            <div>
                                <div class="tax-slip">ใบกำกับภาษี</div>
                                <div class="Sales-tax-list">รายการภาษีขาย</div>
                            </div>
                            <div class="all-gap">
                                <div>
                                    <div class="Business-Type">ยื่นภาษีรวมในงวดที่</div>
                                    <div class="select-tax">
                                        <select name="taxPeriodDropdown" id="taxPeriodDropdown" class="Business-number" style="color: black;">
                                            <option value="">00/00</option>
                                            <option value="option1">01/01</option>
                                            <option value="option2">02/02</option>
                                            <option value="option3">03/03</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="date-input-wrapper">
                                    <div class="Business-Type">วันที่</div>
                                    <div><input type="date" name="taxDate" id="taxDate" class="date-tax" style="color: black;"></div>
                                </div>
                                <div>
                                    <div class="Business-Type">เลขใบกำกับภาษี</div>
                                    <div class="taxt-tax" ><input type="text" name="taxInvoiceNo" id="taxInvoiceNo" placeholder="AA-0000000000"  ></div>
                                </div>
                            </div>
                        </div>
                        <div
                            class="tax-hub">
                            <div class="tax-hub-left">
                                <div>
                                    <div class="depositdeductions"> <!--กล่องของลูกค้าและรหัสลูกค้า-->
                                        <div class="Customer-payeename"> <!--กล่องลูกค้า-->
                                            <div class="Business-Type">ประเภทธุรกิจ / คำนำหน้า</div>
                                            <!--กล่องข้อความลูกค้า-->
                                            <div class="tax-full">
                                                <select name="businessTypeDropdown" id="businessTypeDropdown" class="dropdown-new1" style="color: black;">
                                                    <option value="">ตัวอย่างข้อความ</option>
                                                    <option value="option1">ตัวอย่างข้อความ1</option>
                                                    <option value="option2">ตัวอย่างข้อความ2</option>
                                                    <option value="option3">ตัวอย่างข้อความ3</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="Customer-paymentamount"><!--กล่องรหัสลูกค้า-->
                                            <div class="Business-Type">ชื่อลูกค้า</div><!--กล่องข้อรหัสลูกค้า-->
                                            <div class="tax-full">
                                                <select name="customerNameDropdown" id="customerNameDropdown" class="dropdown-new2" disabled>
                                                    <option value="">ลูกค้าทดสอบ</option>
                                                    <option value="option1">ตัวเลือกที่ 1</option>
                                                    <option value="option2">ตัวเลือกที่ 2</option>
                                                    <option value="option3">ตัวเลือกที่ 3</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="depositdeductions"> <!--กล่องของลูกค้าและรหัสลูกค้า-->
                                        <div class="Customer-payeename"> <!--กล่องลูกค้า-->
                                            <div class="payeename">แผนก</div><!--กล่องข้อความลูกค้า-->
                                            <div class="tax-full">
                                                <select name="departmentDropdown" id="departmentDropdown" class="dropdown-new1" style="color: black;">
                                                    <option value="">แผนก</option>
                                                    <option value="option1">แผนกจัดซื้อ</option>
                                                    <option value="option2">แผนกขนส่ง</option>
                                                    <option value="option3">แผนกบัญชี</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="Customer-paymentamount"><!--กล่องรหัสลูกค้า-->
                                            <div class="paymentamount">เลขประจำตัวผู้เสียภาษี</div>
                                            <!--กล่องข้อรหัสลูกค้า-->
                                            <div class="tax-full">
                                                <select name="taxIdDropdown" id="taxIdDropdown" class="dropdown-new2" disabled>
                                                    <option value="">0000000000000</option>
                                                    <option value="option1">ตัวเลือกที่ 1</option>
                                                    <option value="option2">ตัวเลือกที่ 2</option>
                                                    <option value="option3">ตัวเลือกที่ 3</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="summery-tax">
                                <div class="all-margin">
                                    <div class="Summary-payment">สรุปภาษี</div>
                                </div>
                                <div class="all-margin">
                                    <div class="tex-payment">ราคาสินค้า / บริการ</div>
                                    <div class="all-gap">
                                        <div class="money" id="tax-product-price">0.00</div>
                                        <div class="baht">บาท</div>
                                    </div>
                                </div>
                                <div class="all-margin">
                                    <div class="tex-payment">จำนวนภาษี</div>
                                    <div class="all-gap">
                                        <div class="money" id="tax-total-amount">0.00</div>
                                        <div class="baht">บาท</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                                            <div class="cancel-save-main">
                            <div class="box-cancel-save">
                                 <a href="create-deposit-receipt-table.html" onclick="setCancelState()"><div class="cancel">ยกเลิก</div></a>
                                <div class="save" id="saveAndGo" onclick="handleSaveQuotation()">บันทึก</div>
                            </div>
                        </div>
                    <!--เพิ่มรายการ-->
                    <div class="popup-container myPopupadd">
                        <div class="popup-content3-add">
                            <div style="width: 100%;">
                                <div class="bold">เพิ่มรายการ</div>
                                <div class="regular">รายละเอียด และจำนวน</div>
                            </div>
                            <div style="width: 100%;">
                                <div class="password-unit-price-unit">
                                    <div class="password-unit-price-unit-box">
                                        <div class="password">
                                            <div class="password-title">รหัส</div>
                                            <div class="password-box">
                                                <div class="addAndHideBtn4">
                                                    <div class="password-box-in">
                                                        <img src="picture/save.png" class="img-save">
                                                        เลือกรหัส
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="unit">
                                            <div class="model-all">
                                                <div class="unit-title">หน่วย</div>
                                                <div class="red-dot">*</div>
                                            </div>
                                            <select class="modal-select" id="unit">
                                                <option selected>เลือกหน่วย</option>
                                                <option>1</option>
                                                <option>2</option>
                                                <option>3</option>
                                            </select>
                                        </div>
                                        <div class="price-unit">
                                            <div class="model-all">
                                                <div class="price-unit-title">ราคา/หน่วย</div>
                                                <div class="red-dot">*</div>
                                            </div>
                                            <input type="number" placeholder="ราคา" class="price-unit-class" id="product-price-unit">
                                        </div>
                                    </div>
                                </div>
                                <div style="width: 100%;height: 65px;">
                                    <div class="model-all-name-add-modal">
                                        <div class="unit-title-add-modal">ชื่อรายการ</div>
                                        <div class="red-dot-name">*</div>
                                    </div>
                                    <div><input type="text" class="input-add" placeholder="ชื่อรายการ" id="product-name">
                                    </div>
                                </div>
                                <div style="width: 100%;height: 148px;">
                                    <div class="model-all-name-add-modal">
                                        <div class="unit-title">รายละเอียด</div>
                                        <div class="red-dot-name">*</div>
                                    </div>
                                    <textarea class="textarea-add-name-gray" placeholder="กรอกรายละเอียด" id="product-desc"></textarea>
                                </div>
                                <hr class="line-modal">
                                <div class="price-all">
                                    <div class="price-unit-view">
                                        <div class="model-all">
                                            <div class="price-unit-title">จำนวน</div>
                                            <div class="red-dot">*</div>
                                        </div>
                                        <input type="number" placeholder="กรอกจำนวน" class="price-unit-class" id="product-qty">
                                    </div>
                                    <div class="price-unit-view">
                                        <div class="model-all">
                                            <div class="price-unit-title">ส่วนลด</div>
                                            <div class="red-dot">*</div>
                                        </div>
                                        <input type="number" placeholder="กรอกส่วนลด" class="price-unit-class" id="product-discount">
                                    </div>
                                    <div class="price-unit-view">
                                        <div class="model-all">
                                            <div class="price-unit-title">ราคารวม</div>
                                        </div>
                                        <input type="text" placeholder="ราคารวม" class="price-unit-class-dis" disabled id="product-total">
                                    </div>
                                </div>
                                <div class="cancel-save-under">
                                    <div class="box-cancel-save">
                                        <div class="cancel cancelPopupBtn4">ยกเลิก</div>
                                        <div id="btnConfirmAdd" class="save cancelPopupBtn4">เพิ่ม</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="popup-container sideadd new-section">
                        <div class="popup-content1-side-popup-add">
                                                       <div style="display: flex;justify-content: space-between;">
                                <div class="bold">ค้นหารหัส</div>
                                <div><input type="search" class="search-pass" placeholder="ค้นหา"></div>
                            </div>
                            <div class="head-of-barsearch" >
                                    <div class="bar-search" style="width: unset; ">
                                        <div class="number-bar">ลำดับ</div>
                                        <div class="pass-bar">รหัส</div>
                                        <div class="name-bar">ชื่อรายการ</div>
                                    </div>
                                    <!-- ข้อมูลจะถูกโหลดจาก API getproduct_bycom -->
                                    <!-- <div id="productSearchResults"> -->
                                        <!-- ข้อมูลสินค้าจะแสดงที่นี่ -->
                                    <!-- </div> -->
                            </div>
                            <div class="under-search">
                                <!-- <div class="under-page">1 of 40 pages</div>
                                <div class="under-page1">1</div>
                                <div class="number-green">2</div>
                                <div class="number-green">3</div>
                                <div class="number-green-dot">...</div>
                                <div class="number-green-40">40</div>
                                <div class="arrow-container"><img src="picture/arrow-right.png" class="arrow"></div> -->
                            </div> 
                            <div class="cancel-save-under">
                                <div class="cancel sideaddCancelBtn">ยกเลิก</div>
                                <div class="save sideaddSaveBtn">เพิ่ม</div>
                            </div>
                        </div>
                    </div>
                    <!--อัปโหลดไฟล์-->
                    <div class="popup-container myPopupupload">
                        <div class="popup-content-edit-sum-upload">
                            <div style="width: 100%;">
                                <div class="bold">อัปโหลดไฟล์</div>
                                <div class="regular">ชื่อไฟล์และไฟล์ที่แนบมาทั้งหมด</div>
                            </div>
                            <div style="display: flex;">
                                <div class="left-modal-upload">
                                    <div class="upload-modal">อัปโหลดไฟล์</div>
                                    <input type="file" id="fileElem" accept="image/*" style="display:none">
                                    
                                    <div class="bg-uplaod" id="uploadBox">
                                        <input type="file" id="fileInput" accept=".pdf,.jpg,.jpeg,.png,.xls,.xlsx,.doc,.docx" multiple style="display: none;">
                                        <div>
                                            <div style="display: flex; justify-content: center;">
                                                <div>
                                                    <img src="picture/upload-gray.png" class="upload-gray">
                                                </div>
                                            </div>
                                            <div class="upload-name">อัพโหลดไฟล์</div>
                                        </div>
                                    </div>
                                    <div class="display-upload">(ขนาดไฟล์เอกสาร pdf, jpg, xls,
                                        doc ไม่เกิน 40 MB / ไฟล์)</div>
                                </div>
                                <div class="right-modal-upload">
                                    <div class="upload-modal">อัปโหลดไฟล์</div>
                                    <div class="x-upload-16" id="fileDisplay" style="margin-top: 10px;">
                                        <div> <input type="text" placeholder="document3.pdf" id="fileNameInput"
                                                class="code-edit-box-sum-edit-dis"></div>
                                        <div class="check-x">
                                            <img src="picture/check-green.png" class="upload-gray">
                                            <img src="picture/x-icon.png" class="upload-gray" id="removeFileBtn">
                                        </div>
                                    </div>
                                    <div class="head-x-upload-doc" id="confirmedFilesDisplay">
                                        <!-- ไฟล์ที่ยืนยันแล้วจะแสดงที่นี่ -->
                                        </div>
                                    <!-- <div class="x-upload-doc">
                                        <div class="doc-upload">
                                            <div class="doc-name">image_sell01.jpg</div>
                                            <div class="MB-upload">(5 MB)</div>
                                        </div>
                                        <div class="check-x">
                                            <img src="picture/eye.png" class="upload-gray">
                                            <img src="picture/pen.png" class="upload-gray">
                                            <img src="picture/bin.png" class="upload-gray">
                                        </div>
                                    </div>
                                    <div class="x-upload-doc">
                                        <div class="doc-upload">
                                            <div class="doc-name">document2.pdf</div>
                                            <div class="MB-upload">(32 MB)</div>
                                        </div>
                                        <div class="check-x">
                                            <img src="picture/eye.png" class="upload-gray">
                                            <img src="picture/pen.png" class="upload-gray">
                                            <img src="picture/bin.png" class="upload-gray">
                                        </div>
                                    </div> -->
                                </div>
                            </div>
                            <div class="cancel-save-under">
                                <div class="box-cancel-save">
                                    <div class="cancel cancelPopupBtn">ยกเลิก</div>
                                    <div class="save addAndHideBtn">อัปโหลด</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!--เลือกใบจ่ายมัดจำ-->
                    <div class="popup-container myPopupdeposit">
                        <div class="popup-content1-side-popup-search">
                            <div class="head-bar-search">
                                <div class="bold">ค้นหาใบจ่ายมัดจำ</div>
                                <div><input type="search" class="search-pass-long" placeholder="ค้นหา"></div>
                            </div>
                            <div class="head-of-barsearch">
                            <div class="bar-search-long">
                                <div class="number-bar-long">ลำดับ</div>
                                <div class="pass-bar-long">รหัส</div>
                                <div class="name-bar-long">ชื่อรายการ</div>
                                <div class="price-bar-long">ราคารวม</div>
                                <div class="none-bar"></div>
                            </div>
                            <div class="data-search-long">
                                <div class="number-search">1</div>
                                <div class="code-search">AI-202501130001</div>
                                <div class="name-search-long">Software พื้นที่จัดเก็บข้อมูล พร้อมติดตั้งและจัดอบรม</div>
                                <div class="price-search-long">43,100.00</div>
                                <div class="eye-container"><img src="picture/eye.png" class="eye-search"></div>
                            </div>
                            <div class="data-search-long">
                                <div class="number-search">2</div>
                                <div class="code-search">AI-202501120001</div>
                                <div class="name-search-long">ทดสอบ1</div>
                                <div class="price-search-long">1,111,111,100.00</div>
                                <div class="eye-container"><img src="picture/eye.png" class="eye-search"></div>
                            </div>
                            <div class="data-search-long">
                                <div class="number-search">3</div>
                                <div class="code-search">AI-202501110001</div>
                                <div class="name-search-long">ทดสอบ2</div>
                                <div class="price-search-long">11,100.00</div>
                                <div class="eye-container"><img src="picture/eye.png" class="eye-search"></div>
                            </div>
                            <div class="data-search-long">
                                <div class="number-search">4</div>
                                <div class="code-search">AI-202501100001</div>
                                <div class="name-search-long">ทดสอบ3</div>
                                <div class="price-search-long">11,100.00</div>
                                <div class="eye-container"><img src="picture/eye.png" class="eye-search"></div>
                            </div>
                            <div class="data-search-long">
                                <div class="number-search">5</div>
                                <div class="code-search">AI-202501110002</div>
                                <div class="name-search-long">ทดสอบ4</div>
                                <div class="price-search-long">11,100.00</div>
                                <div class="eye-container"><img src="picture/eye.png" class="eye-search"></div>
                            </div>
                            <div class="data-search-long">
                                <div class="number-search">6</div>
                                <div class="code-search">AI-202501090001</div>
                                <div class="name-search-long">ทดสอบ5</div>
                                <div class="price-search-long">11,100.00</div>
                                <div class="eye-container"><img src="picture/eye.png" class="eye-search"></div>
                            </div>
                            <div class="data-search-long">
                                <div class="number-search">7</div>
                                <div class="code-search">AI-202501080001</div>
                                <div class="name-search-long">ทดสอบ6</div>
                                <div class="price-search-long">11,100.00</div>
                                <div class="eye-container"><img src="picture/eye.png" class="eye-search"></div>
                            </div>
                            <div class="data-search-long">
                                <div class="number-search">8</div>
                                <div class="code-search">AI-202501070001</div>
                                <div class="name-search-long">ทดสอบ7</div>
                                <div class="price-search-long">11,100.00</div>
                                <div class="eye-container"><img src="picture/eye.png" class="eye-search"></div>
                            </div>
                            <div class="data-search-long">
                                <div class="number-search">9</div>
                                <div class="code-search">AI-202501060001</div>
                                <div class="name-search-long">ทดสอบ8</div>
                                <div class="price-search-long">11,100.00</div>
                                <div class="eye-container"><img src="picture/eye.png" class="eye-search"></div>
                            </div>
                            <div class="data-search-long">
                                <div class="number-search">10</div>
                                <div class="code-search">AI-202501050001</div>
                                <div class="name-search-long">ทดสอบ9</div>
                                <div class="price-search-long">11,100.00</div>
                                <div class="eye-container"><img src="picture/eye.png" class="eye-search"></div>
                            </div>
                            </div>
                            <div class="under-search-long">
                                <div class="under-page">1 of 40 pages</div>
                                <div class="under-page1">1</div>
                                <div class="number-green">2</div>
                                <div class="number-green">3</div>
                                <div class="number-green-dot">...</div>
                                <div class="number-green-40">40</div>
                                <div class="arrow-container"><img src="picture/arrow-right.png" class="arrow"></div>
                            </div>
                            <div class="cancel-save-under">
                                <div class="cancel cancelPopupBtn6">ยกเลิก</div>
                                <div class="save addAndHideBtn6">เพิ่ม</div>
                            </div>
                        </div>
                    </div>
                    <!--เพิ่มรายการชำระ-->
                    <div class="popup-container myPopupadddate">
                        <div class="popup-content-adddate">
                            <div style="width: 100%;">
                                <div class="bold">เพิ่มรายการ</div>
                                <div class="regular-nomarginbottom">รายละเอียด และจำนวน</div>
                            </div>
                            <div style="width: 100%;height: 65px;">
                                <div class="model-all-name-add-modal">
                                    <div class="unit-title-add-modal">เลขที่ใบเสร็จ</div>
                                </div>
                                <div><input type="text" class="input-add-modal-gray" placeholder="กรอกเลขที่ใบเสร็จ"></div>
                            </div>
                            <div style="width: 100%;height: 65px;">
                                <div class="model-all-name-add-modal">
                                    <div class="unit-title-add-modal">ชื่อรายการ</div>
                                </div>
                                <div><input type="text" class="input-add-modal-gray" placeholder="กรอกชื่อรายการ"></div>
                            </div>
                            <div class="date-box-modal">
                                <div>
                                    <div class="bold-16">วันที่</div>
                                    <div><input type="date" class="date-modal"></div>
                                </div>
                                <div>
                                    <div class="bold-16">วันที่รับชำระ</div>
                                    <div><input type="date" class="date-modal"></div>
                                </div>
                                <div>
                                    <div class="bold-16">วันที่เรียบร้อย</div>
                                    <div><input type="date" class="date-modal"></div>
                                </div>
                            </div>
                            <hr class="line-modal">
                            <div class="price-all">
                                <div class="price-unit">
                                    <div class="model-all">
                                        <div class="price-unit-title">ราคารวม</div>
                                    </div>
                                    <input type="number" placeholder="กรอกจำนวน" class="price-unit-class">
                                </div>
                            </div>
                            <div class="cancel-save-under">
                                <div class="box-cancel-save">
                                    <div class="cancel cancelPopupBtn7">ยกเลิก</div>
                                    <div class="save addAndHideBtn7">เพิ่ม</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!--eye-->
                    <!-- กล่องดูรายการมัดจำ -->
                        <div class="popup-container  myPopupview">
                            <div class="popup-content-modal-view">
                                <div style="width: 100%;">
                                    <div class="bold">รายการ</div>
                                </div>
                                <div style="width: 100%;">
                                    <div class="password-unit-price-unit">
                                        <div class="price-all">
                                        <div class="price-unit">
                                            <div class="model-all">
                                                <div class="password-title-view">เอกสารที่ตัด</div>
                                            </div>
                                            <div class="password-box-title-box" id="codesheet" >SO-202501100001</div>
                                        </div>
                                        <div class="price-unit">
                                            <div class="model-all">
                                                <div class="password-title-view"></div>
                                            </div>
                                            <div class="password-box-title-box"></div>
                                        </div>
                                        <div class="price-unit">
                                            <div class="model-all">
                                                <div class="password-title-view"></div>
                                            </div>
                                            <div class="password-box-title-box"></div>
                                        </div>
                                    </div>
                                        
                                    </div>
                                    <div style="width: 100%;height: 65px;">
                                        <div class="model-all-name">
                                            <div class="password-title-view">ชื่อรายการ</div>
                                        </div>
                                        <div class="password-box-title" id="namesheet">ระบบจัดเก็บข้อมูลภายในสำนักงาน</div>
                                    </div>
                                    <div style="width: 100%;">
                                        <div class="model-all-name">
                                            <div class="password-title-view">รายละเอียด</div>
                                        </div>
                                        <div class="password-box-title-long" id="detailsheet">รับเงินมัดจำล่วงหน้า
                                        </div>
                                    </div>
                                    <hr class="line-modal">
                                    <div class="price-all">
                                        <div class="price-unit">
                                            <div class="model-all">
                                                <div class="password-title-view">ราคามัดจำ</div>
                                            </div>
                                            <div class="password-box-title-box" id="moneysheet" >20,000.00</div>
                                        </div>
                                        <div class="price-unit">
                                            <div class="model-all">
                                                <div class="password-title-view">ยอดหลังหักส่วนลด</div>
                                            </div>
                                            <div class="password-box-title-box" id="maneybacksheet">43,100.00</div>
                                        </div>
                                        <div class="price-unit">
                                            <div class="model-all">
                                                <div class="password-title-view"></div>
                                            </div>
                                            <div class="password-box-title-box"></div>
                                        </div>
                                    </div>
                                    <div class="cancel-save-under">
                                        <div class="box-cancel-save">
                                            <div class="save cancelPopupBtn3">กลับ</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    <!-- <div class="popup-container  myPopupview">
                        <div class="popup-content-popup-view">
            <div style="width: 100%;">
                <div class="bold">รายการ</div>
            </div>
            <div style="width: 100%;">
                <div class="password-unit-price-unit">
                    <div class="price-all">
                    <div class="price-unit">
                        <div class="model-all">
                            <div class="password-title-view">รหัส</div>
                        </div>
                        <div class="password-box-title-box" id="codesheet">AA-12340000</div>
                    </div>
                    <div class="price-unit">
                        <div class="model-all">
                            <div class="password-title-view">หน่วย</div>
                        </div>
                        <div class="password-box-title-box" id="unitsheet">รายการ</div>
                    </div>
                    <div class="price-unit">
                        <div class="model-all">
                            <div class="password-title-view">ราคา/หน่วย</div>
                        </div>
                        <div class="password-box-title-box" id="moneysheet">43,200.00</div>
                    </div>
                </div>
                    
                </div>
                <div style="width: 100%;height: 65px;">
                    <div class="model-all-name">
                        <div class="password-title-view">ชื่อรายการ</div>
                    </div>
                    <div class="password-box-title" id="namesheet">ระบบจัดเก็บข้อมูลภายในสำนักงาน</div>
                </div>
                <div style="width: 100%;">
                    <div class="model-all-name">
                        <div class="password-title-view">รายละเอียด</div>
                    </div>
                    <div class="password-box-title-long" id="detailsheet">ปุ่มแตะบัตรสมาชิกให้ได้รับค่าแค่การแต่บัตร
                        ไม่รับค่าจากการพิมพ์(ห้ามพิมพ์) (ต้องนำเสนอ Solution
                        เนื่องจากตัวอ่านไม่สามารถตรวจจับแยกประเภท Hardware ได้ ต้องปรับเพื่อให้ได้ ผลลัพธ์ใกล้เคียง)
                        <br>-กรณี Pop up รับค่าเลขที่บัตร และให้ปิดตัวลงหลังจาก x วินาทีเพื่อไม่ให้ได้รับค่าจาก Keyboard
                        เพ่อป้องกัน โดยสามารถ comfig เวลารับของ pop upได้
                        <br>-สามารถ Config การล็อกเวลา ให้คีย์ภายในกี่วินาทีก่อน pop upในการรับปิดไป (ตั้ง Delay Time
                        out)
                    </div>

                </div>


                <hr class="line-modal">


                <div class="price-all">
                    <div class="price-unit">
                        <div class="model-all">
                            <div class="password-title-view">จำนวน</div>
                        </div>
                        <div class="password-box-title-box" id="quantitysheet">1</div>
                    </div>
                    <div class="price-unit">
                        <div class="model-all">
                            <div class="password-title-view">ส่วนลด</div>
                        </div>
                        <div class="password-box-title-box" id="discountsheet">100.00</div>
                    </div>
                    <div class="price-unit">
                        <div class="model-all">
                            <div class="password-title-view">ราคารวม</div>
                        </div>
                        <div class="password-box-title-box" id="totalsheet">43,100.00</div>
                    </div>
                </div>
                <div class="cancel-save-under">
                    <div class="box-cancel-save">
                        <div class="save cancelPopupBtn3">กลับ</div>
                    </div>
                </div>
            </div>
        </div>
                    </div> -->
                    <!--eye-under-->
                    <div class="popup-container myPopupviewdate">
                        <div class="popup-content-modal-view">
                            <div style="width: 100%;">
                                <div class="bold">รายการ</div>
                            </div>
                            <div style="width: 100%;">
                                <div class="password-unit-price-unit">
                                    <div class="password-unit-price-unit-box-view">
                                        <div class="password-view">
                                            <div class="password-title-view">เลขที่ใบเสร็จ</div>
                                            <div class="password-box">
                                                <div class="password-box-title">11-1234000067</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div style="width: 100%;height: 65px;">
                                    <div class="model-all-name">
                                        <div class="password-title-view">ชื่อรายการ</div>
                                    </div>
                                    <div class="password-box-title">ระบบจัดเก็บข้อมูลภายในสำนักงาน</div>
                                </div>
                                <div class="date-box-modal-view">
                                    <div class="date-box-view-modal">
                                        <div class="password-title-view">วันที่</div>
                                        <div class="password-box-title">30/01/2025</div>
                                    </div>
                                    <div class="date-box-view-modal">
                                        <div class="password-title-view">วันที่รับชำระ</div>
                                        <div class="password-box-title">30/01/2025</div>
                                    </div>
                                    <div class="date-box-view-modal">
                                        <div class="password-title-view">วันที่เรียบร้อย</div>
                                        <div class="password-box-title">30/01/2025</div>
                                    </div>
                                </div>
                                <hr class="line-modal">
                                <div class="price-unit">
                                    <div class="model-all">
                                        <div class="password-title-view">ราคา/หน่วย</div>
                                    </div>
                                    <div class="password-box-title-box">43,100.00</div>
                                </div>
                                <div class="cancel-save-under">
                                    <div class="box-cancel-save">
                                        <div class="save cancelPopupBtn8">กลับ</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!--pen-->
                    <div class="popup-container myPopuppenview">
                        <div class="popup-content3-add">
                            <div style="width: 100%;">
                                <div class="bold">แก้ไขรายการ</div>
                                <div class="regular">รายละเอียด และจำนวน</div>
                            </div>
                            <div style="width: 100%;">
                                <div class="password-unit-price-unit">
                                    <div class="password-unit-price-unit-box">
                                        <div class="password">
                                            <div class="password-title">เอกสารที่ตัด</div>
                                            <div class="password-box">
                                                <input type="text" class="code-edit-box" placeholder="SO-202501100001" >
                                            </div>
                                        </div>
                                        <div class="unit">
                                            <div class="model-all">
                                                <div class="unit-title">หน่วย</div>
                                                <div class="red-dot">*</div>
                                            </div>
                                            <select class="modal-select-black" >
                                                <option selected>รายการ</option>
                                                <option>1</option>
                                                <option>2</option>
                                                <option>3</option>
                                            </select>
                                        </div>
                                        <div class="price-unit">
                                            <div class="model-all">
                                                <div class="price-unit-title">ราคา/หน่วย</div>
                                                <div class="red-dot">*</div>
                                            </div>
                                            <input type="number" placeholder="43,200.00" class="price-unit-class-black">
                                        </div>
                                    </div>
                                </div>
                                <div style="width: 100%;height: 65px;">
                                    <div class="model-all-name-add-modal">
                                        <div class="unit-title-add-modal">ชื่อรายการ</div>
                                    </div>
                                    <div><input type="text" class="input-add-name"
                                            placeholder="ระบบจัดเก็บข้อมูลภายในสำนักงาน" disabled></div>
                                </div>
                                <div style="width: 100%;height: 146px;">
                                    <div class="model-all-name">
                                        <div class="unit-title-add-modal">รายละเอียด</div>
                                        <div class="red-dot-name">*</div>
                                    </div>
                                    <textarea class="textarea-add-name-new"
                                        placeholder="Software พื้นที่จัดเก็บข้อมูล พร้อมติดตั้งและจัดอบรม" ></textarea>
                                </div>
                                <hr class="line-modal">
                                <div class="price-all">
                                    <div class="price-unit">
                                        <div class="model-all">
                                            <div class="price-unit-title">จำนวน</div>
                                            <div class="red-dot">*</div>
                                        </div>
                                        <input type="number" placeholder="1" class="price-unit-class-number" id="editsetsheet">
                                    </div>
                                    <div class="price-unit">
                                        <div class="model-all">
                                            <div class="price-unit-title">ส่วนลด</div>
                                            <div class="red-dot">*</div>
                                        </div>
                                        <input type="number" placeholder="100.00" class="price-unit-class-black" id="editdiscountsheet">
                                    </div>
                                    <div class="price-unit">
                                        <div class="model-all">
                                            <div class="price-unit-title">ราคารวม</div>
                                        </div>
                                        <input type="text" placeholder="43,100.00" class="price-unit-class-dis-black"
                                            disabled id="editmoneygroupsheet">
                                    </div>
                                </div>
                                <div class="cancel-save-under">
                                    <div class="box-cancel-save">
                                        <div class="cancel cancelPopupBtn2">ยกเลิก</div>
                                        <div class="save addAndHideBtn2">เพิ่ม</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!--pen-under-->
                    <div class="popup-container myPopupaddsum">
                        <div class="popup-content-modal-pen-view">
                            <div style="width: 100%;">
                                <div class="bold">เพิ่มรายการ</div>
                                <div class="regular-nomarginbottom">รายละเอียด และจำนวน</div>
                            </div>
                            <div style="width: 100%;height: 65px;">
                                <div class="model-all-name-add-modal">
                                    <div class="unit-title-add-modal">เลขที่ใบเสร็จ</div>
                                </div>
                                <div><input type="text" class="input-add-modal-black" placeholder="11-1234000067"></div>
                            </div>
                            <div style="width: 100%;height: 65px;">
                                <div class="model-all-name-add-modal">
                                    <div class="unit-title-add-modal">ชื่อรายการ</div>
                                </div>
                                <div><input type="text" class="input-add-modal-black"
                                        placeholder="ระบบจัดเก็บข้อมูลภายในสำนักงาน">
                                </div>
                            </div>
                            <div class="date-box-modal">
                                <div>
                                    <div class="bold-16">วันที่</div>
                                    <div><input type="date" class="date-modal"></div>
                                </div>
                                <div>
                                    <div class="bold-16">วันที่รับชำระ</div>
                                    <div><input type="date" class="date-modal"></div>
                                </div>
                                <div>
                                    <div class="bold-16">วันที่เรียบร้อย</div>
                                    <div><input type="date" class="date-modal"></div>
                                </div>
                            </div>
                            <hr class="line-modal">
                            <div class="price-all">
                                <div class="price-unit">
                                    <div class="model-all">
                                        <div class="price-unit-title">ราคารวม</div>
                                    </div>
                                    <input type="number" placeholder="43,100.00" class="input-add-modal-black">
                                </div>
                            </div>
                            <div class="cancel-save-under">
                                <div class="box-cancel-save">
                                    <div class="cancel cancelPopupBtn9">ยกเลิก</div>
                                    <div class="save addAndHideBtn9">เพิ่ม</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!--editpen-->
                    <div class="popup-container myPopupeditpen">
                        <div class="popup-content-edit-sum">
                            <div style="width: 100%;">
                                <div class="bold">แก้ไขมูลค่าสุทธิ</div>
                                <div class="regular">จำนวนเงิน</div>
                            </div>
                            <div>
                                <div class="three-box-sum-modal">
                                    <div>
                                        <div class="bold-16-nomargin">จำนวนเงิน</div>
                                        <div class="number-modal-three" id="display-actual-payment">43,200.00</div>
                                    </div>
                                    <div>
                                        <div class="bold-16-nomargin">ยอดชำระจริง</div>
                                        <div class="number-modal-three" id="display-total-amount">43,200.00</div>
                                    </div>
                                    <div>
                                        <div class="bold-16-nomargin">ยอดหลังหักส่วนลด</div>
                                        <div class="number-modal-three" id="display-after-discount">43,100.00</div>
                                    </div>
                                </div>
                                <hr class="line-modal">
                                <div class="model-all-name-sum ">
                                    <div class="regular-sum">จำนวนภาษี</div>
                                </div>
                                
                                <div style="display: flex; gap: 16px;">
                                    <div>
                                    <div class="password-title">ภาษีมูลค่าเพิ่ม 7%</div>
                                    <input type="text" class="code-edit-box-sum" placeholder="0000.00" disabled id="display-vat7"></div>
                                    <div>
                                    <div class="password-title">เพิ่มใหม่</div>
                                    <input type="text" class="code-edit-box-sum-2" placeholder="0.00" id="delete-vat"></div>
                                </div>
                                <!-- <div class="checkbox-list-box-sum">
                                    <div class="edit-sum">
                                        <div class="checkbox-item">
                                            <input type="checkbox" name="visits" id="edit-select-table-1"
                                                class="checkbox-table-input">
                                        </div>
                                        <label for="list-tax-data-modal1">รายการที่ 1:
                                            ระบบจัดเก็บข้อมูลภายในสำนักงาน</label>
                                    </div>
                                    <div><input type="text" placeholder="3,017.00" class="code-edit-box-sum-edit"></div>
                                </div>
                                <div class="checkbox-list-box-sum">
                                    <div class="edit-sum">
                                        <div class="checkbox-item">
                                            <input type="checkbox" name="visits" id="edit-select-table-2"
                                                class="checkbox-table-input">
                                        </div>
                                        <label for="list-tax-data-modal2">รายการที่ 2: ทดสอบ1</label>
                                    </div>
                                    <div><input type="text" placeholder="0000.00" class="code-edit-box-sum-edit-dis">
                                    </div>
                                </div>
                                <div class="checkbox-list-box-sum">
                                    <div class="edit-sum">
                                        <div class="checkbox-item">
                                            <input type="checkbox" name="visits" id="edit-select-table-3"
                                                class="checkbox-table-input">
                                        </div>
                                        <label for="list-tax-data-modal3">รายการที่ 3: ทดสอบ1</label>
                                    </div>
                                    <div><input type="text" placeholder="300.00" class="code-edit-box-sum-edit"></div>
                                </div>
                                <div class="checkbox-list-box-sum">
                                    <div class="edit-sum">
                                        <div class="checkbox-item">
                                            <input type="checkbox" name="visits" id="edit-select-table-4"
                                                class="checkbox-table-input">
                                        </div>
                                        <label for="list-tax-data-modal4">รายการที่ 4: ทดสอบ1</label>
                                    </div>
                                    <div><input type="text" placeholder="0000.00" class="code-edit-box-sum-edit-dis">
                                    </div>
                                </div>
                                <div class="checkbox-list-box-sum">
                                    <div class="edit-sum">
                                        <div class="checkbox-item">
                                            <input type="checkbox" name="visits" id="edit-select-table-5"
                                                class="checkbox-table-input">
                                        </div>
                                        <label for="list-tax-data-modal5">รายการที่ 5: ทดสอบ1</label>
                                    </div>
                                    <div><input type="text" placeholder="0000.00" class="code-edit-box-sum-edit-dis">
                                    </div>
                                </div>
                            </div> -->
                            <!-- ส่วนแสดงรายการสินค้าในรูปแบบ checkbox list -->
                            <div id="product-checkbox-list">
                                <!-- ข้อมูลจะถูกเพิ่มโดย JavaScript -->
                            </div>
                            <div class="under-search-sum-edit" style="display: none;">
                                <div class="under-page">1 of 40 pages</div>
                                <div class="under-page1">1</div>
                                <div class="number-green">2</div>
                                <div class="number-green">3</div>
                                <div class="number-green-dot">...</div>
                                <div class="number-green-40">40</div>
                                <div class="arrow-container"><img src="picture/arrow-right.png" class="arrow"></div>
                            </div>
                            <div class="all-tax-under">
                                <div class="left">
                                    <div class="password-title">ภาษีหัก ณ ที่จ่าย</div>
                                    <div><input id="unit-items2" type="text" placeholder="0000.00" class="code-edit-box-sum" disabled>
                                    </div>
                                </div>
                                <div class="right">
                                    <div class="password-title">%</div>
                                    <div>
                                        <input type="number" placeholder="0.00" class="code-edit-box-sum-2" id="tax_withheld">
                                    </div>
                                </div>
                            </div>
                            <div id="product-checkbox-list2">
                                <!-- ข้อมูลจะถูกเพิ่มโดย JavaScript -->
                            </div>
                            <div class="under-search-sum-edit-2" style="display: none;">
                                <div class="under-page">1 of 40 pages</div>
                                <div class="under-page1">1</div>
                                <div class="number-green">2</div>
                                <div class="number-green">3</div>
                                <div class="number-green-dot">...</div>
                                <div class="number-green-40">40</div>
                                <div class="arrow-container"><img src="picture/arrow-right.png" class="arrow"></div>
                            </div>

                            <!-- ฟอร์มภาษีหัก ณ ที่จ่าย 2 (ซ่อนอยู่) -->
                            <div id="tax-withheld-form-2" style="display: none; margin-top: 16px;">
                                <div class="all-tax-under">
                                    <div class="left">
                                        <div class="password-title">ภาษีหัก ณ ที่จ่าย</div>
                                        <div><input id="unit-items3" type="text" placeholder="0000.00" class="code-edit-box-sum" disabled>
                                        </div>
                                    </div>
                                    <div class="right">
                                        <div class="password-title">%</div>
                                        <div>
                                            <input type="number" placeholder="0.00" class="code-edit-box-sum-2" id="tax_withheld2">
                                        </div>
                                    </div>
                                    <div style="width: 100%; display: flex; justify-content: end; align-items: center;">
                                        <div onclick="removeTaxForm2()" style="height: 27px;"><img src="picture/bin.png" style="cursor: pointer; width: 16px; height: 16px;" ></div>
                                    </div>
                                </div>
                                <div id="product-checkbox-list3">
                                    <!-- ข้อมูลจะถูกเพิ่มโดย JavaScript -->
                                </div>
                                <div class="under-search-sum-edit-3" style="display: none;">
                                    <div class="under-page">1 of 40 pages</div>
                                    <div class="under-page1">1</div>
                                    <div class="number-green">2</div>
                                    <div class="number-green">3</div>
                                    <div class="number-green-dot">...</div>
                                    <div class="number-green-40">40</div>
                                    <div class="arrow-container"><img src="picture/arrow-right.png" class="arrow"></div>
                                </div>
                            </div>

                            <!-- ฟอร์มภาษีหัก ณ ที่จ่าย 3 (ซ่อนอยู่) -->
                            <div id="tax-withheld-form-3" style="display: none; margin-top: 16px;">
                                <div class="all-tax-under">
                                    <div class="left">
                                        <div class="password-title">ภาษีหัก ณ ที่จ่าย</div>
                                        <div><input id="unit-items4" type="text" placeholder="0000.00" class="code-edit-box-sum" disabled>
                                        </div>
                                    </div>
                                    <div class="right">
                                        <div class="password-title">%</div>
                                        <div>
                                            <input type="number" placeholder="0.00" class="code-edit-box-sum-2" id="tax_withheld3">
                                        </div>
                                    </div>
                                    <div style="width: 100%; display: flex; justify-content: end; align-items: center;">
                                        <div onclick="removeTaxForm3()" style="height: 27px;"><img src="picture/bin.png" style="cursor: pointer; width: 16px; height: 16px;" ></div>
                                    </div>
                                </div>
                                <div id="product-checkbox-list4">
                                    <!-- ข้อมูลจะถูกเพิ่มโดย JavaScript -->
                                </div>
                                <div class="under-search-sum-edit-4" style="display: none;">
                                    <div class="under-page">1 of 40 pages</div>
                                    <div class="under-page1">1</div>
                                    <div class="number-green">2</div>
                                    <div class="number-green">3</div>
                                    <div class="number-green-dot">...</div>
                                    <div class="number-green-40">40</div>
                                    <div class="arrow-container"><img src="picture/arrow-right.png" class="arrow"></div>
                                </div>
                            </div>
                            
                            <!--เพิ่มภาษีหัก ณ ที่จ่าย-->
                            <div style="display: flex; justify-content: center;align-items: center; height: 40px; margin-top: 16px">
                                <div id="add-tax-withheld-btn" style="background: #425C59; display: flex; height: 100%; justify-content: center; align-items: center; width: 189px; border-radius: 8px; gap: 8px; cursor: pointer;" onclick="toggleTaxWithheldForm()">
                                    <img src="picture/plus.png" style="width: 16px; height: 16px;">
                                    <div style="font-weight: 700; font-size: 12px; color: #FFFFFF;">เพิ่มภาษีหัก ณ ที่จ่าย</div>
                                </div>
                            </div>
                    
                            <div class="sum-under-total">
                                <div class="name-sum-total">จำนวนเงินรวมทั้งสิ้น</div>
                                <div class="money-baht">
                                    <div class="money-sum-total" id="display-total-amount">46,117.00</div>
                                    <div class="baht-sum-total">บาท</div>
                                </div>
                            </div>
                            <div class="cancel-save-under">
                                <div class="box-cancel-save">
                                    <div class="cancel cancelPopupBtn5">ยกเลิก</div>
                                    <div class="save cancelPopupBtn5">เพิ่ม</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!--ใบสั่งขาย-->
                    <div class="popup-container myPopupsalesorder">
                        <div class="popup-content1-side-popup-search">
                            <div class="head-bar-search">
                                <div class="bold">ค้นหาใบสั่งขาย</div>
                                <div><input type="search" class="search-pass-long" placeholder="ค้นหา" id="productSearchInput2" onkeyup="searchProducts2()"></div>
                            </div>
                            <div class="head-of-barsearch">
                            <div class="bar-search-long">
                                <div class="number-bar-long">ลำดับ</div>
                                <div class="pass-bar-long">รหัส</div>
                                <div class="name-bar-long">ชื่อรายการ</div>
                                <div class="price-bar-long">ราคารวม</div>
                                <div class="none-bar"></div>
                            </div>
                            <div id="productSearchResults2">
                                <!-- ข้อมูลสินค้าจะแสดงที่นี่ -->
                            </div>
                            <!-- <div class="data-search-long">
                                <div class="number-search">1</div>
                                <div class="code-search">AI-202501130001</div>
                                <div class="name-search-long">Software พื้นที่จัดเก็บข้อมูล พร้อมติดตั้งและจัดอบรม</div>
                                <div class="price-search-long">43,100.00</div>
                                <div class="eye-container"><img src="picture/eye.png" class="eye-search"></div>
                            </div>
                            <div class="data-search-long">
                                <div class="number-search">2</div>
                                <div class="code-search">AI-202501120001</div>
                                <div class="name-search-long">ทดสอบ1</div>
                                <div class="price-search-long">1,111,111,100.00</div>
                                <div class="eye-container"><img src="picture/eye.png" class="eye-search"></div>
                            </div>
                            <div class="data-search-long">
                                <div class="number-search">3</div>
                                <div class="code-search">AI-202501110001</div>
                                <div class="name-search-long">ทดสอบ2</div>
                                <div class="price-search-long">11,100.00</div>
                                <div class="eye-container"><img src="picture/eye.png" class="eye-search"></div>
                            </div>
                            <div class="data-search-long">
                                <div class="number-search">4</div>
                                <div class="code-search">AI-202501100001</div>
                                <div class="name-search-long">ทดสอบ3</div>
                                <div class="price-search-long">11,100.00</div>
                                <div class="eye-container"><img src="picture/eye.png" class="eye-search"></div>
                            </div>
                            <div class="data-search-long">
                                <div class="number-search">5</div>
                                <div class="code-search">AI-202501110002</div>
                                <div class="name-search-long">ทดสอบ4</div>
                                <div class="price-search-long">11,100.00</div>
                                <div class="eye-container"><img src="picture/eye.png" class="eye-search"></div>
                            </div>
                            <div class="data-search-long">
                                <div class="number-search">6</div>
                                <div class="code-search">AI-202501090001</div>
                                <div class="name-search-long">ทดสอบ5</div>
                                <div class="price-search-long">11,100.00</div>
                                <div class="eye-container"><img src="picture/eye.png" class="eye-search"></div>
                            </div>
                            <div class="data-search-long">
                                <div class="number-search">7</div>
                                <div class="code-search">AI-202501080001</div>
                                <div class="name-search-long">ทดสอบ6</div>
                                <div class="price-search-long">11,100.00</div>
                                <div class="eye-container"><img src="picture/eye.png" class="eye-search"></div>
                            </div>
                            <div class="data-search-long">
                                <div class="number-search">8</div>
                                <div class="code-search">AI-202501070001</div>
                                <div class="name-search-long">ทดสอบ7</div>
                                <div class="price-search-long">11,100.00</div>
                                <div class="eye-container"><img src="picture/eye.png" class="eye-search"></div>
                            </div>
                            <div class="data-search-long">
                                <div class="number-search">9</div>
                                <div class="code-search">AI-202501060001</div>
                                <div class="name-search-long">ทดสอบ8</div>
                                <div class="price-search-long">11,100.00</div>
                                <div class="eye-container"><img src="picture/eye.png" class="eye-search"></div>
                            </div>
                            <div class="data-search-long">
                                <div class="number-search">10</div>
                                <div class="code-search">AI-202501050001</div>
                                <div class="name-search-long">ทดสอบ9</div>
                                <div class="price-search-long">11,100.00</div>
                                <div class="eye-container"><img src="picture/eye.png" class="eye-search"></div>
                            </div> -->
                            </div>
                            <!-- Pagination -->
                            <div class="top-pagination" id="paginationBox1" style="display: none;">
                            <div class="pagination">
                                <span class="page-info" id="pageInfo1"><!--1 of 1 pages--></span>
                            <div class="hedad-of-pagination">
                                    <div class="pagination-nav">
                                        <div class="btn-prev" id="btnPrev1" disabled style="display: none; height: 27px;display: flex;align-items: center;justify-content: center;">
                                            <img src="picture/arrow-left.png" alt="ก่อนหน้า" style="width: 16px; height: 16px; cursor: pointer;">
                                        </div>
                                    </div>
                                    <div id="paginationButtons1" style="display: flex; align-items: center; justify-content: center;">
                                        <!-- ปุ่ม pagination จะถูกสร้างด้วย JavaScript -->
                                    </div>
                                    <div class="pagination-nav">
                                        <div class="btn-next" id="btnNext1">
                                            <img src="picture/arrow-right.png" alt="ถัดไป" style="width: 16px; height: 16px; cursor: pointer;">
                                        </div>
                                    </div>
                            </div>
                                </div>
                            </div>
                        <!-- Pagination -->
                            <div class="cancel-save-under">
                                <div class="cancel cancelPopupBtn10">ยกเลิก</div>
                                <div class="save addAndHideBtn10">เพิ่ม</div>
                            </div>
                        </div>
                    </div>
                    <!--เพิ่มรายการเอกสาร-->
                    <div class="popup-container myPopupadddeopsit">
                        <div class="popup-content-adddeposit-add-modal">
                            <div style="width: 100%;">
                                <div class="bold">เพิ่มรายการ</div>
                                <div class="regular-nomarginbottom">รายละเอียด และจำนวน</div>
                            </div>
                
                            <div class="add-modal-deposit">
                                <div>
                                    <div>เอกสารที่ตัด</div>
                                    <div><input type="text" placeholder="เอกสารที่ตัด" class="input-add-modal-deposit"id="psodesheet2" readonly></div>
                                </div>
                                <div class="addAndHideBtn11" style="cursor: pointer;">
                                    <div class="refer-add-modal-box">
                                        <div class="refer-add-modal">เลือกใบอ้างอิง</div>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <div class="bold-16">ชื่อรายการ</div>
                                <div><input type="text" class="password-title-view-add-modal" placeholder="ชื่อรายการ" id="editnamesheet2"></div>
                            </div>
                            <div class="bold-16">รายละเอียด</div>
                            <textarea placeholder="รับเงินมัดจำล่วงหน้า" class="textarea-add-name-gray-upload" id="deposit-desc"></textarea>
                            <div class="add-modal-under">
                                <div>
                                    <div class="bold-16-nomargin">ยอดหลังหักส่วนลด</div>
                                    <div><input type="number" class="password-title-view-add-modal-under-gray" placeholder="43,100.00" id="pmoneyunitsheet2" readonly>
                                    </div>
                                </div>
                                <div>
                                    <div class="bold-16-nomargin">ราคามัดจำ</div>
                                    <div><input type="number" class="password-title-view-add-modal-under" placeholder="20,000.00" id="editdeposit_price2"></div>
                                </div>
                            </div>
                            <div class="cancel-save-under">
                                <div class="box-cancel-save">
                                    <div class="cancel cancelPopupBtn11">ยกเลิก</div>
                                    <div  id="btnConfirmAdd" class="save hidePopupadd11">เพิ่ม</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="popup-container sidetable new-section">
                        <div class="popup-content1-side-popup-search">
                            <div class="head-bar-search">
                                <div class="bold">ค้นหาเอกสารที่ตัด</div>
                                <div><input type="search" class="search-pass-long" placeholder="ค้นหา" id="productSearchInput" onkeyup="searchProducts()"></div>
                            </div>
                            <div class="head-of-barsearch">
                            <div class="bar-search-long">
                                <div class="number-bar-long">ลำดับ</div>
                                <div class="pass-bar-long">รหัส</div>
                                <div class="name-bar-long">ชื่อรายการ</div>
                                <div class="price-bar-long">ราคารวม</div>
                                <div class="none-bar"></div>
                            </div>
                            <div id="productSearchResults">
                                                        <!-- ข้อมูลสินค้าจะแสดงที่นี่ -->
                            </div>
                            <!-- <div class="data-search-long">
                                <div class="number-search">1</div>
                                <div class="code-search">AI-202501130001</div>
                                <div class="name-search-long">Software พื้นที่จัดเก็บข้อมูล พร้อมติดตั้งและจัดอบรม</div>
                                <div class="price-search-long">43,100.00</div>
                                <div class="eye-container"><img src="picture/eye.png" class="eye-search"></div>
                            </div> -->
                            <!-- <div class="data-search-long">
                                <div class="number-search">2</div>
                                <div class="code-search">AI-202501120001</div>
                                <div class="name-search-long">ทดสอบ1</div>
                                <div class="price-search-long">1,111,111,100.00</div>
                                <div class="eye-container"><img src="picture/eye.png" class="eye-search"></div>
                            </div>
                            <div class="data-search-long">
                                <div class="number-search">3</div>
                                <div class="code-search">AI-202501110001</div>
                                <div class="name-search-long">ทดสอบ2</div>
                                <div class="price-search-long">11,100.00</div>
                                <div class="eye-container"><img src="picture/eye.png" class="eye-search"></div>
                            </div>
                            <div class="data-search-long">
                                <div class="number-search">4</div>
                                <div class="code-search">AI-202501100001</div>
                                <div class="name-search-long">ทดสอบ3</div>
                                <div class="price-search-long">11,100.00</div>
                                <div class="eye-container"><img src="picture/eye.png" class="eye-search"></div>
                            </div>
                            <div class="data-search-long">
                                <div class="number-search">5</div>
                                <div class="code-search">AI-202501110002</div>
                                <div class="name-search-long">ทดสอบ4</div>
                                <div class="price-search-long">11,100.00</div>
                                <div class="eye-container"><img src="picture/eye.png" class="eye-search"></div>
                            </div>
                            <div class="data-search-long">
                                <div class="number-search">6</div>
                                <div class="code-search">AI-202501090001</div>
                                <div class="name-search-long">ทดสอบ5</div>
                                <div class="price-search-long">11,100.00</div>
                                <div class="eye-container"><img src="picture/eye.png" class="eye-search"></div>
                            </div>
                            <div class="data-search-long">
                                <div class="number-search">7</div>
                                <div class="code-search">AI-202501080001</div>
                                <div class="name-search-long">ทดสอบ6</div>
                                <div class="price-search-long">11,100.00</div>
                                <div class="eye-container"><img src="picture/eye.png" class="eye-search"></div>
                            </div>
                            <div class="data-search-long">
                                <div class="number-search">8</div>
                                <div class="code-search">AI-202501070001</div>
                                <div class="name-search-long">ทดสอบ7</div>
                                <div class="price-search-long">11,100.00</div>
                                <div class="eye-container"><img src="picture/eye.png" class="eye-search"></div>
                            </div>
                            <div class="data-search-long">
                                <div class="number-search">9</div>
                                <div class="code-search">AI-202501060001</div>
                                <div class="name-search-long">ทดสอบ8</div>
                                <div class="price-search-long">11,100.00</div>
                                <div class="eye-container"><img src="picture/eye.png" class="eye-search"></div>
                            </div> -->
                            <!-- <div class="data-search-long">
                                <div class="number-search">10</div>
                                <div class="code-search">AI-202501050001</div>
                                <div class="name-search-long">ทดสอบ9</div>
                                <div class="price-search-long">11,100.00</div>
                                <div class="eye-container"><img src="picture/eye.png" class="eye-search"></div>
                            </div> -->
                            </div>
                            <!-- Pagination -->
                            <div class="top-pagination" id="paginationBox2" style="display: none;">
                            <div class="pagination">
                                <span class="page-info" id="pageInfo2"><!--1 of 1 pages--></span>
                            <div class="hedad-of-pagination">
                                    <div class="pagination-nav">
                                        <div class="btn-prev" id="btnPrev2" disabled style="display: none; height: 27px;display: flex;align-items: center;justify-content: center;">
                                            <img src="picture/arrow-left.png" alt="ก่อนหน้า" style="width: 16px; height: 16px; cursor: pointer;">
                                        </div>
                                    </div>
                                    <div id="paginationButtons2" style="display: flex; align-items: center; justify-content: center;">
                                        <!-- ปุ่ม pagination จะถูกสร้างด้วย JavaScript -->
                                    </div>
                                    <div class="pagination-nav">
                                        <div class="btn-next" id="btnNext2">
                                            <img src="picture/arrow-right.png" alt="ถัดไป" style="width: 16px; height: 16px; cursor: pointer;">
                                        </div>
                                    </div>
                            </div>
                                </div>
                            </div>
                        <!-- Pagination -->
                            <div class="cancel-save-under">
                                <div class="cancel sidetableCancelBtn">ยกเลิก</div>
                                <div class="save sidetableSaveBtn">เพิ่ม</div>
                            </div>
                        </div>
                    </div>

                    <!--ยกเลิกการลบ-->
    <div class="popup-container myPopupdelete">
    <div class="popup-content-modal-view">
        <div style="width: 100%;">
            <div class="bold">ลบรายการนี้หรือไม่</div>
        </div>
        <div style="width: 100%;">
            <div class="cancel-save-under">
                <div class="box-cancel-save" >
                    <div class="cancel cancelPopupBtndetele" style="background: #AAC4BB;">ยกเลิก</div> 
                </div>
                <div class="box-cancel-save">
                    <div class="save cancelPopupBtndetele" data-action="confirm">ตกลง</div> 
                </div>
            </div>
        </div>
    </div>
    </div>
<!--ตัวเรียก modal การลบ-->
    <div class="openPopupBtndelete"></div>
                    <script src="sidebarmain.js"></script>
                    <script>
/* ===========================================
   INITIALIZATION & CONFIGURATION
   =========================================== */

/**
 * ฟังก์ชันรีเซ็ตสถานะการมีข้อมูลใน localStorage
 * ใช้เมื่อต้องการล้างสถานะการแสดงข้อมูล
 */
function setCancelState() {
    localStorage.setItem('hasData', 'false');
}

/**
 * ฟังก์ชันแสดงฟอร์มภาษีหัก ณ ที่จ่าย
 */
let clickCount = 0;

function toggleTaxWithheldForm() {
    const button = document.getElementById('add-tax-withheld-btn');
    
    clickCount++;
    console.log('📋 [ฟอร์มภาษี] กดปุ่มเพิ่มฟอร์ม ครั้งที่:', clickCount);
    
    if (clickCount === 1) {
        // กดครั้งแรก - แสดงฟอร์มที่ 2
        console.log('✅ [ฟอร์มภาษี] เพิ่มฟอร์ม 2 - แสดงฟอร์มภาษีหัก ณ ที่จ่าย ฟอร์มที่ 2');
        const form2 = document.getElementById('tax-withheld-form-2');
        if (form2) {
            form2.style.display = 'block';
            // เรียกใช้ฟังก์ชันแสดงข้อมูล checkbox list 3
            updateCheckboxList3();
            console.log('🔄 [ฟอร์มภาษี] อัปเดต checkbox list สำหรับฟอร์ม 2 เสร็จสิ้น');
        }
    } else if (clickCount === 2) {
        // กดครั้งที่สอง - แสดงฟอร์มที่ 3
        console.log('✅ [ฟอร์มภาษี] เพิ่มฟอร์ม 3 - แสดงฟอร์มภาษีหัก ณ ที่จ่าย ฟอร์มที่ 3');
        const form3 = document.getElementById('tax-withheld-form-3');
        if (form3) {
            form3.style.display = 'block';
            // เรียกใช้ฟังก์ชันแสดงข้อมูล checkbox list 4
            updateCheckboxList4();
            console.log('🔄 [ฟอร์มภาษี] อัปเดต checkbox list สำหรับฟอร์ม 3 เสร็จสิ้น');
        }
        // ซ่อนปุ่มหลังจากกดครั้งที่สอง
        button.style.display = 'none';
        console.log('🚫 [ฟอร์มภาษี] ซ่อนปุ่มเพิ่มฟอร์ม (ครบ 3 ฟอร์มแล้ว)');
    }
}

// ฟังก์ชันย้ายข้อมูลจากฟอร์ม 3 ไปฟอร์ม 2
function moveForm3DataToForm2() {
    console.log('🔄 [ย้ายข้อมูล] เริ่มย้ายข้อมูลจากฟอร์ม 3 ไปฟอร์ม 2');
    
    // ย้ายค่า input
    const taxWithheld3 = document.getElementById('tax_withheld3').value;
    const unitItems4 = document.getElementById('unit-items4').value;
    
    console.log('📝 [ย้ายข้อมูล] ย้ายค่า Input - ภาษีหัก:', taxWithheld3, 'รายการ:', unitItems4);
    
    document.getElementById('tax_withheld2').value = taxWithheld3;
    document.getElementById('unit-items3').value = unitItems4;
    
    // ย้าย checkbox state ใน allProductData
    if (typeof allProductData !== 'undefined' && allProductData) {
        let movedProductCount = 0;
        allProductData.forEach(product => {
            // ล้าง selection ของฟอร์ม 2 เดิมก่อน
            product.isSelectedForWithholding2 = false;
            
            // ย้าย selection จากฟอร์ม 3 มาฟอร์ม 2
            if (product.isSelectedForWithholding3) {
                product.isSelectedForWithholding2 = true;
                product.isSelectedForWithholding3 = false;
                movedProductCount++;
            }
        });
        console.log('✅ [ย้ายข้อมูล] ย้ายสินค้าที่เลือกแล้ว จำนวน:', movedProductCount, 'รายการ');
    }
    
    // ล้างข้อมูลฟอร์ม 3
    document.getElementById('tax_withheld3').value = '';
    document.getElementById('unit-items4').value = '';
    document.getElementById('product-checkbox-list4').innerHTML = '';
    
    console.log('🧹 [ย้ายข้อมูล] ล้างข้อมูลฟอร์ม 3 เสร็จสิ้น');
}

// ฟังก์ชันลบฟอร์ม 2
function removeTaxForm2() {
    console.log('🗑️ [ลบฟอร์ม] เริ่มลบฟอร์ม 2');
    
    const form2 = document.getElementById('tax-withheld-form-2');
    const form3 = document.getElementById('tax-withheld-form-3');
    const button = document.getElementById('add-tax-withheld-btn');
    
    // ตรวจสอบว่ามีฟอร์ม 3 หรือไม่
    const form3Visible = form3 && form3.style.display !== 'none';
    
    console.log('🔍 [ลบฟอร์ม] สถานะฟอร์ม 3:', form3Visible ? 'มีฟอร์ม 3' : 'ไม่มีฟอร์ม 3');
    
    if (form3Visible) {
        // กรณีมีฟอร์ม 3 → ย้ายข้อมูลจากฟอร์ม 3 มาฟอร์ม 2
        console.log('🔄 [ลบฟอร์ม] กรณีมีฟอร์ม 3 - ย้ายข้อมูลจากฟอร์ม 3 มาแทนที่ฟอร์ม 2');
        
        // ล้าง UI ของฟอร์ม 2 ก่อน
        document.getElementById('product-checkbox-list3').innerHTML = '';
        
        // ย้ายข้อมูลจากฟอร์ม 3 มาฟอร์ม 2
        moveForm3DataToForm2();
        
        // ซ่อนฟอร์ม 3
        form3.style.display = 'none';
        console.log('🚫 [ลบฟอร์ม] ซ่อนฟอร์ม 3 แล้ว');
        
        // รีเซ็ต state และแสดงปุ่มอีกครั้ง
        clickCount = 1;
        button.style.display = 'flex';
        console.log('📊 [ลบฟอร์ม] รีเซ็ต clickCount เป็น 1, แสดงปุ่มเพิ่มฟอร์ม');
        
        // รีเฟรชฟอร์ม 2 ให้แสดงข้อมูลใหม่
        updateCheckboxList3();
        updateCheckboxList2();

    } else {
        // กรณีไม่มีฟอร์ม 3 → ลบฟอร์ม 2 ธรรมดา
        console.log('❌ [ลบฟอร์ม] กรณีไม่มีฟอร์ม 3 - ลบฟอร์ม 2 ทั้งหมด');
        
        // ซ่อนฟอร์ม 2
        form2.style.display = 'none';
        console.log('🚫 [ลบฟอร์ม] ซ่อนฟอร์ม 2 แล้ว');
        
        // ล้างข้อมูลฟอร์ม 2
        document.getElementById('tax_withheld2').value = '';
        document.getElementById('unit-items3').value = '';
        document.getElementById('product-checkbox-list3').innerHTML = '';
        console.log('🧹 [ลบฟอร์ม] ล้างข้อมูลฟอร์ม 2 แล้ว');
        
        // ล้าง checkbox state ของฟอร์ม 2 ใน allProductData
        if (typeof allProductData !== 'undefined' && allProductData) {
            let clearedProductCount = 0;
            allProductData.forEach(product => {
                if (product.isSelectedForWithholding2) {
                    clearedProductCount++;
                }
                product.isSelectedForWithholding2 = false;
            });
            console.log('🧹 [ลบฟอร์ม] ล้าง checkbox state ของสินค้า จำนวน:', clearedProductCount, 'รายการ');
        }
        
        // อัปเดตฟอร์มอื่น (ไม่รวมฟอร์ม 1 เพื่อไม่ให้ไปติ๊กเอง)
        updateCheckboxList3(); // ฟอร์ม 2 (ถ้ามี)
        updateCheckboxList4(); // ฟอร์ม 3 (ถ้ามี)
        updateCheckboxList2();
        
        // รีเซ็ต state
        clickCount = 0;
        button.style.display = 'flex';
        console.log('📊 [ลบฟอร์ม] รีเซ็ต clickCount เป็น 0, แสดงปุ่มเพิ่มฟอร์ม');
    }
    
    console.log('✅ [ลบฟอร์ม] ลบฟอร์ม 2 เสร็จสิ้น');
}

// ฟังก์ชันลบฟอร์ม 3
function removeTaxForm3() {
    console.log('🗑️ [ลบฟอร์ม] เริ่มลบฟอร์ม 3');
    
    const form3 = document.getElementById('tax-withheld-form-3');
    const button = document.getElementById('add-tax-withheld-btn');
    
    // ซ่อนฟอร์ม 3
    form3.style.display = 'none';
    console.log('🚫 [ลบฟอร์ม] ซ่อนฟอร์ม 3 แล้ว');
    
    // ล้างข้อมูลฟอร์ม 3
    const taxWithheld3Value = document.getElementById('tax_withheld3').value;
    const unitItems4Value = document.getElementById('unit-items4').value;
    
    document.getElementById('tax_withheld3').value = '';
    document.getElementById('unit-items4').value = '';
    document.getElementById('product-checkbox-list4').innerHTML = '';
    
    console.log('🧹 [ลบฟอร์ม] ล้างข้อมูลฟอร์ม 3 - ภาษีหัก:', taxWithheld3Value, 'รายการ:', unitItems4Value);
    
    // ล้าง checkbox state ของฟอร์ม 3 ใน allProductData
    if (typeof allProductData !== 'undefined' && allProductData) {
        let clearedProductCount = 0;
        allProductData.forEach(product => {
            if (product.isSelectedForWithholding3) {
                clearedProductCount++;
            }
            product.isSelectedForWithholding3 = false;
        });
        console.log('🧹 [ลบฟอร์ม] ล้าง checkbox state ของสินค้าในฟอร์ม 3 จำนวน:', clearedProductCount, 'รายการ');
    }
    
    // อัปเดตฟอร์มอื่นให้รายการที่เคย disabled กลับมา enabled ได้  
    updateCheckboxList3();         // ฟอร์ม 2 (ถ้ามี)
    updateCheckboxList4();         // ฟอร์ม 3 (ถ้ามี)
    updateCheckboxList2();
    
    console.log('🔄 [ลบฟอร์ม] อัปเดต checkbox lists ของฟอร์มอื่นแล้ว');
    
    // จัดการปุ่มและ clickCount
    const form2 = document.getElementById('tax-withheld-form-2');
    if (form2.style.display !== 'none') {
        // ยังมีฟอร์ม 2 อยู่
        clickCount = 1;
        button.style.display = 'flex';
        console.log('📊 [ลบฟอร์ม] ยังมีฟอร์ม 2 อยู่ - รีเซ็ต clickCount เป็น 1');
    } else {
        // ไม่มีฟอร์มเหลือ
        clickCount = 0;
        button.style.display = 'flex';
        console.log('📊 [ลบฟอร์ม] ไม่มีฟอร์มเหลือ - รีเซ็ต clickCount เป็น 0');
    }
    
    console.log('✅ [ลบฟอร์ม] ลบฟอร์ม 3 เสร็จสิ้น');
}

/* ===========================================
   FORM UI CONTROLS & SYNCHRONIZATION
   =========================================== */

$(document).ready(function () {
    /**
     * การซิงโครไนซ์ checkbox ภาษีหัก ณ ที่จ่าย
     * ระหว่าง popup และฟอร์มหลัก
     */
    let syncing = false; // flag ป้องกันการ loop ของ event
    
    $('#list-tax-data-2, #list-tax-data-modal5').on('change', function () {
        if (syncing) return; // ป้องกันการเรียกซ้ำ
        syncing = true;
        const checked = $(this).is(':checked');
        // อัปเดตทั้งสอง checkbox ให้มีค่าเดียวกัน
        $('#list-tax-data-2, #list-tax-data-modal5').prop('checked', checked);
        syncing = false;
    });
});

// ฟังก์ชันสำหรับการจัดการเวลาสถานะ
$(document).ready(function () {
    /**
     * ฟังก์ชันแปลงเวลาเป็นรูปแบบไทย (DD/MM/YYYY HH:MM น.)
     */
    function formatThaiDateTime(date) {
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        
        return `${day}/${month}/${year} ${hours}:${minutes} น.`;
    }
    
    /**
     * ฟังก์ชันอัปเดตเวลาสถานะ
     */
    function updateStatusTime() {
        const now = new Date();
        const timeString = formatThaiDateTime(now);
        $('.word-status').text(`สถานะล่าสุด: ${timeString}`);
    }
    
    /**
     * ฟังก์ชันอัปเดตเวลาการเริ่มสร้างเอกสาร
     */
    function updateCreationStartTime() {
        const urlParams = new URLSearchParams(window.location.search);
        const id = urlParams.get('id');
        const com_id = localStorage.getItem('com_id') || 3;
        
        if (id) {
            // สำหรับเอกสารที่มีอยู่แล้ว - อัปเดตเวลาการเริ่มสร้าง
            $.ajax({
                url: '${endpoint}/api/update_creation_start_time',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    id: id,
                    com_id: com_id,
                    created_by: 'system'
                }),
                success: function(response) {
                    console.log('Creation start time updated:', response);
                },
                error: function(xhr, status, error) {
                    console.error('Error updating creation start time:', error);
                }
            });
        } else {
            // สำหรับเอกสารใหม่ - บันทึกเวลาการเริ่มสร้างใน localStorage (+7 ชั่วโมง)
            const now = new Date();
            const creationStartTime = new Date(now.getTime() + (7 * 60 * 60 * 1000)).toISOString();
            localStorage.setItem('newDocumentCreationStartTime', creationStartTime);
            console.log('New document creation start time saved (+7 hours):', creationStartTime);
        }
    }
    
    // อัปเดตเวลาสถานะเมื่อโหลดหน้า
    updateStatusTime();
    
    // บันทึกเวลาสถานะเริ่มต้นลง localStorage
    const now = new Date();
    const timeString = formatThaiDateTime(now);
    localStorage.setItem('quotationStatusTime', timeString);
    
    // บันทึกเวลาการเริ่มสร้างเอกสารในฐานข้อมูล
    updateCreationStartTime();
    
    // อัปเดตเวลาสถานะเมื่อมีการเลือกสถานะ
    $('#customerStatus').on('change', function() {
        if ($(this).val() !== '') {
            updateStatusTime();
            // บันทึกเวลาสถานะลง localStorage
            const now = new Date();
            const timeString = formatThaiDateTime(now);
            localStorage.setItem('quotationStatusTime', timeString);
            localStorage.setItem('quotationStatusValue', $(this).val());
        }
    });
});


$(document).ready(function () {
    /**
     * การจัดการแสดง/ซ่อนช่องชื่อสาขา
     * - สำนักงานใหญ่: ซ่อนช่องชื่อสาขา
     * - สาขาย่อย: แสดงช่องชื่อสาขา
     */
    
    // เริ่มต้นซ่อนช่องชื่อสาขา
    $(".branch-name").hide();
    
    // Event: เลือกสาขาย่อย
    $("#small-office").on("change", function () {
        if ($(this).is(":checked")) {
            $(".branch-name").show();
        }
    });
    
    // Event: เลือกสำนักงานใหญ่
    $("#big-office").on("change", function () {
        if ($(this).is(":checked")) {
            $(".branch-name").hide();
        }
    });
});

/**
 * การสลับแสดงผลระหว่างสินค้าและบริการ
 * ใช้ radio button ในการเลือกประเภท
 */
$('input[name="fav_language_1"]').change(function () {
    if ($(this).val() === 'product') {
        // แสดงส่วนสินค้า ซ่อนส่วนบริการ
        $('.action-product').show();
        $('.action-serve').hide();
    } else {
        // แสดงส่วนบริการ ซ่อนส่วนสินค้า
        $('.action-product').hide();
        $('.action-serve').show();
    }
});
/**
 * การจัดการสีของ input fields เมื่อมีค่า
 * เพิ่ม/ลบ class 'input-filled' ตามสถานะของ input
 */
$(document).ready(function(){
    // ฟังก์ชันเปลี่ยนสีตามสถานะของ input
    function toggleColor($input) {
        if ($input.val()) {
            $input.addClass('input-filled');
        } else {
            $input.removeClass('input-filled');
        }
    }
    
    // จัดการ input วันที่ทั่วไป
    $('.input-data-day').each(function() {
        toggleColor($(this)); // ตรวจสอบตอนโหลดหน้าเว็บ
    });
    $('.input-data-day').on('change', function() {
        toggleColor($(this)); // ตรวจสอบเมื่อเปลี่ยนค่า
    });
    
    // จัดการ input วันที่สำหรับใบสำคัญจ่าย
    $('.input-date-day-create-a-deposit-payment-slip').each(function() {
        toggleColor($(this)); // ตรวจสอบตอนโหลดหน้าเว็บ
    });
    $('.input-date-day-create-a-deposit-payment-slip').on('change', function() {
        toggleColor($(this)); // ตรวจสอบเมื่อเปลี่ยนค่า
    });
});
    $(document).ready(function () {
        $('#list-tax').on('change', function () {
            if ($(this).is(':checked')) {
                $('#unit-items').slideDown();  // แสดงแบบลื่น
            } else {
                $('#unit-items').slideUp();    // ซ่อนแบบลื่น
            }
        });
    });
    $('.one-button1').click(function () {
    $('.data-table-product').show();
    $('.data-table-serve').hide();
});
$('.one-button1').click(function () {
    $('.data-table-product').hide();
    $('.data-table-serve').show();
});
            $('input[name="fav_language_1"]').change(function () {
                                if ($(this).val() === 'product') {
                                    $('.class-product').show();
                                    $('.class-serve').hide();
                                } else {
                                    $('.class-product').hide();
                                    $('.class-serve').show();
                                }
                            });
/* ===========================================
   DATA DISPLAY INITIALIZATION
   =========================================== */
$(document).ready(function () {
    /**
     * การจัดการการแสดงข้อมูลสินค้า
     * - เริ่มต้นแสดง noDataSection ถ้าไม่มีข้อมูล
     * - แสดง myPopupview เมื่อมีข้อมูล
     */
    
    // การแสดงผลเริ่มต้น
    $('#noDataSection').show();
    $('#myPopupview').hide();

    // โหลดข้อมูลสินค้า (ถ้าไม่ใช่โหมดแก้ไข)
    if (!window.editQuotationId) {
        showProductData();
    } else {
        console.log('Skipping showProductData() in popup - already in edit mode');
    }

    // Event: ยืนยันการเพิ่มข้อมูล
    $('#btnConfirmAdd').on('click', function () {
        $('#noDataSection').hide();      // ซ่อนหน้าไม่มีข้อมูล
        $('#myPopupview').show();        // แสดงตารางข้อมูล
    });
});

$(document).ready(function () {
    // เมื่อคลิกปุ่มเพิ่มรายการ
    $('.openPopupBtnadd').on('click', function () {
        $('#popupAddItem').fadeIn(); // แสดง popup เท่านั้น
        $('.data-table-product').show(); // สำรอง: เผื่อเคยถูกซ่อน
    });

    // ปิด popup
    $('#closePopup').on('click', function () {
        $('#popupAddItem').fadeOut();
    });
});
        //Khaow
        //FEi
        $(document).ready(function () {

            // เก็บ Selector ของ jQuery ไว้ในตัวแปรเพื่อประสิทธิภาพและความอ่านง่าย
            const $radioButtons = $('input[name="pageSelection"]');
            const $pages = $('.page');
            /**
             * ซ่อนทุกหน้าและแสดงหน้าเว็บที่ตรงกับปุ่มวิทยุที่ถูกเลือก
             */
            const displaySelectedPage = () => {
                // รับค่า (ID) ของหน้าเว็บที่ถูกเลือกจากปุ่มวิทยุที่ถูกทำเครื่องหมาย
                const selectedPageId = $radioButtons.filter(':checked').val();
                // ลบ class 'active' ออกจากทุกหน้าเพื่อซ่อน
                $pages.removeClass('active');

                // เพิ่ม class 'active' ให้กับหน้าที่ถูกเลือกเพื่อแสดงผล
                // ใช้ template literal สำหรับ selector ID เพื่อความอ่านง่ายขึ้น
                $(`#${selectedPageId}`).addClass('active');
                
                // อัปเดต payment_detail ใน localStorage ด้วยวิธีการชำระเงินที่เลือก
                updatePaymentMethodInLocalStorage(selectedPageId);
            };
            // ผูก Event Listener ประเภท 'change' เข้ากับปุ่มวิทยุทั้งหมด
            // เมื่อปุ่มวิทยุถูกเลือก ให้เรียกใช้ฟังก์ชัน displaySelectedPage
            $radioButtons.on('change', displaySelectedPage);
            // เรียกใช้ฟังก์ชันหนึ่งครั้งเมื่อโหลดหน้าเว็บครั้งแรก เพื่อแสดงหน้าเริ่มต้นที่ถูกเลือก
            displaySelectedPage();
        });
        $(document).ready(function () {
            // ✅ ซ่อนช่อง "ชื่อสาขา" ตอนโหลดหน้าเว็บ
            $(".branch-name").hide();
            // ✅ เมื่อเลือก "สาขาย่อย" ให้แสดงช่องชื่อสาขา
            $("#small-office").on("change", function () {
                if ($(this).is(":checked")) {
                    $(".branch-name").show();
                }
            });
            // ✅ เมื่อเลือก "สำนักงานใหญ่" ให้ซ่อนช่องชื่อสาขา
            $("#big-office").on("change", function () {
                if ($(this).is(":checked")) {
                    $(".branch-name").hide();
                }
            });
        });
        $('input[name="fav_language_1"]').change(function () {
            if ($(this).val() === 'product') {
                $('.action-product').show();
                $('.action-serve').hide();
            } else {
                $('.action-product').hide();
                $('.action-serve').show();
            }
        });
        $('#toggleBox').on('change', function () {
            const isChecked = $(this).is(':checked');
            localStorage.setItem('deposit_deduction', isChecked);
            
            // อัปเดต payment_detail ใน localStorage ถ้ามีข้อมูลอยู่แล้ว
            const quotationData = localStorage.getItem('quotationData');
            if (quotationData) {
                try {
                    const data = JSON.parse(quotationData);
                    if (data.payment_detail) {
                        let paymentDetail;
                        if (typeof data.payment_detail === 'string') {
                            paymentDetail = JSON.parse(data.payment_detail);
                        } else {
                            paymentDetail = data.payment_detail;
                        }
                        paymentDetail.deposit_deduction = isChecked;
                        data.payment_detail = JSON.stringify(paymentDetail);
                        localStorage.setItem('quotationData', JSON.stringify(data));
                    }
                } catch (error) {
                    console.log('Error updating payment_detail deposit_deduction in localStorage:', error);
                }
            }
            
            if (isChecked) {
                $('#myBox').addClass('show');
            } else {
                $('#myBox').removeClass('show');
            }
        });
        $('#toggle-btn-2').on('change', function () {
            if ($(this).is(':checked')) {
                $('#box-2').addClass('show');
            } else {
                $('#box-2').removeClass('show');
            }
        });
        const allDateInputs = document.querySelectorAll('.input-date-day1');
        allDateInputs.forEach(input => {
            // ตั้งค่าเริ่มต้น ถ้าเลือกวันไว้แล้ว
            if (input.value) {
                input.style.color = '#000';
            }
            // เมื่อผู้ใช้เลือกวัน
            input.addEventListener('input', function () {
                if (this.value) {
                    this.style.color = 'var(--text-color-black)'; // สีดำเข้ม
                } else {
                    this.style.color = 'var(--input-text-color400)'; // สีเดิม
                }
            });
        });
        const dropdowns = document.querySelectorAll('.dropdown, .dropdown-new, dropdown-status');
        dropdowns.forEach(select => {
            // ตั้งค่าเริ่มต้นตอนโหลดหน้า
            if (select.value) {
                select.style.color = '#000';
            } else {
                select.style.color = 'var(--input-text-color400)';
            }
            // เมื่อมีการเปลี่ยนค่า
            select.addEventListener('change', function () {
                if (this.value) {
                    this.style.color = '#000'; // สีดำเข้ม
                } else {
                    this.style.color = 'var(--input-text-color400)'; // สีเดิม
                }
            });
        });
        // เลือก input ทั้งหมดที่มี class deposit-date-text และ deposit-time-text
        const inputs = document.querySelectorAll('.deposit-date-text, .deposit-time-text, .date-tax, .input-date-payment');
        inputs.forEach(input => {
            // เช็คตอนโหลดหน้า ถ้ามีค่าอยู่แล้วให้เป็นสีดำ
            if (input.value) {
                input.style.color = 'var(--Input-text-black)';
            }
            // ฟังชันเวลามีการกรอก/เลือกค่า
            input.addEventListener('input', () => {
                if (input.value) {
                    input.style.color = 'var(--Input-text-black)';  // สีดำเข้ม
                } else {
                    input.style.color = 'var(--input-text-gray-color200)';  // สีอ่อนตาม CSS เดิม
                }
            });
        });
        $(document).ready(function () {
            function updateColor($el) {
                if ($el.val()) {
                    $el.css({
                        'color': '#000',
                        '-webkit-text-fill-color': 'var(--Input-text-black)' // Safari, Chrome
                    });
                } else {
                    $el.css({
                        'color': 'var(--input-text-gray-color200)',
                        '-webkit-text-fill-color': 'var(--input-text-gray-color200)'
                    });
                }
            }
            // เรียกตอนโหลดหน้า
            $('.select-tax-dropdown').each(function () {
                updateColor($(this));
            });
            // ฟังชันเวลามีการเปลี่ยนค่า
            $('.select-tax-dropdown').on('change', function () {
                updateColor($(this));
            });
        });
        $(document).ready(function () {
            $('.dropdown-new1').each(function () {
                toggleColor($(this));
            });
            $('.dropdown-new1').on('change', function () {
                toggleColor($(this));
            });
            function toggleColor($el) {
                if ($el.val()) {
                    $el.addClass('active-color');
                } else {
                    $el.removeClass('active-color');
                }
            }
        });

                $(document).ready(function () {
            $('.dropdown-status').each(function () {
                toggleColor($(this));
            });
            $('.dropdown-status').on('change', function () {
                toggleColor($(this));
            });
            function toggleColor($el) {
                if ($el.val()) {
                    $el.addClass('active-color');
                } else {
                    $el.removeClass('active-color');
                }
            }
        });
        $(document).ready(function () {
            function updateColor($el) {
                if ($el.val()) {
                    $el.addClass('active-selected');
                } else {
                    $el.removeClass('active-selected');
                }
            }
            // เรียกตอนโหลดหน้า
            $('.Business-number').each(function () {
                updateColor($(this));
            });
            // เรียกตอนเปลี่ยนค่า
            $('.Business-number').on('change', function () {
                updateColor($(this));
            });
        });
            $(document).ready(function () {
    $('#list-tax-data-2').change(function () {
    if ($(this).is(':checked')) {
        $('#box-3').show(); // แสดงกล่อง
    } else {
        $('#box-3').hide(); // ซ่อนกล่อง
    }
    });
    // เริ่มต้นซ่อนไว้
    $('#box-3').hide();
});
                        $(document).ready(function () {
    $('#unit-items').on('change', function () {
        $(this).css('color', 'black');
    });
    });
        // เลือก input ทั้งหมดที่มี class deposit-date-text, deposit-time-text, date-tax, input-date-payment
        const inputs1 = document.querySelectorAll('.deposit-date-text, .deposit-time-text, .date-tax, .input-date-payment');
    inputs1.forEach(input => {
            // เช็คตอนโหลดหน้า ถ้ามีค่าอยู่แล้วให้เป็นสีดำ
            if (input.value) {
                input.style.color = 'var(--Input-text-black)';
            }
            // ฟังชันเวลามีการกรอก/เลือกค่า
            input.addEventListener('input', () => {
                if (input.value) {
                    input.style.color = 'var(--Input-text-black)'; // สีดำเข้ม
                } else {
                    input.style.color = 'var(--input-text-gray-color200)'; // สีอ่อนตาม CSS เดิม
                }
            });
        });
        $(document).ready(function () {
            function updateColor($el) {
                if ($el.val()) {
                    $el.css({
                        'color': '#000',
                        '-webkit-text-fill-color': 'var(--Input-text-black)' // Safari, Chrome
                    });
                } else {
                    $el.css({
                        'color': 'var(--input-text-gray-color200)',
                        '-webkit-text-fill-color': 'var(--input-text-gray-color200)'
                    });
                }
            }
            // เรียกตอนโหลดหน้า
            $('.select-tax-dropdown').each(function () {
                updateColor($(this));
            });
            // ฟังชันเวลามีการเปลี่ยนค่า
            $('.select-tax-dropdown').on('change', function () {
                updateColor($(this));
            });
        });
        $(document).ready(function () {
            $('.dropdown-new1').each(function () {
                toggleColor($(this));
            });
            $('.dropdown-new1').on('change', function () {
                toggleColor($(this));
            });
            function toggleColor($el) {
                if ($el.val()) {
                    $el.addClass('active-color');
                } else {
                    $el.removeClass('active-color');
                }
            }
        });
        $(document).ready(function () {
            function updateColor($el) {
                if ($el.val()) {
                    $el.addClass('active-selected');
                } else {
                    $el.removeClass('active-selected');
                }
            }
            // เรียกตอนโหลดหน้า
            $('.Business-number').each(function () {
                updateColor($(this));
            });
            // เรียกตอนเปลี่ยนค่า
            $('.Business-number').on('change', function () {
                updateColor($(this));
            });
        });
        
        
        //Fei
        $(document).ready(function () {
    // เลือกองค์ประกอบของปุ่มเปิด Pop-up หลักแต่ละอัน (ใช้ class)
    const $openPopupBtnsUpload = $('.openPopupBtnupload');
    const $openPopupBtnsPenView = $('.openPopupBtnpenview');
    const $openPopupBtnsView = $('.openPopupBtnview');
    const $openPopupBtnsAdd = $('.openPopupBtnadd');
    const $openPopupBtnsEditPen = $('.openPopupBtneditpen');
    const $openPopupBtnsDeposit = $('.openPopupBtndeposit');
    const $openPopupBtnsAddDate = $('.openPopupBtnadddate');
    const $openPopupBtnsViewDate = $('.openPopupBtnviewdate');
    const $openPopupBtnsAddSum = $('.openPopupBtnaddsum');
    const $openPopupBtnsSalesOrder = $('.openPopupBtnsalesorder');
    const $openPopupBtnsAddDeposit = $('.openPopupBtndeopsit');
    const $openPopupBtnsSelectReceive = $('.openPopupBtnselectreceive');
    const $openPopupBtnsSelectBill = $('.openPopupBtnselectbill');
    const $openPopupBtnsTableSum = $('.openPopupBtntablesum');
    const $openPopupBtnsTableBillingSlip = $('.openPopupBtnTableBillingSlip');
    const $openPopupBtnsViewInvoice = $('.openPopupBtnViewInvoice');
    const $openPopupBtnsViewVat = $('.openPopupBtnviewvat'); // Existing viewvat
    // Added: ปุ่มสำหรับเปิด Pop-up viewtable9 และ viewtable10
    const $openPopupBtnsViewTable9 = $('.openPopupBtnviewtable9');
    const $openPopupBtnsViewTable10 = $('.openPopupBtnviewtable10');
    const $openPopupBtnaddsmallpen = $('.openPopupBtnaddsmallpen');
    
    // เลือกองค์ประกอบของ Pop-up หลักแต่ละอัน (ใช้ class)
    const $myPopupsUpload = $('.myPopupupload');
    const $myPopupsPenView = $('.myPopuppenview');
    const $myPopupsView = $('.myPopupview');
    const $myPopupsAdd = $('.myPopupadd');
    const $myPopupsEditPen = $('.myPopupeditpen');
    const $myPopupsDeposit = $('.myPopupdeposit');
    const $myPopupsAddDate = $('.myPopupadddate');
    const $myPopupsViewDate = $('.myPopupviewdate');
    const $myPopupsAddSum = $('.myPopupaddsum');
    const $myPopupsSalesOrder = $('.myPopupsalesorder');
    const $myPopupsAddDeposit = $('.myPopupadddeopsit');
    const $myPopupsSelectReceive = $('.myPopupselectreceive');
    const $myPopupsSelectBill = $('.myPopupselectbill');
    const $myPopupsTableSum = $('.myPopuptablesum');
    const $myPopupsTableBillingSlip = $('.myPopupsTableBillingSlip');
    const $myPopupsViewInvoice = $('.myPopupsviewinvoice');
    const $myPopupsViewVat = $('.myPopupviewvat'); // Existing viewvat
    // Added: Pop-up viewtable9 และ viewtable10
    const $myPopupsViewTable9 = $('.myPopupviewtable9');
    const $myPopupsViewTable10 = $('.myPopupviewtable10');
    const $myPopupsaddsmallpen = $('.myPopupaddsmallpen');
    // ปุ่มภายใน Pop-up หลักแต่ละอัน (Cancel และ Add/Hide/Save) (ใช้ class)
    const $cancelPopupBtns = $('.cancelPopupBtn');
    const $addAndHideBtns = $('.addAndHideBtn'); // สำหรับ myPopupupload (เปิด sideupload)
    const $cancelPopupBtns2 = $('.cancelPopupBtn2');
    const $addAndHideBtns2 = $('.addAndHideBtn2'); // สำหรับ myPopuppenview (ปิด popup)
    const $cancelPopupBtns3 = $('.cancelPopupBtn3');
    const $addAndHideBtns3 = $('.addAndHideBtn3'); // สำหรับ myPopupview (ปิด popup)
    const $cancelPopupBtns4 = $('.cancelPopupBtn4');
    const $addAndHideBtns4 = $('.addAndHideBtn4'); // สำหรับ myPopupadd (เปิด sideadd)
    const $cancelPopupBtns5 = $('.cancelPopupBtn5');
    const $addAndHideBtns5 = $('.addAndHideBtn5'); // สำหรับ myPopupeditpen (ปิด popup)
    const $cancelPopupBtns6 = $('.cancelPopupBtn6');
    const $addAndHideBtns6 = $('.addAndHideBtn6'); // สำหรับ myPopupdeposit (ปิด popup)
    const $cancelPopupBtns7 = $('.cancelPopupBtn7');
    const $addAndHideBtns7 = $('.addAndHideBtn7'); // สำหรับ myPopupadddate (ปิด popup)
    const $cancelPopupBtns8 = $('.cancelPopupBtn8');
    const $addAndHideBtns8 = $('.addAndHideBtn8'); // สำหรับ myPopup8 (ปิด popup)
    const $cancelPopupBtns9 = $('.cancelPopupBtn9');
    const $addAndHideBtns9 = $('.addAndHideBtn9'); // สำหรับ myPopup9 (ปิด popup)
    const $cancelPopupBtns10 = $('.cancelPopupBtn10');
    const $addAndHideBtns10 = $('.addAndHideBtn10'); // สำหรับ myPopup10 (ปิด popup)
    const $cancelPopupBtns11 = $('.cancelPopupBtn11');
    const $addAndHideBtns11 = $('.addAndHideBtn11'); // สำหรับ myPopup11 (เปิด sidetable)
    const $hidePopupAdd11 = $('.hidePopupadd11'); // ปุ่มใหม่สำหรับซ่อน myPopup11
    const $cancelPopupBtns12 = $('.cancelPopupBtn12');
    const $addAndHideBtns12 = $('.addAndHideBtn12');
    const $hidePopupAdd12 = $('.hidePopupadd12');
    const $cancelPopupBtns13 = $('.cancelPopupBtn13');
    const $addAndHideBtns13 = $('.addAndHideBtn13');
    const $hidePopupAdd13 = $('.hidePopupadd13');
    const $cancelPopupBtns14 = $('.cancelPopupBtn14');
    const $addAndHideBtns14 = $('.addAndHideBtn14');
    const $hidePopupAdd14 = $('.hidePopupadd14');
    const $cancelPopupBtnsTableBillingSlip = $('.cancelPopupBtnTableBillingSlip');
    const $addAndHideBtnsTableBillingSlip = $('.addAndHideBtnTableBillingSlip');
    const $hidePopupAddTableBillingSlip = $('.hidePopupAddTableBillingSlip');
    const $cancelPopupBtnsViewInvoice = $('.cancelPopupBtnViewInvoice');
    const $addAndHideBtnsViewInvoice = $('.addAndHideBtnViewInvoice');
    const $hidePopupAddViewInvoice = $('.hidePopupAddViewInvoice');
    const $cancelPopupBtnsViewVat = $('.cancelPopupBtnviewvat');
    const $addAndHideBtnsViewVat = $('.addAndHideBtnviewvat');
    const $hidePopupAddViewVat = $('.hidePopupAddviewvat');
    // Pop-up ย่อย (.sideupload, .sideadd, .sidetable) และปุ่มภายใน (ใช้ class)
    // Added: ปุ่มสำหรับ Pop-up viewtable9 และ viewtable10
    const $cancelPopupBtnsViewTable9 = $('.cancelPopupBtnviewtable9');
    const $addAndHideBtnsViewTable9 = $('.addAndHideBtnviewtable9');
    const $hidePopupAddViewTable9 = $('.hidePopupAddviewtable9');
    const $cancelPopupBtnsViewTable10 = $('.cancelPopupBtnviewtable10');
    const $addAndHideBtnsViewTable10 = $('.addAndHideBtnviewtable10');
    const $hidePopupAddViewTable10 = $('.hidePopupAddviewtable10');
    const $cancelPopupBtnsaddsmallpen = $('.cancelPopupBtnaddsmallpen');
    const $addAndHideBtnsaddsmallpen = $('.addAndHideBtnaddsmallpen');
    const $hidePopupAddViewaddsmallpen = $('.hidePopupAddaddsmallpen');
    
    // Pop-up ย่อย (.sideupload, .sideadd, .sidetable) และปุ่มภายใน (ใช้ class)
    const $sideuploads = $('.sideupload');
    const $sideuploadCancelBtns = $('.sideuploadCancelBtn');
    const $sideuploadSaveBtns = $('.sideuploadSaveBtn');
    const $uploadFileBtns = $('.uploadFileBtn');
    const $openEditBtns = $('.openedit');
    const $sideadds = $('.sideadd');
    const $sideaddCancelBtns = $('.sideaddCancelBtn');
    const $sideaddSaveBtns = $('.sideaddSaveBtn');
    const $sidetables = $('.sidetable');
    const $sidetableCancelBtns = $('.sidetableCancelBtn');
    const $sidetableSaveBtns = $('.sidetableSaveBtn');
    // 5 ปุ่มเสริมใน Pop-up ย่อย (ถ้ายังคงใช้) (ใช้ class)
    const $newBtns1 = $('.newButton1');
    const $newBtns2 = $('.newButton2');
    const $newBtns3 = $('.newButton3');
    const $newBtns4 = $('.newButton4');
    const $newBtns5 = $('.newButton5');
    // เลือกองค์ประกอบทั้งหมดที่มีคลาส 'data-search-long' และ 'data-search'
    const searchItemsLong = $('.data-search-long');
    const searchItemsShort = $('.data-search');
    // กำหนดระยะเวลา transition ในหน่วยมิลลิวินาที (ตรงกับ 0.15s ใน CSS)
    const TRANSITION_DURATION = 150;
    // ตัวแปรสำหรับเก็บ Pop-up หลักปัจจุบัน เมื่อต้องกลับจาก Pop-up ย่อย
    let currentMainPopup = null;
    // --- ฟังก์ชันตัวช่วยสำหรับการจัดการ Popup ---
    // ฟังก์ชันเหล่านี้ถูกย้ายไปไว้ด้านล่าง
    // ฟังก์ชันสำหรับซ่อน Pop-up ย่อย (.sideupload) และแสดง Pop-up หลักที่กำหนด
    function hideSideuploadAndShowMainPopup() {
        hidePopup($sideuploads);
        setTimeout(() => {
            if (currentMainPopup) {
                showPopup(currentMainPopup);
                currentMainPopup = null; // รีเซ็ตตัวแปร
            }
        }, TRANSITION_DURATION);
    }
    // ฟังก์ชันสำหรับซ่อน Pop-up ย่อย (.sideadd) และแสดง Pop-up หลักที่กำหนด
    function hideSideaddAndShowMainPopup($mainPopupElement) {
        hidePopup($sideadds);
        setTimeout(() => {
            showPopup($mainPopupElement);
        }, TRANSITION_DURATION);
    }
    // ฟังก์ชันสำหรับซ่อน Pop-up ย่อย (.sidetable) และแสดง Pop-up หลักที่กำหนด
    function hideSidetableAndShowMainPopup($mainPopupElement) {
        hidePopup($sidetables);
        setTimeout(() => {
            showPopup($mainPopupElement);
            
            // โหลดข้อมูลสินค้าลงในโมดอลถ้ามีการเลือกสินค้า
            if (window.selectedProductCode) {
                loadProductDataForEdit2(window.selectedProductCode);
                // รีเซ็ตตัวแปรหลังจากโหลดข้อมูลแล้ว
                window.selectedProductCode = null;
                window.selectedProductId = null;
            }
        }, TRANSITION_DURATION);
    }
    // --- การจัดการการเลือกแถวและเปลี่ยนรูปภาพ (One-click selection) ---
    // ฟังก์ชันนี้ถูกย้ายไปไว้ในด้านล่าง
    // เรียกใช้ฟังก์ชันเพื่อตั้งค่าการเลือกแถวสำหรับทั้ง .data-search-long และ .data-search
    setupRowSelection(searchItemsLong);
    setupRowSelection(searchItemsShort);

    // --- ตั้งค่า Event Listeners สำหรับปุ่มเปิด Pop-up หลัก ---
    $openPopupBtnsUpload.on('click', function () { showPopup($myPopupsUpload); console.log(`องค์ประกอบ "เปิด" สำหรับ .myPopupupload ถูกคลิก!`); });
    $openPopupBtnsPenView.on('click', function () { showPopup($myPopupsPenView); console.log(`องค์ประกอบ "เปิด" สำหรับ .myPopuppenview ถูกคลิก!`); });
    $openPopupBtnsView.on('click', function () { showPopup($myPopupsView); console.log(`องค์ประกอบ "เปิด" สำหรับ .myPopupview ถูกคลิก!`); });
    $openPopupBtnsAdd.on('click', function () { showPopup($myPopupsAdd); console.log(`องค์ประกอบ "เปิด" สำหรับ .myPopupadd ถูกคลิก!`); });
    $openPopupBtnsEditPen.on('click', function () { 
        // ดึงค่าจริงจากส่วนสรุปมูลค่าสุทธิ
        const totalAmount = $('#total-allproduct').text();
        const afterDiscount = $('#total-allproduct-total-alldiscount').text();
        const totalAll = $('#total-all').text();
        const vat7 = $('#total-vat7').text();
        
        showPopup($myPopupsEditPen); 
        console.log(`องค์ประกอบ "เปิด" สำหรับ .myPopupeditpen ถูกคลิก!`); 
    });
    $openPopupBtnsDeposit.on('click', function () { showPopup($myPopupsDeposit); console.log(`องค์ประกอบ "เปิด" สำหรับ .myPopupdeposit ถูกคลิก!`); });
    $openPopupBtnsAddDate.on('click', function () { showPopup($myPopupsAddDate); console.log(`องค์ประกอบ "เปิด" สำหรับ .myPopupadddate ถูกคลิก!`); });
    $openPopupBtnsViewDate.on('click', function () { showPopup($myPopupsViewDate); console.log(`องค์ประกอบ "เปิด" สำหรับ .myPopupviewdate ถูกคลิก!`); });
    $openPopupBtnsAddSum.on('click', function () { showPopup($myPopupsAddSum); console.log(`องค์ประกอบ "เปิด" สำหรับ .myPopupaddsum ถูกคลิก!`); });
    $openPopupBtnsSalesOrder.on('click', function () { 
        showPopup($myPopupsSalesOrder); 
        loadProductSearchData4()
        console.log(`องค์ประกอบ "เปิด" สำหรับ .myPopupsalesorder ถูกคลิก!`); 
    });
    $openPopupBtnsAddDeposit.on('click', function () { showPopup($myPopupsAddDeposit); console.log(`องค์ประกอบ "เปิด" สำหรับ .myPopupadddeopsit ถูกคลิก!`); });
    $openPopupBtnsSelectReceive.on('click', function () { showPopup($myPopupsSelectReceive); console.log(`องค์ประกอบ "เปิด" สำหรับ .myPopupselectreceive ถูกคลิก!`); });
    $openPopupBtnsSelectBill.on('click', function () { showPopup($myPopupsSelectBill); console.log(`องค์ประกอบ "เปิด" สำหรับ .myPopupselectbill ถูกคลิก!`); });
    $openPopupBtnsTableSum.on('click', function () { showPopup($myPopupsTableSum); console.log(`องค์ประกอบ "เปิด" สำหรับ .myPopuptablesum ถูกคลิก!`); });
    $openPopupBtnsTableBillingSlip.on('click', function () { showPopup($myPopupsTableBillingSlip); console.log(`องค์ประกอบ "เปิด" สำหรับ .myPopupsTableBillingSlip ถูกคลิก!`); });
    $openPopupBtnsViewInvoice.on('click', function () { showPopup($myPopupsViewInvoice); console.log(`องค์ประกอบ "เปิด" สำหรับ .myPopupsviewinvoice ถูกคลิก!`); });
    $openPopupBtnsViewVat.on('click', function () { showPopup($myPopupsViewVat); console.log(`องค์ประกอบ "เปิด" สำหรับ .myPopupviewvat ถูกคลิก!`); });
    // Added: Event Listener สำหรับปุ่มเปิด Pop-up viewtable9 และ viewtable10
    $openPopupBtnsViewTable9.on('click', function () { showPopup($myPopupsViewTable9); console.log(`องค์ประกอบ "เปิด" สำหรับ .myPopupviewtable9 ถูกคลิก!`); });
    $openPopupBtnsViewTable10.on('click', function () { showPopup($myPopupsViewTable10); console.log(`องค์ประกอบ "เปิด" สำหรับ .myPopupviewtable10 ถูกคลิก!`); });
    $openPopupBtnaddsmallpen.on('click', function () { showPopup($myPopupsaddsmallpen); console.log(`องค์ประกอบ "เปิด" สำหรับ .myPopupDelete ถูกคลิก!`); });
    
    // --- ตั้งค่า Event Listeners สำหรับปุ่มลบ ---
    const $openPopupBtndelete = $('.openPopupBtndelete');
    const $myPopupsdelete = $('.myPopupdelete');
    const $cancelPopupBtndetele = $('.cancelPopupBtndetele');
    
    // ตัวแปรเก็บ ID ของสินค้าที่จะลบ
    let deleteProductId = null;
    let viewProductId = null;
    let editProductId = null;
    
    // Event listener สำหรับปุ่มเปิด modal การลบ (ใช้ event delegation สำหรับ dynamic elements)
    $(document).on('click', '.openPopupBtndelete', function () { 
        // เก็บ ID ของสินค้าที่จะลบ
        deleteProductId = $(this).find('img').data('id');
        console.log('ID สินค้าที่จะลบ:', deleteProductId);
        
        showPopup($myPopupsdelete); 
        console.log(`องค์ประกอบ "เปิด" สำหรับ .myPopupdelete ถูกคลิก!`); 
    });
    
    // Event listener สำหรับปุ่มดู (view)
    $(document).on('click', '.openPopupBtnview', function () { 
        // เก็บ ID ของสินค้าที่จะดู
        viewProductId = $(this).find('img').data('id');
        console.log('ID สินค้าที่จะดู:', viewProductId);
        console.log('Element ที่ถูกคลิก:', $(this));
        console.log('Image element:', $(this).find('img'));
        
        // ดึงข้อมูลสินค้าตาม ID และแสดงใน modal
        loadProductDataForView(viewProductId);
        
        showPopup($myPopupsView); 
        console.log(`องค์ประกอบ "เปิด" สำหรับ .myPopupview ถูกคลิก!`); 
    });
    
    // Event listener สำหรับปุ่มแก้ไข (edit)
    $(document).on('click', '.openPopupBtnpenview', function () { 
        // เก็บรหัสสินค้าที่จะแก้ไข
        const productCode = $(this).find('img').data('id');
        console.log('รหัสสินค้าที่จะแก้ไข:', productCode);

        loadProductDataForEdit(productCode);
        
        showPopup($myPopupsaddsmallpen); 
        console.log(`องค์ประกอบ "เปิด" สำหรับ .myPopuppenview ถูกคลิก!`); 
    });
    
    // Event listener สำหรับปุ่มยกเลิกและตกลงใน modal การลบ
    $cancelPopupBtndetele.on('click', function () { 
        const action = $(this).data('action');
        
        if (action === 'confirm') {
            // กดปุ่มตกลง - ทำการลบสินค้า
            if (deleteProductId) {
                deleteProduct(deleteProductId);
            }
        }
        
        // ปิด modal และรีเซ็ต ID
        hidePopup($myPopupsdelete);
        deleteProductId = null;
        console.log(`องค์ประกอบ "ยกเลิก/ตกลง" สำหรับ .myPopupdelete ถูกคลิก!`); 
    });
    
    // --- ตั้งค่า Event Listeners สำหรับปุ่ม "ยกเลิก" ใน Pop-up หลัก ---
    $cancelPopupBtns.on('click', function () { hidePopup($myPopupsUpload); console.log(`องค์ประกอบ "ยกเลิก" สำหรับ .myPopupupload ถูกคลิก!`); });
    $cancelPopupBtns2.on('click', function () { hidePopup($myPopupsPenView); console.log(`องค์ประกอบ "ยกเลิก" สำหรับ .myPopuppenview ถูกคลิก!`); });
    $cancelPopupBtns3.on('click', function () { hidePopup($myPopupsView); console.log(`องค์ประกอบ "ยกเลิก" สำหรับ .myPopupview ถูกคลิก!`); });
    $cancelPopupBtns4.on('click', function () { hidePopup($myPopupsAdd); console.log(`องค์ประกอบ "ยกเลิก" สำหรับ .myPopupadd ถูกคลิก!`); });
    $cancelPopupBtns5.on('click', function () { hidePopup($myPopupsEditPen); console.log(`องค์ประกอบ "ยกเลิก" สำหรับ .myPopupeditpen ถูกคลิก!`); });
    $cancelPopupBtns6.on('click', function () { hidePopup($myPopupsDeposit); console.log(`องค์ประกอบ "ยกเลิก" สำหรับ .myPopupdeposit ถูกคลิก!`); });
    $cancelPopupBtns7.on('click', function () { hidePopup($myPopupsAddDate); console.log(`องค์ประกอบ "ยกเลิก" สำหรับ .myPopupadddate ถูกคลิก!`); });
    $cancelPopupBtns8.on('click', function () { hidePopup($myPopupsViewDate); console.log(`องค์ประกอบ "ยกเลิก" สำหรับ .myPopupviewdate ถูกคลิก!`); });
    $cancelPopupBtns9.on('click', function () { hidePopup($myPopupsAddSum); console.log(`องค์ประกอบ "ยกเลิก" สำหรับ .myPopupaddsum ถูกคลิก!`); });
    $cancelPopupBtns10.on('click', function () { 
        // ล้างข้อมูลที่เลือกไว้เมื่อยกเลิก
        window.selectedProductCode = null;
        window.selectedProductId = null;
        // ล้างช่องค้นหา productSearchInput2
        $('#productSearchInput2').val('');
        hidePopup($myPopupsSalesOrder); 
        console.log(`องค์ประกอบ "ยกเลิก" สำหรับ .myPopupsalesorder ถูกคลิก!`); 
    });
    $cancelPopupBtns11.on('click', function () { hidePopup($myPopupsAddDeposit); console.log(`องค์ประกอบ "ยกเลิก" สำหรับ .myPopupadddeopsit ถูกคลิก!`); });
    $cancelPopupBtns12.on('click', function () { hidePopup($myPopupsSelectReceive); console.log(`องค์ประกอบ "ยกเลิก" สำหรับ .myPopupselectreceive ถูกคลิก!`); });
    $cancelPopupBtns13.on('click', function () { hidePopup($myPopupsSelectBill); console.log(`องค์ประกอบ "ยกเลิก" สำหรับ .myPopupselectbill ถูกคลิก!`); });
    $cancelPopupBtns14.on('click', function () { hidePopup($myPopupsTableSum); console.log(`องค์ประกอบ "ยกเลิก" สำหรับ .myPopuptablesum ถูกคลิก!`); });
    $cancelPopupBtnsTableBillingSlip.on('click', function () { hidePopup($myPopupsTableBillingSlip); console.log(`องค์ประกอบ "ยกเลิก" สำหรับ .myPopupsTableBillingSlip ถูกคลิก!`); });
    $cancelPopupBtnsViewInvoice.on('click', function () { hidePopup($myPopupsViewInvoice); console.log(`องค์ประกอบ "ยกเลิก" สำหรับ .myPopupsviewinvoice ถูกคลิก!`); });
    $cancelPopupBtnsViewVat.on('click', function () { hidePopup($myPopupsViewVat); console.log(`องค์ประกอบ "ยกเลิก" สำหรับ .myPopupviewvat ถูกคลิก!`); });
    // Added: Event Listener สำหรับปุ่ม "ยกเลิก" ของ Pop-up viewtable9 และ viewtable10
    $cancelPopupBtnsViewTable9.on('click', function () { hidePopup($myPopupsViewTable9); console.log(`องค์ประกอบ "ยกเลิก" สำหรับ .myPopupviewtable9 ถูกคลิก!`); });
    $cancelPopupBtnsViewTable10.on('click', function () { hidePopup($myPopupsViewTable10); console.log(`องค์ประกอบ "ยกเลิก" สำหรับ .myPopupviewtable10 ถูกคลิก!`); });
    $cancelPopupBtnsaddsmallpen.on('click', function () { hidePopup($myPopupsaddsmallpen); console.log(`องค์ประกอบ "ยกเลิก" สำหรับ .myPopupviewdelete ถูกคลิก!`); });
    // --- จัดการปุ่ม "เพิ่ม/บันทึก" ใน Pop-up หลักแต่ละอัน ---
    // Pop-up ที่เปิด Pop-up ย่อย
    $addAndHideBtns.on('click', function () { // myPopupupload -> sideupload
        hidePopup($myPopupsUpload);
        setTimeout(() => {
            currentMainPopup = $myPopupsUpload;
            showPopup($sideuploads);
            // แสดงไฟล์ที่ยืนยันแล้วในตำแหน่งที่เลือกไว้
            if (typeof window.displayConfirmedFilesInShowUpload === 'function') {
                window.displayConfirmedFilesInShowUpload();
            }
        }, TRANSITION_DURATION);
        console.log('Div "เพิ่ม" สำหรับ .myPopupupload ถูกคลิก! .sideupload แสดง.');
    });
    $addAndHideBtns4.on('click', function () { // myPopupadd -> sideadd
        hidePopup($myPopupsAdd);
        setTimeout(() => {
            currentMainPopup = $myPopupsAdd;
            showPopup($sideadds);
            // โหลดข้อมูลสินค้าเมื่อเปิด popup search
            loadProductSearchData();
        }, TRANSITION_DURATION);
        console.log('Div "เพิ่ม" สำหรับ .myPopupadd ถูกคลิก! .sideadd แสดง.');
    });
    $addAndHideBtns11.on('click', function () { // myPopupadddeopsit -> sidetable
        hidePopup($myPopupsAddDeposit);
        setTimeout(() => {
            currentMainPopup = $myPopupsAddDeposit;
            showPopup($sidetables);
            loadProductSearchData();
        }, TRANSITION_DURATION);
        console.log('Div "เพิ่ม" สำหรับ .myPopupsadddeopsit ถูกคลิก! .sidetable แสดง.');
    });
    // ปุ่มที่ปิด Pop-up หลักที่เกี่ยวข้องทันที
    $addAndHideBtns2.on('click', function () { hidePopup($myPopupsPenView); console.log('Div "เพิ่ม" สำหรับ .myPopuppenview ถูกคลิก! และปิด Popup หลัก'); });
    $addAndHideBtns3.on('click', function () { hidePopup($myPopupsView); console.log('Div "เพิ่ม" สำหรับ .myPopupview ถูกคลิก! และปิด Popup หลัก'); });
    $addAndHideBtns5.on('click', function () { hidePopup($myPopupsEditPen); console.log('Div "เพิ่ม" สำหรับ .myPopupeditpen ถูกคลิก! และปิด Popup หลัก'); });
    $addAndHideBtns6.on('click', function () { hidePopup($myPopupsDeposit); console.log('Div "เพิ่ม" สำหรับ .myPopupdeposit ถูกคลิก! และปิด Popup หลัก'); });
    $addAndHideBtns7.on('click', function () { hidePopup($myPopupsAddDate); console.log('Div "บันทึก" สำหรับ .myPopupadddate ถูกคลิก! และปิด Popup หลัก'); });
    $addAndHideBtns8.on('click', function () { hidePopup($myPopupsViewDate); console.log('Div "เพิ่ม" สำหรับ .myPopupviewdate ถูกคลิก! และปิด Popup หลัก'); });
    $addAndHideBtns9.on('click', function () { hidePopup($myPopupsAddSum); console.log('Div "เพิ่ม" สำหรับ .myPopupaddsum ถูกคลิก! และปิด Popup หลัก'); });
    $addAndHideBtns10.on('click', function () { 
        // เปลี่ยนข้อความในช่อง input เมื่อกดปุ่ม save
        if (window.selectedProductCode) {
            $('#salesOrderCodeInput').val(window.selectedProductCode).trigger('input').trigger('change');
        }
        // ล้างช่องค้นหา productSearchInput2
        $('#productSearchInput2').val('');
        hidePopup($myPopupsSalesOrder); 
        console.log('Div "เพิ่ม" สำหรับ .myPopupsalesorder ถูกคลิก! และปิด Popup หลัก'); 
    });
    $addAndHideBtns12.on('click', function () { hidePopup($myPopupsSelectReceive); console.log('Div "เพิ่ม" สำหรับ .myPopupselectreceive ถูกคลิก! และปิด Popup หลัก'); });
    $addAndHideBtns13.on('click', function () { hidePopup($myPopupsSelectBill); console.log('Div "เพิ่ม" สำหรับ .myPopupselectbill ถูกคลิก! และปิด Popup หลัก'); });
    $addAndHideBtns14.on('click', function () { hidePopup($myPopupsTableSum); console.log('Div "เพิ่ม" สำหรับ .myPopup14 ถูกคลิก! และปิด Popup หลัก'); });
    $addAndHideBtnsTableBillingSlip.on('click', function () { hidePopup($myPopupsTableBillingSlip); console.log('Div "เพิ่ม" สำหรับ .myPopupsTableBillingSlip ถูกคลิก! และปิด Popup หลัก'); });
    $addAndHideBtnsViewInvoice.on('click', function () { hidePopup($myPopupsViewInvoice); console.log('Div "เพิ่ม" สำหรับ .myPopupsviewinvoice ถูกคลิก! และปิด Popup หลัก'); });
    // --- ตั้งค่า Event Listeners สำหรับ Pop-up ย่อย (.sideupload, .sideadd, .sidetable) ---
    // Event listeners สำหรับ sideupload
    $sideuploadCancelBtns.on('click', function () { hideSideuploadAndShowMainPopup(); console.log('Div "ยกเลิก" ใน Popup ที่ 2 (.sideupload) ถูกคลิก! กลับไปที่ Popup หลักก่อนหน้า.'); });
    $sideuploadSaveBtns.on('click', function () { hideSideuploadAndShowMainPopup(); console.log('Div "บันทึก" ใน Popup ที่ 2 (.sideupload) ถูกคลิก! กลับไปที่ Popup หลักก่อนหน้า.'); });
    $uploadFileBtns.on('click', function () { console.log('Div "อัปโหลดไฟล์" ใน Popup ที่ 2 (.sideupload) ถูกคลิก!'); hideSideuploadAndShowMainPopup(); });
    $openEditBtns.on('click', function () { console.log('Div "Open Edit" ใน Popup ที่ 2 (.sideupload) ถูกคลิก!'); hideSideuploadAndShowMainPopup(); });
    $newBtns1.on('click', function () { console.log('Div "Div 1" ใน Popup ที่ 2 (.sideupload) ถูกคลิก!'); hideSideuploadAndShowMainPopup(); });
    $newBtns2.on('click', function () { console.log('Div "Div 2" ใน Popup ที่ 2 (.sideupload) ถูกคลิก!'); hideSideuploadAndShowMainPopup(); });
    $newBtns3.on('click', function () { console.log('Div "Div 3" ใน Popup ที่ 2 (.sideupload) ถูกคลิก!'); hideSideuploadAndShowMainPopup(); });
    $newBtns4.on('click', function () { console.log('Div "Div 4" ใน Popup ที่ 2 (.sideupload) ถูกคลิก!'); hideSideuploadAndShowMainPopup(); });
    $newBtns5.on('click', function () { console.log('Div "Div 5" ใน Popup ที่ 2 (.sideupload) ถูกคลิก!'); hideSideuploadAndShowMainPopup(); });
    // Event listeners สำหรับ sideadd
    $sideaddCancelBtns.on('click', function () { hideSideaddAndShowMainPopup($myPopupsAdd); console.log('Div "ยกเลิก" ใน .sideadd ถูกคลิก! กลับไปที่ .myPopupadd.'); });
    $sideaddSaveBtns.on('click', function () { 
        // ตรวจสอบว่ามี tax_withheld หรือไม่ ถ้ามีให้ติ๊ก checkbox ภาษีหัก ณ ที่จ่าย
        const taxWithheldValue = parseFloat($('#tax_withheld').val()) || 0;
        console.log('tax_withheld value:', taxWithheldValue);
        if (taxWithheldValue > 0) {
            $('#list-tax-data-2').prop('checked', true);
            console.log('ติ๊ก checkbox ภาษีหัก ณ ที่จ่าย เนื่องจากมี tax_withheld');
            console.log('Checkbox status after ticking:', $('#list-tax-data-2').is(':checked'));
            
            // ติ๊ก checkbox แล้วให้คำนวณทันที
            isPopupCalculation = false;
            calculateTotalSummary();
        } else {
            // ไม่มี tax_withheld ให้คำนวณปกติ
            isPopupCalculation = false;
            calculateTotalSummary();
        }
        
        hideSideaddAndShowMainPopup($myPopupsAdd); 
        console.log('Div "เพิ่ม" ใน .sideadd ถูกคลิก! กลับไปที่ .myPopupadd.'); 
    });
    // Event listeners สำหรับ sidetable
    if ($sidetables.length) { // ตรวจสอบว่ามีองค์ประกอบนี้อยู่จริง
        $sidetableCancelBtns.on('click', function () { 
            // ล้างช่องค้นหา productSearchInput
            $('#productSearchInput').val('');
            hideSidetableAndShowMainPopup(currentMainPopup); 
            console.log('Div "ยกเลิก" ใน .sidetable ถูกคลิก! กลับไปที่ Popup หลักก่อนหน้า.'); 
        });
        $sidetableSaveBtns.on('click', function () { 
            // ล้างช่องค้นหา productSearchInput
            $('#productSearchInput').val('');
            hideSidetableAndShowMainPopup(currentMainPopup); 
            console.log('Div "บันทึก" ใน .sidetable ถูกคลิก! กลับไปที่ Popup หลักก่อนหน้า.'); 
        });
    }
    // --- Event Listeners สำหรับปุ่ม "เพิ่ม" (ซ่อน Pop-up) ---
    $hidePopupAdd11.on('click', function () { 
        // เรียกใช้ฟังก์ชันเพิ่มข้อมูลเงินมัดจำ
        addProductToDatabase();
        console.log('ปุ่ม .hidePopupadd11 ถูกคลิก! เพิ่มข้อมูลเงินมัดจำและซ่อน .myPopup11.'); 
    });
    $hidePopupAdd12.on('click', function () { hidePopup($myPopupsSelectReceive); console.log('ปุ่ม .hidePopupadd12 ถูกคลิก! ซ่อน .myPopupselectreceive.'); });
    $hidePopupAdd13.on('click', function () { hidePopup($myPopupsSelectBill); console.log('ปุ่ม .hidePopupadd13 ถูกคลิก! ซ่อน .myPopupselectbill.'); });
    $hidePopupAdd14.on('click', function () { hidePopup($myPopupsTableSum); console.log('ปุ่ม .hidePopupadd14 ถูกคลิก! ซ่อน .myPopup14.'); });
    $hidePopupAddTableBillingSlip.on('click', function () { hidePopup($myPopupsTableBillingSlip); console.log('ปุ่ม .hidePopupAddTableBillingSlip ถูกคลิก! ซ่อน .myPopupsTableBillingSlip.'); });
    $hidePopupAddViewInvoice.on('click', function () { hidePopup($myPopupsViewInvoice); console.log('ปุ่ม .hidePopupAddViewInvoice ถูกคลิก! ซ่อน .myPopupsviewinvoice.'); });
    // --- จัดการสีของ Dropdown (select) เมื่อมีการเลือกค่า ---
    // รวม .right-under-long, .right-under, .modal-select เข้าด้วยกันใน event listener เดียว
    $('.right-under-long, .right-under, .modal-select').on('change', function() {
        // ตรวจสอบค่าที่เลือก ถ้าเป็นค่าเริ่มต้นที่แสดงว่ายังไม่ได้เลือก (เช่น "เลือกประเภทเอกสาร", "เลือก...", หรือสตริงว่าง)
        // ให้ลบคลาสที่เปลี่ยนสีออก เพื่อให้กลับไปใช้สีเริ่มต้น
        if ($(this).val() === 'เลือกประเภทเอกสาร' || $(this).val() === 'เลือก...' || $(this).val() === '') {
            $(this).removeClass('text-black-select-modal');
            // หากคุณต้องการเปลี่ยนสีด้วย CSS variable โดยตรงเมื่อไม่ได้เลือก
            $(this).css('color', ''); // ลบ inline style เพื่อให้ CSS เดิมมีผล
        } else {
            // ถ้ามีการเลือกค่าอื่นที่ไม่ใช่ค่าเริ่มต้น ให้เพิ่มคลาสเพื่อเปลี่ยนสี
            $(this).addClass('text-black-select-modal');
            // หรือเปลี่ยนสีด้วย CSS variable โดยตรง
            $(this).css('color', 'var(--input-text-black)');
        }
    });
    // ตั้งค่าสีเริ่มต้นของ dropdowns เมื่อหน้าโหลด (ถ้ามีค่าที่ถูกเลือกอยู่แล้ว)
    // ลูปผ่านทุก dropdown ที่เกี่ยวข้องเพื่อตั้งค่าสีตามค่าปัจจุบัน
    $('.right-under-long, .right-under, .modal-select').each(function() {
        if ($(this).val() !== 'เลือกประเภทเอกสาร' && $(this).val() !== 'เลือก...' && $(this).val() !== '') {
            $(this).addClass('text-black-select-modal');
            // $(this).css('color', 'var(--input-text-black)');
        } else {
            $(this).removeClass('text-black-select-modal');
            $(this).css('color', '');
        }
    });
});
 
        $(document).ready(function () {
    // เริ่มต้น: แสดง noDataSection ซ่อน myPopupview
    $('#noDataSection').show();
    $('#myPopupview').hide();


    // เมื่อกดปุ่มตกลง
    $('#btnConfirmAdd').on('click', function () {
        $('#noDataSection').hide();      // ซ่อนไม่มีข้อมูล
        $('#myPopupview').show();        // แสดงข้อมูลที่เพิ่มแล้ว
    });
});

$(document).ready(function () {
    // เมื่อคลิกปุ่มเพิ่มรายการ
    $('.openPopupBtnadd').on('click', function () {
        $('#popupAddItem').fadeIn(); // แสดง popup เท่านั้น
        $('.data-table-product').show(); // สำรอง: เผื่อเคยถูกซ่อน
    });

    // ปิด popup
    $('#closePopup').on('click', function () {
        $('#popupAddItem').fadeOut();
    });
});

$(document).ready(function () {
    const navEntries = performance.getEntriesByType("navigation");
    const isReload = navEntries.length > 0 && navEntries[0].type === "reload";

    if (isReload) {
        localStorage.clear(); // หรือ remove เฉพาะ key ที่เกี่ยวข้อง
    }
     const Department = localStorage.getItem('customerDepartment') || '';
$('#customerDepartment').val(Department);

// ถ้ามีค่าจริง แสดงว่าเลือกแล้ว → ให้เปลี่ยนสีเป็นดำ
if (Department) {
    $('#customerDepartment').css('color', 'black');
}
     const Day = localStorage.getItem('customerDay') || '';
$('#customerDay').val(Day);

// ถ้ามีค่าจริง แสดงว่าเลือกแล้ว → ให้เปลี่ยนสีเป็นดำ
if (Day) {
    $('#customerDay').css('color', 'black');
}
     const Dayfully = localStorage.getItem('customerDayfully') || '';
$('#customerDayfully').val(Dayfully);

// ถ้ามีค่าจริง แสดงว่าเลือกแล้ว → ให้เปลี่ยนสีเป็นดำ
if (Dayfully) {
    $('#customerDayfully').css('color', 'black');
}
const Employee = localStorage.getItem('customerEmployee') || '';
$('#customerEmployee').val(Employee);

// ถ้ามีค่าจริง แสดงว่าเลือกแล้ว → ให้เปลี่ยนสีเป็นดำ
if (Employee) {
    $('#customerEmployee').css('color', 'black');
}
const County = localStorage.getItem('customerCounty') || '';
$('#customerCounty').val(County);

// ถ้ามีค่าจริง แสดงว่าเลือกแล้ว → ให้เปลี่ยนสีเป็นดำ
if (County) {
    $('#customerCounty').css('color', 'black');
}
const Express = localStorage.getItem('customerExpress') || '';
$('#customerExpress').val(Express);

// ถ้ามีค่าจริง แสดงว่าเลือกแล้ว → ให้เปลี่ยนสีเป็นดำ
if (Express) {
    $('#customerExpress').css('color', 'black');
}
const PriceandTax = localStorage.getItem('customerPriceandTax') || '';
$('#customerPriceandTax').val(PriceandTax);

// ถ้ามีค่าจริง แสดงว่าเลือกแล้ว → ให้เปลี่ยนสีเป็นดำ
if (PriceandTax) {
    $('#customerPriceandTax').css('color', 'black');
}
const Currency = localStorage.getItem('customerCurrency') || '';
$('#customerCurrency').val(Currency);

// ถ้ามีค่าจริง แสดงว่าเลือกแล้ว → ให้เปลี่ยนสีเป็นดำ
if (Currency) {
    $('#customerCurrency').css('color', 'black');
}
const Claim = localStorage.getItem('customerClaim') || '';
$('#customerClaim').val(Claim);

// ถ้ามีค่าจริง แสดงว่าเลือกแล้ว → ให้เปลี่ยนสีเป็นดำ
if (Claim) {
    $('#customerClaim').css('color', 'black');
}
const DayBill = localStorage.getItem('customerDayBill') || '';
$('#customerDayBill').val(Claim);

// ถ้ามีค่าจริง แสดงว่าเลือกแล้ว → ให้เปลี่ยนสีเป็นดำ
if (DayBill) {
    $('#customerDayBill').css('color', 'black');
}
const Dayget = localStorage.getItem('customerDayget') || '';
$('#customerDayget').val(Claim);

// ถ้ามีค่าจริง แสดงว่าเลือกแล้ว → ให้เปลี่ยนสีเป็นดำ
if (Dayget) {
    $('#customerDayget').css('color', 'black');
}
const Salesperson = localStorage.getItem('customerSalesperson') || '';
$('#customerDayget').val(Salesperson);

// ถ้ามีค่าจริง แสดงว่าเลือกแล้ว → ให้เปลี่ยนสีเป็นดำ
if (Salesperson) {
    $('#customerSalesperson').css('color', 'black');
}
const Status = localStorage.getItem('customerStatus') || '';
$('#customerStatus').val(Status);

// ถ้ามีค่าจริง แสดงว่าเลือกแล้ว → ให้เปลี่ยนสีเป็นดำ
if (Status) {
    $('#customerStatus').css('color', 'black');
}
const Noteunder = localStorage.getItem('customerNoteunder') || '';
$('#customerNoteunder').val(Noteunder);

// ถ้ามีค่าจริง แสดงว่าเลือกแล้ว → ให้เปลี่ยนสีเป็นดำ
if (Noteunder) {
    $('#customerNoteunder').css('color', 'black');
}


    $('#customerCode').val(localStorage.getItem('customerCode') || '');
    $('#customerName').val(localStorage.getItem('customerName') || '');
    $('#customerAddress').val(localStorage.getItem('customerAddress') || '');
    $('#customerPhone').val(localStorage.getItem('customerPhone') || '');
    $('#customerHeadOffice').val(localStorage.getItem('customerHeadOffice') || '');
    $('#customerContactName').val(localStorage.getItem('customerContactName') || '');
    $('#customerGmail').val(localStorage.getItem('customerGmail') || '');
    $('#customerRefer').val(localStorage.getItem('customerRefer') || '');
    $('#customerBranchCode').val(localStorage.getItem('customerBranchCode') || '');
    $('#customerBranchName').val(localStorage.getItem('customerBranchName') || '');
    
    // อัปเดตชื่อลูกค้าใน dropdown เมื่อโหลดข้อมูลจาก localStorage
    const customerName = localStorage.getItem('customerName') || '';
    if (customerName) {
        updateCustomerNameDropdown(customerName);
    }
    
    // อัปเดตเลขประจำตัวผู้เสียภาษีใน dropdown เมื่อโหลดข้อมูลจาก localStorage
    const vatNo = localStorage.getItem('vat_no') || '';
    if (vatNo) {
        updateTaxIdDropdown(vatNo);
    }
    
    // อัปเดตเลขประจำตัวผู้เสียภาษี ประเภทธุรกิจ/คำนำหน้า แผนก และยื่นภาษีรวมในงวดที่ใน dropdown จาก cus_detail ใน localStorage
    const quotationData = localStorage.getItem('quotationData');
    if (quotationData) {
        try {
            const data = JSON.parse(quotationData);
            if (data.cus_detail) {
                if (data.cus_detail.vat_no) {
                    updateTaxIdDropdown(data.cus_detail.vat_no);
                }
                if (data.cus_detail.type_business) {
                    updateBusinessTypeDropdown(data.cus_detail.type_business);
                }
                if (data.cus_detail.type_department) {
                    updateDepartmentDropdown(data.cus_detail.type_department);
                }
                if (data.cus_detail.tax_period) {
                    updateTaxPeriodDropdown(data.cus_detail.tax_period);
                }
                if (data.cus_detail.tax_date) {
                    $('#taxDate').val(data.cus_detail.tax_date);
                }
                if (data.cus_detail.tax_invoice_no) {
                    $('#taxInvoiceNo').val(data.cus_detail.tax_invoice_no);
                }
            }
        } catch (error) {
            console.log('Error parsing quotationData:', error);
        }
    }
    
    // อัปเดตประเภทธุรกิจ/คำนำหน้าใน dropdown เมื่อโหลดข้อมูลจาก localStorage
    const typeBusiness = localStorage.getItem('type_business') || '';
    if (typeBusiness) {
        updateBusinessTypeDropdown(typeBusiness);
    }
    
    // อัปเดตแผนกใน dropdown เมื่อโหลดข้อมูลจาก localStorage
    const typeDepartmen = localStorage.getItem('type_department') || '';
    if (typeDepartmen) {
        updateDepartmentDropdown(typeDepartmen);
    }
    
    // อัปเดตยื่นภาษีรวมในงวดที่ใน dropdown เมื่อโหลดข้อมูลจาก localStorage
    const taxPeriod = localStorage.getItem('tax_period') || '';
    if (taxPeriod) {
        updateTaxPeriodDropdown(taxPeriod);
    }
    
    // อัปเดตวันที่เมื่อโหลดข้อมูลจาก localStorage
    const taxDate = localStorage.getItem('tax_date') || '';
    if (taxDate) {
        $('#taxDate').val(taxDate);
    }
    
    // อัปเดตเลขใบกำกับภาษีเมื่อโหลดข้อมูลจาก localStorage
    const taxInvoiceNo = localStorage.getItem('tax_invoice_no') || '';
    if (taxInvoiceNo) {
        $('#taxInvoiceNo').val(taxInvoiceNo);
    }
    
    // โหลดสถานะตัดมัดจำเรียบร้อยจาก localStorage
    const quotationDataForDeposit = localStorage.getItem('quotationData');
    if (quotationDataForDeposit) {
        try {
            const data = JSON.parse(quotationDataForDeposit);
            if (data.payment_detail) {
                let paymentDetail;
                if (typeof data.payment_detail === 'string') {
                    paymentDetail = JSON.parse(data.payment_detail);
                } else {
                    paymentDetail = data.payment_detail;
                }
                
                const depositDeduction = paymentDetail?.deposit_deduction;
                if (depositDeduction !== undefined) {
                    $('#toggleBox').prop('checked', depositDeduction);
                    if (depositDeduction) {
                        $('#myBox').addClass('show');
                    } else {
                        $('#myBox').removeClass('show');
                    }
                }
            }
        } catch (error) {
            console.log('Error loading deposit_deduction from localStorage:', error);
        }
    }
    
    // โหลดจาก localStorage เดิม (fallback)
    const depositDeductionStatus = localStorage.getItem('deposit_deduction');
    if (depositDeductionStatus !== null) {
        const isChecked = depositDeductionStatus === 'true';
        $('#toggleBox').prop('checked', isChecked);
        if (isChecked) {
            $('#myBox').addClass('show');
        } else {
            $('#myBox').removeClass('show');
        }
    }
    
    // โหลดข้อมูลธนาคารจาก localStorage
    if (quotationDataForDeposit) {
        try {
            const data = JSON.parse(quotationDataForDeposit);
            if (data.payment_detail) {
                let paymentDetail;
                if (typeof data.payment_detail === 'string') {
                    paymentDetail = JSON.parse(data.payment_detail);
                } else {
                    paymentDetail = data.payment_detail;
                }
                
                // โหลดข้อมูลธนาคาร
                if (paymentDetail.bank_payment_amount !== undefined) {
                    $('#bankPaymentAmount').val(paymentDetail.bank_payment_amount);
                }
                if (paymentDetail.bank_name !== undefined) {
                    // หา option ที่มี text ตรงกับ bank_name และเลือก
                    $('#bankDropdown option').each(function() {
                        if ($(this).text() === paymentDetail.bank_name) {
                            $(this).prop('selected', true);
                        }
                    });
                    // เปลี่ยนสีเป็นดำเมื่อมีข้อมูลธนาคาร
                    if (paymentDetail.bank_name) {
                        $('#bankDropdown').addClass('active-color');
                    }
                }
                if (paymentDetail.bank_account_number !== undefined) {
                    $('#bankAccountNumber').val(paymentDetail.bank_account_number);
                }
                if (paymentDetail.deposit_cut_date !== undefined) {
                    $('#depositCutDate').val(paymentDetail.deposit_cut_date);
                    if (paymentDetail.deposit_cut_date) {
                        $('#depositCutDate').css('color', 'black');
                    }
                }
                if (paymentDetail.bank_payment_date !== undefined) {
                    $('#bankPaymentDate').val(paymentDetail.bank_payment_date);
                    if (paymentDetail.bank_payment_date) {
                        $('#bankPaymentDate').css('color', 'black');
                    }
                }
                if (paymentDetail.bank_payment_time !== undefined) {
                    $('#bankPaymentTime').val(paymentDetail.bank_payment_time);
                    if (paymentDetail.bank_payment_time) {
                        $('#bankPaymentTime').css('color', 'black');
                    }
                }
            }
        } catch (error) {
            console.log('Error loading bank data from localStorage:', error);
        }
    }
    $('#customerStatus').val(localStorage.getItem('customerStatus') || '');
    $('#customerDay').val(localStorage.getItem('customerDay') || '');
    $('#customerDayfully').val(localStorage.getItem('customerDayfully') || '');
    $('#customerDueDate').val(localStorage.getItem('customerDueDate') || '');
    $('#customerDepartment').val(localStorage.getItem('customerDepartment') || '');
    $('#customerSalesperson').val(localStorage.getItem('customerSalesperson') || '');
    $('#customerPriceandTax').val(localStorage.getItem('customerPriceandTax') || '');
    $('#customerDepositReceiptNumber').val(localStorage.getItem('customerDepositReceiptNumber') || '');
    $('#customerCurrency').val(localStorage.getItem('customerCurrency') || '');
    $('#customerCredithistory').val(localStorage.getItem('customerCredithistory') || '');
    $('#customerEmployee').val(localStorage.getItem('customerEmployee') || '');
    $('#customerCounty').val(localStorage.getItem('customerCounty') || '');
    $('#customerExpress').val(localStorage.getItem('customerExpress') || '');
    $('#customerClaim').val(localStorage.getItem('customerClaim') || '');
    $('#customerDayBill').val(localStorage.getItem('customerDayBill') || '');
    $('#customerDayget').val(localStorage.getItem('customerDayget') || '');
    $('#customerRemark').val(localStorage.getItem('customerRemark') || '');
    $('#customerNoteunder').val(localStorage.getItem('customerNoteunder') || '');
    $('#vat_no').val(localStorage.getItem('vat_no') || '');
    $('#type_business').val(localStorage.getItem('type_business') || '');

    // ตรวจสอบสถานะการออกใบกำกับภาษีจากฐานข้อมูล
    loadTaxInvoiceStatusFromDB();
    
    // ตั้งค่าให้ checkbox ภาษี 7% ถูกติ๊กไว้ตั้งแรก
    $('#list-tax-data').prop('checked', true);

    // ตรวจสอบสถานะจาก localStorage เมื่อโหลดหน้า
    var showMyPopupview = localStorage.getItem('showMyPopupview');
    
    if (showMyPopupview === 'true') {
        // ถ้าเคยกดตกลงแล้ว แสดง myPopupview
        $('#noDataSection').hide();
        $('#myPopupview').show();
    } else {
        // เริ่มต้น: แสดง noDataSection ซ่อน myPopupview
        $('#noDataSection').show();
        $('#myPopupview').hide();
    }

    // เมื่อกดปุ่มตกลง (btnConfirmAdd)
    $('#btnConfirmAdd').on('click', function () {
        $('#noDataSection').hide();      // ซ่อนส่วนไม่มีข้อมูล
        $('#myPopupview').show();        // แสดงข้อมูลที่เพิ่มแล้ว
        $('#popupAddItem').fadeOut();    // ปิด popup หลังจากกดตกลง
        
        // เก็บสถานะใน localStorage
        localStorage.setItem('showMyPopupview', 'true');
    });

    // เมื่อคลิกปุ่มเพิ่มรายการ
    $('.openPopupBtnadd').on('click', function () {
        $('#popupAddItem').fadeIn(); // แสดง popup เท่านั้น
        $('.data-table-product').show(); // สำรอง: เผื่อเคยถูกซ่อน
    });

    // ปิด popup (กดปุ่มปิด)
    $('#closePopup').on('click', function () {
        $('#popupAddItem').fadeOut();
    });

    // ฟังก์ชันสำหรับรีเซ็ตกลับไปสถานะเริ่มต้น (สำหรับใช้ในกรณีพิเศษ)

    // ฟังก์ชันสำหรับรีเซ็ตกลับไปสถานะเริ่มต้น (สำหรับใช้ในกรณีพิเศษ)
    function resetToInitialState() {    
        $('#noDataSection').show();
        $('#myPopupview').hide();
        $('#popupAddItem').fadeOut();
        localStorage.removeItem('showMyPopupview');
    }
});



// ฟังก์ชันสำหรับแปลงรูปแบบวันที่ให้เหมาะกับ input[type="date"]
function formatDateForInput(dateStr) {
    if (!dateStr) return '';
    
    // ถ้าเป็นรูปแบบ DD/MM/YY หรือ DD/MM/YYYY
    if (dateStr.includes('/')) {
        const parts = dateStr.split('/');
        if (parts.length === 3) {
            let day = parts[0].padStart(2, '0');
            let month = parts[1].padStart(2, '0');
            let year = parts[2];
            
            // ถ้าปีเป็น 2 หลัก ให้แปลงเป็น 4 หลัก
            if (year.length === 2) {
                year = '20' + year;
            }
            
            return `${year}-${month}-${day}`;
        }
    }
    
    // ถ้าเป็นรูปแบบ YYYY-MM-DD อยู่แล้ว
    if (dateStr.includes('-') && dateStr.split('-')[0].length === 4) {
        return dateStr;
    }
    
    return dateStr;
}

    // ฟังก์ชันสำหรับล้างข้อมูลแก้ไข
function clearEditData() {
    localStorage.removeItem('editQuotationId');
    localStorage.removeItem('editQuotationData');
    window.editQuotationId = null;
}

/* ===========================================
   API CONFIGURATION & UTILITIES
   =========================================== */

// API Endpoint Configuration
let endpoint = 'http://localhost:3000';

/**
 * ฟังก์ชันแปลงค่าสถานะจาก dropdown (ภาษาไทย) เป็นค่าในฐานข้อมูล (English)
 * @param {string} selectedStatus - สถานะที่เลือก (รออนุมัติ/อนุมัติ/ไม่อนุมัติ)
 * @returns {string} ค่าสถานะภาษาอังกฤษ
 */
function getStatusValue(selectedStatus) {
    const statusMap = {
        'รออนุมัติ': 'pending',
        'อนุมัติ': 'approved',
        'ไม่อนุมัติ': 'rejected'
    };
    return statusMap[selectedStatus] || 'pending';
}

/**
 * ฟังก์ชันแปลงค่าสถานะจากฐานข้อมูล (English) เป็นภาษาไทย
 * @param {string} statusValue - ค่าสถานะในฐานข้อมูล
 * @returns {string} ข้อความสถานะภาษาไทย
 */
function getStatusText(statusValue) {
    const textMap = {
        'pending': 'รออนุมัติ',
        'approved': 'อนุมัติ',
        'rejected': 'ไม่อนุมัติ'
    };
    return textMap[statusValue] || 'รออนุมัติ';
}
/* ===========================================
   QUOTATION CRUD OPERATIONS
   =========================================== */

/**
 * ฟังก์ชันสร้างใบเสนอราคาใหม่
 * รวบรวมข้อมูลจากฟอร์มและส่งไป API
 */
function createQuotation() {
    // รวบรวมข้อมูลจากฟอร์มทั้งหมด
    const formData = {
        tx: $('#customerDepositReceiptNumber').val() || '', // ประเภทเอกสาร
        doc_status: getStatusValue($('').val()), //สถานะเอกสาร
        status: $('#customerStatus').val() || '', //สถานะเอกสาร
        com_id: '3', // ใช้ค่า 1 เสมอ
        doc_name: 'ใบรับเงินมัดจำ', // ใช้ค่า "ใบรับเงินมัดจำ" เสมอ
        cus_no: $('#customerCode').val() || '', //รหัสลูกค้า
        cus_name: $('#customerName').val() || '', //ชื่อลูกค้า
        cus_detail: JSON.stringify({ //รายละเอียดลูกค้า
            cus_no: $('#customerCode').val() || '', //รหัสลูกค้า
            cus_name: $('#customerName').val() || '', //ชื่อลูกค้า
            cus_addr: $('#customerAddress').val() || '', //ที่อยู่ลูกค้า
            cus_phone: $('#customerPhone').val() || '', //หมายเลขโทรศัพท์ลูกค้า
            cus_business_location: $('#customerHeadOffice').val() || '', //ที่ตั้งธุรกิจ
            cus_email: $('#customerGmail').val() || '', //อีเมลลูกค้า
            cus_contact_name: $('#customerContactName').val() || '', //ชื่อผู้ติดต่อ
            cus_refer: $('#customerRefer').val() || '', //อ้างอิง 
            cus_head_office: $('#big-office').is(':checked'), // true = สำนักงานใหญ่, false = สาขาย่อย
            cus_branch_no: $('#customerBranchCode').val() || '', //รหัสสาขาสำนักงานใหญ่
            cus_branch_name: $('#customerBranchName').val() || '', //ชื่อสาขาย่อย
            cus_visits: $('#list-tax-data-3').is(':checked'), //ลายเซ็นต์อิเล็กทรอนิกและตรายาง
            vat_no: $('#taxIdDropdown').val() || '', //เลขประจำตัวผู้เสียภาษี
            type_business: $('#businessTypeDropdown option:selected').text() || $('#businessTypeDropdown').val() || '', //ประเภทธุรกิจ/คำนำหน้า
            type_department: $('#departmentDropdown option:selected').text() || $('#departmentDropdown').val() || '', //แผนก
            tax_period: $('#taxPeriodDropdown option:selected').text() || $('#taxPeriodDropdown').val() || '', //ยื่นภาษีรวมในงวดที่
            tax_date: $('#taxDate').val() || '', //วันที่
            tax_invoice_no: $('#taxInvoiceNo').val() || '', //เลขใบกำกับภาษี
        }),
        payment_detail: JSON.stringify({
            payment_payee_name: $('#paymentPayeeName').val() || '',
            payment_amount: $('#paymentAmount').val() || '',
            payment_description: $('#paymentDescription').val() || '',
            payment_date: $('#paymentDate').val() || '',
            payment_time: $('#paymentTime').val() || '',
            deposit_deduction: $('#toggleBox').is(':checked'), //ตัดมัดจำเรียบร้อย
            bank_payment_amount: $('#bankPaymentAmount').val() || '', //จำนวนเงินรับชำระ (บาท) - ธนาคาร
            bank_name: $('#bankDropdown option:selected').text() || '', //ชื่อธนาคาร
            bank_account_number: $('#bankAccountNumber').val() || '', //เลขบัญชี
            bank_payment_date: $('#bankPaymentDate').val() || '', //วันที่ชำระ - ธนาคาร
            bank_payment_time: $('#bankPaymentTime').val() || '', //เวลา - ธนาคาร
            deposit_cut_date: $('#depositCutDate').val() || '', //วันที่ตัดเงินมัดจำ
            // ข้อมูลสรุปการชำระเงิน
            payment_summary: {
                total_with_tax: $('#cut-total').text().replace(/,/g, '') || '0', //มูลค่ารวมภาษี
                withholding_tax: $('#cut-vat').text().replace(/,/g, '') || '0', //ภาษีถูกหัก ณ ที่จ่าย
                remaining_amount: $('#cut-remaining').text().replace(/,/g, '') || '0', //ยอดคงค้าง
                paid_amount: $('#cut-paid').text().replace(/,/g, '') || '0', //ยอดที่ตัดไปแล้ว
                total_payment: $('#cut-total-sum').text().replace(/,/g, '') || '0' //ชำระรวมทั้งสิ้น
            },
            deposit_due_date: $('#customerDayfully').val() || '', //รับชำระครบเมื่อวันที่
            selected_payment_method: getCurrentActivePage() //วิธีการชำระเงินที่เลือก (page1=เงินสด, page2=ธนาคาร)
        }),
        doc_date: $('#customerDay').val() || new Date().toISOString().split('T')[0], //วันที่เอกสาร
        due_date: $('#customerDayfully').val() || '', //วันครบกำหนด
        // sending_date: $('').val() || '', //วันที่ส่ง
        // pickup_date: $('').val() || '', //วันที่รับ
        doc_date: $('#customerDay').val() || '', //วันที่ส่ง
        due_date: $('#customerDayfully').val() || '', //วันที่รับ
        doc_detail: JSON.stringify({ //รายละเอียดเอกสาร
            doc_date: $('#customerDay').val() || new Date().toISOString().split('T')[0], //วันที่เอกสาร
            due_date: $('#customerDayfully').val() || '', //วันครบกำหนด
            deadline: $('#customerDueDate').val() || '', // กำหนดยืน วัน
            department: $('#customerDepartment').val() || '', //ฝ่าย
            salesman: $('#customerSalesperson').val() || '', //พนักงานขาย
            data_price_tax: $('#customerPriceandTax').val() || '', //ราคาและภาษี
            currency: $('#customerCurrency').val() || '', //สกุลเงิน
            sales_order_code: $('#salesOrderCodeInput').val() || '', //รหัสใบสั่งขาย
            credit_history: $('#customerCredithistory').val() || '', //เครดิตจากประวัติชำระเงินของ
            tax_invoice: $('#toggle-btn-2').is(':checked') //การออกใบกำกับภาษี
        }),
        product_detail: (() => {
            const totals = calculateTotalSummary();
            
            return {
                product_totalAllProducts: totals.totalAllProducts, //ราคาสุทธิทั้งหมด
                product_totalDiscount: totals.totalDiscount, //ส่วนลดทั้งหมด
                product_totalAfterDiscount: totals.totalAfterDiscount, //ราคาสุทธิหลังหักส่วนลด
                product_totalTax: totals.totalTax, //ภาษีมูลค่าเพิ่ม 7%
                product_withholdingTax: totals.withholdingTax, //ภาษีถูกหัก ณ ที่จ่าย อันแรก
                product_withholdingTax2: totals.withholdingTax2, //ภาษีถูกหัก ณ ที่จ่าย อันที่สอง
                product_withholdingTax3: totals.withholdingTax3, //ภาษีถูกหัก ณ ที่จ่าย อันที่สาม
                product_totalAll: totals.totalAll, //ราคารวมทั้งหมด
                // เพิ่มสถานะ checkbox
                vat7_checked: $('#list-tax-data').is(':checked'), //สถานะ checkbox ภาษีมูลค่าเพิ่ม 7%
                withholding_tax_checked: $('#list-tax-data-2').is(':checked'), //สถานะ checkbox ภาษีถูกหัก ณ ที่จ่าย
                withholding_tax_rate: $('#tax_withheld').val() || '0.0%', //อัตราภาษีถูกหัก ณ ที่จ่าย อันแรก
                withholding_tax_rate2: $('#tax_withheld2').val() || '0.0%', //อัตราภาษีถูกหัก ณ ที่จ่าย อันที่สอง
                withholding_tax_rate3: $('#tax_withheld3').val() || '0.0%', //อัตราภาษีถูกหัก ณ ที่จ่าย อันที่สาม
                delete_vat: parseFloat($('#delete-vat').val()) || 0, //จำนวนที่ลบออกจากยอดรวม
                product_selection_status: allProductData.map(product => ({
                    id: product.id,
                    isSelected: product.isSelected || false, //สถานะ checkbox สำหรับ VAT 7%
                    isSelectedForWithholding: product.isSelectedForWithholding || false, //สถานะ checkbox สำหรับ Withholding Tax อันแรก
                    isSelectedForWithholding2: product.isSelectedForWithholding2 || false, //สถานะ checkbox สำหรับ Withholding Tax อันที่สอง
                    isSelectedForWithholding3: product.isSelectedForWithholding3 || false, //สถานะ checkbox สำหรับ Withholding Tax อันที่สาม
                    priceForWithholding: product.priceForWithholding || product.deposit_amount //ราคาสำหรับ Withholding Tax
                }))
            };
        })(),
        remark: $('#customerNoteunder').val() || '', //หมายเหตุ
        file: window.confirmedFiles && window.confirmedFiles.length > 0 ? JSON.stringify(window.confirmedFiles.map((file, index) => ({
            seq: index + 1,
            new_imge_name: file.name,
            size: file.size
        }))) : null,
        product_byuser: JSON.stringify(allProductData), // ส่งข้อมูลสินค้าที่เพิ่มไว้ใน memory
        net_amount: $('#total-all').text().replace(/,/g, '') || '0' // จำนวนเงินรวมทั้งสิ้น
        
    };

    // Debug: แสดงข้อมูลไฟล์
    console.log('window.confirmedFiles exists:', !!window.confirmedFiles);
    console.log('confirmedFiles length:', window.confirmedFiles ? window.confirmedFiles.length : 0);
    console.log('confirmedFiles:', window.confirmedFiles);
    console.log('file data:', formData.file);
    
    // // ตรวจสอบว่ามีไฟล์หรือไม่
    // if (!window.confirmedFiles || window.confirmedFiles.length === 0) {
    //     console.log('ไม่มีไฟล์ที่ยืนยัน - กำลังตั้งค่า file เป็น null');
    //     formData.file = null;
    // }

    // === Validation: ตรวจสอบข้อมูลที่จำเป็น ===
    
    // ตรวจสอบข้อมูลลูกค้าหลัก
    if (!formData.cus_name || !formData.cus_no) {
        alert('กรุณากรอกชื่อลูกค้าและรหัสลูกค้า');
        return;
    }
    
    // ตรวจสอบรายละเอียดลูกค้า
    const cusDetail = JSON.parse(formData.cus_detail);
    if (!cusDetail.cus_addr || !cusDetail.cus_phone || !cusDetail.cus_email || !cusDetail.cus_business_location) {
        alert('กรุณากรอกที่อยู่ลูกค้า หมายเลขโทรศัพท์ อีเมล และที่ตั้งธุรกิจ');
        return;
    }

    // ตรวจสอบรายละเอียดเอกสาร
    // const docDetail = JSON.parse(formData.doc_detail);
    // if (!docDetail.doc_date || !docDetail.due_date || !docDetail.deadline || !docDetail.department || !docDetail.data_price_tax || !docDetail.currency) {
    //     alert('กรุณากรอกวันที่ วันครบกำหนด ครบกำหนดยืน แผนก ราคาและภาษี และสกุลเงิน');
    //     return;
    // }

    // เพิ่มเวลาการเริ่มสร้างเอกสาร
    const creationStartTime = localStorage.getItem('newDocumentCreationStartTime');
    if (creationStartTime) {
        formData.creation_start_time = creationStartTime;
        // ลบข้อมูลจาก localStorage หลังจากใช้แล้ว
        localStorage.removeItem('newDocumentCreationStartTime');
    }

    // === API Call: ส่งข้อมูลไป API เพื่อสร้างใบเสนอราคา ===
    $.ajax({
        url: `${endpoint}/api/add_quotation_bycom`,
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(formData),
        success: function(response) {
            if (response.code === 201) {
                // บันทึกข้อมูลลง localStorage สำหรับใช้ในหน้าต่อไป
                localStorage.setItem('quotationData', JSON.stringify(formData));
                localStorage.setItem('quotationId', response.result?.id || '');
                
                // นำทางไปหน้า preview พร้อม ID ที่ได้จาก API
                window.location.href = `create-deposit-receipt-preview.html?id=${response.result?.id || ''}`;
            } else {
                alert('เกิดข้อผิดพลาดในการสร้างใบเสนอราคา');
            }
        },
        error: function(xhr, status, error) {
            console.error('Error:', error);
            alert('เกิดข้อผิดพลาดในการเชื่อมต่อกับเซิร์ฟเวอร์');
        }
    });
}

//สร้างใบเสนอราคา ปิด


//แก้ไขจากไฟล์ create-deposit-receipt-table.html

//ฟังก์ชันสำหรับโหลดข้อมูลแก้ไข
$(document).ready(function () {
    //ตรวจสอบว่ามีข้อมูลแก้ไขหรือไม่
    loadEditData();
});


function loadEditData() {
    const editId = localStorage.getItem('editQuotationId');
    const editData = localStorage.getItem('editQuotationData');
    
    if (editId && editData) {
        try {
            const data = JSON.parse(editData);
            console.log('Loading edit data:', data);
            
            // แสดงข้อมูลลูกค้า
            $('#customerDepositReceiptNumber').val(data.tx);
            $('#customerCode').val(data.cus_no);
            $('#customerName').val(data.cus_name);
            $('#customerAddress').val(data.cus_detail?.cus_addr);
            $('#customerPhone').val(data.cus_detail?.cus_phone);
            $('#customerHeadOffice').val(data.cus_detail?.cus_business_location);
            $('#customerContactName').val(data.cus_detail?.cus_contact_name);
            $('#customerGmail').val(data.cus_detail?.cus_email);
            
            // อัปเดตชื่อลูกค้าใน dropdown เมื่อโหลดข้อมูลจาก API
            if (data.cus_name) {
                updateCustomerNameDropdown(data.cus_name);
            }
            
            // อัปเดตเลขประจำตัวผู้เสียภาษีใน dropdown เมื่อโหลดข้อมูลจาก API
            if (data.vat_no) {
                updateTaxIdDropdown(data.vat_no);
            } else if (data.cus_detail && data.cus_detail.vat_no) {
                updateTaxIdDropdown(data.cus_detail.vat_no);
            }
            
            // อัปเดตประเภทธุรกิจ/คำนำหน้าใน dropdown เมื่อโหลดข้อมูลจาก API
            if (data.type_business) {
                updateBusinessTypeDropdown(data.type_business);
            } else if (data.cus_detail && data.cus_detail.type_business) {
                updateBusinessTypeDropdown(data.cus_detail.type_business);
            }
            
            // อัปเดตแผนกใน dropdown เมื่อโหลดข้อมูลจาก API
            if (data.type_department) {
                updateDepartmentDropdown(data.type_department);
            } else if (data.cus_detail && data.cus_detail.type_department) {
                updateDepartmentDropdown(data.cus_detail.type_department);
            }
            
            // อัปเดตยื่นภาษีรวมในงวดที่ใน dropdown เมื่อโหลดข้อมูลจาก API
            if (data.tax_period) {
                updateTaxPeriodDropdown(data.tax_period);
            } else if (data.cus_detail && data.cus_detail.tax_period) {
                updateTaxPeriodDropdown(data.cus_detail.tax_period);
            }
            
            // อัปเดตวันที่เมื่อโหลดข้อมูลจาก API
            if (data.tax_date) {
                $('#taxDate').val(data.tax_date);
            } else if (data.cus_detail && data.cus_detail.tax_date) {
                $('#taxDate').val(data.cus_detail.tax_date);
            }
            
            // อัปเดตเลขใบกำกับภาษีเมื่อโหลดข้อมูลจาก API
            if (data.tax_invoice_no) {
                $('#taxInvoiceNo').val(data.tax_invoice_no);
            } else if (data.cus_detail && data.cus_detail.tax_invoice_no) {
                $('#taxInvoiceNo').val(data.cus_detail.tax_invoice_no);
            }
            $('#customerRefer').val(data.cus_detail?.cus_refer);
            if (data.cus_detail?.cus_head_office) {
                $('#big-office').prop('checked', true);
                $('#small-office').prop('checked', false);
                $('.branch-name').hide(); // ซ่อนช่องชื่อสาขา
            } else {
                $('#big-office').prop('checked', false);
                $('#small-office').prop('checked', true);
                $('.branch-name').show(); // แสดงช่องชื่อสาขา
            }
            $('#customerBranchCode').val(data.cus_detail?.cus_branch_no);
            $('#customerBranchName').val(data.cus_detail?.cus_branch_name);
            $('#customerNoteunder').val(data.remark || '');
            
            // แสดงสถานะ checkbox ลายเซ็นต์อิเล็กทรอนิกและตรายาง
            if (data.cus_detail?.cus_visits === true || data.cus_detail?.cus_visits === 'true') {
                $('#list-tax-data-3').prop('checked', true);
            } else {
                $('#list-tax-data-3').prop('checked', false);
            }
            
            // แสดงข้อมูลการชำระเงิน (payment_detail)
            if (data.payment_detail) {
                try {
                    let paymentDetail;
                    if (typeof data.payment_detail === 'string') {
                        paymentDetail = JSON.parse(data.payment_detail);
                    } else {
                        paymentDetail = data.payment_detail;
                    }
                    
                
                    $('#paymentPayeeName').val(paymentDetail.payment_payee_name || '');
                    $('#paymentAmount').val(paymentDetail.payment_amount || '');
                    $('#paymentDescription').val(paymentDetail.payment_description || '');
                    $('#paymentDate').val(paymentDetail.payment_date || '');
                    $('#paymentTime').val(paymentDetail.payment_time || '');
                    
                    // ฟื้นฟูวิธีการชำระเงินที่บันทึกไว้
                    if (paymentDetail.selected_payment_method) {
                        const savedPaymentMethod = paymentDetail.selected_payment_method;
                        console.log('วิธีการชำระเงิน:', savedPaymentMethod);
                        
                        // ซ่อนทุกหน้า
                        $('.page').removeClass('active');
                        
                        // แสดงหน้าที่บันทึกไว้
                        $(`#${savedPaymentMethod}`).addClass('active');
                        
                        // ติ๊ก radio button ที่ตรงกัน
                        $(`input[name="pageSelection"][value="${savedPaymentMethod}"]`).prop('checked', true);
                    }
                    
                    // โหลดข้อมูลธนาคาร
                    $('#bankPaymentAmount').val(paymentDetail.bank_payment_amount || '');
                    // หา option ที่มี text ตรงกับ bank_name และเลือก
                    if (paymentDetail.bank_name) {
                        $('#bankDropdown option').each(function() {
                            if ($(this).text() === paymentDetail.bank_name) {
                                $(this).prop('selected', true);
                            }
                        });
                        $('#bankDropdown').addClass('active-color');
                    }
                    $('#bankAccountNumber').val(paymentDetail.bank_account_number || '');
                    $('#bankPaymentDate').val(paymentDetail.bank_payment_date || '');
                    $('#bankPaymentTime').val(paymentDetail.bank_payment_time || '');
                    
                    // โหลดข้อมูลวันที่ตัดเงินมัดจำ
                    $('#depositCutDate').val(paymentDetail.deposit_cut_date || '');
                    
                    // เปลี่ยนสีเป็นดำเมื่อมีข้อมูลวันที่และเวลา
                    if ($('#paymentDate').val()) {
                        $('#paymentDate').css('color', 'black');
                    }
                    if ($('#paymentTime').val()) {
                        $('#paymentTime').css('color', 'black');
                    }
                    
                    // เปลี่ยนสีเป็นดำเมื่อมีข้อมูลธนาคาร
                    if ($('#bankPaymentDate').val()) {
                        $('#bankPaymentDate').css('color', 'black');
                    }
                    if ($('#bankPaymentTime').val()) {
                        $('#bankPaymentTime').css('color', 'black');
                    }
                    
                    // เปลี่ยนสีเป็นดำเมื่อมีข้อมูลวันที่ตัดเงินมัดจำ
                    if ($('#depositCutDate').val()) {
                        $('#depositCutDate').css('color', 'black');
                    }
                    
                } catch (e) {
                    console.error('Error parsing payment_detail:', e);
                }
            }

            // แสดงข้อมูลเอกสาร
            $('').val(getStatusText(data.doc_status));
            $('#customerStatus').val(data.status);
            // เรียกใช้ฟังก์ชัน toggleColor เพื่อแสดงสีดำเมื่อมีค่า
            $('.dropdown-status').each(function () {
                if ($(this).val()) {
                    $(this).addClass('active-color');
                } else {
                    $(this).removeClass('active-color');
                }
            });
            $('#customerDay').val(formatDateForInput(data.doc_detail?.doc_date || data.doc_date));
            // เปลี่ยนสีเป็นดำเมื่อมีค่า
            if ($('#customerDay').val()) {
                $('#customerDay').css('color', 'black');
            }
            $('#customerDayfully').val(formatDateForInput(data.doc_detail?.due_date || data.due_date));
            // เปลี่ยนสีเป็นดำเมื่อมีค่า
            if ($('#customerDayfully').val()) {
                $('#customerDayfully').css('color', 'black');
            }
            $('#customerDueDate').val(data.doc_detail?.deadline || '');
            $('#customerDepartment').val(data.doc_detail?.department || '');
            // เปลี่ยนสีเป็นดำเมื่อมีค่า
            if ($('#customerDepartment').val()) {
                $('#customerDepartment').css('color', 'black');
            }
            $('#customerSalesperson').val(data.doc_detail?.salesman);
            // เปลี่ยนสีเป็นดำเมื่อมีค่า
            if ($('#customerSalesperson').val()) {
                $('#customerSalesperson').css('color', 'black');
            }
            $('#customerPriceandTax').val(data.doc_detail?.data_price_tax);
            // เปลี่ยนสีเป็นดำเมื่อมีค่า
            if ($('#customerPriceandTax').val()) {
                $('#customerPriceandTax').css('color', 'black');
            }
            $('#customerCurrency').val(data.doc_detail?.currency);
            // เปลี่ยนสีเป็นดำเมื่อมีค่า
            if ($('#customerCurrency').val()) {
                $('#customerCurrency').css('color', 'black');
            }
            // โหลดรหัสใบสั่งขาย
            const salesOrderCode = data.doc_detail?.sales_order_code || '';
            $('#salesOrderCodeInput').val(salesOrderCode);
            // เปลี่ยนสีเป็นดำเมื่อมีค่า
            if (salesOrderCode) {
                $('#salesOrderCodeInput').css('color', 'black');
            }
            // โหลดข้อมูลเครดิตจากประวัติชำระเงิน
            const creditHistory = data.doc_detail?.credit_history || '';
            $('#customerCredithistory').val(creditHistory);
            // เปลี่ยนสีเป็นดำเมื่อมีค่า
            if (creditHistory) {
                $('#customerCredithistory').css('color', 'black');
            }
            // โหลดสถานะการออกใบกำกับภาษี
            const taxInvoice = data.doc_detail?.tax_invoice;
            if (taxInvoice !== undefined) {
                $('#toggle-btn-2').prop('checked', taxInvoice);
                if (taxInvoice) {
                    $('#box-2').addClass('show');
                } else {
                    $('#box-2').removeClass('show');
                }
            }
            // โหลดสถานะตัดมัดจำเรียบร้อยจาก payment_detail
            if (data.payment_detail) {
                try {
                    let paymentDetail;
                    if (typeof data.payment_detail === 'string') {
                        paymentDetail = JSON.parse(data.payment_detail);
                    } else {
                        paymentDetail = data.payment_detail;
                    }
                    
                    const depositDeduction = paymentDetail?.deposit_deduction;
                    if (depositDeduction !== undefined) {
                        $('#toggleBox').prop('checked', depositDeduction);
                        if (depositDeduction) {
                            $('#myBox').addClass('show');
                        } else {
                            $('#myBox').removeClass('show');
                        }
                    }
                } catch (e) {
                    console.error('Error parsing payment_detail for deposit_deduction:', e);
                }
            }
            // แสดงข้อมูลไฟล์
            if (data.file) {
                try {
                    // ตรวจสอบว่า data.file เป็น string หรือ object
                    let fileObj;
                    if (typeof data.file === 'string') {
                        fileObj = JSON.parse(data.file);
                    } else {
                        fileObj = data.file;
                    }
                    
                    console.log('fileObj:', fileObj);
                    
                    // เก็บข้อมูลไฟล์ไว้ใน window.confirmedFiles สำหรับการบันทึก
                    if (Array.isArray(fileObj) && fileObj.length > 0) {
                        window.confirmedFiles = fileObj.map(file => ({
                            name: file.new_imge_name,
                            size: file.size,
                            seq: file.seq
                        }));
                    }
                    
                    // แสดงไฟล์ใน confirmedFilesDisplay
                    const confirmedFilesDisplay = document.getElementById('confirmedFilesDisplay');
                    if (confirmedFilesDisplay && Array.isArray(fileObj) && fileObj.length > 0) {
                        confirmedFilesDisplay.innerHTML = '';
                        
                        fileObj.forEach((file, index) => {
                            const fileElement = document.createElement('div');
                            fileElement.className = 'x-upload-doc';
                            fileElement.innerHTML = `
                                <div class="doc-upload">
                                    <div class="doc-name">${file.new_imge_name}</div>
                                    <div class="MB-upload">(${Math.round(file.size / 1024)} KB)</div>
                                </div>
                                <div class="check-x">
                                    <img src="picture/eye.png" class="upload-gray" onclick="viewFile(${index})" style="cursor:pointer;" title="เปิดไฟล์">
                                    <img src="picture/pen.png" class="upload-gray" onclick="editFileName(${index})" style="cursor:pointer;" title="เปลี่ยนชื่อไฟล์">
                                    <img src="picture/bin.png" class="upload-gray" onclick="removeConfirmedFile(${index})" style="cursor:pointer;" title="ลบไฟล์">
                                </div>
                            `;
                            confirmedFilesDisplay.appendChild(fileElement);
                        });
                    }
                    
                    // แสดงไฟล์ในหน้าหลัก
                    const showUploadFiles = document.getElementById('showUploadFiles');
                    if (showUploadFiles && Array.isArray(fileObj) && fileObj.length > 0) {
                        showUploadFiles.innerHTML = '';
                        
                        fileObj.forEach((file, index) => {
                            const fileElement = document.createElement('div');
                            fileElement.className = 'x-upload-doc';
                            fileElement.innerHTML = `
                                <div class="doc-upload">
                                    <div class="doc-name">${file.new_imge_name}</div>
                                    <div class="MB-upload">(${Math.round(file.size / 1024)} KB)</div>
                                </div>
                                <div class="check-x">
                                    <img src="picture/eye.png" class="upload-gray" onclick="viewFile(${index})" style="cursor:pointer;" title="เปิดไฟล์">
                                    <img src="picture/bin.png" class="upload-gray" onclick="removeConfirmedFile(${index})" style="cursor:pointer;" title="ลบไฟล์">
                                </div>
                            `;
                            showUploadFiles.appendChild(fileElement);
                        });
                    }
                } catch (error) {
                    console.error('Error processing file data:', error);
                    console.log('Raw file data:', data.file);
                }
            }

            // Parse product_detail ถ้าเป็น JSON string
            let productDetail = data.product_detail;
            if (typeof productDetail === 'string') {
                try {
                    productDetail = JSON.parse(productDetail);
                } catch (e) {
                    console.error('Error parsing product_detail:', e);
                }
            }

            // แสดงราคาสุทธิทั้งหมด
            $('#product-totalAllProducts').val(productDetail.product_totalAllProducts);
            $('#product-totalDiscount').val(productDetail.product_totalDiscount);
            $('#product-totalAfterDiscount').val(productDetail.product_totalAfterDiscount);
            $('#product-totalTax').val(productDetail.product_totalTax);
            $('#product-withholdingTax').val(productDetail.product_withholdingTax);
            $('#product-withholdingTax2').val(productDetail.product_withholdingTax2 || 0);
            $('#product-withholdingTax3').val(productDetail.product_withholdingTax3 || 0);
            $('#product-totalAll').val(productDetail.product_totalAll);
            
            // ตั้งค่า checkbox ของภาษีมูลค่าเพิ่ม 7%
            if (productDetail.vat7_checked !== undefined) {
                $('#list-tax-data').prop('checked', productDetail.vat7_checked);
            }
            
            // ตั้งค่า checkbox ของภาษีถูกหัก ณ ที่จ่าย
            if (productDetail.withholding_tax_checked !== undefined) {
                $('#list-tax-data-2').prop('checked', productDetail.withholding_tax_checked);
            }
            
            // ตั้งค่าอัตราภาษีถูกหัก ณ ที่จ่าย
            if (productDetail.withholding_tax_rate !== undefined) {
                $('#tax_withheld').val(productDetail.withholding_tax_rate);
            }
            if (productDetail.withholding_tax_rate2 !== undefined) {
                $('#tax_withheld2').val(productDetail.withholding_tax_rate2);
            }
            if (productDetail.withholding_tax_rate3 !== undefined) {
                $('#tax_withheld3').val(productDetail.withholding_tax_rate3);
            }
            
            // ตรวจสอบและแสดงฟอร์มภาษีหักตามจำนวนที่มีอยู่
            checkAndDisplayWithholdingTaxForms({ product_detail: productDetail });
            
            // แสดงจำนวนที่ลบออกจากยอดรวม ใน popup
            $('#delete-vat').val(productDetail.delete_vat);

            // แสดงข้อมูลสถานะ อัตราภาษีถูกหัก ณ ที่จ่าย ใน popup 
            $('.right-under').val(productDetail.withholding_tax_rate);
            $('.right-under').css('color', 'black');

            // โหลดข้อมูลสินค้าจากตาราง doc_tx คอลัมน์ product_byuser
            const editId = localStorage.getItem('editQuotationId');
            if (editId) {
                $.ajax({
                    url: `${endpoint}/api/get_quotation_by_id`,
                    method: 'POST',
                    dataType: 'json',
                    data: {
                        id: editId,
                        com_id: localStorage.getItem('com_id') || 3
                    },
                    success: function(response) {
                        console.log('Quotation data API Response:', response);
                        if (response.code === 200 && response.result) {
                            try {
                                // ดึงข้อมูล product_byuser จากตาราง doc_tx
                                let productData = [];
                                if (response.result.product_byuser) {
                                    if (typeof response.result.product_byuser === 'string') {
                                        productData = JSON.parse(response.result.product_byuser);
                                    } else if (Array.isArray(response.result.product_byuser)) {
                                        productData = response.result.product_byuser;
                                    }
                                    
                                    // ตั้งค่า allProductData จาก product_byuser
                                    allProductData = productData;
                                    
                                    // โหลดสถานะ checkbox จาก product_selection_status ถ้ามี
                                    if (productDetail && productDetail.product_selection_status) {
                                        const selectionStatus = productDetail.product_selection_status;
                                        allProductData.forEach((product, index) => {
                                            const status = selectionStatus.find(item => item.id === product.id);
                                            if (status) {
                                                product.isSelected = status.isSelected || false;
                                                product.isSelectedForWithholding = status.isSelectedForWithholding || false;
                                                product.isSelectedForWithholding2 = status.isSelectedForWithholding2 || false;
                                                product.isSelectedForWithholding3 = status.isSelectedForWithholding3 || false;
                                            } else {
                                                // ตั้งค่าเริ่มต้นถ้าไม่พบข้อมูล
                                                product.isSelected = true;
                                                product.isSelectedForWithholding = false;
                                                product.isSelectedForWithholding2 = false;
                                                product.isSelectedForWithholding3 = false;
                                            }
                                        });
                                    } else {
                                        // ตั้งค่าเริ่มต้น: VAT=true, ภาษีหัก=false
                                        allProductData.forEach((product, index) => {
                                            product.isSelected = true; // สำหรับ VAT (ภาษี 7%) - ติ๊กไว้ตั้งแต่แรก
                                            product.isSelectedForWithholding = false; // สำหรับ Withholding Tax (ภาษีหัก ณ ที่จ่าย) - ไม่ติ๊กตั้งแต่แรก
                                            product.isSelectedForWithholding2 = false; // สำหรับ Withholding Tax 2 (ไม่ติ๊กตั้งแต่แรก)
                                            product.isSelectedForWithholding3 = false; // สำหรับ Withholding Tax 3 (ไม่ติ๊กตั้งแต่แรก)
                                        });
                                    }
                                    
                                    // อัปเดตการแสดงผล checkbox lists
                                    displayProductCheckboxList();
                                    // คำนวณยอดรวมใหม่
                                    calculateTotalSummary();
                                    
                                    // แสดงข้อมูลสินค้าในตารางหลัก
                                    displayProductPage();
                                    updateProductPagination();
                                    
                                    // แสดงตารางข้อมูลสินค้า
                                    $('#noDataSection').hide();
                                    $('#myPopupview').show();
                                }
                            } catch (e) {
                                console.error('Error parsing product_byuser from doc_tx:', e);
                            }
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Error loading quotation data:', error);
                    }
                });
            }

            
            // เปลี่ยนหัวข้อเป็น "แก้ไขใบเสนอราคา"
            $('.deposit-receipt').text('แก้ไขใบเสนอราคา');
            $('.text-nav-edit').text('แก้ไขใบเสนอราคา');
            
            // เก็บ ID ไว้สำหรับการอัปเดต
            window.editQuotationId = editId;
            
            console.log('Edit data loaded successfully');
        } catch (error) {
            console.error('Error parsing edit data:', error);
        }
    }
}

// ฟังก์ชันตรวจสอบและแสดงฟอร์มภาษีหักตามจำนวนที่มีอยู่
function checkAndDisplayWithholdingTaxForms(data) {
    console.log('🏷️ [Edit Mode] ตรวจสอบฟอร์มภาษีหัก');
    
    let productDetail = {};
    if (data.product_detail) {
        try {
            productDetail = typeof data.product_detail === 'string' ? JSON.parse(data.product_detail) : data.product_detail;
        } catch (e) {
            console.error('Error parsing product_detail:', e);
        }
    }
    
    // ตรวจสอบข้อมูลภาษีหัก ณ ที่จ่าย
    const withholdingTaxData = [];
    
    // ภาษีหัก ณ ที่จ่าย แบบที่ 1 (หลัก)
    if (productDetail.withholding_tax_rate && productDetail.withholding_tax_rate > 0) {
        withholdingTaxData.push({
            form: 1,
            rate: productDetail.withholding_tax_rate,
            amount: productDetail.product_withholdingTax || 0,
            checked: productDetail.withholding_tax_checked || false
        });
        
        // ตั้งค่าในฟอร์มหลัก
        $('#tax_withheld').val(productDetail.withholding_tax_rate);
        $('#list-tax-data-2').prop('checked', productDetail.withholding_tax_checked || false);
    }
    
    // ภาษีหัก ณ ที่จ่าย แบบที่ 2
    if (productDetail.withholding_tax_rate2 && productDetail.withholding_tax_rate2 > 0) {
        withholdingTaxData.push({
            form: 2,
            rate: productDetail.withholding_tax_rate2,
            amount: productDetail.product_withholdingTax2 || 0,
            checked: productDetail.withholding_tax_checked2 || false
        });
        
        // แสดงฟอร์มที่ 2
        const form2 = document.getElementById('tax-withheld-form-2');
        if (form2) {
            form2.style.display = 'block';
            $('#tax_withheld2').val(productDetail.withholding_tax_rate2);
            clickCount = Math.max(clickCount, 1);
        }
    }
    
    // ภาษีหัก ณ ที่จ่าย แบบที่ 3
    if (productDetail.withholding_tax_rate3 && productDetail.withholding_tax_rate3 > 0) {
        withholdingTaxData.push({
            form: 3,
            rate: productDetail.withholding_tax_rate3,
            amount: productDetail.product_withholdingTax3 || 0,
            checked: productDetail.withholding_tax_checked3 || false
        });
        
        // แสดงฟอร์มที่ 3
        const form3 = document.getElementById('tax-withheld-form-3');
        if (form3) {
            form3.style.display = 'block';
            $('#tax_withheld3').val(productDetail.withholding_tax_rate3);
            clickCount = Math.max(clickCount, 2);
            
            // ซ่อนปุ่มเพิ่มฟอร์มถ้ามี 3 ฟอร์มแล้ว
            const addButton = document.getElementById('add-tax-withheld-btn');
            if (addButton) {
                addButton.style.display = 'none';
            }
        }
    }
    
    // โหลดข้อมูลภาษีมูลค่าเพิ่ม 7%
    if (productDetail.vat7_checked !== undefined) {
        $('#list-tax-data').prop('checked', productDetail.vat7_checked);
    }
    
    if (productDetail.delete_vat_amount && productDetail.delete_vat_amount > 0) {
        $('#delete-vat').val(productDetail.delete_vat_amount);
    }
    
    console.log('🏷️ [Edit Mode] พบฟอร์มภาษีหัก จำนวน:', withholdingTaxData.length);
    withholdingTaxData.forEach((tax, index) => {
        console.log(`   - ฟอร์มที่ ${tax.form}: ${tax.rate}% (${tax.amount} บาท)`);
    });
    
    // เปิด popup แก้ไขมูลค่าสุทธิหากมีข้อมูลภาษีหัก
    if (withholdingTaxData.length > 0) {
        console.log('🔧 [Edit Mode] เปิด popup แก้ไขมูลค่าสุทธิ');
        setTimeout(() => {
            $('#myPopupeditpen').fadeIn();
            
            // ติ๊กรายการสินค้าตามข้อมูลที่โหลดมา
            updateProductCheckboxesFromData(productDetail);
            
            displayProductCheckboxList();
            calculateTotalSummary();
        }, 500);
    }
    
    console.log('✅ [Edit Mode] ตรวจสอบฟอร์มภาษีหักเสร็จสิ้น');
}

// ฟังก์ชันติ๊กรายการสินค้าตามข้อมูลที่โหลดมา
function updateProductCheckboxesFromData(productDetail) {
    console.log('📋 [Edit Mode] ติ๊กรายการสินค้าตามข้อมูลที่โหลดมา');
    
    if (!productDetail.product_selection_status || !Array.isArray(productDetail.product_selection_status)) {
        console.log('❌ [Edit Mode] ไม่พบข้อมูลสถานะการเลือกสินค้า');
        return;
    }
    
    // อัปเดตสถานะ checkbox ใน allProductData
    allProductData.forEach((product, index) => {
        const selectionStatus = productDetail.product_selection_status.find(item => item.id === product.id);
        
        if (selectionStatus) {
            // ติ๊ก checkbox ตามข้อมูลที่โหลดมา
            product.isSelected = selectionStatus.isSelected || false; // VAT 7%
            product.isSelectedForWithholding = selectionStatus.isSelectedForWithholding || false; // Withholding Tax 1
            product.isSelectedForWithholding2 = selectionStatus.isSelectedForWithholding2 || false; // Withholding Tax 2
            product.isSelectedForWithholding3 = selectionStatus.isSelectedForWithholding3 || false; // Withholding Tax 3
            
            console.log(`📦 [Edit Mode] สินค้า ${product.name}:`, {
                VAT: product.isSelected,
                Withholding1: product.isSelectedForWithholding,
                Withholding2: product.isSelectedForWithholding2,
                Withholding3: product.isSelectedForWithholding3
            });
        }
    });
    
    console.log('✅ [Edit Mode] ติ๊กรายการสินค้าเสร็จสิ้น');
}

/**
 * ฟังก์ชันอัปเดตใบเสนอราคาที่มีอยู่
 * ใช้ในโหมดแก้ไขข้อมูล
 */
function updateQuotation() {
    // ตรวจสอบว่ามี ID สำหรับแก้ไข
    if (!window.editQuotationId) {
        alert('ไม่พบข้อมูลสำหรับการแก้ไข');
        return;
    }

    // เก็บข้อมูลจากฟอร์ม
    const formData = {
        id: window.editQuotationId,
        com_id: '3', // ใช้ค่า 1 เสมอ
        tx: $('#customerDepositReceiptNumber').val(),
        cus_no: $('#customerCode').val(),
        cus_name: $('#customerName').val(),
        status: $('#customerStatus').val(),
        cus_detail: JSON.stringify({
            cus_no: $('#customerCode').val(),
            cus_name: $('#customerName').val(),
            cus_addr: $('#customerAddress').val(),
            cus_phone: $('#customerPhone').val(),
            cus_business_location: $('#customerHeadOffice').val(),
            cus_email: $('#customerGmail').val(),
            cus_contact_name: $('#customerContactName').val(),
            cus_refer: $('#customerRefer').val(),
            cus_head_office: $('#big-office').is(':checked'),
            cus_branch_no: $('#customerBranchCode').val(),
            cus_branch_name: $('#customerBranchName').val(),
            cus_visits: $('#list-tax-data-3').is(':checked'), //ลายเซ็นต์อิเล็กทรอนิกและตรายาง
            vat_no: $('#taxIdDropdown').val() || '', //เลขประจำตัวผู้เสียภาษี
            type_business: $('#businessTypeDropdown option:selected').text() || $('#businessTypeDropdown').val() || '', //ประเภทธุรกิจ/คำนำหน้า
            type_department: $('#departmentDropdown option:selected').text() || $('#departmentDropdown').val() || '', //แผนก
            tax_period: $('#taxPeriodDropdown option:selected').text() || $('#taxPeriodDropdown').val() || '', //ยื่นภาษีรวมในงวดที่
            tax_date: $('#taxDate').val() || '', //วันที่
            tax_invoice_no: $('#taxInvoiceNo').val() || '', //เลขใบกำกับภาษี
        }),
        payment_detail: JSON.stringify({
            payment_payee_name: $('#paymentPayeeName').val() || '',
            payment_amount: $('#paymentAmount').val() || '',
            payment_description: $('#paymentDescription').val() || '',
            payment_date: $('#paymentDate').val() || '',
            payment_time: $('#paymentTime').val() || '',
            deposit_deduction: $('#toggleBox').is(':checked'), //ตัดมัดจำเรียบร้อย
            bank_payment_amount: $('#bankPaymentAmount').val() || '', //จำนวนเงินรับชำระ (บาท) - ธนาคาร
            bank_name: $('#bankDropdown option:selected').text() || '', //ชื่อธนาคาร
            bank_account_number: $('#bankAccountNumber').val() || '', //เลขบัญชี
            bank_payment_date: $('#bankPaymentDate').val() || '', //วันที่ชำระ - ธนาคาร
            bank_payment_time: $('#bankPaymentTime').val() || '', //เวลา - ธนาคาร
            deposit_cut_date: $('#depositCutDate').val() || '', //วันที่ตัดเงินมัดจำ
            // ข้อมูลสรุปการชำระเงิน
            payment_summary: {
                total_with_tax: $('#cut-total').text().replace(/,/g, '') || '0', //มูลค่ารวมภาษี
                withholding_tax: $('#cut-vat').text().replace(/,/g, '') || '0', //ภาษีถูกหัก ณ ที่จ่าย
                remaining_amount: $('#cut-remaining').text().replace(/,/g, '') || '0', //ยอดคงค้าง
                paid_amount: $('#cut-paid').text().replace(/,/g, '') || '0', //ยอดที่ตัดไปแล้ว
                total_payment: $('#cut-total-sum').text().replace(/,/g, '') || '0' //ชำระรวมทั้งสิ้น
            },
            deposit_due_date: $('#customerDayfully').val() || '', //รับชำระครบเมื่อวันที่
            selected_payment_method: getCurrentActivePage() //วิธีการชำระเงินที่เลือก (page1=เงินสด, page2=ธนาคาร)
        }),
        doc_date: $('#customerDay').val(),
        due_date: $('#customerDayfully').val(),
        deadline: $('#customerDueDate').val(),
        department: $('#customerDepartment').val(),
        salesman: $('#customerSalesperson').val(),
        data_price_tax: $('#customerPriceandTax').val(),
        currency: $('#customerCurrency').val(),
        doc_status: getStatusValue($('').val()),
        doc_detail: JSON.stringify({
            doc_date: $('#customerDay').val(),
            due_date: $('#customerDayfully').val(),
            deadline: $('#customerDueDate').val(),
            department: $('#customerDepartment').val(),
            salesman: $('#customerSalesperson').val(),
            data_price_tax: $('#customerPriceandTax').val(),
            currency: $('#customerCurrency').val(),
            sales_order_code: $('#salesOrderCodeInput').val() || '', //รหัสใบสั่งขาย
            credit_history: $('#customerCredithistory').val() || '', //เครดิตจากประวัติชำระเงินของ
            tax_invoice: $('#toggle-btn-2').is(':checked') //การออกใบกำกับภาษี
        }),
        product_detail: (() => {
            const totals = calculateTotalSummary();
            
            return {
                product_totalAllProducts: totals.totalAllProducts, //ราคาสุทธิทั้งหมด
                product_totalDiscount: totals.totalDiscount, //ส่วนลดทั้งหมด
                product_totalAfterDiscount: totals.totalAfterDiscount, //ราคาสุทธิหลังหักส่วนลด
                product_totalTax: totals.totalTax, //ภาษีมูลค่าเพิ่ม 7%
                product_withholdingTax: totals.withholdingTax, //ภาษีถูกหัก ณ ที่จ่าย อันแรก
                product_withholdingTax2: totals.withholdingTax2, //ภาษีถูกหัก ณ ที่จ่าย อันที่สอง
                product_withholdingTax3: totals.withholdingTax3, //ภาษีถูกหัก ณ ที่จ่าย อันที่สาม
                product_totalAll: totals.totalAll, //ราคารวมทั้งหมด
                // เพิ่มสถานะ checkbox
                vat7_checked: $('#list-tax-data').is(':checked'), //สถานะ checkbox ภาษีมูลค่าเพิ่ม 7%
                withholding_tax_checked: $('#list-tax-data-2').is(':checked'), //สถานะ checkbox ภาษีถูกหัก ณ ที่จ่าย
                withholding_tax_rate: $('#tax_withheld').val() || '0.0%', //อัตราภาษีถูกหัก ณ ที่จ่าย อันแรก
                withholding_tax_rate2: $('#tax_withheld2').val() || '0.0%', //อัตราภาษีถูกหัก ณ ที่จ่าย อันที่สอง
                withholding_tax_rate3: $('#tax_withheld3').val() || '0.0%', //อัตราภาษีถูกหัก ณ ที่จ่าย อันที่สาม
                delete_vat: parseFloat($('#delete-vat').val()) || 0, //จำนวนที่ลบออกจากยอดรวม
                product_selection_status: allProductData.map(product => ({
                    id: product.id,
                    isSelected: product.isSelected || false, //สถานะ checkbox สำหรับ VAT 7%
                    isSelectedForWithholding: product.isSelectedForWithholding || false, //สถานะ checkbox สำหรับ Withholding Tax อันแรก
                    isSelectedForWithholding2: product.isSelectedForWithholding2 || false, //สถานะ checkbox สำหรับ Withholding Tax อันที่สอง
                    isSelectedForWithholding3: product.isSelectedForWithholding3 || false, //สถานะ checkbox สำหรับ Withholding Tax อันที่สาม
                    priceForWithholding: product.priceForWithholding || product.deposit_amount //ราคาสำหรับ Withholding Tax
                }))
            };
        })(),
        remark: $('#customerNoteunder').val(),
        file: window.confirmedFiles && window.confirmedFiles.length > 0 ? JSON.stringify(window.confirmedFiles.map((file, index) => ({
            seq: index + 1,
            new_imge_name: file.name,
            size: file.size
        }))) : null,
        product_byuser: JSON.stringify(allProductData), // ส่งข้อมูลสินค้าที่เพิ่มไว้ใน memory
        net_amount: $('#total-all').text().replace(/,/g, '') || '0' // จำนวนเงินรวมทั้งสิ้น
    };

    // ตรวจสอบข้อมูลที่จำเป็น
    if (!formData.cus_name || !formData.cus_no) {
        alert('กรุณากรอกชื่อลูกค้าและรหัสลูกค้า');
        return;
    }

    // ส่งข้อมูลไปยัง API
    $.ajax({
        url: `${endpoint}/api/update_quotation_bycom`,
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(formData),
        success: function(response) {
            if (response.code === 200) {
                // ล้างข้อมูลแก้ไข
                clearEditData();
                // กลับไปหน้าหลักหรือหน้าต่อไป พร้อมส่งค่า ID ที่ return มาจาก API
                const quotationId = response.id || window.editQuotationId;
                window.location.href = `create-deposit-receipt-preview.html?id=${quotationId}&fromEdit=true`;
            } else {
                alert('เกิดข้อผิดพลาดในการอัปเดตข้อมูล: ' + (response.result || 'ไม่ทราบสาเหตุ'));
            }
        },
        error: function(xhr, status, error) {
            alert('เกิดข้อผิดพลาดในการเชื่อมต่อกับเซิร์ฟเวอร์');
        }
    });
}


/* ===========================================
   PRODUCT CALCULATIONS
   =========================================== */

/**
 * คำนวณราคารวมสินค้า
 * สูตร: ใช้ deposit_amount
 * @returns {string} ราคารวมที่คำนวณได้
 */
function calculateProductTotal() {
    const price = parseFloat($('#product-price-unit').val()) || 0;
    
    // ใช้ deposit_amount
    const total = price;
    
    // อัปเดตการแสดงผลในฟอร์ม
    $('#product-total').val(total.toFixed(2));
    
    return total.toFixed(2);
}

/* ===========================================
   PRODUCT CRUD OPERATIONS
   =========================================== */

/**
 * เพิ่มสินค้าใหม่ลงฐานข้อมูล
 * ตรวจสอบข้อมูลและส่งไป API
 */
function addProductToDatabase() {
    // Validation: ตรวจสอบข้อมูลที่จำเป็นจากโมดอลเพิ่มเงินมัดจำ
    if (!$('#psodesheet2').val() || !$('#editnamesheet2').val() || 
        !$('#deposit-desc').val() || !$('#pmoneyunitsheet2').val() || 
        !$('#editdeposit_price2').val()) {
        alert('กรุณากรอกข้อมูลให้ครบถ้วน');
        return;
    }
    
    // ตั้งค่า flag เพื่อป้องกันการเรียกซ้ำ
    window.isAddingProduct = true;
    console.log('เริ่มเพิ่มข้อมูลเงินมัดจำ - ตั้งค่า flag');
    
    // สร้างข้อมูลเงินมัดจำใหม่
    const timestamp = Date.now();
    const newProduct = {
        id: timestamp, // ใช้ timestamp 
        product_code: $('#psodesheet2').val(), // เอกสารที่ตัด
        name: $('#editnamesheet2').val(), // ชื่อรายการ
        desc_product: $('#deposit-desc').val() || '', // รายละเอียด
        deposit_amount: $('#editdeposit_price2').val(), // ราคามัดจำ
        total: $('#pmoneyunitsheet2').val(), // ยอดหลังหักส่วนลด
    };
    
    // เพิ่มข้อมูลเงินมัดจำใหม่เข้าไปใน allProductData
    allProductData.push(newProduct);
    productTotalItems = allProductData.length;
    
    console.log('เพิ่มข้อมูลเงินมัดจำใหม่เข้า allProductData:', newProduct);
    console.log('จำนวนรายการทั้งหมด:', allProductData.length);
    
    // อัปเดตการแสดงผล
    displayProductPage();
    updateProductPagination();
    displayProductCheckboxList();
    
    // คำนวณราคาสุทธิทั้งหมด
    calculateTotalSummary();
    
    // แสดงข้อความสำเร็จ
    // alert('เพิ่มข้อมูลเงินมัดจำสำเร็จ');
    
    // ล้างฟอร์มเงินมัดจำ
    clearDepositForm();
    
    // ปิด modal
    $('.cancelPopupBtn11').click();
    
    // แสดงตารางข้อมูลสินค้า
    $('#noDataSection').hide();
    $('#myPopupview').show();
    
    // รีเซ็ต flag
    window.isAddingProduct = false;
    console.log('เสร็จสิ้นการเพิ่มข้อมูลเงินมัดจำ - รีเซ็ต flag');
}

/**
 * ล้างข้อมูลในฟอร์มเพิ่มเงินมัดจำ
 * ใช้หลังจากบันทึกข้อมูลสำเร็จ
 */
function clearDepositForm() {
    $('#psodesheet2').val(''); // เอกสารที่ตัด
    $('#editnamesheet2').val(''); // ชื่อรายการ
    $('#deposit-desc').val(''); // รายละเอียด
    $('#pmoneyunitsheet2').val(''); // ยอดหลังหักส่วนลด
    $('#editdeposit_price2').val(''); // ราคามัดจำ
    
    console.log('ล้างฟอร์มเงินมัดจำเรียบร้อย');
}

/**
 * ล้างข้อมูลในฟอร์มเพิ่มสินค้า
 * ใช้หลังจากบันทึกข้อมูลสำเร็จ
 */
function clearProductForm() {
    const fields = [
        '#product-name', '#product-desc', '#product-qty',
        '#product-price-unit', '#product-discount', 
        '#product-total', '#unit'
    ];
    fields.forEach(field => $(field).val(''));
}

/**
 * ล้างข้อมูลในตารางสินค้า
 * ใช้เมื่อไม่มีข้อมูลสินค้า
 */
function clearProductTable() {
    const tbody = $('#myPopupview tbody');
    tbody.empty();
    allProductData = [];
    productTotalItems = 0;
}

/**
 * เติมข้อมูลสินค้าจาก master data ในฟอร์มแก้ไข
 * @param {Object} product - ข้อมูลสินค้าจาก master data
 */
function fillEditFormWithMasterProduct(product) {
    // เติมข้อมูลในฟอร์มแก้ไข
    $('#editsodesheet').val(product.product_code);
    $('#editsetsheet').val(product.qty);
    $('#editmoneyunitsheet').val(product.deposit_amount);
    $('#editdiscountsheet').val(product.discount);
    $('#editnamesheet').val(product.name);
    
    // ตรวจสอบและเติมข้อมูล desc_product
    console.log('กำลังเติม desc_product:', product.desc_product);
    console.log('Element #editdetailsheet มีอยู่หรือไม่:', $('#editdetailsheet').length);
    if ($('#editdetailsheet').length > 0) {
        // ลบ disabled และ readonly ออกจาก textarea
        $('#editdetailsheet').prop('disabled', false);
        $('#editdetailsheet').prop('readonly', false);
        $('#editdetailsheet').val(product.desc_product);
        console.log('เติม desc_product สำเร็จ:', $('#editdetailsheet').val());
    } else {
        console.error('ไม่พบ element #editdetailsheet');
    }
    
    $('#editunitsheet').val(product.unit);
    
    // คำนวณและแสดง total ทันที
    const price = parseFloat(product.deposit_amount) || 0;
    const total = price;
    
    // แสดง total ในฟิลด์ที่ถูกต้อง
    if ($('#editmoneygroupsheet').length) {
        $('#editmoneygroupsheet').val(total.toFixed(2));
    }
    
    // เก็บ ID ของสินค้าที่กำลังแก้ไข (ใช้ ID ชั่วคราว)
    window.editingProductId = product.id;
    
    // ตั้งค่าให้รู้ว่าเป็นการเพิ่มสินค้าใหม่จาก master data
    window.isAddingFromMaster = true;
    
    console.log('เติมข้อมูลในฟอร์มแก้ไข:', product);
    console.log('คำนวณ total ทันที:', total.toFixed(2));
    console.log('ค่า total ที่แสดง:', $('#editmoneygroupsheet').val());
}

/**
 * คำนวณยอดรวมจากค่าที่กำหนด
 * @param {string|number} price - ราคามัดจำ
 * @returns {string} ยอดรวมที่คำนวณแล้ว
 */
function calculateProductTotalFromValues(qty, price, discount) {
    const priceNum = parseFloat(price) || 0;
    
    // ใช้ deposit_amount
    return priceNum.toFixed(2);
}

/**
 * สร้างรหัสสินค้าแบบ AA-YYYYMMDD0001
 * @returns {string} รหัสสินค้า
 */
function generateProductCode() {
    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    const dateStr = `${year}${month}${day}`;
    
    // หาลำดับถัดไปสำหรับวันนี้
    const todayProducts = allProductData.filter(product => {
        if (!product.product_code) return false;
        const parts = product.product_code.split('-');
        return parts.length === 2 && parts[1].startsWith(dateStr);
    });
    
    const nextNumber = todayProducts.length + 1;
    const sequence = String(nextNumber).padStart(4, '0');
    
    return `AA-${dateStr}${sequence}`;
}

/**
 * ลบสินค้าตาม ID ที่ระบุ
 * @param {string} productId - ID ของสินค้าที่จะลบ
 */
function deleteProduct(productId) {
    if (!productId) {
        alert('ไม่พบ ID ของสินค้าที่จะลบ');
        return;
    }
    
    // หาดัชนีของสินค้าใน allProductData
    const productIndex = allProductData.findIndex(p => p.id == productId);
    if (productIndex === -1) {
        alert('ไม่พบข้อมูลสินค้าที่จะลบ');
        return;
    }
    
    // ลบสินค้าออกจาก allProductData
    allProductData.splice(productIndex, 1);
    productTotalItems = allProductData.length;
    
    console.log('ลบสินค้าออกจาก allProductData, จำนวนที่เหลือ:', allProductData.length);
    
    // อัปเดตการแสดงผล
    displayProductPage();
    updateProductPagination();
    displayProductCheckboxList();
                calculateTotalSummary();
    
    // alert('ลบสินค้าสำเร็จ');
}

//ฟังก์ชันสำหรับดึงข้อมูลสินค้าตาม ID เพื่อแสดงใน modal view
function loadProductDataForEdit(productCode) {
    if (!productCode) {
        console.error('ไม่พบรหัสสินค้าที่จะแก้ไข');
        return;
    }

    // หาข้อมูลสินค้าจาก allProductData
    const product = allProductData.find(p => p.product_code === productCode);
                
    if (product) {
        // แสดงข้อมูลสินค้าในฟอร์มแก้ไข
        //แก้ไขเอกสารตัด
        $('#editsodesheet').val(product.product_code);
        $('#editsetsheet').val(product.qty);
        
        //แก้ไขราคามัดจำ
        $('#editdeposit_price').val(product.deposit_amount);
        $('#editdiscountsheet').val(product.discount);
        
        //แก้ไขชื่อรายการ
        $('#editnamesheet').val(product.name);
        
        //แก้ไขยอดหลังหักส่วนลด
        $('#editmoneyunitsheet').val(product.total);
        // ลบ disabled และ readonly ออกจาก textarea ก่อนเติมข้อมูล
        $('#editdetailsheet').prop('disabled', false);
        $('#editdetailsheet').prop('readonly', false);
        //แก้ไขรายละเอียด
        $('#editdetailsheet').val(product.desc_product);
        
        $('#editunitsheet').val(product.unit);
        $('#editmoneygroupsheet').val(product.total);
        
        // เก็บ ID ของสินค้าที่จะแก้ไข
        window.editingProductId = product.id;
        
    } else {
        alert('ไม่พบข้อมูลสินค้าตามรหัสที่ระบุ');
    }
}

// ฟังก์ชันสำหรับโหลดข้อมูลสินค้าลงในโมดอลเพิ่มเงินมัดจำ
function loadProductDataForEdit2(productCode) {
    if (!productCode) {
        console.error('ไม่พบรหัสสินค้าที่จะโหลด');
        return;
    }

    // หาข้อมูลสินค้าจาก allProducts (ข้อมูลที่ใช้ใน search)
    const product = allProducts.find(p => p.tx === productCode);
    
    if (product) {
        // แสดงข้อมูลสินค้าในโมดอลเพิ่มเงินมัดจำ
        $('#psodesheet2').val(product.tx || ''); // รหัส (เอกสารที่ตัด)
        $('#editnamesheet2').val(product.cus_name || ''); // ชื่อรายการ
        $('#deposit-desc').val('รับเงินมัดจำล่วงหน้า'); // รายละเอียด
        // คำนวณยอดรวมจากทุก item ใน product_byuser
        let totalAmount = 0;
        if (product.product_byuser && product.product_byuser.length > 0) {
            product.product_byuser.forEach(item => {
                totalAmount += parseFloat(item.total) || 0;
            });
        }
        $('#pmoneyunitsheet2').val(totalAmount.toFixed(2)); // ยอดหลังหักส่วนลด (ราคารวม)
        
        console.log('โหลดข้อมูลสินค้าลงในโมดอล:', {
            code: product.tx,
            name: product.cus_name,
            amount: totalAmount.toFixed(2)
        });
    } else {
        console.error('ไม่พบข้อมูลสินค้าตามรหัสที่ระบุ:', productCode);
        alert('ไม่พบข้อมูลสินค้าตามรหัสที่ระบุ');
    }
}

//ฟังก์ชันสำหรับอัปเดตข้อมูลสินค้า
function updateProductData() {
    // ตรวจสอบว่ามี ID ของสินค้าที่จะแก้ไข
    if (!window.editingProductId) {
        alert('ไม่พบข้อมูลสินค้าที่จะแก้ไข');
        return;
    }
    
    // อ่านค่าจากฟอร์มแก้ไข
    const qty = parseInt($('#editqtysheet').val()) || 1; // จำนวน
    const deposit_amount = parseFloat($('#editdeposit_price').val()) || 0; // ราคามัดจำ
    const amount_after_discount = parseFloat($('#editmoneyunitsheet').val()) || 0; // ยอดหลังหักส่วนลด
    const total = amount_after_discount; // ยอดหลังหักส่วนลด
    
    
    // ตรวจสอบว่าเป็นการเพิ่มสินค้าใหม่จาก master data หรือไม่
    if (window.isAddingFromMaster) {
        // สร้างสินค้าใหม่จากข้อมูลที่แก้ไข
        const newProduct = {
            id: window.editingProductId,
            product_code: window.selectedMasterProduct.product_code,
            name: $('#editnamesheet').val(), 
            desc_product: $('#editdetailsheet').val() || window.selectedMasterProduct.desc_product || '',
            qty: 1,
            unit: $('#editunitsheet').val(),
            deposit_amount: deposit_amount, // ราคามัดจำ
            amount_after_discount: amount_after_discount, // ยอดหลังหักส่วนลด
            discount: 0, // ไม่มีส่วนลด
            total: total.toFixed(2) // ยอดหลังหักส่วนลด
        };
        
        // เพิ่มสินค้าใหม่เข้าไปใน allProductData
        allProductData.push(newProduct);
        productTotalItems = allProductData.length;
        
        
        // รีเซ็ตตัวแปร
        window.isAddingFromMaster = false;
        window.selectedMasterProduct = null;
    } else {
        // หาดัชนีของสินค้าใน allProductData
        const productIndex = allProductData.findIndex(p => p.id == window.editingProductId);
        
        if (productIndex === -1) {
            alert('ไม่พบข้อมูลสินค้าที่จะแก้ไข');
            return;
        }
        
        
        // อัปเดตข้อมูลสินค้าใน allProductData
        allProductData[productIndex] = {
            ...allProductData[productIndex], // เก็บข้อมูลเดิม
            name: $('#editnamesheet').val(),
            desc_product: $('#editdetailsheet').val(),
            qty: 1,
            unit: $('#editunitsheet').val(),
            deposit_amount: deposit_amount, // ราคามัดจำ
            amount_after_discount: amount_after_discount, // ยอดหลังหักส่วนลด
            discount: 0, // ไม่มีส่วนลด
            total: total.toFixed(2) // ยอดหลังหักส่วนลด
        };
        
    }

    // อัปเดตการแสดงผล
    displayProductPage();
    updateProductPagination();
    displayProductCheckboxList();
    calculateTotalSummary();
    
    // ปิด modal
    const $productViewModal = $('#productViewModal');
    hidePopup($productViewModal);
    
    // รีเซ็ต editingProductId
    window.editingProductId = null;
    
    console.log('=== updateProductData เสร็จสิ้น ===');
    // alert('อัปเดตข้อมูลสินค้าสำเร็จ');
}

//ฟังก์ชันสำหรับดึงข้อมูลสินค้าตาม ID เพื่อแสดงใน modal view
function loadProductDataForView(productId) {
    if (!productId) {
        console.error('ไม่พบ ID ของสินค้าที่จะดู');
        return;
    }
    
    console.log('กำลังค้นหาข้อมูลสินค้า ID:', productId);
    
    // หาข้อมูลสินค้าจาก allProductData
    const product = allProductData.find(p => p.id == productId);
    console.log('ข้อมูลสินค้าที่พบ:', product);
                
                if (product) {
                    // แสดงข้อมูลใน modal view
                    displayProductInViewModal(product);
                } else {
                    alert('ไม่พบข้อมูลสินค้าตาม ID ที่ระบุ');
                }
}

//ฟังก์ชันสำหรับแสดงข้อมูลสินค้าใน modal
function displayProductInViewModal(product) {
    // แสดงข้อมูลในส่วน view
    $('#codesheet').text(product.product_code);
    $('#namesheet').text(product.name);
    $('#detailsheet').text(product.desc_product);
    $('#unitsheet').text(product.unit);
    $('#quantitysheet').text(product.qty);
    $('#discountsheet').text(product.discount);
    //$('#totalsheet').text(parseFloat(product.price * product.qty - product.discount).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}));
    $('#moneysheet').text(parseFloat(product.deposit_amount).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}));
    $('#maneybacksheet').text(parseFloat(product.total).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}));
    // ล้างค่าทั้งหมดก่อนแสดงข้อมูลใหม่
    clearEditForm();
    
    // แสดงข้อมูลในส่วน edit
    $('#editsodesheet').val(product.product_code);
    $('#editnamesheet').val(product.name);
    
    // ลบ disabled และ readonly ออกจาก textarea ก่อนเติมข้อมูล
    $('#editdetailsheet').prop('disabled', false);
    $('#editdetailsheet').prop('readonly', false);
    $('#editdetailsheet').val(product.desc_product); 
    
    $('#editsetsheet').val(product.qty);
    $('#editunitsheet').val(product.unit);
    $('#editmoneyunitsheet').val(product.deposit_amount);
    $('#editdiscountsheet').val(product.discount);
    

    $('#psodesheet2').val(product.tx || '');
    $('#editnamesheet2').val(product.cus_name || '');
    $('#pmoneyunitsheet2').val(product.net_amount != null ? product.net_amount : 0);
    $('#editdeposit_price2').val(product.amount_after_discount != null ? product.amount_after_discount : 0);
    // คำนวณราคารวมหลังจากแสดงข้อมูล
    calculateEditProductTotal();
    
}  

// ฟังก์ชันล้างค่าทั้งหมดในฟอร์มแก้ไขสินค้า
function clearEditForm() {
    // ล้างค่าทั้งหมด
    $('#editsodesheet').val('');
    $('#editnamesheet').val('');
    $('#editdetailsheet').val('');
    $('#editsetsheet').val('');
    $('#editunitsheet').val('');
    $('#editmoneyunitsheet').val('');
    $('#editdiscountsheet').val('');
    $('#editmoneygroupsheet').val('');
    
    // ลบ disabled และ readonly ออกจาก textarea
    $('#editdetailsheet').prop('disabled', false);
    $('#editdetailsheet').prop('readonly', false);
    
    // ล้าง error states และ validation
    $('.form-control').removeClass('is-invalid');
    $('.invalid-feedback').remove();
    
    // รีเซ็ต focus
    $('#editsodesheet').focus();
}

// ฟังก์ชันคำนวณราคารวมสำหรับฟอร์มแก้ไขสินค้า
function calculateEditProductTotal() {
    // แปลงราคาจากรูปแบบ 1,000.00 กลับเป็นตัวเลข
    const priceStr = $('#editmoneyunitsheet').val().replace(/,/g, '');
    const price = parseFloat(priceStr) || 0;
    
    // ใช้ deposit_amount
    const totalPrice = price;
    
    // แสดงผลในรูปแบบ 10,000.00
    $('#editmoneygroupsheet').val(totalPrice.toLocaleString('en-US', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    }));
}

// เพิ่ม event listener สำหรับคำนวณอัตโนมัติ
$(document).ready(function() {
    // คำนวณเมื่อมีการเปลี่ยนแปลงในช่องราคา
    $('#product-price-unit').on('input', function() {
        calculateProductTotal();
    });
    
    // คำนวณอัตโนมัติสำหรับฟอร์มแก้ไขสินค้า
    $('#editmoneyunitsheet').on('input', function() {
        calculateEditProductTotal();
    });
    
    // ล้างค่าทั้งหมดเมื่อปิด modal
    $('#productViewModal').on('hidden.bs.modal', function() {
        // ใช้ setTimeout เพื่อให้แน่ใจว่าการล้างค่าทำงานได้
        setTimeout(function() {
            clearEditForm();
        }, 100);
    });
    
    // Event listener สำหรับปุ่ม "เพิ่ม" ในฟอร์มแก้ไขสินค้า
    $('.addAndHideBtnaddsmallpen').on('click', function(e) {
        e.preventDefault();
        e.stopImmediatePropagation();
        console.log('ปุ่มเพิ่มในฟอร์มแก้ไขถูกกด - เรียก updateProductData');
        updateProductData();
        
        // ปิด modal myPopupaddsmallpen
        const $myPopupaddsmallpen = $('.myPopupaddsmallpen');
        hidePopup($myPopupaddsmallpen);

        displayProductPage();
        updateProductPagination();
    });
    
    // Event listener สำหรับปุ่ม "เพิ่ม" และ "ยกเลิก" ใน popup (cancelPopupBtn5)
    $('.cancelPopupBtn5').on('click', function(e) {
        e.preventDefault();
        e.stopImmediatePropagation();
        
        // ตรวจสอบว่าเป็นปุ่ม "เพิ่ม" หรือ "ยกเลิก"
        const buttonText = $(this).text().trim();
        console.log('ปุ่มใน popup ถูกกด:', buttonText);
        
        if (buttonText === 'เพิ่ม') {
            // 🔄 Sync checkbox หน้าหลักตามสถานะใน popup เมื่อกดปุ่มเพิ่ม
            const hasVatSelected = allProductData.some(p => p.isSelected);
            const hasWithholdingSelected = allProductData.some(p => p.isSelectedForWithholding);

            $('#list-tax-data').prop('checked', hasVatSelected);
            $('#list-tax-data-2').prop('checked', hasWithholdingSelected);
            
            console.log('✅ [Sync] อัปเดต checkbox หน้าหลักเมื่อกดปุ่มเพิ่ม');
            console.log('  - VAT มีรายการที่เลือก:', hasVatSelected, 'ภาษีหักมีรายการที่เลือก:', hasWithholdingSelected);
            
            // คำนวณหน้าหลักเมื่อกดปุ่มเพิ่ม
            calculateTotalSummary();
            // ล้างค่าเดิมหลังจากยืนยัน
            originalProductData = null;
            originalCheckboxStates = null;
        } else if (buttonText === 'ยกเลิก') {
            // คืนค่าเดิมเมื่อกดปุ่มยกเลิก
            console.log('🔙 [ยกเลิก] เริ่มกระบวนการยกเลิกและคืนค่าเดิม');
            if (originalProductData && originalCheckboxStates) {
                // เก็บข้อมูลปัจจุบันก่อนคืนค่า (สำหรับเปรียบเทียบ)
                const currentProductData = JSON.parse(JSON.stringify(allProductData));
                const currentPopupValues = {
                    deleteVat: $('#delete-vat').val(),
                    rightUnder: $('.right-under').val()
                };
                
                console.log('📊 [ยกเลิก] ข้อมูลก่อนคืนค่า:');
                console.log('  - ข้อมูลสินค้าปัจจุบัน:', currentProductData.length, 'รายการ');
                console.log('  - Popup Values ปัจจุบัน:', currentPopupValues);
                
                console.log('💾 [ยกเลิก] ข้อมูลเดิมที่เก็บไว้:');
                console.log('  - ข้อมูลสินค้าเดิม:', originalProductData.length, 'รายการ');
                console.log('  - Checkbox States เดิม:', originalCheckboxStates);
                console.log('  - Popup Values เดิม:', originalPopupValues);
                
                // 🔧 ป้องกันการลบสินค้า - เก็บจำนวนสินค้าก่อนคืนค่า
                const productCountBeforeCancel = allProductData.length;
                console.log('🛡️ [ป้องกัน] จำนวนสินค้าก่อนยกเลิก:', productCountBeforeCancel, 'รายการ');
                console.log('🔧 [ยกเลิก] คืนเฉพาะ checkbox states - ไม่คืนข้อมูลสินค้า');
                
                // คืนค่าเดิมของ checkbox states
                let changedProductCount = 0;
                allProductData.forEach(product => {
                    const vatState = originalCheckboxStates.vat && originalCheckboxStates.vat.find(s => s.id === product.id);
                    const withholdingState = originalCheckboxStates.withholding && originalCheckboxStates.withholding.find(s => s.id === product.id);
                    const withholding2State = originalCheckboxStates.withholding2 && originalCheckboxStates.withholding2.find(s => s.id === product.id);
                    const withholding3State = originalCheckboxStates.withholding3 && originalCheckboxStates.withholding3.find(s => s.id === product.id);
                    
                    // เปรียบเทียบและแสดงการเปลี่ยนแปลง
                    const currentProduct = currentProductData.find(p => p.id === product.id);
                    if (currentProduct) {
                        let changes = [];
                        
                        if (vatState && vatState.isSelected !== currentProduct.isSelected) {
                            changes.push(`VAT: ${currentProduct.isSelected} → ${vatState.isSelected}`);
                        }
                        if (withholdingState && withholdingState.isSelectedForWithholding !== currentProduct.isSelectedForWithholding) {
                            changes.push(`ภาษีหัก1: ${currentProduct.isSelectedForWithholding} → ${withholdingState.isSelectedForWithholding}`);
                        }
                        if (withholding2State && withholding2State.isSelectedForWithholding2 !== currentProduct.isSelectedForWithholding2) {
                            changes.push(`ภาษีหัก2: ${currentProduct.isSelectedForWithholding2} → ${withholding2State.isSelectedForWithholding2}`);
                        }
                        if (withholding3State && withholding3State.isSelectedForWithholding3 !== currentProduct.isSelectedForWithholding3) {
                            changes.push(`ภาษีหัก3: ${currentProduct.isSelectedForWithholding3} → ${withholding3State.isSelectedForWithholding3}`);
                        }
                        
                        if (changes.length > 0) {
                            console.log(`🔄 [ยกเลิก] สินค้า ID ${product.id} (${product.name}): ${changes.join(', ')}`);
                            changedProductCount++;
                        }
                    }
                    
                    // คืนค่าเดิม
                    if (vatState) product.isSelected = vatState.isSelected;
                    if (withholdingState) product.isSelectedForWithholding = withholdingState.isSelectedForWithholding;
                    if (withholding2State) product.isSelectedForWithholding2 = withholding2State.isSelectedForWithholding2;
                    if (withholding3State) product.isSelectedForWithholding3 = withholding3State.isSelectedForWithholding3;
                });
                
                console.log(`📈 [ยกเลิก] รวมสินค้าที่มีการเปลี่ยนแปลง: ${changedProductCount} รายการ`);
                
                // คืนค่าเดิมของ popup values
                if (originalPopupValues) {
                    const oldDeleteVat = $('#delete-vat').val();
                    const oldRightUnder = $('.right-under').val();
                    
                    $('#delete-vat').val(originalPopupValues.deleteVat);
                    $('.right-under').val(originalPopupValues.rightUnder);
                    
                    console.log('🔄 [ยกเลิก] คืนค่า Popup Values:');
                    console.log(`  - delete-vat: ${oldDeleteVat} → ${originalPopupValues.deleteVat}`);
                    console.log(`  - right-under: ${oldRightUnder} → ${originalPopupValues.rightUnder}`);
                }
                
                // 🔧 ป้องกันการ sync ใหม่เมื่อยกเลิก - ตั้งค่า flag เพื่อไม่ให้ sync
                window.isRestoringFromCancel = true;
                
                // อัปเดตการแสดงผล checkbox โดยไม่ sync ใหม่
                displayProductCheckboxList();
                console.log('🔄 [ยกเลิก] อัปเดต VAT checkbox list แล้ว (ไม่ sync ใหม่)');
                
                // รีเซ็ต flag หลังจากอัปเดตเสร็จ
                    window.isRestoringFromCancel = false;
                
                // 🔧 ไม่ต้องอัปเดต checkbox list ของภาษีหักเมื่อยกเลิก
                // เพื่อป้องกันไม่ให้ภาษีหักที่ไม่ได้ติ๊กถูกติ๊กหมด
                console.log('🔄 [ยกเลิก] ข้ามการอัปเดต checkbox list ของภาษีหัก (ป้องกันการติ๊กอัตโนมัติ)');
                
                // คำนวณใหม่เพื่อคืนค่าเดิม
                calculateTotalSummary();
                console.log('💰 [ยกเลิก] คำนวณราคารวมใหม่แล้ว');
                
                // ล้างค่าเดิมหลังจากยกเลิก
                originalProductData = null;
                originalCheckboxStates = null;
                originalPopupValues = null;
                
                // 🛡️ ตรวจสอบว่าจำนวนสินค้าไม่เปลี่ยน
                const productCountAfterCancel = allProductData.length;
                console.log('🛡️ [ป้องกัน] จำนวนสินค้าหลังยกเลิก:', productCountAfterCancel, 'รายการ');
                
                if (productCountBeforeCancel === productCountAfterCancel) {
                    console.log('✅ [ป้องกัน] ปลอดภัย - ไม่มีสินค้าถูกลบ');
                } else {
                    console.error('🚨 [ป้องกัน] เตือน! จำนวนสินค้าเปลี่ยนจาก', productCountBeforeCancel, 'เป็น', productCountAfterCancel);
                }
                
                console.log('✅ [ยกเลิก] คืนค่าเดิมเสร็จสิ้น - ล้างข้อมูลที่เก็บไว้แล้ว');
            } else {
                console.log('⚠️ [ยกเลิก] ไม่พบข้อมูลเดิมที่เก็บไว้ - ไม่มีอะไรให้คืนค่า');
            }
        }
    });
    
    // Event listener สำหรับปุ่ม "เพิ่ม" สินค้า
    $('#btnConfirmAdd').off('click').on('click', function(e) {
        e.preventDefault();
        e.stopImmediatePropagation();
        console.log('ปุ่มเพิ่มถูกกด - เรียก addProductToDatabase');
        
        // ป้องกันการเรียกซ้ำ
        if (window.isAddingProduct) {
            console.log('กำลังเพิ่มสินค้าอยู่แล้ว - ข้ามการเรียกซ้ำ');
            return;
        }
        
        addProductToDatabase();
    });
    
    // Event listener สำหรับปุ่ม "เพิ่ม" ใน popup search สินค้า
    $('.sideaddSaveBtn').off('click').on('click', function(e) {
        e.preventDefault();
        e.stopImmediatePropagation();
        console.log('ปุ่มเพิ่มใน popup search ถูกกด');
        
        // ตรวจสอบว่ามีสินค้าที่เลือกหรือไม่
        if (!window.selectedMasterProduct) {
            alert('กรุณาเลือกสินค้าก่อน');
            return;
        }
        
        // ปิด popup search
        $('.popup-container.sideadd').hide();
        
        // เปิด popup แก้ไข
        const $myPopupsPenView = $('.myPopuppenview');
        showPopup($myPopupsPenView);
        console.log('เปิด popup แก้ไขสำหรับสินค้า:', window.selectedMasterProduct.product_code);
        
        // เติมข้อมูลสินค้าที่เลือกในฟอร์มแก้ไข
        fillEditFormWithMasterProduct(window.selectedMasterProduct);
    });
    
    // Event listener สำหรับการคำนวณ total ในฟอร์มแก้ไข
    $(document).on('input change', '#editmoneyunitsheet', function() {
        const price = parseFloat($('#editmoneyunitsheet').val()) || 0;
        
        // ใช้ deposit_amount
        const total = price;
        
        // แสดง total ในฟิลด์ที่ถูกต้อง
        if ($('#editmoneygroupsheet').length) {
            $('#editmoneygroupsheet').val(total.toFixed(2));
        }
        
    });
    
    // Event listener สำหรับ pagination buttons ของ popup view
    $(document).on('click', '.pagination a[data-product-page]', function(e) {
        e.preventDefault();
        const page = parseInt($(this).data('product-page'));
        if (page && page !== productCurrentPage) {
            productCurrentPage = page;
            displayProductPage();
            updateProductPagination();
        }
    });
    
    // Event listener สำหรับ pagination buttons ของ checkbox list
    $(document).on('click', 'a[data-checkbox-page]', function(e) {
        e.preventDefault();
        const page = parseInt($(this).data('checkbox-page'));
        if (page && page !== checkboxCurrentPage) {
            goToCheckboxPage(page);
        }
    });
    
    // Event listener สำหรับ pagination buttons ของ checkbox list2
    $(document).on('click', 'a[data-checkbox-page2]', function(e) {
        e.preventDefault();
        const page = parseInt($(this).data('checkbox-page2'));
        if (page && page !== checkboxCurrentPage2) {
            goToCheckboxPage2(page);
        }
    });
    
    // Event listener สำหรับกล่องกรอกหมายเลขหน้า checkbox list
    $(document).on('keypress', '#checkboxPageJump', function(e) {
        if (e.which === 13) { // Enter key
            e.preventDefault();
            const page = parseInt($(this).val());
            const totalPages = Math.ceil(allProductData.length / checkboxItemsPerPage);
            if (page >= 1 && page <= totalPages) {
                goToCheckboxPage(page);
                $(this).val(''); // ล้างค่าในช่อง
            }
        }
    });
    
    // Event listener สำหรับกล่องกรอกหมายเลขหน้า checkbox list2
    $(document).on('keypress', '#checkboxPageJump2', function(e) {
        if (e.which === 13) { // Enter key
            e.preventDefault();
            const page = parseInt($(this).val());
            const totalPages = Math.ceil(allProductData.length / checkboxItemsPerPage);
            if (page >= 1 && page <= totalPages) {
                goToCheckboxPage2(page);
                $(this).val(''); // ล้างค่าในช่อง
            }
        }
    });
    
    // Event listener สำหรับ pagination buttons ของ checkbox list3
    $(document).on('click', 'a[data-checkbox-page3]', function(e) {
        e.preventDefault();
        const page = parseInt($(this).data('checkbox-page3'));
        if (page && page !== checkboxCurrentPage3) {
            goToCheckboxPage3(page);
        }
    });
    
    // Event listener สำหรับกล่องกรอกหมายเลขหน้า checkbox list3
    $(document).on('keypress', '#checkboxPageJump3', function(e) {
        if (e.which === 13) { // Enter key
            e.preventDefault();
            const page = parseInt($(this).val());
            const totalPages = Math.ceil(allProductData.length / checkboxItemsPerPage);
            if (page >= 1 && page <= totalPages) {
                goToCheckboxPage3(page);
                $(this).val(''); // ล้างค่าในช่อง
            }
        }
    });
    
    // Event listener สำหรับ pagination buttons ของ checkbox list4
    $(document).on('click', 'a[data-checkbox-page4]', function(e) {
        e.preventDefault();
        const page = parseInt($(this).data('checkbox-page4'));
        if (page && page !== checkboxCurrentPage4) {
            goToCheckboxPage4(page);
        }
    });
    
    // Event listener สำหรับกล่องกรอกหมายเลขหน้า checkbox list4
    $(document).on('keypress', '#checkboxPageJump4', function(e) {
        if (e.which === 13) { // Enter key
            e.preventDefault();
            const page = parseInt($(this).val());
            const totalPages = Math.ceil(allProductData.length / checkboxItemsPerPage);
            if (page >= 1 && page <= totalPages) {
                goToCheckboxPage4(page);
                $(this).val(''); // ล้างค่าในช่อง
            }
        }
    });
    
    // Event listener สำหรับ checkbox change (Container - ภาษี 7%)
    $(document).on('change', '.checkbox-table-input', function() {
        const productId = $(this).data('product-id');
        const isChecked = $(this).is(':checked');
        
        // เก็บค่าเดิมก่อนแก้ไข (ถ้ายังไม่เคยเก็บ)
        if (!originalProductData) {
            originalProductData = JSON.parse(JSON.stringify(allProductData));
            originalCheckboxStates = {
                vat: allProductData.map(p => ({ id: p.id, isSelected: p.isSelected })),
                withholding: allProductData.map(p => ({ id: p.id, isSelectedForWithholding: p.isSelectedForWithholding }))
            };
            originalPopupValues = {
                deleteVat: $('#delete-vat').val(),
                rightUnder: $('.right-under').val()
            };
            console.log('เก็บค่าเดิมก่อนแก้ไข');
        }
        
        // อัปเดตสถานะในข้อมูลสินค้า
        const product = allProductData.find(p => p.id === productId);
        if (product) {
            product.isSelected = isChecked;
        }
        
        console.log(`Product ${productId} VAT checkbox changed to: ${isChecked}`);
        
        // 🔄 Reverse Sync: อัปเดต checkbox หน้าหลักตามสถานะใน popup (เฉพาะเมื่อกดปุ่มเพิ่ม)
        // ไม่ sync ทันทีเมื่อติ๊ก checkbox เพื่อให้สามารถยกเลิกได้
        console.log('🔶 [Reverse Sync] ไม่ sync กับหน้าหลักทันที - รอให้กดปุ่มเพิ่ม');
        
        // อัปเดตราคาใน checkbox list เฉพาะ Container แรก (VAT) เท่านั้น
        const priceElement = $(`#product-checkbox-list [data-product-id="${productId}"]`).filter(function() {
            return $(this).closest('.checkbox-list-box-sum').length > 0;
        });
        if (priceElement.length > 0) {
            const newPrice = calculateTotalWithVAT(1, product.deposit_amount, 0, isChecked);
            priceElement.text(newPrice);
        }
        
        // คำนวณใหม่เมื่อมีการเปลี่ยนแปลง checkbox
        isPopupCalculation = true;
        calculateTotalSummary();
        isPopupCalculation = false;
    });
    
    // Event listener สำหรับ checkbox change (Container3 - ภาษีหัก ณ ที่จ่าย 2)
    $(document).on('change', '.checkbox-table-input3', function() {
        const productId = $(this).data('product-id');
        const isChecked = $(this).is(':checked');
        
        // เก็บค่าเดิมก่อนแก้ไข (ถ้ายังไม่เคยเก็บ)
        if (!originalProductData) {
            originalProductData = JSON.parse(JSON.stringify(allProductData));
            originalCheckboxStates = {
                vat: allProductData.map(p => ({ id: p.id, isSelected: p.isSelected })),
                withholding: allProductData.map(p => ({ id: p.id, isSelectedForWithholding: p.isSelectedForWithholding })),
                withholding2: allProductData.map(p => ({ id: p.id, isSelectedForWithholding2: p.isSelectedForWithholding2 })),
                withholding3: allProductData.map(p => ({ id: p.id, isSelectedForWithholding3: p.isSelectedForWithholding3 }))
            };
            originalPopupValues = {
                deleteVat: $('#delete-vat').val(),
                rightUnder: $('.right-under').val()
            };
            console.log('เก็บค่าเดิมก่อนแก้ไข');
        }
        
        // อัปเดตสถานะในข้อมูลสินค้า (ใช้ property แยกสำหรับ withholding tax 2)
        const product = allProductData.find(p => p.id === productId);
        if (product) {
            product.isSelectedForWithholding2 = isChecked;
        }
        
        console.log(`Product ${productId} Withholding Tax 2 checkbox changed to: ${isChecked}`);
        
        // อัปเดตราคาใน checkbox list เฉพาะ Container3 (Withholding Tax 2) เท่านั้น
        const priceElement = $(`#product-checkbox-list3 [data-product-id="${productId}"]`).filter(function() {
            return $(this).closest('.checkbox-list-box-sum').length > 0;
        });
        if (priceElement.length > 0) {
            const taxRate2 = $('#tax_withheld2').val() || '0.0%';
            const newPrice = calculateTotalWithWithholdingTax(1, product.deposit_amount, 0, isChecked, taxRate2);
            priceElement.text(newPrice);
        }
        
        // อัปเดต checkbox list ทั้งหมดเมื่อมีการเปลี่ยนแปลงในอันที่สอง
        const form2 = document.getElementById('tax-withheld-form-2');
        const form3 = document.getElementById('tax-withheld-form-3');
        
        // อัปเดตอันแรก (ถ้าฟอร์มแสดงอยู่)
        updateCheckboxList2();
        
        if (form3 && form3.style.display !== 'none') {
            updateCheckboxList4();
        }
        
        // คำนวณใหม่เมื่อมีการเปลี่ยนแปลง checkbox
        isPopupCalculation = true;
        calculateTotalSummary();
        isPopupCalculation = false;
    });
    
    // Event listener สำหรับ checkbox change (Container4 - ภาษีหัก ณ ที่จ่าย 3)
    $(document).on('change', '.checkbox-table-input4', function() {
        const productId = $(this).data('product-id');
        const isChecked = $(this).is(':checked');
        
        // เก็บค่าเดิมก่อนแก้ไข (ถ้ายังไม่เคยเก็บ)
        if (!originalProductData) {
            originalProductData = JSON.parse(JSON.stringify(allProductData));
            originalCheckboxStates = {
                vat: allProductData.map(p => ({ id: p.id, isSelected: p.isSelected })),
                withholding: allProductData.map(p => ({ id: p.id, isSelectedForWithholding: p.isSelectedForWithholding })),
                withholding2: allProductData.map(p => ({ id: p.id, isSelectedForWithholding2: p.isSelectedForWithholding2 })),
                withholding3: allProductData.map(p => ({ id: p.id, isSelectedForWithholding3: p.isSelectedForWithholding3 }))
            };
            originalPopupValues = {
                deleteVat: $('#delete-vat').val(),
                rightUnder: $('.right-under').val()
            };
            console.log('เก็บค่าเดิมก่อนแก้ไข');
        }
        
        // อัปเดตสถานะในข้อมูลสินค้า (ใช้ property แยกสำหรับ withholding tax 3)
        const product = allProductData.find(p => p.id === productId);
        if (product) {
            product.isSelectedForWithholding3 = isChecked;
        }
        
        console.log(`Product ${productId} Withholding Tax 3 checkbox changed to: ${isChecked}`);
        
        // อัปเดตราคาใน checkbox list เฉพาะ Container4 (Withholding Tax 3) เท่านั้น
        const priceElement = $(`#product-checkbox-list4 [data-product-id="${productId}"]`).filter(function() {
            return $(this).closest('.checkbox-list-box-sum').length > 0;
        });
        if (priceElement.length > 0) {
            const taxRate3 = $('#tax_withheld3').val() || '0.0%';
            const newPrice = calculateTotalWithWithholdingTax(1, product.deposit_amount, 0, isChecked, taxRate3);
            priceElement.text(newPrice);
        }
        
        // อัปเดต checkbox list ทั้งหมดเมื่อมีการเปลี่ยนแปลงในอันที่สาม
        const form2 = document.getElementById('tax-withheld-form-2');
        const form3 = document.getElementById('tax-withheld-form-3');
        
        // อัปเดตอันแรกและอันที่สอง (ถ้าฟอร์มแสดงอยู่)
        updateCheckboxList2();
        
        if (form2 && form2.style.display !== 'none') {
            updateCheckboxList3();
        }
        
        // คำนวณใหม่เมื่อมีการเปลี่ยนแปลง checkbox
        isPopupCalculation = true;
        calculateTotalSummary();
        isPopupCalculation = false;
    });
    
    // Event listener สำหรับ checkbox change (Container2 - ภาษีหัก ณ ที่จ่าย)
    $(document).on('change', '.checkbox-table-input2', function() {
        const productId = $(this).data('product-id');
        const isChecked = $(this).is(':checked');
        
        // เก็บค่าเดิมก่อนแก้ไข (ถ้ายังไม่เคยเก็บ)
        if (!originalProductData) {
            originalProductData = JSON.parse(JSON.stringify(allProductData));
            originalCheckboxStates = {
                vat: allProductData.map(p => ({ id: p.id, isSelected: p.isSelected })),
                withholding: allProductData.map(p => ({ id: p.id, isSelectedForWithholding: p.isSelectedForWithholding }))
            };
            originalPopupValues = {
                deleteVat: $('#delete-vat').val(),
                rightUnder: $('.right-under').val()
            };
            console.log('เก็บค่าเดิมก่อนแก้ไข');
        }
        
        // อัปเดตสถานะในข้อมูลสินค้า (ใช้ property แยกสำหรับ withholding tax)
        const product = allProductData.find(p => p.id === productId);
        if (product) {
            product.isSelectedForWithholding = isChecked;
        }
        
        console.log(`Product ${productId} Withholding Tax checkbox changed to: ${isChecked}`);
        
        // 🔄 Reverse Sync: อัปเดต checkbox หน้าหลักตามสถานะใน popup
        const allWithholdingSelected = allProductData.every(p => p.isSelectedForWithholding);
        const noWithholdingSelected = allProductData.every(p => !p.isSelectedForWithholding);
        
        if (allWithholdingSelected) {
            $('#list-tax-data-2').prop('checked', true);
            console.log('✅ [Reverse Sync] ติ๊กภาษีหักหน้าหลัก (ทุกรายการติ๊ก)');
        } else if (noWithholdingSelected) {
            $('#list-tax-data-2').prop('checked', false);
            console.log('❌ [Reverse Sync] ยกเลิกภาษีหักหน้าหลัก (ทุกรายการยกเลิก)');
        } else {
            console.log('🔶 [Reverse Sync] ภาษีหักหน้าหลักคงที่ (มีบางรายการติ๊ก)');
        }
        
        // อัปเดตราคาใน checkbox list เฉพาะ Container2 (Withholding Tax) เท่านั้น
        const priceElement = $(`#product-checkbox-list2 [data-product-id="${productId}"]`).filter(function() {
            return $(this).closest('.checkbox-list-box-sum').length > 0;
        });
        if (priceElement.length > 0) {
            const taxRate = $('#tax_withheld').val() || '0.0%';
            const newPrice = calculateTotalWithWithholdingTax(1, product.deposit_amount, 0, isChecked, taxRate);
            priceElement.text(newPrice);
        }
        
        // อัปเดต checkbox list ทั้งหมดเมื่อมีการเปลี่ยนแปลงในอันแรก
        const form2 = document.getElementById('tax-withheld-form-2');
        const form3 = document.getElementById('tax-withheld-form-3');
        
        if (form2 && form2.style.display !== 'none') {
            updateCheckboxList3();
        }
        
        if (form3 && form3.style.display !== 'none') {
            updateCheckboxList4();
        }
        
        // คำนวณใหม่เมื่อมีการเปลี่ยนแปลง checkbox
        isPopupCalculation = true;
        calculateTotalSummary();
        isPopupCalculation = false;
    });
    
    // Event listener สำหรับ input field ราคารวม (Container - ภาษี 7%)
    $(document).on('input', '.code-edit-box-sum-edit', function() {
        const productId = $(this).data('product-id');
        const newValue = $(this).val();
        
        console.log(`Product ${productId} VAT price changed to: ${newValue}`);
        
        // อัปเดตข้อมูลใน allProductData
        const product = allProductData.find(p => p.id === productId);
        if (product) {
            // ใช้ deposit_amount
            const totalPrice = parseFloat(newValue.replace(/,/g, '')) || 0;
            
            product.deposit_amount = totalPrice.toFixed(2);
            console.log(`Updated product ${productId} VAT price to: ${product.deposit_amount}`);
        }
        
        // คำนวณใหม่เมื่อมีการเปลี่ยนแปลง
        isPopupCalculation = true;
        calculateTotalSummary();
        isPopupCalculation = false;
    });
    
    // Event listener สำหรับ input field ราคารวม (Container2 - ภาษีหัก ณ ที่จ่าย)
    $(document).on('input', '.code-edit-box-sum-edit2', function() {
        const productId = $(this).data('product-id');
        const newValue = $(this).val();
        
        console.log(`Product ${productId} Withholding Tax price changed to: ${newValue}`);
        
        // อัปเดตข้อมูลใน allProductData (ใช้ property แยกสำหรับ withholding tax)
        const product = allProductData.find(p => p.id === productId);
        if (product) {
            // ใช้ deposit_amount
            const totalPrice = parseFloat(newValue.replace(/,/g, '')) || 0;
            
            product.priceForWithholding = totalPrice.toFixed(2);
            console.log(`Updated product ${productId} Withholding Tax price to: ${product.priceForWithholding}`);
        }
        
        // คำนวณใหม่เมื่อมีการเปลี่ยนแปลง
        isPopupCalculation = true;
        calculateTotalSummary();
        isPopupCalculation = false;
    });
    
    // Event listener สำหรับ delete-vat input field
    $(document).on('input', '#delete-vat', function() {
        // เก็บค่าเดิมก่อนแก้ไข (ถ้ายังไม่เคยเก็บ)
        if (!originalProductData) {
            originalProductData = JSON.parse(JSON.stringify(allProductData));
            originalCheckboxStates = {
                vat: allProductData.map(p => ({ id: p.id, isSelected: p.isSelected })),
                withholding: allProductData.map(p => ({ id: p.id, isSelectedForWithholding: p.isSelectedForWithholding }))
            };
            originalPopupValues = {
                deleteVat: $('#delete-vat').val(),
                rightUnder: $('.right-under').val()
            };
            console.log('เก็บค่าเดิมก่อนแก้ไข');
        }
        
        isPopupCalculation = true;
        calculateTotalSummary();
        isPopupCalculation = false;
    });
});

//ฟังก์ชันสำหรับอัปเดตใบเสนอราคา ปิด

/**
 * ฟังก์ชันจัดการการบันทึกใบเสนอราคา
 * ตัดสินใจว่าจะสร้างใหม่หรืออัปเดตตามโหมดที่ใช้
 */
function handleSaveQuotation() {
    if (window.editQuotationId) {
        // โหมดแก้ไข: อัปเดตใบเสนอราคาที่มีอยู่
        updateQuotation();
    } else {
        // โหมดสร้างใหม่: สร้างใบเสนอราคาใหม่
        createQuotation();
    }
}

/* ===========================================
   PRODUCT DATA DISPLAY & MANAGEMENT
   =========================================== */

/**
 * แสดงข้อมูลสินค้าทั้งหมด
 * โหลดจาก API และแสดงในตาราง
 */
function showProductData() {
    // ตรวจสอบว่ามีข้อมูลสินค้าหรือไม่
    if (allProductData && allProductData.length > 0) {
        console.log('Found products in allProductData:', allProductData.length);
        
                // มีข้อมูล - แสดงตารางข้อมูล
                $('#noDataSection').hide();
                $('#myPopupview').show();
                
                productTotalItems = allProductData.length;
                
                // แสดงข้อมูลหน้าแรก
                productCurrentPage = 1;
                displayProductPage();
                updateProductPagination();
                
                // แสดงข้อมูลในรูปแบบ checkbox list
                checkboxCurrentPage = 1;
                displayProductCheckboxList();
                
                // คำนวณราคาสุทธิทั้งหมด
                calculateTotalSummary();
            } else {
        console.log('No products found in allProductData');
                // ไม่มีข้อมูล - แสดงข้อความไม่พบข้อมูล
                $('#noDataSection').show();
                $('#myPopupview').hide();
                clearProductTable();
            }
}


/**
 * แสดงข้อมูลสินค้าตามหน้าที่เลือก
 * จัดการ pagination และการแสดงผล
 */
function displayProductPage() {
    const tbody = $('#myPopupview tbody');
    tbody.empty(); // ล้างข้อมูลเก่า
    
    // ตรวจสอบว่ามีข้อมูลหรือไม่
    if (!allProductData || allProductData.length === 0) {
        console.log('ไม่มีข้อมูลสินค้า - แสดงข้อความไม่มีข้อมูล');
        $('#noDataSection').show();
        $('#myPopupview').hide();
        return;
    }
    
    // แสดงตารางข้อมูล
    $('#noDataSection').hide();
    $('#myPopupview').show();
    
    // เรียงลำดับข้อมูลตามรหัสสินค้า
    const sortedData = [...allProductData].sort((a, b) => {
        return (a.product_code || '').localeCompare(b.product_code || '');
    });
    
    const startIndex = (productCurrentPage - 1) * productItemsPerPage;
    const endIndex = startIndex + productItemsPerPage;
    const pageData = sortedData.slice(startIndex, endIndex);
    
    pageData.forEach((product, index) => {
        const globalIndex = startIndex + index;
        const row = `
            <tr class="data-row">
                <td>${globalIndex + 1}</td>
                <td>${product.product_code || ''}</td>
                <td>${product.name || ''}</td>
                <td>${product.desc_product || ''}</td>
                <td>${product.total|| ''}</td>
                <td>${product.deposit_amount || ''}</td>
                <td>
                    <div class="action-icons">
                        <div class="openPopupBtnview">
                            <div class="ac-icon"><img src="picture/eye.png" data-action="view" data-id="${product.id}"></div>
                        </div>
                        <div class="openPopupBtnpenview">
                            <div class="ac-icon"><img src="picture/pen.png" data-action="edit" data-id="${product.product_code}"></div>
                        </div>
                        <div class="openPopupBtndelete">
                            <div class="ac-icon"><img src="picture/bin.png" data-action="delete" data-id="${product.id}"></div>
                        </div>
                    </div>
                </td>
            </tr>
        `;
        tbody.append(row);
    });
}

// pagination ของ checkbox list
let checkboxCurrentPage = 1;
let checkboxCurrentPage2 = 1;
let checkboxCurrentPage3 = 1;
let checkboxCurrentPage4 = 1;
const checkboxItemsPerPage = 5;

// แสดงข้อมูลสินค้าในรูปแบบ checkbox list
function displayProductCheckboxList() {
    const container = $('#product-checkbox-list');
    const container2 = $('#product-checkbox-list2');
    container.empty(); // ล้างข้อมูลเก่า
    container2.empty(); // ล้างข้อมูลเก่า
    
    console.log('🔍 [Debug] displayProductCheckboxList ถูกเรียก');
    
    // 🔧 ตรวจสอบว่า popup เปิดอยู่จริงหรือไม่
    const isPopupVisible = $('#myPopupeditpen').is(':visible') || $('#myPopupeditpen').hasClass('show');
    console.log('🔍 [Debug] popup เปิดอยู่หรือไม่:', isPopupVisible);
    
    // 🔧 รีเซ็ต originalProductData เมื่อเปิด popup ใหม่ (ไม่ใช่ edit mode)
    if (!window.editQuotationId) {
        originalProductData = null;
        originalCheckboxStates = null;
        originalPopupValues = null;
        console.log('🔄 [Reset] รีเซ็ต originalProductData สำหรับ popup ใหม่');
    }
    
    // 🔧 Sync ข้อมูลกับสถานะ checkbox หน้าหลัก (เฉพาะเมื่อเปิด popup ครั้งแรก)
    // ป้องกันการ sync ใหม่เมื่อกำลังคืนค่าจากการยกเลิก
    if (!window.editQuotationId && !originalProductData && !window.isRestoringFromCancel) {
        const isMainVatChecked = $('#list-tax-data').is(':checked');
        const isMainWithholdingChecked = $('#list-tax-data-2').is(':checked');
        
        console.log('🔧 [Sync ครั้งแรก] สถานะหน้าหลัก - VAT:', isMainVatChecked, 'ภาษีหัก:', isMainWithholdingChecked);
        
        allProductData.forEach(product => {
            // Sync กับสถานะ checkbox หน้าหลัก
            product.isSelected = isMainVatChecked; // สำหรับ VAT (ภาษี 7%)
            product.isSelectedForWithholding = isMainWithholdingChecked; // สำหรับ Withholding Tax (ภาษีหัก ณ ที่จ่าย)
        });
        
        console.log('✅ [Sync ครั้งแรก] Sync ข้อมูลกับหน้าหลักเสร็จแล้ว');
        
        // เก็บข้อมูลเดิมหลังจาก sync
        console.log('📦 [เปิด Popup ครั้งแรก] เก็บข้อมูลเดิมหลัง sync');
        
        originalProductData = JSON.parse(JSON.stringify(allProductData));
        originalCheckboxStates = {
            vat: allProductData.map(p => ({ id: p.id, isSelected: p.isSelected })),
            withholding: allProductData.map(p => ({ id: p.id, isSelectedForWithholding: p.isSelectedForWithholding })),
            withholding2: allProductData.map(p => ({ id: p.id, isSelectedForWithholding2: p.isSelectedForWithholding2 })),
            withholding3: allProductData.map(p => ({ id: p.id, isSelectedForWithholding3: p.isSelectedForWithholding3 }))
        };
        originalPopupValues = {
            deleteVat: $('#delete-vat').val(),
            rightUnder: $('.right-under').val()
        };
        
        console.log('✅ [เปิด Popup ครั้งแรก] เก็บข้อมูลเดิมเสร็จแล้ว');
        console.log('💾 [เปิด Popup ครั้งแรก] ข้อมูลเดิมที่เก็บ:', originalCheckboxStates);
    } else {
        console.log('🔄 [ข้าม Sync] ไม่ sync');
        console.log('🔄 [ข้าม Sync] เหตุผล: editQuotationId=', window.editQuotationId, 'originalProductData=', !!originalProductData, 'isRestoringFromCancel=', !!window.isRestoringFromCancel);
    }
    
    
    // คำนวณข้อมูลที่จะแสดงในหน้าปัจจุบัน (สำหรับ container แรก)
    const startIndex = (checkboxCurrentPage - 1) * checkboxItemsPerPage;
    const endIndex = startIndex + checkboxItemsPerPage;
    const currentPageData = allProductData.slice(startIndex, endIndex);
    
    // คำนวณข้อมูลที่จะแสดงในหน้าปัจจุบัน (สำหรับ container ที่สอง)
    const startIndex2 = (checkboxCurrentPage2 - 1) * checkboxItemsPerPage;
    const endIndex2 = startIndex2 + checkboxItemsPerPage;
    const currentPageData2 = allProductData.slice(startIndex2, endIndex2);
    
    // แสดงข้อมูลในหน้าปัจจุบัน (Container แรก - VAT)
    currentPageData.forEach((product, index) => {
        const globalIndex = startIndex + index;
        const checkboxId = `product-checkbox-${globalIndex}`;
        const totalPrice = calculateTotalWithVAT(1, product.deposit_amount, 0, product.isSelected);
        
        // console.log(`Creating checkbox for product ${product.id}: isSelected=${product.isSelected}`);
        
        // Container สำหรับไม่เอา ภาษี 7% (VAT)
        const checkboxItem = `
            <div class="checkbox-list-box-sum">
                <div class="edit-sum">
                    <div class="checkbox-item">
                        <input type="checkbox" name="product_visits" id="${checkboxId}"
                            class="checkbox-table-input" data-product-id="${product.id}" ${product.isSelected ? 'checked' : ''}>
                    </div>
                    <label for="${checkboxId}">รายการที่ ${globalIndex + 1}:
                        ${product.name}</label>
                </div>
                <div>
                    <div class="bold-16" data-product-id="${product.id}" value="${totalPrice}">${totalPrice}</div>
                </div>
            </div>
        `;
        
        // console.log(`Creating VAT checkbox for product ${product.id}: isSelected=${product.isSelected}, HTML: ${product.isSelected ? 'checked' : ''}`);
        container.append(checkboxItem);
    });
    
    // แสดงข้อมูลในหน้าปัจจุบัน (Container ที่สอง - Withholding Tax)
    currentPageData2.forEach((product, index) => {
        const globalIndex = startIndex2 + index;
        const checkboxId2 = `product-checkbox2-${globalIndex}`;
        const taxRate = $('#tax_withheld').val() || '0.0%';
        const totalPrice = calculateTotalWithWithholdingTax(1, product.deposit_amount, 0, product.isSelectedForWithholding, taxRate);
        
        // console.log(`Creating Withholding Tax checkbox for product ${product.id}: isSelectedForWithholding=${product.isSelectedForWithholding}`);

        // Container2 สำหรับไม่เอา ภาษีหัก ณ ที่จ่าย (Withholding Tax)
        const checkboxItem2 = `
            <div class="checkbox-list-box-sum">
                <div class="edit-sum">
                    <div class="checkbox-item">
                        <input type="checkbox" name="product_visits2" id="${checkboxId2}"
                            class="checkbox-table-input2" data-product-id="${product.id}" ${product.isSelectedForWithholding ? 'checked' : ''}>
                    </div>
                    <label for="${checkboxId2}">รายการที่ ${globalIndex + 1}:
                        ${product.name}</label>
                </div>
                <div>
                    <div class="bold-16"; data-product-id="${product.id}" value="${totalPrice}">${totalPrice}</div>
                </div>
            </div>
        `;
        
        // console.log(`Creating Withholding Tax checkbox for product ${product.id}: isSelectedForWithholding=${product.isSelectedForWithholding}, HTML: ${product.isSelectedForWithholding ? 'checked' : ''}`);
        container2.append(checkboxItem2);
    });
    
    // อัปเดต pagination controls
    updateCheckboxPagination();
    
    // อัปเดต pagination controls
    updateCheckboxPagination2();
    
    // อัปเดต checkbox list 3 และ 4 ถ้าฟอร์มแสดงอยู่
    const form2 = document.getElementById('tax-withheld-form-2');
    const form3 = document.getElementById('tax-withheld-form-3');
    
    if (form2 && form2.style.display !== 'none') {
        updateCheckboxList3();
    }
    
    if (form3 && form3.style.display !== 'none') {
        updateCheckboxList4();
    }
    
    // คำนวณค่ารวมใหม่หลังจากสร้าง checkbox
    calculateTotalSummary();
    
    
    // เชื่อมต่อ select ภาษีหัก ณ ที่จ่ายระหว่าง popup และส่วนสรุปหลัก
    $('.right-under').on('change', function() {
        const selectedValue = $(this).val();
        $('#unit-items').val(selectedValue);
        $('#unit-items').css('color', 'var(--input-text-black)');
        console.log('Popup withholding tax changed to:', selectedValue);
        
        // เก็บค่าเดิมก่อนแก้ไข (ถ้ายังไม่เคยเก็บ)
        if (!originalProductData) {
            originalProductData = JSON.parse(JSON.stringify(allProductData));
            originalCheckboxStates = {
                vat: allProductData.map(p => ({ id: p.id, isSelected: p.isSelected })),
                withholding: allProductData.map(p => ({ id: p.id, isSelectedForWithholding: p.isSelectedForWithholding }))
            };
            originalPopupValues = {
                deleteVat: $('#delete-vat').val(),
                rightUnder: $('.right-under').val()
            };
            console.log('เก็บค่าเดิมก่อนแก้ไข');
        }
        
        
        isPopupCalculation = true;
        calculateTotalSummary();
        isPopupCalculation = false;
    });
    
    // เชื่อมต่อ select ภาษีหัก ณ ที่จ่ายจากส่วนสรุปหลักไป popup
    $('#unit-items').on('change', function() {
        const selectedValue = $(this).val();
        $('.right-under').val(selectedValue);
        console.log('Main withholding tax changed to:', selectedValue);
        calculateTotalSummary();
    });
}

// อัปเดต pagination controls สำหรับ checkbox list
function updateCheckboxPagination() {
    const totalPages = Math.ceil(allProductData.length / checkboxItemsPerPage);
    const paginationContainer = $('.under-search-sum-edit');
    
    // ตรวจสอบว่ามีข้อมูลมากกว่า 5 รายการหรือไม่
    if (allProductData.length <= checkboxItemsPerPage) {
        paginationContainer.hide();
        return;
    }
    
    // แสดง pagination container
    paginationContainer.show();
    

    const paginationHTML = generateCheckboxPaginationHTML(checkboxCurrentPage, totalPages);
    paginationContainer.html(paginationHTML);
}

// อัปเดต pagination controls สำหรับ checkbox list2
function updateCheckboxPagination2() {
    const totalPages = Math.ceil(allProductData.length / checkboxItemsPerPage);
    const paginationContainer2 = $('.under-search-sum-edit-2');
    
    // ตรวจสอบว่ามีข้อมูลมากกว่า 5 รายการหรือไม่
    if (allProductData.length <= checkboxItemsPerPage) {
        paginationContainer2.hide();
        return;
    }
    
    // แสดง pagination container
    paginationContainer2.show();
    
    // อัปเดต pagination ให้แสดงหน้าปัจจุบัน
    const paginationHTML = generateCheckboxPaginationHTML2(checkboxCurrentPage2, totalPages);
    paginationContainer2.html(paginationHTML);
}

// ฟังก์ชันสร้าง HTML สำหรับ pagination ของ checkbox list
function generateCheckboxPaginationHTML(currentPage, totalPages) {
    let html = `<div class="under-page">${currentPage} of ${totalPages} pages</div>`;
    
    // สร้างปุ่ม pagination แบบใหม่
    const paginationButtons = $('<div class="pagination-buttons" style="display: flex; justify-content: center; align-items: center;"></div>');
    
    // helper สร้างปุ่มเลขหน้า
    const addBtn = (i) => {
        const buttonClass = i === currentPage ? 'active' : '';
        const textColor = i === currentPage ? 'color: black;' : 'color: var(--text-color400);';
        paginationButtons.append(`<a class="num-btn ${buttonClass}" style="${textColor}
    text-decoration: none;
    padding: 2px 6px;
    cursor: pointer;" href="#" data-checkbox-page="${i}">${i}</a>`);
    };
    
    const addDots = () => paginationButtons.append('<span class="dots" style="color: var(--text-color400); padding: 2px 6px;">...</span>');
    
    // ปุ่ม Previous (แสดงตลอด)
    const prevPage = currentPage > 1 ? currentPage - 1 : 1;
    paginationButtons.append(`<a href="#" class="prev" style="width: 16px; height: 16px;" data-checkbox-page="${prevPage}"><img src="picture/arrow-left.png" style="width: 16px; height: 16px;"></a>`);
    
    // เลือกเลขที่จะโชว์ 3 ตัว + ... + กล่องค้นหา
    let pagesToShow = [];
    if (totalPages <= 3) {
        for (let i = 1; i <= totalPages; i++) pagesToShow.push(i);
    } else if (currentPage <= 2) {
        pagesToShow = [1, 2, 3];
    } else if (currentPage >= totalPages - 1) {
        pagesToShow = [Math.max(1, totalPages - 2), totalPages - 1, totalPages];
    } else {
        pagesToShow = [currentPage - 1, currentPage, currentPage + 1];
    }
    
    // ใส่เลข 3 ตัว
    pagesToShow.forEach(addBtn);
    
    // ถ้าหน้ามากกว่า 3 และยังมีหน้าที่ซ่อนไว้ด้านขวา ค่อยใส่ "..."
    if (totalPages > 3) addDots();
    
    // กล่องค้นหาหน้า (ค่าในช่องคือหน้าสุดท้าย เริ่มต้นพิมพ์ได้ทันที)
    const jumpHtml = `
        <div class="page-jump-wrap">
            <input
                type="text"
                inputmode="numeric"
                pattern="[0-9]*"
                class="page-jump"
                id="checkboxPageJump"
                placeholder="${totalPages}"
                aria-label="ไปหน้าที่..."
            />
        </div>`;
    paginationButtons.append(jumpHtml);
    
    // ปุ่ม Next (แสดงตลอด)
    const nextPage = currentPage < totalPages ? currentPage + 1 : totalPages;
    paginationButtons.append(`<a href="#" class="next" data-checkbox-page="${nextPage}"><img src="picture/arrow-right.png" style="width: 16px; height: 16px;"></a>`);
    
    // รวม pagination HTML
    html += paginationButtons.prop('outerHTML');
    
    return html;
}

// ฟังก์ชันสร้าง HTML สำหรับ pagination ของ checkbox list2
function generateCheckboxPaginationHTML2(currentPage, totalPages) {
    let html = `<div class="under-page">${currentPage} of ${totalPages} pages</div>`;
    
    // สร้างปุ่ม pagination แบบใหม่
    const paginationButtons = $('<div class="pagination-buttons" style="display: flex; justify-content: center; align-items: center;"></div>');
    
    // helper สร้างปุ่มเลขหน้า
    const addBtn = (i) => {
        const buttonClass = i === currentPage ? 'active' : '';
        const textColor = i === currentPage ? 'color: black;' : 'color: var(--text-color400);';
        paginationButtons.append(`<a class="num-btn ${buttonClass}" style="${textColor}
    text-decoration: none;
    padding: 2px 6px;
    cursor: pointer;" href="#" data-checkbox-page2="${i}">${i}</a>`);
    };
    
    const addDots = () => paginationButtons.append('<span class="dots" style="color: var(--text-color400); padding: 2px 6px;">...</span>');
    
    // ปุ่ม Previous (แสดงตลอด)
    const prevPage = currentPage > 1 ? currentPage - 1 : 1;
    paginationButtons.append(`<a href="#" class="prev" style="width: 16px; height: 16px;" data-checkbox-page2="${prevPage}"><img src="picture/arrow-left.png" style="width: 16px; height: 16px;"></a>`);
    
    // เลือกเลขที่จะโชว์ 3 ตัว + ... + กล่องค้นหา
    let pagesToShow = [];
    if (totalPages <= 3) {
        for (let i = 1; i <= totalPages; i++) pagesToShow.push(i);
    } else if (currentPage <= 2) {
        pagesToShow = [1, 2, 3];
    } else if (currentPage >= totalPages - 1) {
        pagesToShow = [Math.max(1, totalPages - 2), totalPages - 1, totalPages];
    } else {
        pagesToShow = [currentPage - 1, currentPage, currentPage + 1];
    }
    
    // ใส่เลข 3 ตัว
    pagesToShow.forEach(addBtn);
    
    // ถ้าหน้ามากกว่า 3 และยังมีหน้าที่ซ่อนไว้ด้านขวา ค่อยใส่ "..."
    if (totalPages > 3) addDots();
    
    // กล่องค้นหาหน้า (ค่าในช่องคือหน้าสุดท้าย เริ่มต้นพิมพ์ได้ทันที)
    const jumpHtml = `
        <div class="page-jump-wrap">
            <input
                type="text"
                inputmode="numeric"
                pattern="[0-9]*"
                class="page-jump"
                id="checkboxPageJump2"
                placeholder="${totalPages}"
                aria-label="ไปหน้าที่..."
            />
        </div>`;
    paginationButtons.append(jumpHtml);
    
    // ปุ่ม Next (แสดงตลอด)
    const nextPage = currentPage < totalPages ? currentPage + 1 : totalPages;
    paginationButtons.append(`<a href="#" class="next" data-checkbox-page2="${nextPage}"><img src="picture/arrow-right.png" style="width: 16px; height: 16px;"></a>`);
    
    // รวม pagination HTML
    html += paginationButtons.prop('outerHTML');
    
    return html;
}

// ฟังก์ชันสร้าง HTML สำหรับ pagination ของ checkbox list3
function generateCheckboxPaginationHTML3(currentPage, totalPages) {
    let html = `<div class="under-page">${currentPage} of ${totalPages} pages</div>`;
    
    // สร้างปุ่ม pagination แบบใหม่
    const paginationButtons = $('<div class="pagination-buttons" style="display: flex; justify-content: center; align-items: center;"></div>');
    
    // helper สร้างปุ่มเลขหน้า
    const addBtn = (i) => {
        const buttonClass = i === currentPage ? 'active' : '';
        const textColor = i === currentPage ? 'color: black;' : 'color: var(--text-color400);';
        paginationButtons.append(`<a class="num-btn ${buttonClass}" style="${textColor}
    text-decoration: none;
    padding: 2px 6px;
    cursor: pointer;" href="#" data-checkbox-page3="${i}">${i}</a>`);
    };
    
    const addDots = () => paginationButtons.append('<span class="dots" style="color: var(--text-color400); padding: 2px 6px;">...</span>');
    
    // ปุ่ม Previous (แสดงตลอด)
    const prevPage = currentPage > 1 ? currentPage - 1 : 1;
    paginationButtons.append(`<a href="#" class="prev" style="width: 16px; height: 16px;" data-checkbox-page3="${prevPage}"><img src="picture/arrow-left.png" style="width: 16px; height: 16px;"></a>`);
    
    // เลือกเลขที่จะโชว์ 3 ตัว + ... + กล่องค้นหา
    let pagesToShow = [];
    if (totalPages <= 3) {
        for (let i = 1; i <= totalPages; i++) pagesToShow.push(i);
    } else if (currentPage <= 2) {
        pagesToShow = [1, 2, 3];
    } else if (currentPage >= totalPages - 1) {
        pagesToShow = [Math.max(1, totalPages - 2), totalPages - 1, totalPages];
    } else {
        pagesToShow = [currentPage - 1, currentPage, currentPage + 1];
    }
    
    // เพิ่มเลขหน้า
    pagesToShow.forEach(page => addBtn(page));
    
    // เพิ่ม ... ถ้าจำเป็น
    if (currentPage < totalPages - 2) {
        addDots();
    }
    
    // กล่องค้นหาหน้า (ค่าในช่องคือหน้าสุดท้าย เริ่มต้นพิมพ์ได้ทันที)
    const jumpHtml = `
        <div class="page-jump-wrap">
            <input
                type="text"
                inputmode="numeric"
                pattern="[0-9]*"
                class="page-jump"
                id="checkboxPageJump3"
                placeholder="${totalPages}"
                aria-label="ไปหน้าที่..."
            />
        </div>`;
    paginationButtons.append(jumpHtml);
    
    // ปุ่ม Next (แสดงตลอด)
    const nextPage = currentPage < totalPages ? currentPage + 1 : totalPages;
    paginationButtons.append(`<a href="#" class="next" style="width: 16px; height: 16px;" data-checkbox-page3="${nextPage}"><img src="picture/arrow-right.png" style="width: 16px; height: 16px;"></a>`);
    
    html += paginationButtons.prop('outerHTML');
    
    return html;
}

// ฟังก์ชันสร้าง HTML สำหรับ pagination ของ checkbox list4
function generateCheckboxPaginationHTML4(currentPage, totalPages) {
    let html = `<div class="under-page">${currentPage} of ${totalPages} pages</div>`;
    
    // สร้างปุ่ม pagination แบบใหม่
    const paginationButtons = $('<div class="pagination-buttons" style="display: flex; justify-content: center; align-items: center;"></div>');
    
    // helper สร้างปุ่มเลขหน้า
    const addBtn = (i) => {
        const buttonClass = i === currentPage ? 'active' : '';
        const textColor = i === currentPage ? 'color: black;' : 'color: var(--text-color400);';
        paginationButtons.append(`<a class="num-btn ${buttonClass}" style="${textColor}
    text-decoration: none;
    padding: 2px 6px;
    cursor: pointer;" href="#" data-checkbox-page4="${i}">${i}</a>`);
    };
    
    const addDots = () => paginationButtons.append('<span class="dots" style="color: var(--text-color400); padding: 2px 6px;">...</span>');
    
    // ปุ่ม Previous (แสดงตลอด)
    const prevPage = currentPage > 1 ? currentPage - 1 : 1;
    paginationButtons.append(`<a href="#" class="prev" style="width: 16px; height: 16px;" data-checkbox-page4="${prevPage}"><img src="picture/arrow-left.png" style="width: 16px; height: 16px;"></a>`);
    
    // เลือกเลขที่จะโชว์ 3 ตัว + ... + กล่องค้นหา
    let pagesToShow = [];
    if (totalPages <= 3) {
        for (let i = 1; i <= totalPages; i++) pagesToShow.push(i);
    } else if (currentPage <= 2) {
        pagesToShow = [1, 2, 3];
    } else if (currentPage >= totalPages - 1) {
        pagesToShow = [Math.max(1, totalPages - 2), totalPages - 1, totalPages];
    } else {
        pagesToShow = [currentPage - 1, currentPage, currentPage + 1];
    }
    
    // เพิ่มเลขหน้า
    pagesToShow.forEach(page => addBtn(page));
    
    // เพิ่ม ... ถ้าจำเป็น
    if (currentPage < totalPages - 2) {
        addDots();
    }
    
    // กล่องค้นหาหน้า (ค่าในช่องคือหน้าสุดท้าย เริ่มต้นพิมพ์ได้ทันที)
    const jumpHtml = `
        <div class="page-jump-wrap">
            <input
                type="text"
                inputmode="numeric"
                pattern="[0-9]*"
                class="page-jump"
                id="checkboxPageJump4"
                placeholder="${totalPages}"
                aria-label="ไปหน้าที่..."
            />
        </div>`;
    paginationButtons.append(jumpHtml);
    
    // ปุ่ม Next (แสดงตลอด)
    const nextPage = currentPage < totalPages ? currentPage + 1 : totalPages;
    paginationButtons.append(`<a href="#" class="next" style="width: 16px; height: 16px;" data-checkbox-page4="${nextPage}"><img src="picture/arrow-right.png" style="width: 16px; height: 16px;"></a>`);
    
    html += paginationButtons.prop('outerHTML');
    
    return html;
}

// ฟังก์ชันสำหรับเปลี่ยนหน้า checkbox list
function goToCheckboxPage(page) {
    const totalPages = Math.ceil(allProductData.length / checkboxItemsPerPage);
    
    if (page >= 1 && page <= totalPages) {
        checkboxCurrentPage = page;
        displayProductCheckboxList();
    }
}

// ฟังก์ชันสำหรับเปลี่ยนหน้า checkbox list2
function goToCheckboxPage2(page) {
    const totalPages = Math.ceil(allProductData.length / checkboxItemsPerPage);
    
    if (page >= 1 && page <= totalPages) {
        checkboxCurrentPage2 = page;
        updateCheckboxList2();
    }
}

// ฟังก์ชันสำหรับเปลี่ยนหน้า checkbox list3
function goToCheckboxPage3(page) {
    const totalPages = Math.ceil(allProductData.length / checkboxItemsPerPage);
    
    if (page >= 1 && page <= totalPages) {
        checkboxCurrentPage3 = page;
        updateCheckboxList3();
    }
}

// ฟังก์ชันสำหรับเปลี่ยนหน้า checkbox list4
function goToCheckboxPage4(page) {
    const totalPages = Math.ceil(allProductData.length / checkboxItemsPerPage);
    
    if (page >= 1 && page <= totalPages) {
        checkboxCurrentPage4 = page;
        updateCheckboxList4();
    }
}

// ฟังก์ชันอัปเดต checkbox list2 เท่านั้น
function updateCheckboxList2() {
    const container2 = $('#product-checkbox-list2');
    container2.empty(); // ล้างข้อมูลเก่า
    
    // คำนวณข้อมูลที่จะแสดงในหน้าปัจจุบัน (สำหรับ container ที่สอง)
    const startIndex2 = (checkboxCurrentPage2 - 1) * checkboxItemsPerPage;
    const endIndex2 = startIndex2 + checkboxItemsPerPage;
    const currentPageData2 = allProductData.slice(startIndex2, endIndex2);
    
    // แสดงข้อมูลในหน้าปัจจุบัน (Container ที่สอง - Withholding Tax)
    currentPageData2.forEach((product, index) => {
        const globalIndex = startIndex2 + index;
        const checkboxId2 = `product-checkbox2-${globalIndex}`;

        // ตรวจสอบว่ารายการนี้ถูกเลือกในอันที่สองหรืออันที่สามหรือไม่
        const isSelectedInSecond = product.isSelectedForWithholding2 || false;
        const isSelectedInThird = product.isSelectedForWithholding3 || false;
        const isDisabledFirst = (isSelectedInSecond || isSelectedInThird) ? 'disabled' : '';
        const isCheckedFirst = product.isSelectedForWithholding && !isSelectedInSecond && !isSelectedInThird ? 'checked' : '';
        
        const taxRate = $('#tax_withheld').val() || '0.0%';
        // ตรวจสอบว่ามี tax_withheld และ product ถูกเลือกหรือไม่
        const hasTaxRate = parseFloat(taxRate.replace('%', '')) > 0;
        const shouldShowTax = product.isSelectedForWithholding && hasTaxRate;
        const totalPrice = calculateTotalWithWithholdingTax(product.qty, product.deposit_amount, product.discount, shouldShowTax, taxRate);
        
        // console.log(`Creating Withholding Tax checkbox for product ${product.id}: isSelectedForWithholding=${product.isSelectedForWithholding}`);
        
        // Container2 สำหรับไม่เอา ภาษีหัก ณ ที่จ่าย (Withholding Tax)
        const checkboxItem2 = `
            <div class="checkbox-list-box-sum">
                <div class="edit-sum">
                    <div class="checkbox-item">
                        <input type="checkbox" name="product_visits2" id="${checkboxId2}"
                            class="checkbox-table-input2" data-product-id="${product.id}" ${isCheckedFirst} ${isDisabledFirst}>
                    </div>
                    <label for="${checkboxId2}">รายการที่ ${globalIndex + 1}:
                        ${product.name}</label>
                </div>
                <div>
                    <div class="bold-16" data-product-id="${product.id}" value="${totalPrice}">${totalPrice}</div>
                </div>
            </div>
        `;
        
        // console.log(`Creating Withholding Tax checkbox for product ${product.id}: isSelectedForWithholding=${product.isSelectedForWithholding}, HTML: ${product.isSelectedForWithholding ? 'checked' : ''}`);
        container2.append(checkboxItem2);
    });
    
    // อัปเดต pagination controls
    updateCheckboxPagination2();
}

// ฟังก์ชันอัปเดต checkbox list3 เท่านั้น
function updateCheckboxList3() {
    const container3 = $('#product-checkbox-list3');
    container3.empty(); // ล้างข้อมูลเก่า
    
    // คำนวณข้อมูลที่จะแสดงในหน้าปัจจุบัน (สำหรับ container ที่สาม)
    const startIndex3 = (checkboxCurrentPage3 - 1) * checkboxItemsPerPage;
    const endIndex3 = startIndex3 + checkboxItemsPerPage;
    const currentPageData3 = allProductData.slice(startIndex3, endIndex3);
    
    // แสดงข้อมูลในหน้าปัจจุบัน (Container ที่สาม - Withholding Tax 2)
    currentPageData3.forEach((product, index) => {
        const globalIndex = startIndex3 + index;
        const checkboxId3 = `product-checkbox3-${globalIndex}`;
        
        // console.log(`Creating Withholding Tax 2 checkbox for product ${product.id}: isSelectedForWithholding2=${product.isSelectedForWithholding2}`);

        // ตรวจสอบว่ารายการนี้ถูกเลือกในอันแรกหรืออันที่สามหรือไม่
        const isSelectedInFirst = product.isSelectedForWithholding || false;
        const isSelectedInThird = product.isSelectedForWithholding3 || false;
        const isDisabled = (isSelectedInFirst || isSelectedInThird) ? 'disabled' : '';
        // ไม่ให้ติ๊กอัตโนมัติ ถ้าถูกเลือกในอันอื่น
        const isChecked = product.isSelectedForWithholding2 && !isSelectedInFirst && !isSelectedInThird ? 'checked' : '';
        
        const taxRate2 = $('#tax_withheld2').val() || '0.0%';
        // ตรวจสอบว่ามี tax_withheld2 และ product ถูกเลือกหรือไม่
        const hasTaxRate2 = parseFloat(taxRate2.replace('%', '')) > 0;
        const shouldShowTax2 = product.isSelectedForWithholding2 && hasTaxRate2;
        const totalPrice = calculateTotalWithWithholdingTax(1, product.deposit_amount, 0, shouldShowTax2, taxRate2);
        
        // Container3 สำหรับไม่เอา ภาษีหัก ณ ที่จ่าย 2 (Withholding Tax 2)
        const checkboxItem3 = `
            <div class="checkbox-list-box-sum">
                <div class="edit-sum">
                    <div class="checkbox-item">
                        <input type="checkbox" name="product_visits3" id="${checkboxId3}"
                            class="checkbox-table-input3" data-product-id="${product.id}" ${isChecked} ${isDisabled}>
                    </div>
                    <label for="${checkboxId3}">รายการที่ ${globalIndex + 1}:
                        ${product.name}</label>
                </div>
                <div>
                    <div class="bold-16" data-product-id="${product.id}" value="${totalPrice}">${totalPrice}</div>
                </div>
            </div>
        `;
        
        // console.log(`Creating Withholding Tax 2 checkbox for product ${product.id}: isSelectedForWithholding2=${product.isSelectedForWithholding2}, HTML: ${product.isSelectedForWithholding2 ? 'checked' : ''}`);
        container3.append(checkboxItem3);
    });
    
    // อัปเดต pagination controls
    updateCheckboxPagination3();
}

// ฟังก์ชันอัปเดต checkbox list4 เท่านั้น
function updateCheckboxList4() {
    const container4 = $('#product-checkbox-list4');
    container4.empty(); // ล้างข้อมูลเก่า
    
    // คำนวณข้อมูลที่จะแสดงในหน้าปัจจุบัน (สำหรับ container ที่สี่)
    const startIndex4 = (checkboxCurrentPage4 - 1) * checkboxItemsPerPage;
    const endIndex4 = startIndex4 + checkboxItemsPerPage;
    const currentPageData4 = allProductData.slice(startIndex4, endIndex4);
    
    // แสดงข้อมูลในหน้าปัจจุบัน (Container ที่สี่ - Withholding Tax 3)
    currentPageData4.forEach((product, index) => {
        const globalIndex = startIndex4 + index;
        const checkboxId4 = `product-checkbox4-${globalIndex}`;
        
        // console.log(`Creating Withholding Tax 3 checkbox for product ${product.id}: isSelectedForWithholding3=${product.isSelectedForWithholding3}`);

        // ตรวจสอบว่ารายการนี้ถูกเลือกในอันแรกหรืออันที่สองหรือไม่
        const isSelectedInFirst = product.isSelectedForWithholding || false;
        const isSelectedInSecond = product.isSelectedForWithholding2 || false;
        const isSelectedInPrevious = isSelectedInFirst || isSelectedInSecond;
        const isDisabled = isSelectedInPrevious ? 'disabled' : '';
        const isChecked = product.isSelectedForWithholding3 && !isSelectedInPrevious ? 'checked' : '';
        
        const taxRate3 = $('#tax_withheld3').val() || '0.0%';
        // ตรวจสอบว่ามี tax_withheld3 และ product ถูกเลือกหรือไม่
        const hasTaxRate3 = parseFloat(taxRate3.replace('%', '')) > 0;
        const shouldShowTax3 = product.isSelectedForWithholding3 && hasTaxRate3;
        const totalPrice = calculateTotalWithWithholdingTax(1, product.deposit_amount, 0, shouldShowTax3, taxRate3);
        
        // Container4 สำหรับไม่เอา ภาษีหัก ณ ที่จ่าย 3 (Withholding Tax 3)
        const checkboxItem4 = `
            <div class="checkbox-list-box-sum">
                <div class="edit-sum">
                    <div class="checkbox-item">
                        <input type="checkbox" name="product_visits4" id="${checkboxId4}"
                            class="checkbox-table-input4" data-product-id="${product.id}" ${isChecked} ${isDisabled}>
                    </div>
                    <label for="${checkboxId4}">รายการที่ ${globalIndex + 1}:
                        ${product.name}</label>
                </div>
                <div>
                    <div class="bold-16" data-product-id="${product.id}" value="${totalPrice}">${totalPrice}</div>
                </div>
            </div>
        `;
        
        // console.log(`Creating Withholding Tax 3 checkbox for product ${product.id}: isSelectedForWithholding3=${product.isSelectedForWithholding3}, HTML: ${product.isSelectedForWithholding3 ? 'checked' : ''}`);
        container4.append(checkboxItem4);
    });
    
    // อัปเดต pagination controls
    updateCheckboxPagination4();
}

// อัปเดต pagination controls สำหรับ checkbox list3
function updateCheckboxPagination3() {
    const totalPages = Math.ceil(allProductData.length / checkboxItemsPerPage);
    const paginationContainer3 = $('.under-search-sum-edit-3');
    
    // ตรวจสอบว่ามีข้อมูลมากกว่า 5 รายการหรือไม่
    if (allProductData.length <= checkboxItemsPerPage) {
        paginationContainer3.hide();
        return;
    }
    
    // แสดง pagination container
    paginationContainer3.show();
    
    // อัปเดต pagination ให้แสดงหน้าปัจจุบัน
    const paginationHTML = generateCheckboxPaginationHTML3(checkboxCurrentPage3, totalPages);
    paginationContainer3.html(paginationHTML);
}

// อัปเดต pagination controls สำหรับ checkbox list4
function updateCheckboxPagination4() {
    const totalPages = Math.ceil(allProductData.length / checkboxItemsPerPage);
    const paginationContainer4 = $('.under-search-sum-edit-4');
    
    // ตรวจสอบว่ามีข้อมูลมากกว่า 5 รายการหรือไม่
    if (allProductData.length <= checkboxItemsPerPage) {
        paginationContainer4.hide();
        return;
    }
    
    // แสดง pagination container
    paginationContainer4.show();
    
    // อัปเดต pagination ให้แสดงหน้าปัจจุบัน
    const paginationHTML = generateCheckboxPaginationHTML4(checkboxCurrentPage4, totalPages);
    paginationContainer4.html(paginationHTML);
}

// อัปเดต pagination controls สำหรับ popup view
function updateProductPagination() {
    const totalPages = Math.ceil(productTotalItems / productItemsPerPage);
    const paginationContainer = $('.pagination');
    
    // ตรวจสอบว่ามีข้อมูลมากกว่า 5 รายการหรือไม่ (ไม่ถึง 6)
    if (productTotalItems <= 5) {
        paginationContainer.hide();
        return;
    }
    
    // แสดง pagination container
    paginationContainer.show();
    
    // สร้าง pagination HTML ใหม่ทั้งหมด
    let paginationHTML = `<span class="page-info">${productCurrentPage} of ${totalPages} pages</span>`;
    
    // สร้างปุ่ม pagination แบบใหม่ (เหมือน create-deposit-receipt-table.html)
    const paginationButtons = $('<div class="pagination-buttons" style="display: flex; justify-content: center; align-items: center;"></div>');
    
    // helper สร้างปุ่มเลขหน้า
    const addBtn = (i) => {
        const buttonClass = i === productCurrentPage ? 'active' : '';
        paginationButtons.append(`<a class="num-btn ${buttonClass}" href="#" data-product-page="${i}">${i}</a>`);
    };
    
    const addDots = () => paginationButtons.append('<span class="dots">...</span>');
    
    // ปุ่ม Previous (แสดงตลอด)
    const prevPage = productCurrentPage > 1 ? productCurrentPage - 1 : 1;
    paginationButtons.append(`<a href="#" class="prev" data-product-page="${prevPage}"><img src="picture/arrow-left.png" style="width: 16px; height: 16px;"></a>`);
    
    // เลือกเลขที่จะโชว์ 3 ตัว + ... + กล่องค้นหา
    let pagesToShow = [];
    if (totalPages <= 3) {
        for (let i = 1; i <= totalPages; i++) pagesToShow.push(i);
    } else if (productCurrentPage <= 2) {
        pagesToShow = [1, 2, 3];
    } else if (productCurrentPage >= totalPages - 1) {
        pagesToShow = [Math.max(1, totalPages - 2), totalPages - 1, totalPages];
    } else {
        pagesToShow = [productCurrentPage - 1, productCurrentPage, productCurrentPage + 1];
    }
    
    // ใส่เลข 3 ตัว
    pagesToShow.forEach(addBtn);
    
    // ถ้าหน้ามากกว่า 3 และยังมีหน้าที่ซ่อนไว้ด้านขวา ค่อยใส่ "..."
    if (totalPages > 3) addDots();
    
    // กล่องค้นหาหน้า (ค่าในช่องคือหน้าสุดท้าย เริ่มต้นพิมพ์ได้ทันที)
    const jumpHtml = `
        <div class="page-jump-wrap">
            <input
                type="text"
                inputmode="numeric"
                pattern="[0-9]*"
                class="page-jump"
                id="productPageJump"
                placeholder="${totalPages}"
                aria-label="ไปหน้าที่..."
            />
        </div>`;
    paginationButtons.append(jumpHtml);
    
     // ปุ่ม Next (แสดงตลอด)
     const nextPage = productCurrentPage < totalPages ? productCurrentPage + 1 : totalPages;
    paginationButtons.append(`<a href="#" class="next" data-product-page="${nextPage}"><img src="picture/arrow-right.png" style="width: 16px; height: 16px;"></a>`);
    
    // รวม pagination HTML
    paginationHTML += paginationButtons.prop('outerHTML');
    
    // แทนที่เนื้อหาทั้งหมดของ pagination container
    paginationContainer.html(paginationHTML);
    
    // เพิ่ม event listeners สำหรับปุ่ม pagination
    attachProductPaginationEvents();
}

// ฟังก์ชันเพิ่ม event listeners สำหรับ pagination
function attachProductPaginationEvents() {
    // events ปุ่มเลข
    $('.pagination a.num-btn').off('click').on('click', function (e) {
        e.preventDefault();
        const page = parseInt($(this).data('product-page'));
        goToProductPage(page);
    });
    
    // events ปุ่ม Previous และ Next
    $('.pagination a.prev, .pagination a.next').off('click').on('click', function (e) {
        e.preventDefault();
        const page = parseInt($(this).data('product-page'));
        goToProductPage(page);
    });
    
    // events กล่องค้นหา (Enter/blur เพื่อกระโดดหน้า)
    (function attachJumpHandlers() {
        const commit = () => {
            const totalPages = Math.ceil(productTotalItems / productItemsPerPage);
            const last = totalPages;
            let v = parseInt($('#productPageJump').val(), 10);
            if (isNaN(v)) v = last;
            v = Math.max(1, Math.min(last, v));
            goToProductPage(v);
        };
        
        $('#productPageJump').off('keypress blur').on('keypress blur', function (e) {
            if (e.type === 'keypress' && e.which !== 13) return;
            e.preventDefault();
            commit();
        });
    })();
}

// ฟังก์ชันไปหน้าที่กำหนด
function goToProductPage(page) {
    const totalPages = Math.ceil(productTotalItems / productItemsPerPage);
    if (page >= 1 && page <= totalPages) {
        productCurrentPage = page;
        displayProductPage();
        updateProductPagination();
    }
}

/**
 * คำนวณราคารวมของสินค้าแต่ละรายการ
 * @param {number} price - ราคามัดจำ
 * @returns {string} ราคารวมที่จัดฟอร์แมต
 */
function calculateTotal(qty, price, discount) {
    if (!price) return '0.00';
    
    const priceNum = parseFloat(price) || 0;
    
    // ใช้ deposit_amount
    return priceNum.toLocaleString('th-TH', {minimumFractionDigits: 2});
}

/**
 * คำนวณส่วนแบ่งภาษี 7% ของสินค้าแต่ละรายการ (สำหรับ VAT)
 * @param {number} qty - จำนวนสินค้า (ไม่ใช้)
 * @param {number} price - ราคามัดจำ
 * @param {number} discount - ส่วนลด (ไม่ใช้)
 * @param {boolean} isChecked - สถานะการติ๊ก checkbox
 * @returns {string} ส่วนแบ่งภาษี 7% ที่จัดฟอร์แมต (0.00 ถ้าไม่ได้ติ๊ก)
 */
function calculateTotalWithVAT(qty, price, discount, isChecked = false) {
    if (!price || !isChecked) return '0.00';
    
    const priceNum = parseFloat(price) || 0;
    
    // คำนวณเฉพาะส่วนภาษี 7% จาก deposit_amount
    const vatAmount = priceNum * 0.07;
    
    return vatAmount.toLocaleString('th-TH', {minimumFractionDigits: 2});
}

/**
 * คำนวณส่วนแบ่งภาษีหัก ณ ที่จ่ายของสินค้าแต่ละรายการ
 * @param {number} price - ราคามัดจำ
 * @param {boolean} isChecked - สถานะการติ๊ก checkbox
 * @param {string} taxRate - อัตราภาษีหัก ณ ที่จ่าย (เช่น "3.0%")
 * @returns {string} ส่วนแบ่งภาษีหัก ณ ที่จ่ายที่จัดฟอร์แมต (0.00 ถ้าไม่ได้ติ๊ก)
 */
function calculateTotalWithWithholdingTax(qty, price, discount, isChecked = false, taxRate = "0.0%") {
    if (!price || !isChecked) return '0.00';
    
    const priceNum = parseFloat(price) || 0;
    
    // แปลงอัตราภาษีจาก "3.0%" เป็น 0.03
    const taxRateNum = parseFloat(taxRate.replace('%', '')) / 100;
    
    // คำนวณเฉพาะส่วนภาษีหัก ณ ที่จ่ายจาก deposit_amount
    const withholdingAmount = priceNum * taxRateNum;
    
    return withholdingAmount.toLocaleString('th-TH', {minimumFractionDigits: 2});
}

/* ===========================================
   TAX & TOTAL CALCULATIONS
   =========================================== */

// ตัวแปรควบคุมการคำนวณ
let isPopupCalculation = false;

// ตัวแปรเก็บค่าเดิมก่อนแก้ไข (สำหรับ rollback)
let originalProductData = null;
let originalCheckboxStates = null;
let originalPopupValues = null;

/**
 * คำนวณราคาสุทธิทั้งหมด รวมภาษี
 * - คำนวณภาษีมูลค่าเพิ่ม 7%
 * - คำนวณภาษีหัก ณ ที่จ่าย
 * - คำนวณยอดรวมสุทธิ
 * @returns {Object} ผลการคำนวณทั้งหมด
 */
function calculateTotalSummary() {
    // ดึงข้อมูลสินค้าทั้งหมดจากตาราง
    let totalAllProducts = 0;
    let totalDiscount = 0;
    let totalAllProductsForWithholding = 0;
    let totalDiscountForWithholding = 0;
    let totalAllProductsForWithholding2 = 0;
    let totalDiscountForWithholding2 = 0;
    let totalAllProductsForWithholding3 = 0;
    let totalDiscountForWithholding3 = 0;
    
    // คำนวณจากข้อมูลสินค้าที่มีอยู่และถูกติ๊กเท่านั้น
    if (allProductData && allProductData.length > 0) {
        allProductData.forEach(product => {
            // ตรวจสอบ checkbox สำหรับ VAT (ภาษี 7%)
            const checkboxVAT = $(`.checkbox-table-input[data-product-id="${product.id}"]`);
            let isCheckedVAT = false;
            
            if (checkboxVAT.length > 0) {
                isCheckedVAT = checkboxVAT.is(':checked');
            } else {
                isCheckedVAT = product.isSelected || false;
            }
            
            // ตรวจสอบ checkbox สำหรับ Withholding Tax (ภาษีหัก ณ ที่จ่าย)
            const checkboxWithholding = $(`.checkbox-table-input2[data-product-id="${product.id}"]`);
            let isCheckedWithholding = false;
            
            if (checkboxWithholding.length > 0) {
                isCheckedWithholding = checkboxWithholding.is(':checked');
            } else {
                isCheckedWithholding = product.isSelectedForWithholding || false;
            }
            
            // ตรวจสอบ checkbox สำหรับ Withholding Tax 2 (ภาษีหัก ณ ที่จ่าย 2)
            const checkboxWithholding2 = $(`.checkbox-table-input3[data-product-id="${product.id}"]`);
            let isCheckedWithholding2 = false;
            
            if (checkboxWithholding2.length > 0) {
                isCheckedWithholding2 = checkboxWithholding2.is(':checked');
            } else {
                isCheckedWithholding2 = product.isSelectedForWithholding2 || false;
            }
            
            // ตรวจสอบ checkbox สำหรับ Withholding Tax 3 (ภาษีหัก ณ ที่จ่าย 3)
            const checkboxWithholding3 = $(`.checkbox-table-input4[data-product-id="${product.id}"]`);
            let isCheckedWithholding3 = false;
            
            if (checkboxWithholding3.length > 0) {
                isCheckedWithholding3 = checkboxWithholding3.is(':checked');
            } else {
                isCheckedWithholding3 = product.isSelectedForWithholding3 || false;
            }
            
            const depositAmount = parseFloat(product.deposit_amount) || 0;
            const productTotal = depositAmount;
            
            // คำนวณสำหรับ VAT (ภาษี 7%) - ใช้เฉพาะรายการที่ติ๊กใน Container
            if (isCheckedVAT) {
                totalAllProducts += productTotal;
                totalDiscount += 0; 
            }
            
            // คำนวณสำหรับ Withholding Tax (ภาษีหัก ณ ที่จ่าย) - ใช้เฉพาะรายการที่ติ๊กใน Container2
            if (isCheckedWithholding) {
                totalAllProductsForWithholding += productTotal;
                totalDiscountForWithholding += 0; 
            }
            
            // คำนวณสำหรับ Withholding Tax 2 (ภาษีหัก ณ ที่จ่าย 2) - ใช้เฉพาะรายการที่ติ๊กใน Container3
            if (isCheckedWithholding2) {
                totalAllProductsForWithholding2 += productTotal;
                totalDiscountForWithholding2 += 0; 
            }
            
            // คำนวณสำหรับ Withholding Tax 3 (ภาษีหัก ณ ที่จ่าย 3) - ใช้เฉพาะรายการที่ติ๊กใน Container4
            if (isCheckedWithholding3) {
                totalAllProductsForWithholding3 += productTotal;
                totalDiscountForWithholding3 += 0; 
            }
        });
    }
    
    // คำนวณยอดหลังหักส่วนลด
    const totalAfterDiscount = totalAllProducts;
    const totalAfterDiscountForWithholding = totalAllProductsForWithholding;
    const totalAfterDiscountForWithholding2 = totalAllProductsForWithholding2;
    const totalAfterDiscountForWithholding3 = totalAllProductsForWithholding3;
    
    // คำนวณภาษีมูลค่าเพิ่ม 7% (เฉพาะรายการที่ติ๊กใน Container)
    const taxRate = 0.07;
    const isTaxChecked = $('#list-tax-data').is(':checked');
    const deleteVatAmount = parseFloat($('#delete-vat').val()) || 0;
    
    // ถ้ามีการกรอกในช่อง "เพิ่มใหม่" ให้ใช้ค่านั้นแทนการคำนวณภาษี 7%
    const totalTax = deleteVatAmount > 0 ? deleteVatAmount : (isTaxChecked ? totalAfterDiscount * taxRate : 0);
    
    // คำนวณข้อมูลรวมทั้งหมดสำหรับการแสดงผล (แสดงทุกรายการที่เพิ่มเข้ามา)
    let totalAllProductsCombined = 0;
    let totalDiscountCombined = 0;
    
    // รวมทุกรายการที่เพิ่มเข้ามา (ไม่ขึ้นอยู่กับการติ๊กใน container)
    if (allProductData && allProductData.length > 0) {
        allProductData.forEach(product => {
            const depositAmount = parseFloat(product.deposit_amount) || 0;
            
            // totalAllProductsCombined ต้องแสดงรวม deposit_amount ทั้งหมด
            totalAllProductsCombined += depositAmount;
            totalDiscountCombined += 0;
        });
    }
    
    const totalAfterDiscountCombined = totalAllProductsCombined;
    
    // คำนวณภาษีถูกหัก ณ ที่จ่าย (ใช้ข้อมูลจาก container2)
    const taxWithheldValue = parseFloat($('#tax_withheld').val()) || 0;
    const isMainWithholdingTaxChecked = $('#list-tax-data-2').is(':checked');
    
    console.log('Withholding tax calculation:', {
      taxWithheldValue: taxWithheldValue,
      totalAfterDiscountForWithholding: totalAfterDiscountForWithholding,
      isMainWithholdingTaxChecked: isMainWithholdingTaxChecked,
      isPopupCalculation: isPopupCalculation
    });
    
    // ใช้ค่า tax_withheld เป็นเปอร์เซ็นต์ในการคำนวณ
    let withholdingTax = 0;
    
    // คำนวณในหน้าหลัก: ต้องติ๊ก checkbox ก่อน
    // คำนวณใน popup: คำนวณปกติเมื่อมี tax_withheld (ไม่ต้องติ๊ก checkbox)
    if (isPopupCalculation) {
        // ใน popup: คำนวณปกติเมื่อมี tax_withheld (ไม่ต้องติ๊ก checkbox)
        if (taxWithheldValue > 0) {
            withholdingTax = totalAfterDiscountForWithholding * (taxWithheldValue / 100);
        }
    } else {
        // ในหน้าหลัก: คำนวณเมื่อมี tax_withheld และมีข้อมูลสินค้าที่ติ๊ก
        if (taxWithheldValue > 0 && totalAfterDiscountForWithholding > 0) {
            withholdingTax = totalAfterDiscountForWithholding * (taxWithheldValue / 100);
            // ติ๊ก checkbox อัตโนมัติเมื่อคำนวณได้
            if (withholdingTax > 0) {
                $('#list-tax-data-2').prop('checked', true);
            }
        }
    }
    
    console.log('Final withholding tax:', withholdingTax);
    
    // คำนวณภาษีหัก ณ ที่จ่าย 2 (คำนวณเฉพาะเมื่อฟอร์มที่ 2 แสดงอยู่)
    const form2 = document.getElementById('tax-withheld-form-2');
    const isForm2Visible = form2 && form2.style.display !== 'none';
    
    const taxWithheldValue2 = parseFloat($('#tax_withheld2').val()) || 0;
    let withholdingTax2 = 0;
    
    // คำนวณเฉพาะเมื่อฟอร์มที่ 2 แสดงอยู่และมีข้อมูลในช่องเปอร์เซ็นต์
    if (isForm2Visible && taxWithheldValue2 > 0) {
        withholdingTax2 = totalAfterDiscountForWithholding2 * (taxWithheldValue2 / 100);
    }
    
    // คำนวณภาษีหัก ณ ที่จ่าย 3 (คำนวณเฉพาะเมื่อฟอร์มที่ 3 แสดงอยู่)
    const form3 = document.getElementById('tax-withheld-form-3');
    const isForm3Visible = form3 && form3.style.display !== 'none';
    
    const taxWithheldValue3 = parseFloat($('#tax_withheld3').val()) || 0;
    let withholdingTax3 = 0;
    
    // คำนวณเฉพาะเมื่อฟอร์มที่ 3 แสดงอยู่และมีข้อมูลในช่องเปอร์เซ็นต์
    if (isForm3Visible && taxWithheldValue3 > 0) {
        withholdingTax3 = totalAfterDiscountForWithholding3 * (taxWithheldValue3 / 100);
    }
    
    console.log('Final withholding tax 2:', withholdingTax2);
    console.log('Final withholding tax 3:', withholdingTax3);
    
    // คำนวณยอดรวมทั้งสิ้น (ใช้ข้อมูลรวมทั้งหมด)
    const totalAll = totalAfterDiscountCombined + totalTax - withholdingTax - withholdingTax2 - withholdingTax3;
    
    // อัปเดตการแสดงผลในส่วนสรุปมูลค่าสุทธิ (เฉพาะเมื่อไม่ใช่ popup calculation)
    if (!isPopupCalculation) {
        $('#total-allproduct').text(totalAllProductsCombined.toLocaleString('en-US', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        }));
        
        // อัปเดตค่าในส่วนสรุปภาษีให้ใช้ค่าเดียวกันกับ total-allproduct
        $('#tax-product-price').text(totalAllProductsCombined.toLocaleString('en-US', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        }));
        
        // อัปเดตจำนวนภาษีทั้งหมด (ภาษีมูลค่าเพิ่ม + ภาษีหัก ณ ที่จ่ายทั้งหมด)
        const totalTaxAmount = totalTax + withholdingTax + withholdingTax2 + withholdingTax3;
        $('#tax-total-amount').text(totalTaxAmount.toLocaleString('en-US', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        }));
        
        $('#total-alldiscount').text(totalDiscountCombined.toLocaleString('en-US', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        }));
        
        $('#total-allproduct-total-alldiscount').text(totalAfterDiscountCombined.toLocaleString('en-US', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        }));
    }
    
    // แสดง/ซ่อนภาษีมูลค่าเพิ่ม 7% (เฉพาะเมื่อไม่ใช่ popup calculation)
    if (!isPopupCalculation) {
            // แสดงภาษีถ้ามีการกรอกในช่อง "เพิ่มใหม่" หรือมีการติ๊ก checkbox และคำนวณได้
            if ((deleteVatAmount > 0) || (isTaxChecked && totalTax > 0)) {
                const displayVatValue = deleteVatAmount > 0 ? deleteVatAmount : totalTax;
                $('#total-vat7').text(displayVatValue.toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            })).show();
        } else {
            $('#total-vat7').text('0.00').hide();
        }
        
        // แสดง/ซ่อนภาษีถูกหัก ณ ที่จ่าย (รวมทั้ง 3 อัน)
        const totalWithholdingTax = withholdingTax + withholdingTax2 + withholdingTax3;
        
        if (isMainWithholdingTaxChecked && totalWithholdingTax > 0) {
            $('#total-vat-unit').text(totalWithholdingTax.toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            })).show();
        } else {
            $('#total-vat-unit').text('0.00').hide();
        }
        
        $('#total-all').text(totalAll.toLocaleString('en-US', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        }));
    }
    
    // อัปเดต popup แก้ไข (ทำเสมอ) - คำนวณปกติเมื่อมี tax_withheld
    if (withholdingTax > 0) {
        $('.code-edit-box-sum').val(withholdingTax.toLocaleString('en-US', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        }));
    } else {
        $('.code-edit-box-sum').val('0.00');
    }
    
    // อัปเดต popup แก้ไขสำหรับ withholding tax 2 (แสดงผลเฉพาะเมื่อฟอร์มแสดงอยู่)
    if (isForm2Visible) {
        $('#unit-items3').val(withholdingTax2.toLocaleString('en-US', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        }));
    } else {
        $('#unit-items3').val('0.00');
    }
    
    // อัปเดต popup แก้ไขสำหรับ withholding tax 3 (แสดงผลเฉพาะเมื่อฟอร์มแสดงอยู่)
    if (isForm3Visible) {
        $('#unit-items4').val(withholdingTax3.toLocaleString('en-US', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        }));
    } else {
        $('#unit-items4').val('0.00');
    }
    
    // อัปเดต popup แก้ไข (ทำเสมอ)
    $('#display-total-amount').text(totalAll.toLocaleString('en-US', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    }));
    $('#display-actual-payment').text(totalAllProductsCombined.toLocaleString('en-US', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    }));
    $('#display-after-discount').text(totalAfterDiscountCombined.toLocaleString('en-US', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    }));
    // แสดงค่าภาษีในช่อง display-vat7 (ถ้ามีการกรอกในช่อง "เพิ่มใหม่" ให้แสดงค่านั้น)
    const displayVatValue = deleteVatAmount > 0 ? deleteVatAmount : totalTax;
    $('#display-vat7').val(displayVatValue.toLocaleString('en-US', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    }));
    
    // อัปเดตจำนวนเงินรวมทั้งสิ้นใน popup
    $('.money-sum-total').text(totalAll.toLocaleString('en-US', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    }));
    
    // อัปเดตส่วนสรุปยอดรับชำระ เงินสด
    $('#cut-total-sum').text(totalAll.toLocaleString('en-US', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    }));

    // อัปเดตส่วนสรุปยอดรับชำระ - แสดง total-allproduct + total-vat7
    const cutTotal = totalAllProductsCombined + totalTax;
    $('#cut-total').text(cutTotal.toLocaleString('en-US', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    }));
    
    // อัปเดตภาษีถูกหัก ณ ที่จ่าย (cut-vat) - แสดงค่าของ list-tax-data-2
    const totalWithholdingTax = withholdingTax + withholdingTax2 + withholdingTax3;
    $('#cut-vat').text(totalWithholdingTax.toLocaleString('en-US', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    }));
    
    // อัปเดตยอดคงค้าง (cut-remaining) - แสดงค่าของ product.total ทุกรายการ
    let totalRemaining = 0;
    if (allProductData && allProductData.length > 0) {
        allProductData.forEach(product => {
            const productTotal = parseFloat(product.total) || 0;
            totalRemaining += productTotal;
        });
    }
    $('#cut-remaining').text(totalRemaining.toLocaleString('en-US', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    }));
    
    // อัปเดตยอดที่ตัดไปแล้ว (cut-paid) - คำนวณจากยอดรวมลบยอดคงค้าง
    const totalPaid = totalAll - totalRemaining;
    // ใช้ค่าสัมบูรณ์เพื่อไม่แสดงเครื่องหมายลบ
    const displayPaid = Math.abs(totalPaid);
    $('#cut-paid').text(displayPaid.toLocaleString('en-US', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    }));

     // อัปเดตส่วนสรุปยอดรับชำระ ธนาคาร
    $('#cut-total-sum-bank').text(totalAll.toLocaleString('en-US', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    }));

    // อัปเดตส่วนสรุปยอดรับชำระ - แสดง total-allproduct + total-vat7
    const cutTotalBank = totalAllProductsCombined + totalTax;
    $('#cut-total-bank').text(cutTotal.toLocaleString('en-US', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    }));
    
    // อัปเดตภาษีถูกหัก ณ ที่จ่าย (cut-vat) - แสดงค่าของ list-tax-data-2
    const totalWithholdingTaxBank = withholdingTax + withholdingTax2 + withholdingTax3;
    $('#cut-vat-bank').text(totalWithholdingTax.toLocaleString('en-US', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    }));
    
    // อัปเดตยอดคงค้าง (cut-remaining) - แสดงค่าของ product.total ทุกรายการ
    let totalRemainingBank = 0;
    if (allProductData && allProductData.length > 0) {
        allProductData.forEach(product => {
            const productTotal = parseFloat(product.total) || 0;
            totalRemainingBank += productTotal;
        });
    }
    $('#cut-remaining-bank').text(totalRemainingBank.toLocaleString('en-US', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    }));
    
    // อัปเดตยอดที่ตัดไปแล้ว (cut-paid) - คำนวณจากยอดรวมลบยอดคงค้าง
    const totalPaidBank = totalAll - totalRemainingBank;
    // ใช้ค่าสัมบูรณ์เพื่อไม่แสดงเครื่องหมายลบ
    const displayPaidBank = Math.abs(totalPaidBank);
    $('#cut-paid-bank').text(displayPaidBank.toLocaleString('en-US', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    }));
    
    // อัปเดต payment_detail ใน localStorage ด้วยข้อมูลสรุปการชำระเงิน
    updatePaymentDetailSummary();
    
    console.log('ราคาสุทธิทั้งหมด:', {
        totalAllProducts: totalAllProducts,
        totalDiscount: totalDiscount,
        totalAfterDiscount: totalAfterDiscount,
        totalAllProductsForWithholding: totalAllProductsForWithholding,
        totalDiscountForWithholding: totalDiscountForWithholding,
        totalAfterDiscountForWithholding: totalAfterDiscountForWithholding,
        totalTax: totalTax,
        withholdingTax: withholdingTax,
        totalAll: totalAll
    });
    
    return {
        totalAllProducts: totalAllProductsCombined, // ราคารวมทั้งหมด (ก่อนหักส่วนลด)
        totalDiscount: totalDiscountCombined, // ส่วนลดทั้งหมด
        totalAfterDiscount: totalAfterDiscountCombined, // ยอดหลังหักส่วนลด
        totalAllProductsForWithholding: totalAllProductsForWithholding, // ราคารวมทั้งหมดสำหรับภาษีหัก ณ ที่จ่าย
        totalDiscountForWithholding: totalDiscountForWithholding, // ส่วนลดทั้งหมดสำหรับภาษีหัก ณ ที่จ่าย
        totalAfterDiscountForWithholding: totalAfterDiscountForWithholding, // ยอดหลังหักส่วนลดสำหรับภาษีหัก ณ ที่จ่าย
        totalAllProductsForWithholding2: totalAllProductsForWithholding2, // ราคารวมทั้งหมดสำหรับภาษีหัก ณ ที่จ่าย 2
        totalDiscountForWithholding2: totalDiscountForWithholding2, // ส่วนลดทั้งหมดสำหรับภาษีหัก ณ ที่จ่าย 2
        totalAfterDiscountForWithholding2: totalAfterDiscountForWithholding2, // ยอดหลังหักส่วนลดสำหรับภาษีหัก ณ ที่จ่าย 2
        totalAllProductsForWithholding3: totalAllProductsForWithholding3, // ราคารวมทั้งหมดสำหรับภาษีหัก ณ ที่จ่าย 3
        totalDiscountForWithholding3: totalDiscountForWithholding3, // ส่วนลดทั้งหมดสำหรับภาษีหัก ณ ที่จ่าย 3
        totalAfterDiscountForWithholding3: totalAfterDiscountForWithholding3, // ยอดหลังหักส่วนลดสำหรับภาษีหัก ณ ที่จ่าย 3
        totalTax: totalTax, // ภาษีมูลค่าเพิ่ม 7%
        withholdingTax: withholdingTax, // ภาษีหัก ณ ที่จ่าย
        withholdingTax2: withholdingTax2, // ภาษีหัก ณ ที่จ่าย 2
        withholdingTax3: withholdingTax3, // ภาษีหัก ณ ที่จ่าย 3
        totalAll: totalAll // ราคาสุทธิทั้งหมด
    };
}

// ฟังก์ชันโหลดข้อมูลสินค้าใน popup search
function loadProductSearchData() {
    $.ajax({
        url: `${endpoint}/api/get_all_quotation_bycom`,
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            com_id: '4',
            doc_name: 'ใบสั่งขาย'
        }),
        success: function(response) {
            if (response.code === 200 && response.result && response.result.length > 0) {
                console.log('Found products for search:', response.result);
                
                // เก็บข้อมูลสินค้าทั้งหมด
                allProducts = response.result;
                
                // รีเซ็ตหน้าเป็น 1 เมื่อโหลดข้อมูลใหม่
                currentPage = 1;
                
                // แสดงข้อมูลทั้งหมด
                displayProducts(allProducts);
            } else {
                console.log('No products found for search');
                // แสดงข้อความไม่พบข้อมูล
                const searchResults = $('#productSearchResults');
                searchResults.html('<div class="no-data-message">ไม่พบข้อมูลสินค้า</div>');
                $('.under-search').hide();
            }
        },
        error: function(xhr, status, error) {
            console.log('AJAX Error loading product search:', error);
            console.log('Status:', status);
            console.log('Response:', xhr.responseText);
            
            // แสดงข้อความข้อผิดพลาด
            const searchResults = $('#productSearchResults');
            searchResults.html('<div class="error-message">เกิดข้อผิดพลาดในการโหลดข้อมูล</div>');
            $('.under-search').hide();
        }
    });
}

// ฟังก์ชันโหลดข้อมูลใบสั่งขายใน popup search
function loadProductSearchData4() {
    $.ajax({
        url: `${endpoint}/api/get_all_quotation_bycom`,
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            com_id: '4',
            doc_name: 'ใบสั่งขาย'
        }),
        success: function(response) {
            if (response.code === 200 && response.result && response.result.length > 0) {
                console.log('Found products for search:', response.result);
                
                // เก็บข้อมูลสินค้าทั้งหมด
                allProducts = response.result;
                
                // รีเซ็ตหน้าเป็น 1 เมื่อโหลดข้อมูลใหม่
                currentPage = 1;
                
                // แสดงข้อมูลทั้งหมด
                displayProducts(allProducts, true, '4');
                
                // เพิ่ม event listener สำหรับการคลิกเลือกใน productSearchResults2
                const newSearchItems = $('#productSearchResults2').find('.data-search-long');
                setupRowSelection2(newSearchItems);
            } else {
                console.log('No products found for search');
                // แสดงข้อความไม่พบข้อมูล
                const searchResults = $('#productSearchResults2');
                searchResults.html('<div class="no-data-message">ไม่พบข้อมูลสินค้า</div>');
                $('.under-search').hide();
            }
        },
        error: function(xhr, status, error) {
            console.log('AJAX Error loading product search:', error);
            console.log('Status:', status);
            console.log('Response:', xhr.responseText);
            
            // แสดงข้อความข้อผิดพลาด
            const searchResults = $('#productSearchResults');
            searchResults.html('<div class="error-message">เกิดข้อผิดพลาดในการโหลดข้อมูล</div>');
            $('.under-search').hide();
        }
    });
}


/* ===========================================
   PAGINATION & SEARCH VARIABLES
   =========================================== */

// Global Variables for Product Data
let allProducts = [];              // ข้อมูลสินค้าทั้งหมดจาก API
let allProductData = [];           // ข้อมูลสินค้าสำหรับการแสดงผล

// Pagination Settings - Product View
let productCurrentPage = 1;        // หน้าปัจจุบัน

let productItemsPerPage = 5;       // จำนวนรายการต่อหน้า
let productTotalItems = 0;         // จำนวนรายการทั้งหมด

// Pagination Settings - Search
let currentPage = 1;               // หน้าปัจจุบันของการค้นหา
const itemsPerPage = 10;           // แสดง 10 รายการต่อหน้า

/* ===========================================
   SEARCH FUNCTIONS
   =========================================== */

/**
 * ค้นหาเอกสารที่ตัดตามรหัสใบสั่งขายและชื่อลูกค้า
 */
function searchProducts() {
    const searchTerm = $('#productSearchInput').val().toLowerCase();
    
    // Reset to first page when searching
    currentPage = 1;
    
    if (searchTerm === '') {
        // ไม่มีคำค้น: แสดงข้อมูลทั้งหมด
        displayProducts(allProducts, true, '3');
    } else {
        // กรองข้อมูลตามคำค้น
        const filteredProducts = allProducts.filter(product => 
            (product.tx && product.tx.toLowerCase().includes(searchTerm)) ||
            (product.cus_name && product.cus_name.toLowerCase().includes(searchTerm))
        );
        displayProducts(filteredProducts, true, '3');
    }
}

/**
 * ค้นหาใบสั่งขายตามรหัสใบสั่งขายและชื่อลูกค้า
 */
function searchProducts2() {
    const searchTerm = $('#productSearchInput2').val().toLowerCase();
    
    // Reset to first page when searching
    currentPage = 1;
    
    if (searchTerm === '') {
        // ไม่มีคำค้น: แสดงข้อมูลทั้งหมด
        displayProducts(allProducts, true, '4');
    } else {
        // กรองข้อมูลตามคำค้น
        const filteredProducts = allProducts.filter(product => 
            (product.tx && product.tx.toLowerCase().includes(searchTerm)) ||
            (product.cus_name && product.cus_name.toLowerCase().includes(searchTerm))
        );
        displayProducts(filteredProducts, true, '4');
    }
}

// ฟังก์ชันแสดงข้อมูลสินค้า
function displayProducts(products, usePagination = true) {
    const containers = [
        { selector: '#productSearchResults', com_id: '3' },
        { selector: '#productSearchResults2', com_id: '4' }
    ];

    containers.forEach(({ selector, com_id }) => {
        const searchResults = $(selector);
        searchResults.empty();

        if (products.length === 0) {
            // ไม่มีผลลัพธ์ - ซ่อน pagination ทั้งหมด
            $(selector).closest('.popup-content1-side-popup-add')
                .find('.under-search')
                .hide();
            
            // ซ่อน pagination ใหม่ด้วย
            if (com_id === '4') {
                $('#paginationBox1').hide();
            } else {
                $('#paginationBox2').hide();
            }
            return;
        }

        let dataToShow = products;
        let startIndex = 0;

        if (usePagination) {
            startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            dataToShow = products.slice(startIndex, endIndex);
        }

        dataToShow.forEach((product, index) => {
            const actualIndex = usePagination ? startIndex + index + 1 : index + 1;
            const productRow = `
                <div class="data-search-long" data-product-id="${product.id || ''}" data-product-code="${product.tx || ''}">
                    <div class="number-search">${actualIndex}</div>
                    <div class="code-search">${product.tx || ''}</div>
                    <div class="name-search-long">${product.cus_name || ''}</div>
                    <div class="price-search-long">${product.net_amount || ''}</div>
                    <div class="eye-container">
                        <img src="picture/eye.png" class="eye-search">
                    </div>
                </div>
            `;
            searchResults.append(productRow);
        });

        // ใช้ setupRowSelection หรือ setupRowSelection2 ตาม com_id
        const newSearchItems = searchResults.find('.data-search-long');
        if (com_id === '4') {
            setupRowSelection2(newSearchItems);
        } else  {
            setupRowSelection3(newSearchItems);
        }

        const underSearch = $(selector).closest('.popup-content1-side-popup-add')
            .find('.under-search');

        if (usePagination) {
            if (products.length > 10) {
                // ใช้ pagination ใหม่แทน underSearch เก่า
                if (com_id === '4') {
                    // ใช้ pagination แรกสำหรับ container ที่ 2
                    setupPagination1(products);
                } else {
                    // ใช้ pagination ที่สองสำหรับ container อื่นๆ
                    setupPagination2(products);
                }
                underSearch.hide(); // ซ่อน pagination เก่า
            } else {
                // ซ่อน pagination ทั้งเก่าและใหม่เมื่อข้อมูลไม่เกิน 10 รายการ
                underSearch.hide();
                if (com_id === '4') {
                    $('#paginationBox1').hide();
                } else {
                    $('#paginationBox2').hide();
                }
            }
        }
    });
}

// ฟังก์ชันเปิด popup search และโหลดข้อมูล
function openProductSearchPopup() {
    $('.popup-container.sideadd').show();
    loadProductSearchData();
}

// ฟังก์ชันสำหรับไปหน้าที่กำหนด
function goToPage(page) {
    const searchTerm = $('#productSearchInput').val().toLowerCase();
    let totalPages;
    
    if (searchTerm === '') {
        totalPages = Math.ceil(allProducts.length / itemsPerPage);
    } else {
        const filteredProducts = allProducts.filter(product => 
            (product.product_code && product.product_code.toLowerCase().includes(searchTerm)) ||
            (product.name && product.name.toLowerCase().includes(searchTerm))
        );
        totalPages = Math.ceil(filteredProducts.length / itemsPerPage);
    }
    
    if (page >= 1 && page <= totalPages) {
        currentPage = page;
        displayProducts(allProducts);
        updatePagination();
    }
}

// ฟังก์ชันอัปเดต pagination
function updatePagination() {
    const searchTerm = $('#productSearchInput').val().toLowerCase();
    let totalPages;
    let filteredProducts = allProducts;
    
    if (searchTerm !== '') {
        filteredProducts = allProducts.filter(product => 
            (product.product_code && product.product_code.toLowerCase().includes(searchTerm)) ||
            (product.name && product.name.toLowerCase().includes(searchTerm))
        );
    }
    
    // ตรวจสอบว่ามีข้อมูลมากกว่า 10 รายการหรือไม่
    if (filteredProducts.length <= 10) {
        $('.under-search').hide();
        return;
    }
    
    totalPages = Math.ceil(filteredProducts.length / itemsPerPage);
    
    // อัปเดต pagination HTML
    const paginationHTML = generatePaginationHTML(currentPage, totalPages);
    $('.under-search').html(paginationHTML);
    
    // เพิ่ม event listeners สำหรับปุ่ม pagination
    attachPaginationEvents();
}

/**
 * สร้าง HTML สำหรับ pagination controls
 * @param {number} currentPage - หน้าปัจจุบัน
 * @param {number} totalPages - จำนวนหน้าทั้งหมด
 * @returns {string} HTML string ของ pagination
 */
function generatePaginationHTML(currentPage, totalPages) {
    let html = `<div class="under-page">${currentPage} of ${totalPages} pages</div>`;
    
    // สร้างปุ่ม pagination แบบใหม่
    const paginationButtons = $('<div class="pagination-buttons" style="display: flex; justify-content: center; align-items: center;"></div>');
    
    // helper สร้างปุ่มเลขหน้า
    const addBtn = (i) => {
        const buttonClass = i === currentPage ? 'active' : '';
        const textColor = i === currentPage ? 'color: black;' : 'color: var(--text-color400);';
        paginationButtons.append(`<a class="num-btn ${buttonClass}" style="${textColor}
    text-decoration: none;
    padding: 2px 6px;
    cursor: pointer;" href="#" data-page="${i}">${i}</a>`);
    };
    
    const addDots = () => paginationButtons.append('<span class="dots" style="color: var(--text-color400); padding: 2px 6px;">...</span>');
    
    // ปุ่ม Previous (แสดงตลอด)
    const prevPage = currentPage > 1 ? currentPage - 1 : 1;
    paginationButtons.append(`<a href="#" class="prev" style="width: 16px; height: 16px;" data-page="${prevPage}"><img src="picture/arrow-left.png" style="width: 16px; height: 16px;"></a>`);
    
    // เลือกเลขที่จะโชว์ 3 ตัว + ... + กล่องค้นหา
    let pagesToShow = [];
    if (totalPages <= 3) {
        for (let i = 1; i <= totalPages; i++) pagesToShow.push(i);
    } else if (currentPage <= 2) {
        pagesToShow = [1, 2, 3];
    } else if (currentPage >= totalPages - 1) {
        pagesToShow = [Math.max(1, totalPages - 2), totalPages - 1, totalPages];
    } else {
        pagesToShow = [currentPage - 1, currentPage, currentPage + 1];
    }
    
    // ใส่เลข 3 ตัว
    pagesToShow.forEach(addBtn);
    
    // ถ้าหน้ามากกว่า 3 และยังมีหน้าที่ซ่อนไว้ด้านขวา ค่อยใส่ "..."
    if (totalPages > 3) addDots();
    
    // กล่องค้นหาหน้า (ค่าในช่องคือหน้าสุดท้าย เริ่มต้นพิมพ์ได้ทันที)
    const jumpHtml = `
        <div class="page-jump-wrap">
            <input
                type="text"
                inputmode="numeric"
                pattern="[0-9]*"
                class="page-jump"
                id="pageJump"
                placeholder="${totalPages}"
                aria-label="ไปหน้าที่..."
            />
        </div>`;
    paginationButtons.append(jumpHtml);
    
    // ปุ่ม Next (แสดงตลอด)
    const nextPage = currentPage < totalPages ? currentPage + 1 : totalPages;
    paginationButtons.append(`<a href="#" class="next" data-page="${nextPage}"><img src="picture/arrow-right.png" style="width: 16px; height: 16px;"></a>`);
    
    // รวม pagination HTML
    html += paginationButtons.prop('outerHTML');
    
    return html;
}

// ฟังก์ชันเพิ่ม event listeners สำหรับ pagination (แบบใหม่เหมือน popup view)
function attachPaginationEvents() {
    // ลบ event listeners เก่า
    $('.page-btn, .prev-btn, .next-btn, .num-btn').off('click');
    
    // events ปุ่มเลข
    $('.under-search a.num-btn').off('click').on('click', function (e) {
        e.preventDefault();
        const page = parseInt($(this).data('page'));
        goToPage(page);
    });
    
    // events ปุ่ม Previous และ Next
    $('.under-search a.prev, .under-search a.next').off('click').on('click', function (e) {
        e.preventDefault();
        const page = parseInt($(this).data('page'));
        goToPage(page);
    });
    
    // events กล่องค้นหา (Enter/blur เพื่อกระโดดหน้า)
    (function attachJumpHandlers() {
        const commit = () => {
            const searchTerm = $('#productSearchInput').val().toLowerCase();
            let totalPages;
            let filteredProducts = allProducts;
            
            if (searchTerm !== '') {
                filteredProducts = allProducts.filter(product => 
                    (product.product_code && product.product_code.toLowerCase().includes(searchTerm)) ||
                    (product.name && product.name.toLowerCase().includes(searchTerm))
                );
            }
            
            totalPages = Math.ceil(filteredProducts.length / itemsPerPage);
            const last = totalPages;
            let v = parseInt($('#pageJump').val(), 10);
            if (isNaN(v)) v = last;
            v = Math.max(1, Math.min(last, v));
            goToPage(v);
        };
        
        $('#pageJump').off('keypress blur').on('keypress blur', function (e) {
            if (e.type === 'keypress' && e.which !== 13) return;
            e.preventDefault();
            commit();
        });
    })();
}

// ฟังก์ชันสำหรับสร้างเลขเอกสารอัตโนมัติ
function generateDocumentNumber() {
    const today = new Date();
    const year = today.getFullYear();
    const month = String(today.getMonth() + 1).padStart(2, '0');
    const day = String(today.getDate()).padStart(2, '0');
    const dateString = `${year}${month}${day}`;

    // เรียก API เพื่อสร้างเลขเอกสาร
    fetch(`${endpoint}/api/generateDocumentNumber`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            com_id: '3',
            doc_name: 'ใบรับเงินมัดจำ',
            doc_date: dateString
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.code === 200 && data.result && !data.result.error) {
            // ใช้เลขที่ได้จาก API
            $('#customerDepositReceiptNumber').val(data.result.tx);
            console.log('Generated document number:', data.result.tx);
        } else {
            // ถ้า API ไม่ทำงาน ให้สร้างเลขแบบง่าย
            const fallbackNumber = `PO-${dateString}001`;
            $('#customerDepositReceiptNumber').val(fallbackNumber);
            console.log('Using fallback document number:', fallbackNumber);
        }
    })
    .catch(error => {
        console.error('Error generating document number:', error);
        // ถ้าเกิดข้อผิดพลาด ให้สร้างเลขแบบง่าย
        const fallbackNumber = `PO-${dateString}001`;
        $('#customerDepositReceiptNumber').val(fallbackNumber);
        console.log('Using fallback document number:', fallbackNumber);
    });
}

// ฟังก์ชันสำหรับรีเฟรชเลขเอกสาร
function refreshDocumentNumber() {
    if (confirm('ต้องการสร้างเลขเอกสารใหม่หรือไม่?')) {
        generateDocumentNumber();
    }
}

// Event listener สำหรับปุ่มนำทาง
$(document).ready(function() {
    // Event listeners จะถูกเพิ่มผ่าน attachPaginationEvents()
    
    // สร้างเลขเอกสารอัตโนมัติเมื่อโหลดหน้า (เฉพาะเมื่อไม่ใช่โหมดแก้ไข)
    if (!window.editQuotationId) {
        generateDocumentNumber();
    }
    
    // โหลดข้อมูลสินค้าและคำนวณราคาสุทธิเมื่อโหลดหน้าเว็บ (เฉพาะเมื่อไม่ใช่โหมดแก้ไข)
    if (!window.editQuotationId) {
    showProductData();
    } else {
        console.log('Skipping showProductData() in document.ready - already in edit mode');
    }
    
    // Event listener สำหรับ checkbox ภาษีมูลค่าเพิ่ม
    $('#list-tax-data').on('change', function() {
        console.log('🔄 [หน้าหลัก VAT] เปลี่ยน checkbox ภาษีมูลค่าเพิ่ม');
        const isChecked = $(this).is(':checked');
        
        // ติ๊กหรือยกเลิกทุกรายการใน popup
        if (typeof allProductData !== 'undefined' && allProductData) {
            allProductData.forEach(product => {
                product.isSelected = isChecked;
            });
            console.log(`🔄 [หน้าหลัก VAT] ${isChecked ? 'ติ๊ก' : 'ยกเลิก'}ทุกรายการ`);
            
            // อัปเดต popup ถ้าเปิดอยู่
            displayProductCheckboxList();
        }
        
        calculateTotalSummary();
    });
    
    // Event listener สำหรับ checkbox ภาษีถูกหัก ณ ที่จ่าย
    $('#list-tax-data-2').on('change', function() {
        console.log('🔄 [หน้าหลัก ภาษีหัก] เปลี่ยน checkbox ภาษีถูกหัก ณ ที่จ่าย');
        const isChecked = $(this).is(':checked');
        
        // ติ๊กหรือยกเลิกทุกรายการใน popup
        if (typeof allProductData !== 'undefined' && allProductData) {
            allProductData.forEach(product => {
                product.isSelectedForWithholding = isChecked;
            });
            console.log(`🔄 [หน้าหลัก ภาษีหัก] ${isChecked ? 'ติ๊ก' : 'ยกเลิก'}ทุกรายการ`);
            
            // อัปเดต popup ถ้าเปิดอยู่
            updateCheckboxList2();
        }
        
        calculateTotalSummary();
    });
    
    // Event listener สำหรับ dropdown อัตราภาษีถูกหัก ณ ที่จ่าย
    $('#unit-items').on('change', function() {
        console.log('เปลี่ยน dropdown อัตราภาษีถูกหัก ณ ที่จ่าย');
        calculateTotalSummary();
    });
    
    // Event listener สำหรับการเปลี่ยนแปลงอัตราภาษีหัก ณ ที่จ่าย
    $('#tax_withheld, #tax_withheld2, #tax_withheld3').on('input change', function() {
        console.log('เปลี่ยนอัตราภาษีหัก ณ ที่จ่าย:', $(this).val());
        
        // อัปเดต checkbox list ที่เกี่ยวข้อง
        if ($(this).attr('id') === 'tax_withheld') {
            updateCheckboxList2();
        } else if ($(this).attr('id') === 'tax_withheld2') {
            updateCheckboxList3();
        } else if ($(this).attr('id') === 'tax_withheld3') {
            updateCheckboxList4();
        }
        
        calculateTotalSummary();
    });
});

/* ===========================================
   GLOBAL HELPER FUNCTIONS
   =========================================== */

/**
 * แสดง Popup/Modal
 * @param {jQuery} $popupElement - jQuery element ของ popup
 */
function showPopup($popupElement) {
    $popupElement.css('display', 'flex');
    $popupElement.appendTo('body');
    setTimeout(() => {
        $popupElement.addClass('show');
        $('body').addClass('no-scroll'); // ป้องกันการ scroll
    }, 10);
}

/**
 * ซ่อน Popup/Modal
 * @param {jQuery} $popupElement - jQuery element ของ popup
 */
function hidePopup($popupElement) {
    $popupElement.removeClass('show');
    setTimeout(() => {
        // ตรวจสอบ popup อื่นที่กำลังแสดง
        if (!$('.popup.show').length && !$('.sideupload.show').length && 
            !$('.sideadd.show').length && !$('.sidetable.show').length) {
            $('body').removeClass('no-scroll');
        }
        
        // ซ่อน element หลัง animation เสร็จ
        if (!$popupElement.hasClass('show')) {
            $popupElement.css('display', 'none');
        }
    }, 150); // TRANSITION_DURATION
}

/**
 * Setup การเลือกแถวและเปลี่ยนรูปภาพ
 * One-click selection with visual feedback
 * @param {jQuery} items - jQuery collection ของ items
 */
function setupRowSelection(items) {
    items.each(function () {
        const item = $(this);
        item.on('click', function () {
            // ลบคลาส 'selected' และเปลี่ยนรูปภาพกลับสำหรับทุกรายการในกลุ่มเดียวกัน
            items.each(function () {
                const currentItem = $(this);
                currentItem.removeClass('selected');
                const eyeImg = currentItem.find('.eye-search');
                if (eyeImg.length) {
                    eyeImg.attr('src', 'picture/eye.png'); // Path รูปเริ่มต้น
                }
            });
            // เพิ่มคลาส 'selected' และเปลี่ยนรูปภาพสำหรับรายการที่ถูกคลิก
            item.addClass('selected');
            const eyeImgSelected = item.find('.eye-search');
            if (eyeImgSelected.length) {
                eyeImgSelected.attr('src', 'picture/eye-white.png'); // Path รูปเมื่อถูกเลือก
            }
            
            // ดึงข้อมูล ID และ product_code จาก data attributes
            const productId = item.data('product-id');
            const productCode = item.data('product-code');
            
            console.log('Item clicked and selected:', item.attr('class'));
            console.log('Product ID:', productId);
            console.log('Product Code:', productCode);

            // หาข้อมูลสินค้าจาก master data
            const product = allProducts.find(p => p.id == productId);
            if (product) {
                // เก็บข้อมูลสินค้าที่เลือกไว้ในตัวแปรชั่วคราว
                window.selectedMasterProduct = {
                    id: Date.now(), // ใช้ timestamp เป็น ID ชั่วคราว
                    product_code: product.product_code || generateProductCode(),
                    name: product.name || '',
                    desc_product: product.desc_product || '',
                    qty: product.qty || '1',
                    unit: product.unit || '',
                    price: product.deposit_amount || '0',
                    discount: product.discount || '0',
                    total: calculateProductTotalFromValues(product.qty || '1', product.deposit_amount || '0', product.discount || '0')
                };
                console.log('เลือกสินค้าจาก master data:', window.selectedMasterProduct);
            } else {
                alert('ไม่พบข้อมูลสินค้าที่เลือก');
            }
            
        });
    });
}


function setupRowSelection2(items) {
    items.each(function () {
        const item = $(this);
        item.on('click', function () {
            // ลบคลาส 'selected' และเปลี่ยนรูปภาพกลับสำหรับทุกรายการในกลุ่มเดียวกัน
            items.each(function () {
                const currentItem = $(this);
                currentItem.removeClass('selected');
                const eyeImg = currentItem.find('.eye-search');
                if (eyeImg.length) {
                    eyeImg.attr('src', 'picture/eye.png'); // Path รูปเริ่มต้น
                }
            });
            // เพิ่มคลาส 'selected' และเปลี่ยนรูปภาพสำหรับรายการที่ถูกคลิก
            item.addClass('selected');
            const eyeImgSelected = item.find('.eye-search');
            if (eyeImgSelected.length) {
                eyeImgSelected.attr('src', 'picture/eye-white.png'); // Path รูปเมื่อถูกเลือก
            }
            
            // ดึงข้อมูล ID และ product_code จาก data attributes
            const productId = item.data('product-id');
            const productCode = item.data('product-code');
            
            console.log('Item clicked and selected:', item.attr('class'));
            console.log('Product ID:', productId);
            console.log('Product Code:', productCode);

            // เก็บข้อมูลที่เลือกไว้ในตัวแปร global เพื่อใช้เมื่อกดปุ่ม save
            window.selectedProductCode = productCode;
            window.selectedProductId = productId;

            // ไม่เปลี่ยนข้อความในช่อง input ทันที รอให้กดปุ่ม save ก่อน
            // const $salesOrderInput = $('.input-select-refer input.input-credit[placeholder="ใบสั่งขาย"]');
            // if ($salesOrderInput.length) {
            //     $salesOrderInput.val(productCode).trigger('input').trigger('change');
            // }

            // ปิด popup search แล้วเปิด popup มัดจำ พร้อมโหลดข้อมูลใบสั่งขายที่เลือก
            //$('.popup-container').hide();
        
            
        });
    });
}

//เพิ่มใบสั่งขายลงบริการ
function setupRowSelection3(items) {
    const $container = (items && items.length) ? items.first().parent() : $(document);

    // ป้องกันการผูก event ซ้ำ
    $container.off('click.setupRowSelection3', '.data-search-long');

    // ใช้ event delegation เพื่อให้รองรับแถวที่ถูกสร้างแบบไดนามิกทั้งหมด
    $container.on('click.setupRowSelection3', '.data-search-long', function () {
        const $clickedItem = $(this);

        // ลบคลาส 'selected' และเปลี่ยนรูปภาพกลับสำหรับทุกรายการในกลุ่มเดียวกัน
        const $allItems = $container.find('.data-search-long');
        $allItems.each(function () {
            const $currentItem = $(this);
            $currentItem.removeClass('selected');
            const $eyeImg = $currentItem.find('.eye-search');
            if ($eyeImg.length) {
                $eyeImg.attr('src', 'picture/eye.png'); // Path รูปเริ่มต้น
            }
        });

        // เพิ่มคลาส 'selected' และเปลี่ยนรูปภาพสำหรับรายการที่ถูกคลิก
        $clickedItem.addClass('selected');
        const $eyeImgSelected = $clickedItem.find('.eye-search');
        if ($eyeImgSelected.length) {
            $eyeImgSelected.attr('src', 'picture/eye-white.png'); // Path รูปเมื่อถูกเลือก
        }

        // ดึงข้อมูล ID และ product_code จาก data attributes ของแถวที่ถูกคลิก
        const productId = $clickedItem.data('product-id');
        const productCode = $clickedItem.data('product-code');

        console.log('Item clicked and selected:', $clickedItem.attr('class'));
        console.log('Product ID:', productId);
        console.log('Product Code:', productCode);

        // เก็บข้อมูลที่เลือกไว้ในตัวแปร global เพื่อใช้เมื่อกดปุ่ม sidetableSaveBtn
        window.selectedProductId = productId;
        window.selectedProductCode = productCode;

        console.log('เลือกสินค้าแล้ว:', productCode);
        console.log('รอให้กดปุ่ม "เพิ่ม" เพื่อโหลดข้อมูลลงในโมดอล');
    });
}



/* ===========================================
   FILE UPLOAD MANAGEMENT
   =========================================== */

document.addEventListener('DOMContentLoaded', function() {
    /**
     * ระบบจัดการการอัปโหลดไฟล์
     * - เลือกไฟล์
     * - ยืนยันไฟล์
     * - แก้ไขชื่อไฟล์
     * - ลบไฟล์
     */
    
    // DOM Elements
    const uploadBox = document.getElementById('uploadBox');
    const fileInput = document.getElementById('fileInput');
    const fileDisplay = document.getElementById('fileDisplay');
    const fileNameInput = document.getElementById('fileNameInput');
    const removeFileBtn = document.getElementById('removeFileBtn');
    const checkBtn = document.querySelector('.check-x img[src="picture/check-green.png"]');
    const confirmedFilesDisplay = document.getElementById('confirmedFilesDisplay');

    // Validation: ตรวจสอบ element ที่จำเป็น
    if (!uploadBox || !fileInput || !fileNameInput || !removeFileBtn || !checkBtn) {
        console.error('ไม่พบ element ที่ต้องการ:', {
            uploadBox: !!uploadBox,
            fileInput: !!fileInput,
            fileNameInput: !!fileNameInput,
            removeFileBtn: !!removeFileBtn,
            checkBtn: !!checkBtn
        });
        return;
    }

    // State Variables
    let selectedFiles = [];        // ไฟล์ที่เลือก (ยังไม่ยืนยัน)
    window.confirmedFiles = [];    // ไฟล์ที่ยืนยันแล้ว (global)
    

    /**
     * ล้างค่า input ทั้งหมด
     * ใช้เมื่อเปิด popup ใหม่
     */
    function clearInputs() {
        selectedFiles = [];
        fileNameInput.value = '';
        fileInput.value = '';
        console.log('ล้างค่า input แล้ว');
    }

    /**
     * แสดงรายการไฟล์ที่ยืนยันแล้ว
     * อัปเดต UI แสดงไฟล์ทั้งหมด
     */
    function displayConfirmedFiles() {
      if (confirmedFilesDisplay) {
        if (window.confirmedFiles.length === 0) {
          confirmedFilesDisplay.innerHTML = '';
        } else {
          let html = '';
          window.confirmedFiles.forEach((file, index) => {
            const fileSize = (file.size / (1024 * 1024)).toFixed(2); // แปลงเป็น MB
            html += `
              <div class="x-upload-doc">
                <div class="doc-upload">
                  <div class="doc-name">${file.name}</div>
                  <div class="MB-upload">(${fileSize} MB)</div>
                </div>
                <div class="check-x">
                  <img src="picture/eye.png" class="upload-gray" onclick="viewFile(${index})" style="cursor:pointer;" title="เปิดไฟล์">
                  <img src="picture/pen.png" class="upload-gray" onclick="editFileName(${index})" style="cursor:pointer;" title="เปลี่ยนชื่อไฟล์">
                  <img src="picture/bin.png" class="upload-gray" onclick="removeConfirmedFile(${index})" style="cursor:pointer;" title="ลบไฟล์">
                </div>
              </div>
            `;
          });
          confirmedFilesDisplay.innerHTML = html;
        }
      }
      
    }

    // ฟังก์ชันแสดงไฟล์ที่ยืนยันแล้วในตำแหน่งที่เลือกไว้
    window.displayConfirmedFilesInShowUpload = function() {
      const showUploadFiles = document.getElementById('showUploadFiles');
      if (showUploadFiles) {
        if (window.confirmedFiles.length === 0) {
          showUploadFiles.innerHTML = '<!--กล่องอัปโหลดไฟล์แล้วจะแสดงที่นี่ด้วย-->';
        } else {
          let html = '';
          window.confirmedFiles.forEach((file, index) => {
            const fileSize = (file.size / (1024 * 1024)).toFixed(2); // แปลงเป็น MB
            html += `
              <div class="x-upload-doc">
                <div class="doc-upload">
                  <div class="doc-name">${file.name}</div>
                  <div class="MB-upload">(${fileSize} MB)</div>
                </div>
                <div class="check-x">
                  <img src="picture/eye.png" class="upload-gray" onclick="viewFile(${index})" style="cursor:pointer;" title="เปิดไฟล์">
                  <img src="picture/bin.png" class="upload-gray" onclick="removeConfirmedFile(${index})" style="cursor:pointer;" title="ลบไฟล์">
                </div>
              </div>
            `;
          });
          showUploadFiles.innerHTML = html;
        }
      }
    }

    // ฟังก์ชันลบไฟล์ที่ยืนยันแล้ว
    window.removeConfirmedFile = function(index) {
      window.confirmedFiles.splice(index, 1);
      displayConfirmedFiles();
      displayConfirmedFilesInShowUpload(); // เพิ่มการอัปเดตแสดงผลในตำแหน่งที่เลือกไว้
      console.log('ไฟล์ถูกลบออกจากรายการยืนยัน');
    };

    // ฟังก์ชันเปิดไฟล์ในแท็บใหม่
    window.viewFile = function(index) {
      const file = window.confirmedFiles[index];
      if (file) {
        const fileUrl = URL.createObjectURL(file);
        window.open(fileUrl, '_blank');
        console.log('เปิดไฟล์ในแท็บใหม่:', file.name);
      }
    };

    // ฟังก์ชันเอาชื่อไฟล์ไปแสดงในช่อง
    window.editFileName = function(index) {
      const file = window.confirmedFiles[index];
      if (file) {
        fileNameInput.value = file.name;
        console.log('เอาชื่อไฟล์ไปแสดงในช่อง input:', file.name);
      }
    };

  // คลิก div เพื่อเปิด input file
  uploadBox.addEventListener('click', () => {
    fileInput.click();
  });

    // ล้างค่า input เมื่อเปิด popup ใหม่
    // ตรวจสอบว่ามีปุ่มเปิด popup หรือไม่
    const openPopupBtn = document.querySelector('.openPopupBtnupload');
    if (openPopupBtn) {
      openPopupBtn.addEventListener('click', () => {
        clearInputs();
        console.log('กดปุ่มอัปโหลดไฟล์ - ล้างค่า input');
      });
    } else {
      console.log('ไม่พบปุ่ม .openPopupBtnupload');
    }

    // หรือใช้ event listener สำหรับ modal show
    const modal = document.querySelector('.modal');
    if (modal) {
      modal.addEventListener('show.bs.modal', () => {
        clearInputs();
        console.log('เปิด modal - ล้างค่า input');
      });
    } else {
      console.log('ไม่พบ modal');
    }

    // เพิ่ม event listener สำหรับปุ่มอื่นๆ ที่อาจเปิด popup
    const allButtons = document.querySelectorAll('button, div[onclick], div[data-bs-toggle]');
    allButtons.forEach(btn => {
      if (btn.textContent.includes('อัปโหลด') || btn.textContent.includes('upload')) {
        btn.addEventListener('click', () => {
          clearInputs();
          console.log('กดปุ่มที่เกี่ยวข้องกับอัปโหลด - ล้างค่า input');
        });
      }
  });

  // เมื่อเลือกไฟล์
  fileInput.addEventListener('change', (event) => {
      const files = Array.from(event.target.files);
      console.log('ไฟล์ที่เลือก:', files); // Debug
      if (files.length > 0) {
        // เพิ่มไฟล์ใหม่เข้าไปใน selectedFiles (ไม่แทนที่)
        selectedFiles = [...selectedFiles, ...files];
        // แสดงชื่อไฟล์ทั้งหมดในช่อง input (คั่นด้วยจุลภาค)
        const fileNames = selectedFiles.map(file => file.name).join(', ');
        fileNameInput.value = fileNames;
        console.log('ชื่อไฟล์ที่เลือกทั้งหมด:');
        selectedFiles.forEach((file, index) => {
          console.log(`${index + 1}. ${file.name}`);
        });
        console.log('จำนวนไฟล์ที่เลือกทั้งหมด:', selectedFiles.length);
        
    }
  });

  // ลบไฟล์ที่เลือก
  removeFileBtn.addEventListener('click', () => {
      selectedFiles = []; // ล้างไฟล์ที่เลือก
    fileInput.value = ''; // เคลียร์ input
      fileNameInput.value = ''; // เคลียร์ชื่อไฟล์ในช่อง input
      console.log('ไฟล์ถูกลบแล้ว');
    });

    // ยืนยันไฟล์ที่เลือก (เก็บไว้ก่อน ยังไม่ลง DB)
    checkBtn.addEventListener('click', () => {
      if (selectedFiles.length > 0) {
        // ตรวจสอบว่ามีการเปลี่ยนชื่อไฟล์ในช่อง input หรือไม่
        const inputNames = fileNameInput.value.split(',').map(name => name.trim());
        if (inputNames.length === selectedFiles.length && inputNames.every(name => name)) {
          // เปลี่ยนชื่อไฟล์ตามที่แก้ไขในช่อง input
          const renamedFiles = selectedFiles.map((file, index) => {
            if (inputNames[index] && inputNames[index] !== file.name) {
              const newFile = new File([file], inputNames[index], {
                type: file.type,
                lastModified: file.lastModified
              });
              console.log('เปลี่ยนชื่อไฟล์จาก:', file.name, 'เป็น:', inputNames[index]);
              return newFile;
            }
            return file;
          });
          window.confirmedFiles = [...window.confirmedFiles, ...renamedFiles];
        } else {
          // ไม่มีการเปลี่ยนชื่อ ใช้ชื่อเดิม
          window.confirmedFiles = [...window.confirmedFiles, ...selectedFiles];
        }
        
        // ล้างไฟล์ที่เลือกหลังจากยืนยันแล้ว
        selectedFiles = [];
        fileNameInput.value = ''; // ล้างช่อง input
        fileInput.value = ''; // ล้าง input file
        
        // แสดงไฟล์ที่ยืนยันแล้ว
        displayConfirmedFiles();
        
        console.log('ไฟล์ที่ยืนยันทั้งหมด:');
        window.confirmedFiles.forEach((file, index) => {
          console.log(`${index + 1}. ${file.name}`);
        });
        console.log('จำนวนไฟล์ที่ยืนยันทั้งหมด:', window.confirmedFiles.length);
      } else if (fileNameInput.value.trim()) {
        // ถ้าไม่มีไฟล์ที่เลือก แต่มีชื่อในช่อง input (กรณีแก้ไขชื่อไฟล์ที่ยืนยันแล้ว)
        const newName = fileNameInput.value.trim();
        if (newName) {
          // หาไฟล์ที่กำลังแก้ไข (ไฟล์ล่าสุดที่กดปุ่ม pen)
          const lastIndex = window.confirmedFiles.length - 1;
          if (lastIndex >= 0) {
            const file = window.confirmedFiles[lastIndex];
            const newFile = new File([file], newName, {
              type: file.type,
              lastModified: file.lastModified
            });
            
            window.confirmedFiles[lastIndex] = newFile;
            displayConfirmedFiles();
            console.log('เปลี่ยนชื่อไฟล์ที่ยืนยันแล้วจาก:', file.name, 'เป็น:', newName);
          }
        }
        fileNameInput.value = ''; // ล้างช่อง input
      } else {
        console.log('กรุณาเลือกไฟล์ก่อน');
      }
    });
  });

  // Autocomplete functionality for customer name
  let customerData = [];

  let currentFocus = -1;
  const customerInput = document.getElementById('customerName');
  const customerDropdown = document.getElementById('customerDropdown');

  // Function to search customers from API
  async function searchCustomers(input) {
    try {
        const response = await fetch(`${endpoint}/api/search_company`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          search_term: input,
          limit: 10
        })
      });
      
      const data = await response.json();
      if (data.code === 200) {
        return data.result.map(company => ({
          name: company.name, //ชื่อลูกค้า
          no: company.no, //รหัสลูกค้า
          phone_no: company.phone_no, //โทรศัพท์
          addr: company.addr, //ที่อยู่
          email: company.email, //อีเมล
          business_location: company.business_location, //ที่ตั้งธุรกิจ
          contact_name: company.contact_name, //ชื่อผู้ติดต่อ
          refer: company.refer, //อ้างอิง
          head_office: company.head_office, //ที่ตั้งสำนักงาน
          branch_no: company.branch_no, //รหัสสาขาสำนักงานใหญ่
          branch_name: company.branch_name, //ชื่อสาขา
        }));
      }
      return [];
    } catch (error) {
      console.error('Error searching customers:', error);
      return [];
    }
  }

  // Function to display dropdown
  function showDropdown(customers) {
    customerDropdown.innerHTML = '';
    
    if (customers.length === 0) {
      customerDropdown.style.display = 'none';
      return;
    }

    customers.forEach((customer, index) => {
      const item = document.createElement('div');
      item.className = 'autocomplete-item';
      item.innerHTML = `
        <div class="customer-name">${customer.name}</div>
      `;
      
      item.addEventListener('click', () => {
        selectCustomer(customer);
      });
      
      customerDropdown.appendChild(item);
    });
    
    customerDropdown.classList.add('show');
    customerDropdown.style.display = 'block';
  }

  // Function to select customer
  function selectCustomer(customer) {
    customerInput.value = customer.name;
    document.getElementById('customerCode').value = customer.no;
    document.getElementById('customerPhone').value = customer.phone_no;
    document.getElementById('customerAddress').value = customer.addr;
    document.getElementById('customerGmail').value = customer.email;
    document.getElementById('customerHeadOffice').value = customer.business_location;
    document.getElementById('customerRefer').value = customer.refer;
    document.getElementById('customerContactName').value = customer.contact_name;
    if (customer.head_office) {
        $('#big-office').prop('checked', true);
        $('.branch-name').hide();
    } else {
        $('#small-office').prop('checked', true);
        $('.branch-name').show();
    }
    document.getElementById('customerBranchCode').value = customer.branch_no;
    document.getElementById('customerBranchName').value = customer.branch_name;

    // อัปเดตชื่อลูกค้าใน dropdown
    updateCustomerNameDropdown(customer.name);

    // โหลดข้อมูลบริษัทตามรหัสลูกค้าที่เลือก
    if (customer.no) {
      loadCompanyDataByCustomerNo(customer.no);
    }

    hideDropdown();
  }

  // Function to update customer name dropdown
  function updateCustomerNameDropdown(customerName) {
    const customerNameDropdown = document.getElementById('customerNameDropdown');
    if (customerNameDropdown && customerName) {
      // ล้าง options เดิม
      customerNameDropdown.innerHTML = '';
      
      // เพิ่ม option ใหม่ที่มีชื่อลูกค้าที่เลือก
      const newOption = document.createElement('option');
      newOption.value = customerName;
      newOption.textContent = customerName;
      newOption.selected = true;
      customerNameDropdown.appendChild(newOption);
    }
  }

  // Function to update tax ID dropdown
  function updateTaxIdDropdown(vatNo) {
    const taxIdDropdown = document.getElementById('taxIdDropdown');
    if (taxIdDropdown && vatNo) {
      // ล้าง options เดิม
      taxIdDropdown.innerHTML = '';
      
      // เพิ่ม option ใหม่ที่มีเลขประจำตัวผู้เสียภาษี
      const newOption = document.createElement('option');
      newOption.value = vatNo;
      newOption.textContent = vatNo;
      newOption.selected = true;
      taxIdDropdown.appendChild(newOption);
    }
  }

  // Function to update business type dropdown
  function updateBusinessTypeDropdown(typeBusiness) {
    const businessTypeDropdown = document.getElementById('businessTypeDropdown');
    if (businessTypeDropdown && typeBusiness) {
      // ตรวจสอบว่ามี option นี้อยู่แล้วหรือไม่
      let existingOption = null;
      for (let i = 0; i < businessTypeDropdown.options.length; i++) {
        if (businessTypeDropdown.options[i].value === typeBusiness || 
            businessTypeDropdown.options[i].textContent === typeBusiness) {
          existingOption = businessTypeDropdown.options[i];
          break;
        }
      }
      
      if (existingOption) {
        // ถ้ามีอยู่แล้ว ให้เลือก option นั้น
        existingOption.selected = true;
      } else {
        // ถ้าไม่มี ให้เพิ่ม option ใหม่
        const newOption = document.createElement('option');
        newOption.value = typeBusiness;
        newOption.textContent = typeBusiness;
        newOption.selected = true;
        businessTypeDropdown.appendChild(newOption);
      }
    }
  }

  // Function to update department dropdown
  function updateDepartmentDropdown(typeDepartmen) {
    const departmentDropdown = document.getElementById('departmentDropdown');
    if (departmentDropdown && typeDepartmen) {
      // ตรวจสอบว่ามี option นี้อยู่แล้วหรือไม่
      let existingOption = null;
      for (let i = 0; i < departmentDropdown.options.length; i++) {
        if (departmentDropdown.options[i].value === typeDepartmen || 
            departmentDropdown.options[i].textContent === typeDepartmen) {
          existingOption = departmentDropdown.options[i];
          break;
        }
      }
      
      if (existingOption) {
        // ถ้ามีอยู่แล้ว ให้เลือก option นั้น
        existingOption.selected = true;
      } else {
        // ถ้าไม่มี ให้เพิ่ม option ใหม่
        const newOption = document.createElement('option');
        newOption.value = typeDepartmen;
        newOption.textContent = typeDepartmen;
        newOption.selected = true;
        departmentDropdown.appendChild(newOption);
      }
    }
  }

  // Function to update tax period dropdown
  function updateTaxPeriodDropdown(taxPeriod) {
    const taxPeriodDropdown = document.getElementById('taxPeriodDropdown');
    if (taxPeriodDropdown && taxPeriod) {
      // ตรวจสอบว่ามี option นี้อยู่แล้วหรือไม่
      let existingOption = null;
      for (let i = 0; i < taxPeriodDropdown.options.length; i++) {
        if (taxPeriodDropdown.options[i].value === taxPeriod || 
            taxPeriodDropdown.options[i].textContent === taxPeriod) {
          existingOption = taxPeriodDropdown.options[i];
          break;
        }
      }
      
      if (existingOption) {
        // ถ้ามีอยู่แล้ว ให้เลือก option นั้น
        existingOption.selected = true;
      } else {
        // ถ้าไม่มี ให้เพิ่ม option ใหม่
        const newOption = document.createElement('option');
        newOption.value = taxPeriod;
        newOption.textContent = taxPeriod;
        newOption.selected = true;
        taxPeriodDropdown.appendChild(newOption);
      }
    }
  }

  // Function to hide dropdown
  function hideDropdown() {
    customerDropdown.classList.remove('show');
    customerDropdown.style.display = 'none';
    currentFocus = -1;
  }

  // Function to highlight item
  function highlightItem(index) {
    const items = customerDropdown.querySelectorAll('.autocomplete-item');
    items.forEach((item, i) => {
      if (i === index) {
        item.classList.add('highlighted');
      } else {
        item.classList.remove('highlighted');
      }
    });
  }

  // Event listeners
  customerInput.addEventListener('input', async function() {
    const input = this.value;
    
    // อัปเดตชื่อลูกค้าใน dropdown ทันทีเมื่อมีการเปลี่ยนแปลง
    updateCustomerNameDropdown(input);
    
    if (input.length >= 1) {
      const filteredCustomers = await searchCustomers(input);
      showDropdown(filteredCustomers);
    } else {
      hideDropdown();
    }
    currentFocus = -1;
  });

  customerInput.addEventListener('keydown', function(e) {
    const items = customerDropdown.querySelectorAll('.autocomplete-item');
    
    if (e.key === 'ArrowDown') {
      e.preventDefault();
      currentFocus = Math.min(currentFocus + 1, items.length - 1);
      highlightItem(currentFocus);
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      currentFocus = Math.max(currentFocus - 1, -1);
      highlightItem(currentFocus);
    } else if (e.key === 'Enter') {
      e.preventDefault();
      if (currentFocus >= 0 && items[currentFocus]) {
        items[currentFocus].click();
      }
    } else if (e.key === 'Escape') {
      hideDropdown();
    }
  });

  // Hide dropdown when clicking outside
  document.addEventListener('click', function(e) {
    if (!customerInput.contains(e.target) && !customerDropdown.contains(e.target)) {
      hideDropdown();
    }
  });

  // Focus management
  customerInput.addEventListener('focus', async function() {
    if (this.value.length >= 1) {
      const filteredCustomers = await searchCustomers(this.value);
      showDropdown(filteredCustomers);
    }
  });

  // ฟังก์ชันโหลดข้อมูลบริษัท
  function loadCompanyDataByCustomerNo(customerNo) {
    if (!customerNo || customerNo.trim() === '') {
      console.log('No customer number provided');
      return;
    }

    fetch(`${endpoint}/api/get_company`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        no: customerNo
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.code === 200 && data.result) {
        // แสดงค่า tax_withheld ในช่อง input
        const taxWithheldInput = document.getElementById('tax_withheld');
        if (taxWithheldInput && data.result.tax_withheld) {
          taxWithheldInput.value = data.result.tax_withheld;
          // คำนวณ withholding tax ใหม่เมื่อโหลดข้อมูลลูกค้า
          calculateTotalSummary();
          // อัปเดต checkbox list เพื่อแสดง totalPrice ใหม่
          displayProductCheckboxList();
        }
        
        // อัปเดตเลขประจำตัวผู้เสียภาษีใน dropdown
        if (data.result.vat_no) {
          updateTaxIdDropdown(data.result.vat_no);
        }
        
        // อัปเดตประเภทธุรกิจ/คำนำหน้าใน dropdown
        if (data.result.type_business) {
          updateBusinessTypeDropdown(data.result.type_business);
        }
        
        // อัปเดตแผนกใน dropdown
        if (data.result.type_department) {
          updateDepartmentDropdown(data.result.type_department);
        }
        
        // อัปเดตข้อมูลอื่นๆ ในฟอร์ม
        if (data.result.name) {
          $('#customerName').val(data.result.name);
        }
        if (data.result.addr) {
          $('#customerAddress').val(data.result.addr);
        }
        if (data.result.phone_no) {
          $('#customerPhone').val(data.result.phone_no);
        }
        if (data.result.email) {
          $('#customerGmail').val(data.result.email);
        }
        if (data.result.contact_name) {
          $('#customerContactName').val(data.result.contact_name);
        }
        if (data.result.refer) {
          $('#customerRefer').val(data.result.refer);
        }
        if (data.result.business_location) {
          $('#customerHeadOffice').val(data.result.business_location);
        }
        
        console.log('Company data loaded for customer no:', customerNo, data.result);
      } else {
        console.log('No company data found for customer no:', customerNo);
        // ล้างค่า tax_withheld ถ้าไม่พบข้อมูล
        const taxWithheldInput = document.getElementById('tax_withheld');
        if (taxWithheldInput) {
          taxWithheldInput.value = '';
        }
      }
    })
    .catch(error => {
      console.error('Error loading company data for customer no:', customerNo, error);
    });
  }

  // Event listener สำหรับการเปลี่ยนแปลงรหัสลูกค้า
  document.addEventListener('DOMContentLoaded', function() {
    const customerCodeInput = document.getElementById('customerCode');
    if (customerCodeInput) {
      customerCodeInput.addEventListener('input', function() {
        const customerNo = this.value.trim();
        if (customerNo) {
          loadCompanyDataByCustomerNo(customerNo);
        } else {
          // ล้างค่า tax_withheld ถ้าไม่มีรหัสลูกค้า
          const taxWithheldInput = document.getElementById('tax_withheld');
          if (taxWithheldInput) {
            taxWithheldInput.value = '';
          }
        }
      });

      // โหลดข้อมูลเมื่อมีการ paste หรือ change event
      customerCodeInput.addEventListener('change', function() {
        const customerNo = this.value.trim();
        if (customerNo) {
          loadCompanyDataByCustomerNo(customerNo);
        }
      });
    }

    // Event listener สำหรับการเปลี่ยนแปลง tax_withheld
    $(document).on('input change', '#tax_withheld, #tax_withheld2, #tax_withheld3', function() {
      console.log('tax_withheld changed:', $(this).val());
        
        // อัปเดต checkbox list ที่เกี่ยวข้อง
        if ($(this).attr('id') === 'tax_withheld') {
            updateCheckboxList2();
        } else if ($(this).attr('id') === 'tax_withheld2') {
            updateCheckboxList3();
        } else if ($(this).attr('id') === 'tax_withheld3') {
            updateCheckboxList4();
        }
        
      // คำนวณใหม่เมื่อมีการเปลี่ยนแปลงค่า tax_withheld (ใน popup)
      isPopupCalculation = true;
      calculateTotalSummary();
      isPopupCalculation = false;
    });
  });

  // Event listener สำหรับการแก้ไขรหัสใบสั่งขายโดยตรง
  $(document).ready(function() {
    $('#salesOrderCodeInput').on('input change', function() {
      // เปลี่ยนสีเป็นดำเมื่อมีค่า
      if ($(this).val()) {
        $(this).css('color', 'black');
      } else {
        $(this).css('color', 'var(--input-text-gray-color200)');
      }
    });
  });

  // Event listener สำหรับการบันทึกค่า vat_no ลง localStorage
  $(document).ready(function() {
    $('#vat_no').on('input change', function() {
      localStorage.setItem('vat_no', $(this).val());
      // อัปเดตเลขประจำตัวผู้เสียภาษีใน dropdown
      updateTaxIdDropdown($(this).val());
    });
    
    // Event listener สำหรับการเปลี่ยนแปลงค่าใน dropdown เลขประจำตัวผู้เสียภาษี
    $('#taxIdDropdown').on('change', function() {
      const selectedVatNo = $(this).val();
      localStorage.setItem('vat_no', selectedVatNo);
      
      // อัปเดต cus_detail ใน localStorage ถ้ามีข้อมูลอยู่แล้ว
      const quotationData = localStorage.getItem('quotationData');
      if (quotationData) {
        try {
          const data = JSON.parse(quotationData);
          if (data.cus_detail) {
            data.cus_detail.vat_no = selectedVatNo;
            localStorage.setItem('quotationData', JSON.stringify(data));
          }
        } catch (error) {
          console.log('Error updating cus_detail in localStorage:', error);
        }
      }
    });
  });

  // Event listener สำหรับการบันทึกค่า type_business ลง localStorage
  $(document).ready(function() {
    $('#type_business').on('input change', function() {
      localStorage.setItem('type_business', $(this).val());
      // อัปเดตประเภทธุรกิจ/คำนำหน้าใน dropdown
      updateBusinessTypeDropdown($(this).val());
    });
    
    // Event listener สำหรับการเปลี่ยนแปลงค่าใน dropdown ประเภทธุรกิจ/คำนำหน้า
    $('#businessTypeDropdown').on('change', function() {
      const selectedValue = $(this).val();
      const selectedText = $(this).find('option:selected').text();
      
      // เก็บทั้ง value และ text ที่เลือกไว้
      const selectedTypeBusiness = selectedText || selectedValue;
      
      localStorage.setItem('type_business', selectedTypeBusiness);
      
      // อัปเดต cus_detail ใน localStorage ถ้ามีข้อมูลอยู่แล้ว
      const quotationData = localStorage.getItem('quotationData');
      if (quotationData) {
        try {
          const data = JSON.parse(quotationData);
          if (data.cus_detail) {
            data.cus_detail.type_business = selectedTypeBusiness;
            localStorage.setItem('quotationData', JSON.stringify(data));
          }
        } catch (error) {
          console.log('Error updating cus_detail type_business in localStorage:', error);
        }
      }
      
      console.log('Selected business type:', selectedTypeBusiness);
    });
    
    // Event listener สำหรับการเปลี่ยนแปลงค่าใน dropdown แผนก
    $('#departmentDropdown').on('change', function() {
      const selectedValue = $(this).val();
      const selectedText = $(this).find('option:selected').text();
      
      // เก็บทั้ง value และ text ที่เลือกไว้
      const selectedTypeDepartmen = selectedText || selectedValue;
      
      localStorage.setItem('type_department', selectedTypeDepartmen);
      
      // อัปเดต cus_detail ใน localStorage ถ้ามีข้อมูลอยู่แล้ว
      const quotationData = localStorage.getItem('quotationData');
      if (quotationData) {
        try {
          const data = JSON.parse(quotationData);
          if (data.cus_detail) {
            data.cus_detail.type_department = selectedTypeDepartmen;
            localStorage.setItem('quotationData', JSON.stringify(data));
          }
        } catch (error) {
          console.log('Error updating cus_detail type_department in localStorage:', error);
        }
      }
      
      console.log('Selected department:', selectedTypeDepartmen);
    });
    
    // Event listener สำหรับการเปลี่ยนแปลงค่าใน dropdown ยื่นภาษีรวมในงวดที่
    $('#taxPeriodDropdown').on('change', function() {
      const selectedValue = $(this).val();
      const selectedText = $(this).find('option:selected').text();
      
      // เก็บทั้ง value และ text ที่เลือกไว้
      const selectedTaxPeriod = selectedText || selectedValue;
      
      localStorage.setItem('tax_period', selectedTaxPeriod);
      
      // อัปเดต cus_detail ใน localStorage ถ้ามีข้อมูลอยู่แล้ว
      const quotationData = localStorage.getItem('quotationData');
      if (quotationData) {
        try {
          const data = JSON.parse(quotationData);
          if (data.cus_detail) {
            data.cus_detail.tax_period = selectedTaxPeriod;
            localStorage.setItem('quotationData', JSON.stringify(data));
          }
        } catch (error) {
          console.log('Error updating cus_detail tax_period in localStorage:', error);
        }
      }
      
      console.log('Selected tax period:', selectedTaxPeriod);
    });
    
    // Event listener สำหรับการเปลี่ยนแปลงค่าในช่องวันที่
    $('#taxDate').on('change', function() {
      const selectedTaxDate = $(this).val();
      
      localStorage.setItem('tax_date', selectedTaxDate);
      
      // อัปเดต cus_detail ใน localStorage ถ้ามีข้อมูลอยู่แล้ว
      const quotationData = localStorage.getItem('quotationData');
      if (quotationData) {
        try {
          const data = JSON.parse(quotationData);
          if (data.cus_detail) {
            data.cus_detail.tax_date = selectedTaxDate;
            localStorage.setItem('quotationData', JSON.stringify(data));
          }
        } catch (error) {
          console.log('Error updating cus_detail tax_date in localStorage:', error);
        }
      }
      
      console.log('Selected tax date:', selectedTaxDate);
    });
    
    // Event listener สำหรับการเปลี่ยนแปลงค่าในช่องเลขใบกำกับภาษี
    $('#taxInvoiceNo').on('input', function() {
      const taxInvoiceNo = $(this).val();
      
      localStorage.setItem('tax_invoice_no', taxInvoiceNo);
      
      // อัปเดต cus_detail ใน localStorage ถ้ามีข้อมูลอยู่แล้ว
      const quotationData = localStorage.getItem('quotationData');
      if (quotationData) {
        try {
          const data = JSON.parse(quotationData);
          if (data.cus_detail) {
            data.cus_detail.tax_invoice_no = taxInvoiceNo;
            localStorage.setItem('quotationData', JSON.stringify(data));
          }
        } catch (error) {
          console.log('Error updating cus_detail tax_invoice_no in localStorage:', error);
        }
      }
      
      console.log('Tax invoice number:', taxInvoiceNo);
    });
  });

  // Event listeners สำหรับฟิลด์ธนาคาร
  $(document).ready(function() {
    // Event listener สำหรับจำนวนเงินรับชำระ (ธนาคาร)
    $('#bankPaymentAmount').on('input change', function() {
      updatePaymentDetailInLocalStorage('bank_payment_amount', $(this).val());
    });
    
    // Event listener สำหรับชื่อธนาคาร
    $('#bankDropdown').on('change', function() {
      updatePaymentDetailInLocalStorage('bank_name', $(this).val());
    });
    
    // Event listener สำหรับเลขบัญชี
    $('#bankAccountNumber').on('input change', function() {
      updatePaymentDetailInLocalStorage('bank_account_number', $(this).val());
    });
    
    // Event listener สำหรับวันที่ชำระ (ธนาคาร)
    $('#bankPaymentDate').on('change', function() {
      updatePaymentDetailInLocalStorage('bank_payment_date', $(this).val());
      if ($(this).val()) {
        $(this).css('color', 'black');
      } else {
        $(this).css('color', 'var(--input-text-gray-color200)');
      }
    });
    
    // Event listener สำหรับเวลา (ธนาคาร)
    $('#bankPaymentTime').on('change', function() {
      updatePaymentDetailInLocalStorage('bank_payment_time', $(this).val());
      if ($(this).val()) {
        $(this).css('color', 'black');
      } else {
        $(this).css('color', 'var(--input-text-gray-color200)');
      }
    });
    
    // Event listener สำหรับวันที่ตัดเงินมัดจำ
    $('#depositCutDate').on('change', function() {
      updatePaymentDetailInLocalStorage('deposit_cut_date', $(this).val());
      if ($(this).val()) {
        $(this).css('color', 'black');
      } else {
        $(this).css('color', 'var(--input-text-gray-color200)');
      }
    });
  });

  // ฟังก์ชันอัปเดต payment_detail ใน localStorage
  function updatePaymentDetailInLocalStorage(key, value) {
    const quotationData = localStorage.getItem('quotationData');
    if (quotationData) {
      try {
        const data = JSON.parse(quotationData);
        if (data.payment_detail) {
          let paymentDetail;
          if (typeof data.payment_detail === 'string') {
            paymentDetail = JSON.parse(data.payment_detail);
          } else {
            paymentDetail = data.payment_detail;
          }
          paymentDetail[key] = value;
          data.payment_detail = JSON.stringify(paymentDetail);
          localStorage.setItem('quotationData', JSON.stringify(data));
        }
      } catch (error) {
        console.log('Error updating payment_detail in localStorage:', error);
      }
    }
  }

  // ฟังก์ชันดึงหน้าปัจจุบันที่ active
  function getCurrentActivePage() {
    if ($('#page1').hasClass('active')) {
      return 'page1'; // เงินสด
    } else if ($('#page2').hasClass('active')) {
      return 'page2'; // ธนาคาร
    }
    return 'page1'; // ค่าเริ่มต้น
  }

  // ฟังก์ชันอัปเดตวิธีการชำระเงินใน payment_detail
  function updatePaymentMethodInLocalStorage(selectedPageId) {
    const quotationData = localStorage.getItem('quotationData');
    if (quotationData) {
      try {
        const data = JSON.parse(quotationData);
        if (data.payment_detail) {
          let paymentDetail;
          if (typeof data.payment_detail === 'string') {
            paymentDetail = JSON.parse(data.payment_detail);
          } else {
            paymentDetail = data.payment_detail;
          }
          
          paymentDetail.selected_payment_method = selectedPageId;
          data.payment_detail = JSON.stringify(paymentDetail);
          localStorage.setItem('quotationData', JSON.stringify(data));
          
          console.log('อัปเดตวิธีการชำระเงินใน payment_detail:', selectedPageId);
        }
      } catch (error) {
        console.log('Error updating payment method in payment_detail:', error);
      }
    }
  }

  // ฟังก์ชันอัปเดต payment_summary ใน payment_detail
  function updatePaymentDetailSummary() {
    const quotationData = localStorage.getItem('quotationData');
    if (quotationData) {
      try {
        const data = JSON.parse(quotationData);
        if (data.payment_detail) {
          let paymentDetail;
          if (typeof data.payment_detail === 'string') {
            paymentDetail = JSON.parse(data.payment_detail);
          } else {
            paymentDetail = data.payment_detail;
          }
          
          // อัปเดตข้อมูลสรุปการชำระเงิน
          paymentDetail.payment_summary = {
            total_with_tax: $('#cut-total').text().replace(/,/g, '') || '0', //มูลค่ารวมภาษี
            withholding_tax: $('#cut-vat').text().replace(/,/g, '') || '0', //ภาษีถูกหัก ณ ที่จ่าย
            remaining_amount: $('#cut-remaining').text().replace(/,/g, '') || '0', //ยอดคงค้าง
            paid_amount: $('#cut-paid').text().replace(/,/g, '') || '0', //ยอดที่ตัดไปแล้ว
            total_payment: $('#cut-total-sum').text().replace(/,/g, '') || '0' //ชำระรวมทั้งสิ้น
          };
          
          // อัปเดตวันที่รับชำระครบ
          paymentDetail.deposit_due_date = $('#customerDayfully').val() || '';
          
          data.payment_detail = JSON.stringify(paymentDetail);
          localStorage.setItem('quotationData', JSON.stringify(data));
          
          console.log(' อัปเดต payment_summary ใน payment_detail เรียบร้อยแล้ว');
        }
      } catch (error) {
        console.log('Error updating payment_summary in payment_detail:', error);
      }
    }
  }

  // Event listener สำหรับการแก้ไขข้อมูลเครดิตจากประวัติชำระเงินโดยตรง
  $(document).ready(function() {
    $('#customerCredithistory').on('input change', function() {
      // เปลี่ยนสีเป็นดำเมื่อมีค่า
      if ($(this).val()) {
        $(this).css('color', 'black');
      } else {
        $(this).css('color', 'var(--input-text-gray-color200)');
      }
    });
  });

  // ฟังก์ชันโหลดสถานะการออกใบกำกับภาษีและตัดมัดจำเรียบร้อยจากฐานข้อมูล
  function loadTaxInvoiceStatusFromDB() {
    const editId = localStorage.getItem('editQuotationId');
    if (editId) {
      // ถ้ามี editId แสดงว่ากำลังแก้ไข ใช้ loadEditData แทน
      return;
    }
    
    // สำหรับการสร้างใหม่ ให้ตรวจสอบจากข้อมูลที่บันทึกไว้ล่าสุด
    // หรือใช้ค่าเริ่มต้น (ไม่เปิดกล่อง)
    $('#toggle-btn-2').prop('checked', false);
    $('#box-2').removeClass('show');
    
    $('#toggleBox').prop('checked', false);
    $('#myBox').removeClass('show');
  }

  // ==================== PAGINATION SCRIPT ====================
  
  // ตัวแปรสำหรับ pagination แรก
  let currentPage1 = 1;
  const itemsPerPage1 = 10;
  let filteredData1 = [];
  
  // ตัวแปรสำหรับ pagination ที่สอง
  let currentPage2 = 1;
  const itemsPerPage2 = 10;
  let filteredData2 = [];

  // ฟังก์ชันสำหรับแสดง pagination แรก
  function displayPagination1() {
    const totalPages = Math.ceil(filteredData1.length / itemsPerPage1);
    
    // ซ่อน pagination เมื่อมีข้อมูลไม่ถึง 11 รายการ
    if (filteredData1.length <= 10) {
      $('#paginationBox1').hide();
      return;
    }
    
    $('#paginationBox1').show();
    
    // อัปเดตข้อมูลหน้า
    $('#pageInfo1').text(`${currentPage1} of ${totalPages} pages`);

    // สร้างปุ่ม pagination
    const paginationButtons = $('#paginationButtons1');
    paginationButtons.empty();

    // helper สร้างปุ่มเลขหน้า
    const addBtn = (i) => {
      const buttonClass = i === currentPage1 ? 'active' : '';
      paginationButtons.append(`<a class="num-btn ${buttonClass}" href="#" data-page="${i}">${i}</a>`);
    };

    const addDots = () => paginationButtons.append('<span class="dots">...</span>');

    // เลือกเลขที่จะโชว์ 3 ตัว + ... + กล่องค้นหา
    let pagesToShow = [];
    if (totalPages <= 3) {
      for (let i = 1; i <= totalPages; i++) pagesToShow.push(i);
    } else if (currentPage1 <= 2) {
      pagesToShow = [1, 2, 3];
    } else if (currentPage1 >= totalPages - 1) {
      pagesToShow = [Math.max(1, totalPages - 2), totalPages - 1, totalPages];
    } else {
      pagesToShow = [currentPage1 - 1, currentPage1, currentPage1 + 1];
    }

    // ใส่เลข 3 ตัว
    pagesToShow.forEach(addBtn);

    // ถ้าหน้ามากกว่า 3 และยังมีหน้าที่ซ่อนไว้ด้านขวา ค่อยใส่ "..."
    if (totalPages > 3) addDots();
    
    // กล่องค้นหาหน้า
    const jumpHtml = `
      <div class="page-jump-wrap">
        <input
          type="text"
          inputmode="numeric"
          pattern="[0-9]*"
          class="page-jump"
          id="pageJump1"
          placeholder="${totalPages}"
          aria-label="ไปหน้าที่..."
        />
      </div>`;
    paginationButtons.append(jumpHtml);

    // events ปุ่มเลข
    $('.pagination a.num-btn').off('click').on('click', function (e) {
      e.preventDefault();
      const page = parseInt($(this).data('page'));
      goToPage1(page);
    });

    // events กล่องค้นหา
    (function attachJumpHandlers1() {
      const commit = () => {
        const last = totalPages;
        let v = parseInt($('#pageJump1').val(), 10);
        if (isNaN(v)) v = last;
        v = Math.max(1, Math.min(last, v));
        goToPage1(v);
      };
      $('#pageJump1')
        .off('keydown.jump blur.jump')
        .on('keydown.jump', function (e) { if (e.key === 'Enter') commit(); })
        .on('blur.jump', commit);
    })();
        
    // อัปเดตสถานะปุ่มนำทาง
    $('#btnPrev1').show().toggleClass('disabled', currentPage1 === 1);
    $('#btnNext1').show().toggleClass('disabled', currentPage1 === totalPages);
  }

  // ฟังก์ชันสำหรับแสดง pagination ที่สอง
  function displayPagination2() {
    const totalPages = Math.ceil(filteredData2.length / itemsPerPage2);
    
    // ซ่อน pagination เมื่อมีข้อมูลไม่ถึง 11 รายการ
    if (filteredData2.length <= 10) {
      $('#paginationBox2').hide();
      return;
    }
    
    $('#paginationBox2').show();
    
    // อัปเดตข้อมูลหน้า
    $('#pageInfo2').text(`${currentPage2} of ${totalPages} pages`);

    // สร้างปุ่ม pagination
    const paginationButtons = $('#paginationButtons2');
    paginationButtons.empty();

    // helper สร้างปุ่มเลขหน้า
    const addBtn = (i) => {
      const buttonClass = i === currentPage2 ? 'active' : '';
      paginationButtons.append(`<a class="num-btn ${buttonClass}" href="#" data-page="${i}">${i}</a>`);
    };

    const addDots = () => paginationButtons.append('<span class="dots">...</span>');

    // เลือกเลขที่จะโชว์ 3 ตัว + ... + กล่องค้นหา
    let pagesToShow = [];
    if (totalPages <= 3) {
      for (let i = 1; i <= totalPages; i++) pagesToShow.push(i);
    } else if (currentPage2 <= 2) {
      pagesToShow = [1, 2, 3];
    } else if (currentPage2 >= totalPages - 1) {
      pagesToShow = [Math.max(1, totalPages - 2), totalPages - 1, totalPages];
    } else {
      pagesToShow = [currentPage2 - 1, currentPage2, currentPage2 + 1];
    }

    // ใส่เลข 3 ตัว
    pagesToShow.forEach(addBtn);

    // ถ้าหน้ามากกว่า 3 และยังมีหน้าที่ซ่อนไว้ด้านขวา ค่อยใส่ "..."
    if (totalPages > 3) addDots();
    
    // กล่องค้นหาหน้า
    const jumpHtml = `
      <div class="page-jump-wrap">
        <input
          type="text"
          inputmode="numeric"
          pattern="[0-9]*"
          class="page-jump"
          id="pageJump2"
          placeholder="${totalPages}"
          aria-label="ไปหน้าที่..."
        />
      </div>`;
    paginationButtons.append(jumpHtml);

    // events ปุ่มเลข
    $('.pagination a.num-btn').off('click').on('click', function (e) {
      e.preventDefault();
      const page = parseInt($(this).data('page'));
      goToPage2(page);
    });

    // events กล่องค้นหา
    (function attachJumpHandlers2() {
      const commit = () => {
        const last = totalPages;
        let v = parseInt($('#pageJump2').val(), 10);
        if (isNaN(v)) v = last;
        v = Math.max(1, Math.min(last, v));
        goToPage2(v);
      };
      $('#pageJump2')
        .off('keydown.jump blur.jump')
        .on('keydown.jump', function (e) { if (e.key === 'Enter') commit(); })
        .on('blur.jump', commit);
    })();
        
    // อัปเดตสถานะปุ่มนำทาง
    $('#btnPrev2').show().toggleClass('disabled', currentPage2 === 1);
    $('#btnNext2').show().toggleClass('disabled', currentPage2 === totalPages);
  }

  // ฟังก์ชันสำหรับเปลี่ยนหน้า pagination แรก
  function goToPage1(page) {
    currentPage1 = page;
    // เรียกใช้ฟังก์ชันแสดงข้อมูลสำหรับ pagination แรก
    displayData1();
  }

  // ฟังก์ชันสำหรับเปลี่ยนหน้า pagination ที่สอง
  function goToPage2(page) {
    currentPage2 = page;
    // เรียกใช้ฟังก์ชันแสดงข้อมูลสำหรับ pagination ที่สอง
    displayData2();
  }

  // ฟังก์ชันสำหรับแสดงข้อมูล pagination แรก
  function displayData1() {
    // ถ้าไม่มีข้อมูลให้ซ่อน pagination และล้างตาราง
    if (filteredData1.length === 0) {
      $('#productSearchResults2').empty();
      $('#paginationBox1').hide();
      return;
    }
    
    const startIndex = (currentPage1 - 1) * itemsPerPage1;
    const endIndex = startIndex + itemsPerPage1;
    const dataToShow = filteredData1.slice(startIndex, endIndex);
    
    // แสดงข้อมูลในตาราง #productSearchResults2
    const container = $('#productSearchResults2');
    container.empty();
    
    dataToShow.forEach((item, index) => {
      const actualIndex = startIndex + index + 1;
      const row = `
        <div class="data-search-long" data-product-id="${item.id || ''}" data-product-code="${item.tx || ''}">
          <div class="number-search">${actualIndex}</div>
          <div class="code-search">${item.tx || '-'}</div>
          <div class="name-search-long">${item.cus_name || '-'}</div>
          <div class="price-search-long">${item.net_amount || '-'}</div>
          <div class="eye-container"><img src="picture/eye.png" class="eye-search"></div>
        </div>
      `;
      container.append(row);
    });
    
    // เพิ่ม event listener สำหรับการคลิกเลือกใน productSearchResults2 หลังจากแสดงข้อมูลใหม่
    const newSearchItems = $('#productSearchResults2').find('.data-search-long');
    setupRowSelection2(newSearchItems);
    
    // แสดง pagination เฉพาะเมื่อมีข้อมูลเกิน 10 รายการ
    if (filteredData1.length > 10) {
      displayPagination1();
    } else {
      $('#paginationBox1').hide();
    }
  }

  // ฟังก์ชันสำหรับแสดงข้อมูล pagination ที่สอง
  function displayData2() {
    // ถ้าไม่มีข้อมูลให้ซ่อน pagination
    if (filteredData2.length === 0) {
        $('#productSearchResults').empty();
      $('#paginationBox2').hide();
      return;
    }
    
    const startIndex = (currentPage2 - 1) * itemsPerPage2;
    const endIndex = startIndex + itemsPerPage2;
    const dataToShow = filteredData2.slice(startIndex, endIndex);

    // แสดงข้อมูลในตาราง #productSearchResults
    const container = $('#productSearchResults');
    container.empty();

    dataToShow.forEach((item, index) => {
      const actualIndex = startIndex + index + 1;
      const row = `
        <div class="data-search-long" data-product-id="${item.id || ''}" data-product-code="${item.tx || ''}">
          <div class="number-search">${actualIndex}</div>
          <div class="code-search">${item.tx || '-'}</div>
          <div class="name-search-long">${item.cus_name || '-'}</div>
          <div class="price-search-long">${item.net_amount || '-'}</div>
          <div class="eye-container"><img src="picture/eye.png" class="eye-search"></div>
        </div>
      `;
      container.append(row);
    });
    
    // แสดง pagination เฉพาะเมื่อมีข้อมูลเกิน 10 รายการ
    if (filteredData2.length > 10) {
      displayPagination2();
    } else {
      $('#paginationBox2').hide();
    }
  }

  // Event listener สำหรับปุ่มนำทาง pagination แรก
  $('#btnPrev1').on('click', function() {
    if (currentPage1 > 1) {
      goToPage1(currentPage1 - 1);
    }
  });

  $('#btnNext1').on('click', function() {
    const totalPages = Math.ceil(filteredData1.length / itemsPerPage1);
    if (currentPage1 < totalPages) {
      goToPage1(currentPage1 + 1);
    }
  });

  // Event listener สำหรับปุ่มนำทาง pagination ที่สอง
  $('#btnPrev2').on('click', function() {
    if (currentPage2 > 1) {
      goToPage2(currentPage2 - 1);
    }
  });

  $('#btnNext2').on('click', function() {
    const totalPages = Math.ceil(filteredData2.length / itemsPerPage2);
    if (currentPage2 < totalPages) {
      goToPage2(currentPage2 + 1);
    }
  });

  // ฟังก์ชันสำหรับตั้งค่า pagination แรก (เรียกใช้เมื่อมีข้อมูล)
  function setupPagination1(data) {
    filteredData1 = data || [];
    currentPage1 = 1;
    
    // ถ้าไม่มีข้อมูลให้ซ่อน pagination
    if (filteredData1.length === 0) {
      $('#paginationBox1').hide();
      return;
    }
    
    displayPagination1();
    displayData1();
  }

  // ฟังก์ชันสำหรับตั้งค่า pagination ที่สอง (เรียกใช้เมื่อมีข้อมูล)
  function setupPagination2(data) {
    filteredData2 = data || [];
    currentPage2 = 1;
    
    // ถ้าไม่มีข้อมูลให้ซ่อน pagination
    if (filteredData2.length === 0) {
      $('#paginationBox2').hide();
      return;
    }
    
    displayPagination2();
    displayData2();
  }
  
</script>
</body>

</html>