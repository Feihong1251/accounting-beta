<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ใบเสนอราคา</title>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Thai:wght@100;200;300;400;500;600;700&family=Noto+Sans+Thai:wght@100..900&family=Open+Sans:ital,wght@0,300..800;1,300..800&display=swap"
        rel="sty    lesheet">
    <!-- Option 1: Include in HTML -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.3.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="main.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<style>
@page { size: A4; margin: 10mm; } 
* { box-sizing: border-box; }

@media print {
body { margin: 0; padding: 0; background: transparent !important; }
.a4-sheet { width: 190mm; min-height: 277mm; margin: 0 auto; }
table { margin-left: auto; margin-right: auto; }
}

@media screen {
.a4-sheet { width: 210mm; min-height: 297mm; margin: 0 auto; }
}
</style>
<body>
    <div class="head-box"> <!--กล่องใหญ่-->
        <div id="sidemenuacc"></div>
        <div class="main-project"><!--กล่อง main-->
            <div class="navbar">
                <div style="width: 100%;height: 100%; padding: 24px;">
                    <div style=" width: 100%; height: 100%;display: flex;justify-content: space-between; ">
                        <div style="width: 502px; height: 40px; padding: 6.5px 0;">
                            <div class="nav-menu">
                                <div style="background-color: #FFFFFF; display: flex;width: 350px; border-radius: 32px;height: 100%;display: flex;align-items: center;justify-content: center; gap: 8px;">
                                <div class="text-nav">หน้าหลัก</div>
                                <img src="picture/arrow-right-nav.png" style="width: 12px;height: 12px;">
                                <div class="text-nav">ขาย</div>
                                <img src="picture/arrow-right-nav.png" style="width: 12px;height: 12px;">
                                <div class="text-nav">ใบเสนอราคา</div>
                                <img src="picture/arrow-right-nav.png" style="width: 12px;height: 12px;">
                                <div class="text-nav">สร้างใบเสนอราคา</div>
                                </div>
                                <div style="width: 135px;display: flex;justify-content: center;align-items: center;">
                                    <div style="color: #FFFFFF; font-weight: 700; font-size: 14px;" id="headerDocumentNumber"></div>
                                </div>
                            </div>
                        </div>
                        <div style=" width: 30%; height: 100%; display: flex; justify-content: end; gap: 8px;">
                            <div class="nav-pic-right" id="printf" onclick="goToPaperDepositReceipt()"><img src="picture/print.png"  class="nav-pic"></div>
                            <div class="nav-pic-right" id="download" onclick="downloadQuotationPDF()"><img src="picture/upload.png"  class="nav-pic"></div>
                            <div class="nav-pic-right"><img src="picture/send.png"  class="nav-pic"></div>
                        </div>
                    </div>
                    
                </div>
            </div>
            <div class="head-work">
                <div class="deposit-receipt-box">
                    <div class="deposit-receipt-head-box">
                        <div class="deposit-receipt-head-box-title" id="quotationTitle">ใบเสนอราคา</div>
                        <div class="deposit-receipt-head-box-title" id="historyTitle" style="display: none;"></div>
                        <div class="deposit-receipt-head-box-title"  id="approveTitle">อนุมัติใบเสนอราคา</div>
                        <div class="deposit-receipt-box-mini">
                            <div class="deposit-receipt-box-mini-in">
                                <div class="deposit-receipt-box-mini-deposit">เลขที่ใบเสนอราคา</div>
                                <div class="deposit-receipt-box-mini-number"  id="customerDepositReceiptNumberDisplay"></div>
                            </div>
                            <div class="deposit-receipt-box-mini-in-back">
                                <div class="deposit-receipt-box-mini-deposit-in">มูลค่าสุทธิ (บาท)</div>
                                <div class="deposit-receipt-box-mini-number-in" id="product-totalAll-2">46,117.00</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="container">
                    <div class="tabs-2">
                        <input type="radio" id="radio-1" name="tabs" checked />
                        <label class="tab-2" for="radio-1">ข้อมูลเอกสาร<span></span></label>
                        <input type="radio" id="radio-2" name="tabs" />
                        <label class="tab-2" for="radio-2">ข้อมูลประวัติ</label>
                        <span class="glider-2"></span>
                    </div>
                    <!--ข้อมูลเอกสาร-->
                    <div id="pagepreview1" class="tab-content-new active">
                        <div class="head-second">
                            <div class="head-second-box">
                                <div class="second-box-in">
                                    <div class="document-title">ข้อมูลลูกค้า</div>
                                    <div class="data-box">
                                        <div class="data-box-1">
                                            <div class="data-customer-box">
                                                <div class="text-thin">ชื่อลูกค้า</div>
                                                <div class="text-bold" id="customerNameDisplay"><!-- ลูกค้าทดสอบ1 --></div>
                                            </div>
                                            <div class="address-customer-box">
                                                <div class="text-thin">ที่อยู่ลูกค้า</div>
                                                <div class="text-bold" id="customerAddressDisplay" ><!-- 90 อาคารซีดับเบิ้ลยู ทาวเวอร์ ชั้น 3 ห้อง 310 ถนนรัชดาภิเษก แขวงห้วยขวาง เขตห้วยขวาง กรุงเทพมหานคร 10310 --></div>
                                            </div>
                                            <div class="email-customer-box">
                                                <div class="text-thin">อีเมล</div>
                                                <div class="text-bold" id="customerGmailDisplay"><!-- Test_customer@test.co.th1 --></div>
                                            </div>
                                            <div class="office-customer-box">
                                                <div class="text-thin">สำนักงาน / สาขา</div>
                                                <div class="office-customer-two-box">
                                                <div class="text-bold" id="customernameoffice"><!-- สาขาย่อย: --></div>
                                                <div class="text-bold" id="customerBranchCodeDisplay"><!-- nt1234 --></div>
                                                <div class="text-bold" id="customerBranchNameDisplay"></div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="cover-data-box-2-3">
                                            <div class="data-box-2">
                                                <div class="password-customer-box">
                                                    <div class="text-thin">รหัสลูกค้า</div>
                                                    <div class="text-bold" id="customerCodeDisplay"><!-- BB-0000000000 --></div>
                                                </div>
                                                <div class="address-office-box">
                                                    <div class="text-thin">ที่ตั้งธุรกิจ</div>
                                                    <div class="text-bold" id="customerHeadOfficeDisplay"><!-- ไทย --></div>
                                                </div>
                                                <div class="refer-data-box">
                                                    <div class="text-thin">อ้างอิง</div>
                                                    <div class="text-bold" id="customerReferDisplay"><!-- ทดสอบ01 --></div>
                                                </div>
                                            </div>
                                            <div class="data-box-3">
                                                <div class="phone-number-box">
                                                    <div class="text-thin">เบอร์โทร</div>
                                                    <div class="text-bold" id="customerPhoneDisplay"><!-- 02-1234-0000 --></div>
                                                </div>
                                                <div class="contact-customer">
                                                    <div class="text-thin">ชื่อผู้ติดต่อ</div>
                                                    <div class="text-bold" id="customerContactNameDisplay"><!-- ผู้ติดต่อทดสอบ1 --></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="right-box-data">
                                    <div class="document-title">ข้อมูลเอกสาร</div>
                                    <div class="status-box">
                                        <div class="status-thin">สถานะล่าสุด: 19/02/2025 8:00 น.</div>
                                        <div class="status-bold" id="customerStatusDisplay"><!--กำลังทำเรื่องจัดซื้อ--></div>

                                    </div>
                                    <div class="date-box-day">
                                        <div class="text-thin">วันที่</div>
                                        <div class="text-bold" id="customerDayDisplay"><!-- 19/01/2025 --></div>
                                    </div>
                                    <div class="status-box-in">
                                        <div class="status-box-inbox">
                                            <div class="text-thin">ครบกำหนดวันที่</div>
                                            <div class="text-bold" id="customerDayfullyDisplay"><!-- 26/01/2025 --></div>
                                        </div>
                                        <div class="status-box-inbox">
                                            <div class="text-thin">กำหนดยื่น (วัน)</div>
                                            <div class="text-bold" id="customerDueDateDisplay" ><!-- 14 --></div>
                                        </div>
                                    </div>
                                    <div class="status-box-in">
                                        <div class="status-box-inbox">
                                            <div class="text-thin">แผนก</div>
                                            <div class="text-bold" id="customerDepartmentDisplay"><!-- UXUI Designer --></div>
                                        </div>
                                        <div class="status-box-inbox">
                                            <div class="text-thin">พนักงานขาย</div>
                                            <div class="text-bold" id="customerSalespersonDisplay"><!-- พนักงานทดสอบ1 --></div>
                                        </div>
                                    </div>
                                    <div class="status-box-in-last">
                                        <div class="status-box-inbox">
                                            <div class="text-thin">ข้อมูลราคาและภาษี</div>
                                            <div class="text-bold"  id="customerPriceandTaxDisplay"><!-- รวมภาษี --></div>
                                        </div>
                                        <div class="status-box-inbox">
                                            <div class="text-thin">สกุลเงิน</div>
                                            <div class="text-bold" id="customerCurrencyDisplay"><!-- THB - บาท --></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="head-four">
                            <div class="list-bar-box">
                                <div class="list-bar-title">
                                    รายการ
                                </div>
                                <div class="list-bar-text">
                                    บริการ
                                </div>
                                <div class="list-bar-box-in">
                                    <div class="list-bar-data-box">
                                        <div class="list-bar-number">
                                            <div class="order-list-box">
                                                <div class="data5-table">
                                                    <table class="data-table-preview">
                                                        <thead>
                                                            <tr>
                                                                <th>ลำดับ</th>
                                                                <th>รหัส</th>
                                                                <th>ชื่อรายการ</th>
                                                                <th>รายละเอียด</th>
                                                                <th>จำนวน</th>
                                                                <th>หน่วย</th>
                                                                <th>ราคา/หน่วย</th>
                                                                <th>ส่วนลด</th>
                                                                <th>ราคารวม</th>
                                                                <th></th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            <tr class="data-row">
                                                                <td>1</td>
                                                                <td>AA-12340000</td>
                                                                <td>ระบบจัดเก็บข้อมูลลู...</td>
                                                                <td>Software สำหรับจัดเก็บข้อม...</td>
                                                                <td>1</td>
                                                                <td>รายการ</td>
                                                                <td>43,200.00</td>
                                                                <td>100.00</td>
                                                                <td>43,100.00</td>
                                                                <td>
                                                                </td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                </div>
                                                <!-- <div class="pagination">
                                                    <span class="page-info">1 of 5 pages</span>
                                                    <a class="active" href="#">1</a>
                                                    <a href="#">2</a>
                                                    <a href="#">3</a>
                                                    <span class="dots">...</span>
                                                    <a href="#">5</a>
                                                    <a href="#" class="next"><img
                                                            src="picture/subtract-1--button-delete-buttons-subtract-horizontal-remove-line-add-mathematics-math-minus.png"></a>
                                                </div> -->
                                                <div class="pagination">
                                                    <!-- Pagination จะถูกสร้างโดย JavaScript -->
                                                </div>
                                                <div class="amount-money-box-kk">
                                                    <div class="amount-money-box">
                                                        <div class="amount-box-in-one">
                                                            <div class="box-in-amount">
                                                                <div class="tilte-sarup">สรุปมูลค่าสุทธิ</div>
                                                            </div>
                                                            <div class="amount-box-in-text-number">
                                                                <div class="amount-box-in-text">จำนวนเงิน
                                                                </div>
                                                                <div class="amount-money-box-in-number-box">
                                                                    <div class="amount-money-box-in-number" id="product-totalAllProducts">
                                                                        </div>
                                                                    <div class="amount-money-box-in-number-bart">บาท
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div class="amount-box-in-text-number">
                                                                <div class="amount-box-in-text">หักส่วนลด
                                                                </div>
                                                                <div class="amount-money-box-in-number-box">
                                                                    <div class="amount-money-box-in-number" id="product-totalDiscount">
                                                                        </div>
                                                                    <div class="amount-money-box-in-number-bart">บาท
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div class="amount-box-in-text-number">
                                                                <div class="amount-box-in-text">ยอดหลังหักส่วนลด
                                                                </div>
                                                                <div class="amount-money-box-in-number-box">
                                                                    <div class="amount-money-box-in-number" id="product-totalAfterDiscount">
                                                                        </div>
                                                                    <div class="amount-money-box-in-number-bart">บาท
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <div class="amount-money-box-in-tax-seven">
                                                                <div class="checkbox-box-disableb">
                                                                    <div class="checkbox-box-1-force-seven">
                                                                        <input type="checkbox" name="visits"
                                                                            id="list-tax"
                                                                            class="checkbox-input-disableb" checked
                                                                            disabled>
                                                                        <label for="list-tax"></label>
                                                                    </div>
                                                                    <div class="seven-percent-box">
                                                                        <div class="checkbox-box-1-text-seven">
                                                                            รายการภาษี
                                                                        </div>
                                                                        <div class="seven-percent"> 7%</div>
                                                                    </div>
                                                                </div>
                                                                <div class="big-amount-money">
                                                                <div class="amount-money-box-in-tax-number-box">
                                                                    <div class="amount-money-box-in-tax-number" id="product-totalTax">
                                                                        </div>
                                                                    </div>
                                                                    <div class="amount-money-box-in-tax-number-bart">
                                                                        บาท
                                                                    </div>
                                                                </div>
                                                                </div>
                                                            </div>
                                                            <div class="amount-money-box-in-tax-seven">
                                                                <div class="checkbox-box-disableb">
                                                                    <div class="checkbox-box-1-force-seven">
                                                                        <input type="checkbox" name="visits"
                                                                            id="list-tax-2"
                                                                            class="checkbox-input-disableb" disabled>
                                                                        <label for="list-tax-2"></label>
                                                                    </div>
                                                                    <div class="seven-percent-box">
                                                                        <div class="checkbox-box-1-text-seven">
                                                                            ภาษีหัก ณ ที่จ่าย
                                                                        </div>
                                                                        <!-- <div>
                                                                            <select class="right-under-dissible" placeholder="0.0%" id="withholding-tax-rate" disabled>
                                                                                <option value="0.00" selected>0.0%</option>
                                                                                <option value="1.0">1.0%</option>
                                                                                <option value="3.0">3.0%</option>
                                                                                <option value="5.0">5.0%</option>
                                                                            </select>
                                                                        </div> -->
                                                                    </div>
                                                                </div>
                                                                <div class="big-amount-money">
                                                                    <div class="amount-money-box-in-tax-number-box">
                                                                        <div class="amount-money-box-in-tax-number" id="product-withholdingTax">
                                                                            </div>
                                                                        </div>
                                                                        <div class="amount-money-box-in-tax-number-bart">
                                                                            บาท
                                                                        </div>
                                                                </div>
                                                                </div>
                                                                 <div class="sell-all-box">
                                                            <div class="sell-all-box-in-text-number">
                                                                <div class="sell-all-box-in-text">
                                                                    จำนวนเงินรวมทั้งสิ้น</div>
                                                                <div class="sell-all-box-in-box">
                                                                    <div class="sell-all-box-in-number" id="product-totalAll">
                                                                        </div>
                                                                    <div class="sell-all-box-in-number-bart">บาท
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                            </div>
                                                        </div>
                        
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                           
                        <div class="cover-signature">
                            <div class="signature-eltc-box">
                                <div class="signature-eltc-box-in-one">
                                    <div class="checkbox-box-1">
                                        <input type="checkbox" name="visits" id="list-tax-1" class="checkbox-input-1"
                                            disabled>
                                        <label for="list-tax-1"></label>
                                        <div class="checkbox-box-1-text">
                                            ลายเซ็นต์อิเล็กทรอนิกและตารายาง
                                        </div>
                                    </div>
                                    <div class=" footnote-box">
                                        <div class="footnote-text-title">หมายเหตุ</div>
                                        <div class="footnote-text"  id="customerNoteunderDisplay"><!--ฟรีค่าจัดส่ง พร้อมอุปกรณ์ติดตั้ง--></div>
                                    </div>
                                </div>
                                <div class="signature-eltc-box-in-two">
                                    <div class="signature-eltc-box-in-two-in">
                                        <div class="signature-eltc-text-title">ผู้จัดทำ</div>
                                        <div class="signature-eltc-text" id="name-Creator">ธิติรัตน์ สตาปรณ์ศิริ</div>
                                    </div>
                                    <div class="checkbox-container">
                                        <div class="checkbox-item">
                                            <input type="checkbox" name="visits" id="not-show-name"
                                                class="my-checkbox-input">
                                            <label for="not-show-name">ไม่แสดงชื่อผู้จัดทำ</label>
                                        </div>
                                        <div class="checkbox-item">
                                            <input type="checkbox" name="signature" id="signature-option"
                                                class="my-checkbox-input" checked>
                                            <label for="signature-option">ลายเซ็นต์อิเล็กทรอนิก</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="attach-file">
                                <div class="attach-file-text-title">แนบไฟล์</div>
                                <div class="attach-file-box" id="customerFileDisplay">
                                    <!-- ไฟล์จะถูกแสดงที่นี่โดย JavaScript -->
                                </div>
                            </div>
                        </div>
                        <div class="tree-button"><!-- กล่องใหญ่ของ3ปุ่ม -->
                            <div class="cover-box-home-edit-approve">
                                <!-- <div class="Homepage-button" id="btnHome">
                                    <a href="quotation-info.html" c lass="word-Homepage-button">กลับไปหน้าหลัก</a>
                                </div> -->
                                <div class="Homepage-button"  id="goBack" style="display:none;"> <!-- กล่องกลับไปหน้าหลัก -->
                                    <a href="#"  class="word-Homepage-button">กลับไปหน้าหลัก</a>
                                </div>
                                <div class="edit-button" id="btnEdit"> <!-- กล่องแก้ไข -->
                                    <a href="#" onclick="editQuotation()"><div class="word-edit-button">แก้ไข</div></a>
                                </div>
                                <div class="approve-button" id="btnApprove"> <!-- กล่องอนุมัติ -->
                                    <a href="#" onclick="approveQuotation()" class="word-appvrove-button">อนุมัติ</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div> 
                <!--ข้อมูลเอกสาร-->
                <!--ข้อมูลประวัติ-->
                <div id="pagepreview2" class="tab-content-new">
                    <div class="page-three-box">
                        <div class="page-three-box-in">
                            <!-- <ul class="timeline">
                                <li>
                                    <div class="timestamp">
                                        <div class="text-date">27/01/25</div>
                                        <div class="text-time">16:09:12</div>
                                    </div>
                                    <div class="dot-line">
                                        <div class="dot active"></div>
                                        <div class="line"></div>
                                    </div>
                                    <div class="content">
                                        <div class="user-box-in">
                                            <div class="user-title">User test 02</div>
                                            <div class="save-test">อนุมัติใบรับเงินมัดจำ</div>
                                        </div>
                                        <div class="day-box">
                                            <div class="note-text">หมายเหตุ: รอเอกสารเพิ่มเติมจากลูกค้า</div>
                                        </div>
                                    </div>
                                </li>
                                <li>
                                    <div class="timestamp">
                                        <div class="text-date">17/01/25</div>
                                        <div class="text-time">11:09:14</div>
                                    </div>
                                    <div class="dot-line">
                                        <div class="dot"></div>
                                        <div class="line"></div>
                                    </div>
                                    <div class="content">
                                        <div class="user-box-in">
                                            <div class="user-title">User test 01</div>
                                            <div class="save-test">บันทึกใบเสนอราคา</div>
                                        </div>
                                        <div class="day-box">
                                            <div class="note-text">หมายเหตุ: รอเอกสารเพิ่มเติมจากลูกค้า</div>
                                        </div>
                                    </div>
                                </li>
                                <li>
                                    <div class="timestamp">
                                        <div class="text-date">12/01/25</div>
                                        <div class="text-time">10:12:34</div>
                                    </div>
                                    <div class="dot-line">
                                        <div class="dot"></div>
                                        <div class="line"></div>
                                    </div>
                                    <div class="content">
                                        <div class="user-box-in">
                                            <div class="user-title">User test 01</div>
                                            <div class="save-test">ดูเอกสาร</div>
                                        </div>
                                        <div class="day-box">
                                            <div class="note-text">หมายเหตุ: รอเอกสารเพิ่มเติมจากลูกค้า</div>
                                        </div>
                                    </div>
                                </li>
                                <li>
                                    <div class="timestamp">
                                        <div class="text-date">02/01/25</div>
                                        <div class="text-time">10:45:34</div>
                                    </div>
                                    <div class="dot-line">
                                        <div class="dot"></div>
                                    </div>
                                    <div class="content">
                                        <div class="user-box-in">
                                            <div class="user-title">User test 01</div>
                                            <div class="save-test">เริ่มสร้างใบเสนอราคา</div>
                                        </div>
                                    </div>
                                </li>
                            </ul> -->
                            <ul class="timeline" id="quotationTimeline">
                                <!-- Timeline จะถูกสร้างโดย JavaScript -->
                            </ul>
                        </div>
                    </div>
                </div>
                <!--ข้อมูลประวัติ-->
                <!-- ข้อมูลการหักเงินมัดจำ-->
            </div>
        </div>
    </div>
    </div>
    </div>
    <script src="sidebarmain.js"></script>
    <script>
// Global variables
const endpoint = 'http://localhost:3000';

$(document).ready(function () {
    // โหลดข้อมูลใบเสนอราคา
    loadQuotationPreviewData();
    // โหลดข้อมูลสินค้า
    loadProductData();
    // สร้าง timeline
    createQuotationTimeline();
    
    // โหลดและแสดงเวลาสถานะที่บันทึกไว้
    loadStatusTime();
    
    // ตรวจสอบว่ามาจากการแก้ไขหรือไม่
    const urlParams = new URLSearchParams(window.location.search);
    const fromEdit = urlParams.get('fromEdit');
    if (fromEdit === 'true') {
        // ถ้ามาจากการแก้ไข ให้อัปเดต timeline ทันที
        setTimeout(() => {
            createQuotationTimeline();
        }, 1000); // รอ 1 วินาทีเพื่อให้ข้อมูลในฐานข้อมูลอัปเดต
    }
    
    let isApproved = false;

    // ------------------------------
    // ส่วน Tab content
    // ------------------------------
    const $tabRadios = $('input[name="tabs"]');
    const $tabContents = $('.tab-content-new');

    const displaySelectedTabContent = () => {
        const selectedRadioId = $tabRadios.filter(':checked').attr('id');
        const tabNumber = selectedRadioId.split('-')[1];
        const tabIdMap = {
            '1': 'pagepreview1',
            '2': 'pagepreview2'
        };
        $tabContents.removeClass('active');
        $(`#${tabIdMap[tabNumber]}`).addClass('active');
    };

    $tabRadios.on('change', displaySelectedTabContent);
    displaySelectedTabContent();

    // ------------------------------
    // ส่วนหัวข้อ
    // ------------------------------
    $('#quotationTitle').show();
    $('#approveTitle').hide();
    $('#historyTitle').hide();

    $('#radio-1').on('click', function () {
        if (isApproved) {
            $('#quotationTitle').hide();
            $('#historyTitle').hide();
            $('#approveTitle').show();
        } else {
            $('#quotationTitle').show();
            $('#historyTitle').hide();
            $('#approveTitle').hide();
        }
    });

    $('#radio-2').on('click', function () {
        $('#quotationTitle').hide();
        $('#approveTitle').hide();
        $('#historyTitle').text('ประวัติการใช้งานใบเสนอราคา').show();
    });

    $('#btnApprove').on('click', function () {
        isApproved = true;
        $('#btnnone').hide();
        $('#quotationTitle').hide();
        $('#historyTitle').hide();
        $('#approveTitle').show();
    });
});


let totalPages = 5;
function createPagination(current, total) {
    const pagination = $('.pagination');
    pagination.empty();
    const pageInfo = `<span class="page-info">${current} of ${total} pages</span>`;
    pagination.append(pageInfo);
    let pages = [];
    if (current <= 2) {
        pages = [1, 2, 3, '...', 5];
    } else if (current >= 4) {
        pages = [1, '...', 3, 4, 5];
    } else {
        pages = [1, 2, 3, 4, 5];
    }
    pages.forEach(page => {
        if (page === '...') {
            const dots = '<span class="dots">...</span>';
            pagination.append(dots);
        } else {
            const activeClass = page === current ? ' class="active"' : '';
            const link = `<a href="#"${activeClass}>${page}</a>`;
            pagination.append(link);
        }
    });
    const nextBtn = '<a href="#" class="next"><img src="picture/subtract-1--button-delete-buttons-subtract-horizontal-remove-line-add-mathematics-math-minus.png"></a>';
    pagination.append(nextBtn);
}
function changePage(page) {
    currentPage = page;
    createPagination(currentPage, totalPages);
}
$(document).ready(function () {
    $('.pagination').on('click', 'a:not(.next)', function (e) {
        e.preventDefault();
        const pageNum = parseInt($(this).text());
        if (pageNum && pageNum !== currentPage) {
            changePage(pageNum);
        }
    });
    $('.pagination').on('click', '.next', function (e) {
        e.preventDefault();
        if (currentPage < totalPages) {
            changePage(currentPage + 1);
        }
    });
    createPagination(currentPage, totalPages);
});
$(document).ready(function () {
    $('#tableBody .data-row:gt(4)').hide();
});
//อันนี้จะติ้กได้แค่หน้าก่อนอนุมัติ
        $(document).ready(function () {
    function updateSignatureBox() {
        const showSignature = $('#signature-option').is(':checked');
        const showMaker = $('#not-show-name').is(':checked');

        if (showMaker) {
            $('#signature-maker-box').hide();
        } else if (showSignature) {
            $('#signature-maker-box').show();
        } else {
            $('#signature-maker-box').hide();
        }
    }

    // ตั้งค่าตั้งต้น: ให้ติ๊ก "แสดงลายเซ็น"
    $('#signature-option').prop('checked', true);
    $('#not-show-name').prop('checked', false);
    updateSignatureBox();

    $('#not-show-name').on('change', function () {
        if ($(this).is(':checked')) {
            $('#signature-option').prop('checked', false);
        }
        updateSignatureBox();
    });

    $('#signature-option').on('change', function () {
        if ($(this).is(':checked')) {
            $('#not-show-name').prop('checked', false);
        }
        updateSignatureBox();
    });
});
//khaow
    $(document).ready(function() {
    // ซ่อนปุ่ม goBack ตอนโหลดหน้า
    $('#goBack').hide();

    // เมื่อกดปุ่ม อนุมัติ
    $('#btnApprove a').click(function(e) {
        e.preventDefault(); // กันลิงก์ไปหน้าจริง (ถ้าต้องการเปลี่ยนลิงก์แทน ให้แก้ที่นี่)

        // ซ่อน 3 ปุ่มบน
        $('#btnHome, #btnEdit, #btnApprove,btnnone').hide();

        // แสดงปุ่ม goBack
        $('#goBack').show();
    });
});
$(document).ready(function() {
  // ซ่อนข้อความ "อนุมัติใบเสนอราคา" ตอนโหลดหน้า
  $('#approveTitle').hide();

  // เมื่อกดปุ่ม btnApprove
  $('#btnApprove').click(function() {
    $('#quotationTitle').hide();   // ซ่อน "ใบเสนอราคา"
    $('#approveTitle').show();     // แสดง "อนุมัติใบเสนอราคา"
  });
})
$('#goBack').click(function () {
      localStorage.setItem('hasData', 'true'); // ตั้งให้แสดงข้อมูลเมื่อย้อนกลับ
      window.location.href = 'quotation-info.html'; // กลับไปหน้าแรก
    });
    //
//khaow

// ฟังก์ชันสำหรับสร้าง timeline ประวัติการทำงาน
function createQuotationTimeline() {
    // ดึง ID จาก URL parameter
    const urlParams = new URLSearchParams(window.location.search);
    const quotationId = urlParams.get('id');
    
    if (!quotationId) {
        console.log('No quotation ID found, showing sample timeline');
        createSampleTimeline();
        return;
    }
    
    console.log('Loading timeline data for quotation ID:', quotationId);
    
    // ดึงข้อมูล timeline จากฐานข้อมูล
    $.ajax({
        url: `${endpoint}/api/get_quotation_timeline`,
        method: 'POST',
        dataType: 'json',
        data: {
            id: quotationId,
            com_id: localStorage.getItem('com_id') || 1
        },
        success: function(response) {
            console.log('Timeline API Response:', response);
            if (response.code === 200 && response.result) {
                displayTimelineData(response.result);
            } else {
                console.log('No timeline data found, showing sample timeline');
                createSampleTimeline();
            }
        },
        error: function(xhr, status, error) {
            console.error('Error loading timeline data:', error);
            console.log('Falling back to sample timeline');
            createSampleTimeline();
        }
    });
}

// ฟังก์ชันสำหรับแสดงข้อมูล timeline จากฐานข้อมูล
function displayTimelineData(timelineData) {
    // เรียงลำดับ: อนุมัติอยู่บนสุด, เริ่มสร้างอยู่ล่างสุดเสมอ, บันทึกอยู่ก่อนเริ่มสร้าง, ส่วนอื่นเรียงตามวันที่
    timelineData.sort((a, b) => {
        // ถ้าเป็น approve ให้อยู่บนสุดเสมอ
        if (a.action_type === 'approve' && b.action_type !== 'approve') {
            return -1; // a อยู่ก่อน b
        }
        if (b.action_type === 'approve' && a.action_type !== 'approve') {
            return 1; // b อยู่ก่อน a
        }
        
        // ถ้าเป็น create_start ให้อยู่ล่างสุดเสมอ
        if (a.action_type === 'create_start' && b.action_type !== 'create_start') {
            return 1; // a อยู่หลัง b
        }
        if (b.action_type === 'create_start' && a.action_type !== 'create_start') {
            return -1; // b อยู่หลัง a
        }
        
        // ถ้าเป็น create ให้อยู่ก่อน create_start แต่หลัง save/edit/approve
        if (a.action_type === 'create' && b.action_type !== 'create' && b.action_type !== 'create_start') {
            return 1; // a อยู่หลัง b
        }
        if (b.action_type === 'create' && a.action_type !== 'create' && a.action_type !== 'create_start') {
            return -1; // b อยู่หลัง a
        }
        
        // ถ้าเป็น save ให้อยู่ก่อน create/create_start แต่หลัง edit/approve
        if (a.action_type === 'save' && b.action_type !== 'create' && b.action_type !== 'create_start' && b.action_type !== 'save') {
            return 1; // a อยู่หลัง b
        }
        if (b.action_type === 'save' && a.action_type !== 'create' && a.action_type !== 'create_start' && a.action_type !== 'save') {
            return -1; // b อยู่หลัง a
        }
        
        // ถ้าทั้งคู่เป็น create หรือทั้งคู่ไม่ใช่ create ให้เรียงตามวันที่
        const dateA = new Date(a.created_at || a.updated_at);
        const dateB = new Date(b.created_at || b.updated_at);
        return dateB - dateA; // เรียงจากใหม่ไปเก่า
    });

    // สร้าง HTML สำหรับ timeline
    const timelineContainer = $('#quotationTimeline');
    timelineContainer.empty();

    timelineData.forEach((item, index) => {
        const isLast = index === timelineData.length - 1;
        const isActive = index === 0; // รายการแรก (บนสุด) เท่านั้นที่ active
        const dotClass = isActive ? 'dot active' : 'dot';
        const lineHtml = isLast ? '' : '<div class="line"></div>';
        
        // แปลงวันที่และเวลา
        let dateTime;
        let date, time;
        
        // ใช้เวลาจากฐานข้อมูลสำหรับทุก action
        dateTime = new Date(item.created_at || item.updated_at);
        date = dateTime.toLocaleDateString('th-TH', { 
            day: '2-digit', 
            month: '2-digit', 
            year: '2-digit' 
        });
        time = dateTime.toLocaleTimeString('th-TH', { 
            hour: '2-digit', 
            minute: '2-digit', 
            second: '2-digit' 
        });
        
        // กำหนด action text ตาม type
        let actionText = '';
        if (item.action_type === 'create_start') {
            actionText = 'เริ่มสร้างใบเสนอราคา';
        } else if (item.action_type === 'create') {
            actionText = 'บันทึกใบเสนอราคา';
        } else if (item.action_type === 'save') {
            actionText = 'บันทึกใบเสนอราคา';
        } else if (item.action_type === 'edit') {
            actionText = 'แก้ไขใบเสนอราคา';
        } else if (item.action_type === 'approve') {
            actionText = 'อนุมัติใบเสนอราคา';
        } else {
            actionText = item.action_type || 'ดำเนินการ';
        }
        
        const noteHtml = item.note ? `
            <div class="day-box">
                <div class="note-text">${item.note}</div>
            </div>
        ` : '';

        const timelineItem = `
            <li>
                <div class="timestamp">
                    <div class="text-date">${date}</div>
                    <div class="text-time">${time}</div>
                </div>
                <div class="dot-line">
                    <div class="${dotClass}"></div>
                    ${lineHtml}
                </div>
                <div class="content">
                    <div class="user-box-in">
                        <div class="user-title">${item.user_name || item.created_by || 'Unknown User'}</div>
                        <div class="save-test">${actionText}</div>
                    </div>
                    ${noteHtml}
                </div>
            </li>
        `;
        
        timelineContainer.append(timelineItem);
    });
}

// ฟังก์ชันสำหรับสร้าง timeline ตัวอย่าง (fallback)
function createSampleTimeline() {
    const timelineData = [
        {
            type: 'create',
            date: '02/01/25',
            time: '10:45:34',
            user: 'User test 01',
            action: 'เริ่มสร้างใบเสนอราคา',
            note: ''
        },
        {
            type: 'save',
            date: '02/01/25',
            time: '10:45:34',
            user: 'User test 01',
            action: 'บันทึกใบเสนอราคา',
            note: ''
        },
        {
            type: 'edit',
            date: '12/01/25',
            time: '10:12:34',
            user: 'User test 01',
            action: 'แก้ไข',
            note: 'หมายเหตุ: รอเอกสารเพิ่มเติมจากลูกค้า'
        },
        {
            type: 'edit',
            date: '17/01/25',
            time: '11:09:14',
            user: 'User test 01',
            action: 'แก้ไข',
            note: ''
        },
        {
            type: 'approve',
            date: '27/01/25',
            time: '16:09:12',
            user: 'User test 02',
            action: 'อนุมัติใบรับเงินมัดจำ',
            note: 'หมายเหตุ: รอเอกสารเพิ่มเติมจากลูกค้า'
        }
    ];

    // เรียงลำดับ: อนุมัติอยู่บนสุด, เริ่มสร้างอยู่ล่างสุดเสมอ, บันทึกอยู่ก่อนเริ่มสร้าง, ส่วนอื่นเรียงตามวันที่
    timelineData.sort((a, b) => {
        // ถ้าเป็น approve ให้อยู่บนสุดเสมอ
        if (a.type === 'approve' && b.type !== 'approve') {
            return -1; // a อยู่ก่อน b
        }
        if (b.type === 'approve' && a.type !== 'approve') {
            return 1; // b อยู่ก่อน a
        }
        
        // ถ้าเป็น create ให้อยู่ล่างสุดเสมอ
        if (a.type === 'create' && b.type !== 'create') {
            return 1; // a อยู่หลัง b
        }
        if (b.type === 'create' && a.type !== 'create') {
            return -1; // b อยู่หลัง a
        }
        
        // ถ้าเป็น save ให้อยู่ก่อน create แต่หลัง edit/approve
        if (a.type === 'save' && b.type !== 'create' && b.type !== 'save') {
            return 1; // a อยู่หลัง b
        }
        if (b.type === 'save' && a.type !== 'create' && a.type !== 'save') {
            return -1; // b อยู่หลัง a
        }
        
        // ถ้าทั้งคู่เป็น create หรือทั้งคู่ไม่ใช่ create ให้เรียงตามวันที่
        const dateA = new Date(a.date.split('/').reverse().join('-') + ' ' + a.time);
        const dateB = new Date(b.date.split('/').reverse().join('-') + ' ' + b.time);
        return dateB - dateA; // เรียงจากใหม่ไปเก่า
    });

    // สร้าง HTML สำหรับ timeline
    const timelineContainer = $('#quotationTimeline');
    timelineContainer.empty();

    timelineData.forEach((item, index) => {
        const isLast = index === timelineData.length - 1;
        const isActive = index === 0; // รายการแรก (บนสุด) เท่านั้นที่ active
        const dotClass = isActive ? 'dot active' : 'dot';
        const lineHtml = isLast ? '' : '<div class="line"></div>';
        const noteHtml = item.note ? `
            <div class="day-box">
                <div class="note-text">${item.note}</div>
            </div>
        ` : '';

        // กำหนด action text ตาม type
        let actionText = '';
        if (item.type === 'create') {
            actionText = 'เริ่มสร้างใบเสนอราคา';
        } else if (item.type === 'save') {
            actionText = 'บันทึกใบเสนอราคา';
        } else if (item.type === 'edit') {
            actionText = 'แก้ไขใบเสนอราคา';
        } else if (item.type === 'approve') {
            actionText = 'อนุมัติใบเสนอราคา';
        } else {
            actionText = item.action || 'ดำเนินการ';
        }

        const timelineItem = `
            <li>
                <div class="timestamp">
                    <div class="text-date">${item.date}</div>
                    <div class="text-time">${item.time}</div>
                </div>
                <div class="dot-line">
                    <div class="${dotClass}"></div>
                    ${lineHtml}
                </div>
                <div class="content">
                    <div class="user-box-in">
                        <div class="user-title">${item.user}</div>
                        <div class="save-test">${actionText}</div>
                    </div>
                    ${noteHtml}
                </div>
            </li>
        `;
        
        timelineContainer.append(timelineItem);
    });
}

// ฟังก์ชันสำหรับโหลดข้อมูลสินค้า
function loadProductData() {
    // ดึง ID จาก URL parameter
    const urlParams = new URLSearchParams(window.location.search);
    const quotationId = urlParams.get('id');
    
    if (quotationId) {
        // ถ้ามี ID ใน URL ให้โหลดข้อมูลจากใบเสนอราคา
        console.log('Loading product data from quotation ID:', quotationId);
        
        $.ajax({
            url: `${endpoint}/api/get_quotation_by_id`,
            method: 'POST',
            dataType: 'json',
            data: {
                id: quotationId,
                com_id: localStorage.getItem('com_id') || 1
            },
            success: function(response) {
                console.log('Quotation data API Response:', response);
                if (response.code === 200 && response.result.product_byuser) {
                    // แปลง product_byuser จาก JSON string เป็น array
                    let productData = [];
                    try {
                        if (typeof response.result.product_byuser === 'string') {
                            productData = JSON.parse(response.result.product_byuser);
                        } else if (Array.isArray(response.result.product_byuser)) {
                            productData = response.result.product_byuser;
                        }
                        displayProductData(productData);
                    } catch (e) {
                        console.error('Error parsing product_byuser:', e);
                    }
                } else {
                    console.error('No product data found in quotation');
                }
            },
            error: function(xhr, status, error) {
                console.error('Error loading quotation data:', error);
            }
        });
    } else {
        // ถ้าไม่มี ID ให้แสดงข้อมูลตัวอย่าง
        console.log('No quotation ID found, showing sample data');
    }
}

// ตัวแปรสำหรับ pagination
let allProductData = [];
let currentPage = 1;
let itemsPerPage = 5;

// ฟังก์ชันสำหรับแสดงข้อมูลสินค้าในตาราง (พร้อม pagination)
function displayProductData(products) {
    allProductData = products || [];
    currentPage = 1;
    
    if (!allProductData || allProductData.length === 0) {
        const tbody = $('tbody');
        tbody.empty();
        tbody.html('<tr><td colspan="10" style="text-align: center; color: #999;">ไม่มีข้อมูลสินค้า</td></tr>');
        $('.pagination').hide();
        return;
    }
    
    // แสดงข้อมูลตามหน้า
    displayProductPage();
    
    // แสดง pagination
    updatePagination();
}

// ฟังก์ชันแสดงข้อมูลสินค้าตามหน้าที่เลือก
function displayProductPage() {
    const tbody = $('tbody');
    tbody.empty(); // ล้างข้อมูลเก่า
    
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    const pageData = allProductData.slice(startIndex, endIndex);
    
    pageData.forEach((product, index) => {
        const globalIndex = startIndex + index;
        const row = `
            <tr class="data-row">
                <td>${globalIndex + 1}</td>
                <td>${product.product_code || '-'}</td>
                <td>${product.name || '-'}</td>
                <td>${product.desc_product || '-'}</td>
                <td>${product.qty || 1}</td>
                <td>${product.unit || 'รายการ'}</td>
                <td>${formatCurrency(product.price || 0)}</td>
                <td>${formatCurrency(product.discount || 0)}</td>
                <td>${formatCurrency((product.price || 0) * (product.qty || 1) - (product.discount || 0))}</td>
                <td></td>
            </tr>
        `;
        tbody.append(row);
    });
}

// ฟังก์ชันอัปเดต pagination
function updatePagination() {
    const totalPages = Math.ceil(allProductData.length / itemsPerPage);
    const paginationContainer = $('.pagination');
    
    // ตรวจสอบว่ามีข้อมูลมากกว่า 5 รายการหรือไม่
    if (allProductData.length <= 5) {
        paginationContainer.hide();
        return;
    }
    
    // แสดง pagination container
    paginationContainer.show();
    
    // สร้าง pagination HTML
    let paginationHTML = `<span class="page-info">${currentPage} of ${totalPages} pages</span>`;
    
    // สร้างปุ่ม pagination แบบใหม่
    const paginationButtons = $('<div class="pagination-buttons" style="display: flex; justify-content: center; align-items: center;"></div>');
    
    // helper สร้างปุ่มเลขหน้า
    const addBtn = (i) => {
        const buttonClass = i === currentPage ? 'active' : '';
        const textColor = i === currentPage ? 'color: black;' : 'color: var(--text-color400);';
        paginationButtons.append(`<a class="num-btn ${buttonClass}" style="${textColor}
    text-decoration: none;
    padding: 2px 6px;
    cursor: pointer;" href="#" data-page="${i}">${i}</a>`);
    };
    
    const addDots = () => paginationButtons.append('<span class="dots">...</span>');
    
    // ปุ่ม Previous (แสดงตลอด)
    const prevPage = currentPage > 1 ? currentPage - 1 : 1;
    paginationButtons.append(`<a href="#" class="prev" style="width: 16px; height: 16px; display: flex; justify-content: center; align-items: center;" data-page="${prevPage}"><img src="picture/arrow-left.png" style="width: 16px; height: 16px;"></a>`);
    
    // เลือกเลขที่จะโชว์ 3 ตัว + ... + กล่องค้นหา
    let pagesToShow = [];
    if (totalPages <= 3) {
        for (let i = 1; i <= totalPages; i++) pagesToShow.push(i);
    } else if (currentPage <= 2) {
        pagesToShow = [1, 2, 3];
    } else if (currentPage >= totalPages - 1) {
        pagesToShow = [Math.max(1, totalPages - 2), totalPages - 1, totalPages];
    } else {
        pagesToShow = [currentPage - 1, currentPage, currentPage + 1];
    }
    
    // ใส่เลข 3 ตัว
    pagesToShow.forEach(addBtn);
    
    // ถ้าหน้ามากกว่า 3 และยังมีหน้าที่ซ่อนไว้ด้านขวา ค่อยใส่ "..."
    if (totalPages > 3) addDots();
    
    // กล่องค้นหาหน้า (ค่าในช่องคือหน้าสุดท้าย เริ่มต้นพิมพ์ได้ทันที)
    const jumpHtml = `
        <div class="page-jump-wrap">
            <input
                type="text"
                inputmode="numeric"
                pattern="[0-9]*"
                class="page-jump"
                id="pageJump"
                placeholder="${totalPages}"
                aria-label="ไปหน้าที่..."
            />
        </div>`;
    paginationButtons.append(jumpHtml);
    
    // ปุ่ม Next (แสดงตลอด)
    const nextPage = currentPage < totalPages ? currentPage + 1 : totalPages;
    paginationButtons.append(`<a href="#" class="next" data-page="${nextPage}"><img src="picture/arrow-right.png" style="width: 16px; height: 16px;"></a>`);
    
    // รวม pagination HTML
    paginationHTML += paginationButtons.prop('outerHTML');
    
    // แทนที่เนื้อหาทั้งหมดของ pagination container
    paginationContainer.html(paginationHTML);
    
    // เพิ่ม event listeners สำหรับปุ่ม pagination
    attachPaginationEvents();
}

// ฟังก์ชันเพิ่ม event listeners สำหรับ pagination
function attachPaginationEvents() {
    // events ปุ่มเลข
    $('.pagination a.num-btn').off('click').on('click', function (e) {
        e.preventDefault();
        const page = parseInt($(this).data('page'));
        goToPage(page);
    });
    
    // events ปุ่ม Previous และ Next
    $('.pagination a.prev, .pagination a.next').off('click').on('click', function (e) {
        e.preventDefault();
        const page = parseInt($(this).data('page'));
        goToPage(page);
    });
    
    // events กล่องค้นหา (Enter/blur เพื่อกระโดดหน้า)
    (function attachJumpHandlers() {
        const commit = () => {
            const totalPages = Math.ceil(allProductData.length / itemsPerPage);
            const last = totalPages;
            let v = parseInt($('#pageJump').val(), 10);
            if (isNaN(v)) v = last;
            v = Math.max(1, Math.min(last, v));
            goToPage(v);
        };
        
        $('#pageJump').off('keypress blur').on('keypress blur', function (e) {
            if (e.type === 'keypress' && e.which !== 13) return;
            e.preventDefault();
            commit();
        });
    })();
}

// ฟังก์ชันไปหน้าที่กำหนด
function goToPage(page) {
    const totalPages = Math.ceil(allProductData.length / itemsPerPage);
    if (page >= 1 && page <= totalPages) {
        currentPage = page;
        displayProductPage();
        updatePagination();
    }
}


// ฟังก์ชันสำหรับโหลดและแสดงเวลาสถานะที่บันทึกไว้
function loadStatusTime() {
    // โหลดเวลาสถานะจาก localStorage
    const savedStatusTime = localStorage.getItem('quotationStatusTime');
    const savedStatusValue = localStorage.getItem('quotationStatusValue');
    
    // ถ้ามีเวลาสถานะที่เลือก ให้แสดงเวลานั้น
    // ถ้าไม่มี ให้แสดงเวลาปัจจุบัน
    if (savedStatusTime) {
        $('.status-thin').text(`สถานะล่าสุด: ${savedStatusTime}`);
    } else {
        const now = new Date();
        const timeString = now.toLocaleDateString('th-TH', { 
            day: '2-digit', 
            month: '2-digit', 
            year: '2-digit' 
        }) + ' ' + now.toLocaleTimeString('th-TH', { 
            hour: '2-digit', 
            minute: '2-digit' 
        });
        $('.status-thin').text(`สถานะล่าสุด: ${timeString}`);
    }
    
    if (savedStatusValue) {
        // อัปเดตสถานะที่เลือก
        $('#customerStatusDisplay').text(savedStatusValue);
    }
}

// ฟังก์ชันสำหรับโหลดข้อมูลใบเสนอราคา
function loadQuotationPreviewData() {
    // ดึง ID จาก URL parameter
    const urlParams = new URLSearchParams(window.location.search);
    const quotationId = urlParams.get('id');
    
    // ตรวจสอบว่ามีข้อมูลใน localStorage หรือไม่
    const localQuotationData = localStorage.getItem('quotationData');
    const localQuotationId = localStorage.getItem('quotationId');
    
    if (quotationId) {
        // ถ้ามี ID ใน URL ให้โหลดจากฐานข้อมูล
        console.log('Loading quotation data for ID:', quotationId);
        
        $.ajax({
            url: `${endpoint}/api/get_quotation_by_id`,
            method: 'POST',
            dataType: 'json',
            data: {
                id: quotationId,
                com_id: localStorage.getItem('com_id') || 1
            },
            success: function(response) {
                console.log('Quotation preview API Response:', response);
                if (response.code === 200) {
                    displayQuotationPreviewData(response.result);
                } else {
                    console.error('Error loading quotation data:', response.result);
                    // ถ้าโหลดจาก API ไม่ได้ ให้ลองใช้ข้อมูลจาก localStorage
                    if (localQuotationData) {
                        console.log('Falling back to localStorage data');
                        const parsedData = JSON.parse(localQuotationData);
                        displayQuotationPreviewData(parsedData);
                    } else {
                        alert('ไม่พบข้อมูลใบเสนอราคา');
                    }
                }
            },
            error: function(xhr, status, error) {
                console.error('Error loading quotation data:', error);
                // ถ้าโหลดจาก API ไม่ได้ ให้ลองใช้ข้อมูลจาก localStorage
                if (localQuotationData) {
                    console.log('Falling back to localStorage data due to API error');
                    const parsedData = JSON.parse(localQuotationData);
                    displayQuotationPreviewData(parsedData);
                } else {
                    alert('เกิดข้อผิดพลาดในการโหลดข้อมูล');
                }
            }
        });
    } else if (localQuotationData) {
        // ถ้าไม่มี ID ใน URL แต่มีข้อมูลใน localStorage ให้ใช้ข้อมูลจาก localStorage
        console.log('Loading quotation data from localStorage');
        const parsedData = JSON.parse(localQuotationData);
        displayQuotationPreviewData(parsedData);
    } else {
        console.error('No quotation ID found in URL and no data in localStorage');
        alert('ไม่พบข้อมูลใบเสนอราคา');
    }
}

// ฟังก์ชันสำหรับแสดงข้อมูลใบเสนอราคา
function displayQuotationPreviewData(data) {
    console.log('Displaying quotation data:', data);
    
    // ตรวจสอบว่าข้อมูลมาจาก localStorage หรือไม่
    let cusDetail = {};
    let docDetail = {};
    
    // ถ้าข้อมูลมาจาก localStorage จะมีโครงสร้างที่แตกต่าง
    if (data.cus_detail && typeof data.cus_detail === 'string') {
        try {
            cusDetail = JSON.parse(data.cus_detail);
        } catch (e) {
            console.error('Error parsing cus_detail:', e);
            cusDetail = {};
        }
    } else if (data.cus_detail && typeof data.cus_detail === 'object') {
        cusDetail = data.cus_detail;
    }
    
    if (data.doc_detail && typeof data.doc_detail === 'string') {
        try {
            docDetail = JSON.parse(data.doc_detail);
        } catch (e) {
            console.error('Error parsing doc_detail:', e);
            docDetail = {};
        }
    } else if (data.doc_detail && typeof data.doc_detail === 'object') {
        docDetail = data.doc_detail;
    }
    
    // แสดงข้อมูลพื้นฐาน
    if (data.net_amount) {
        $('.deposit-receipt-box-mini-number-in').text(formatCurrency(data.net_amount));
    }
    
    // แสดงข้อมูลลูกค้า
    if (data.tx) {
        $('#customerDepositReceiptNumberDisplay').text(data.tx);
        $('#headerDocumentNumber').text(data.tx);
    }
    if (data.cus_name) $('#customerNameDisplay').text(data.cus_name);
    if (data.cus_no) $('#customerCodeDisplay').text(data.cus_no);
    
    // แสดงเบอร์โทรศัพท์
    if (cusDetail.cus_phone) {
        let phoneNumber = cusDetail.cus_phone;
        // แปลงเบอร์โทรศัพท์ให้เป็นรูปแบบ 080-870-5488
        if (phoneNumber && phoneNumber.length >= 10) {
            // ลบตัวอักษรที่ไม่ใช่ตัวเลขออก
            let cleanNumber = phoneNumber.replace(/\D/g, '');
            if (cleanNumber.length >= 10) {
                // แปลงเป็นรูปแบบ 080-870-5488
                phoneNumber = cleanNumber.substring(0, 3) + '-' + 
                             cleanNumber.substring(3, 6) + '-' + 
                             cleanNumber.substring(6, 10);
            }
        }
        $('#customerPhoneDisplay').text(phoneNumber);
    }
    
    // แสดงที่อยู่ลูกค้า
    if (cusDetail.cus_addr) {
        $('#customerAddressDisplay').text(cusDetail.cus_addr);
    }
    
    // แสดงที่ตั้งธุรกิจ
    if (cusDetail.cus_business_location) {
        $('#customerHeadOfficeDisplay').text(cusDetail.cus_business_location);
    }
    
    // แสดงชื่อผู้ติดต่อ
    if (cusDetail.cus_contact_name) {
        $('#customerContactNameDisplay').text(cusDetail.cus_contact_name);
    }
    
    // แสดงอีเมล
    if (cusDetail.cus_email) {
        $('#customerGmailDisplay').text(cusDetail.cus_email);
    }
    
    // แสดงอ้างอิง
    if (cusDetail.cus_refer) {
        $('#customerReferDisplay').text(cusDetail.cus_refer);
    }
    
    // แสดงประเภทสำนักงาน
    if (cusDetail.cus_head_office !== undefined) {
        $('#customernameoffice').text(cusDetail.cus_head_office ? 'สำนักงานใหญ่ :' : 'สาขาย่อย :');
    }
    
    // แสดงรหัสสาขา
    if (cusDetail.cus_branch_no) {
        $('#customerBranchCodeDisplay').text(cusDetail.cus_branch_no);
    }
    
    // แสดงชื่อสาขา
    if (cusDetail.cus_branch_name) {
        $('#customerBranchNameDisplay').text(cusDetail.cus_branch_name);
    }

    // แสดงข้อมูลเอกสาร
    if (data.doc_status) {
        let statusText = data.doc_status;
        if (data.doc_status === 'pending') {
            statusText = 'รออนุมัติ';
        } else if (data.doc_status === 'approved') {
            statusText = 'อนุมัติ';
        } else if (data.doc_status === 'rejected') {
            statusText = 'ไม่อนุมัติ';
        }
        $('#customerStatusDisplay').text(data.status);
        
        // จัดการการแสดงปุ่มตามสถานะ
        handleButtonDisplayByStatus(data.doc_status);
    }
    
    // แสดงวันที่เอกสาร
    if (data.doc_date) {
        $('#customerDayDisplay').text(formatDateForDisplay(data.doc_date));
    }
    
    // แสดงวันครบกำหนด
    if (data.due_date) {
        $('#customerDayfullyDisplay').text(formatDateForDisplay(data.due_date));
    }
    
    // แสดงกำหนดยื่น
    if (docDetail.deadline) {
        $('#customerDueDateDisplay').text(docDetail.deadline);
    }
    
    // แสดงแผนก
    if (docDetail.department) {
        $('#customerDepartmentDisplay').text(docDetail.department);
    }
    
    // แสดงพนักงานขาย
    if (docDetail.salesman) {
        $('#customerSalespersonDisplay').text(docDetail.salesman);
    }
    
    // แสดงข้อมูลราคาและภาษี
    if (docDetail.data_price_tax) {
        $('#customerPriceandTaxDisplay').text(docDetail.data_price_tax);
    }
    
    // แสดงสกุลเงิน
    if (docDetail.currency) {
        $('#customerCurrencyDisplay').text(docDetail.currency);
    }
    
    // แสดงหมายเหตุ
    if (data.remark) {
        $('#customerNoteunderDisplay').text(data.remark);
    }
    
    // แสดงไฟล์
    if (data.file && Array.isArray(data.file)) {
        displayFileList(data.file);
    } else if (data.file) {
        // รองรับกรณีที่ file เป็น object เดียว
        $('#customerFileDisplay').text(data.file.name);
    }
    
    // แสดงสถานะ checkbox ลายเซ็นต์อิเล็กทรอนิกและตรายาง
    if (cusDetail.cus_visits === true || cusDetail.cus_visits === 'true') {
        $('#list-tax-1').prop('checked', true);
    } else {
        $('#list-tax-1').prop('checked', false);
    }

    // แสดงข้อมูลราคาและภาษี
    if (data.product_detail) {
        $('#product-totalAllProducts').text(formatCurrency(data.product_detail.product_totalAllProducts));
        $('#product-totalDiscount').text(formatCurrency(data.product_detail.product_totalDiscount));
        $('#product-totalAfterDiscount').text(formatCurrency(data.product_detail.product_totalAfterDiscount));
        $('#product-totalTax').text(formatCurrency(data.product_detail.product_totalTax));
        
        // คำนวณรวม withholdingTax ทั้ง 3 อัน
        const withholdingTax1 = parseFloat(data.product_detail.product_withholdingTax) || 0;
        const withholdingTax2 = parseFloat(data.product_detail.product_withholdingTax2) || 0;
        const withholdingTax3 = parseFloat(data.product_detail.product_withholdingTax3) || 0;
        const totalWithholdingTax = withholdingTax1 + withholdingTax2 + withholdingTax3;
        
        $('#product-withholdingTax').text(formatCurrency(totalWithholdingTax));
        $('#product-totalAll').text(formatCurrency(data.product_detail.product_totalAll));
        $('#product-totalAll-2').text(formatCurrency(data.product_detail.product_totalAll));
        
        // แสดงสถานะ checkbox ภาษีมูลค่าเพิ่ม 7%
        if (data.product_detail.vat7_checked !== undefined) {
            $('#list-tax').prop('checked', data.product_detail.vat7_checked);
            // ควบคุมการแสดง/ซ่อนจำนวนเงินภาษีมูลค่าเพิ่ม 7%
            if (data.product_detail.vat7_checked) {
                $('#product-totalTax').parent().parent().show();
            } else {
                $('#product-totalTax').parent().parent().hide();
            }
        } else {
            // ถ้าไม่มีข้อมูล checkbox ให้ซ่อนจำนวนเงิน
            $('#product-totalTax').parent().parent().hide();
        }
        
        // แสดงสถานะ checkbox ภาษีถูกหัก ณ ที่จ่าย
        if (data.product_detail.withholding_tax_checked !== undefined) {
            $('#list-tax-2').prop('checked', data.product_detail.withholding_tax_checked);
            // ควบคุมการแสดง/ซ่อน dropdown และจำนวนเงิน
            if (data.product_detail.withholding_tax_checked) {
                $('#withholding-tax-rate').parent().show();
                $('#product-withholdingTax').parent().parent().show();
            } else {
                $('#withholding-tax-rate').parent().hide();
                $('#product-withholdingTax').parent().parent().hide();
            }
        } else {
            // ถ้าไม่มีข้อมูล checkbox ให้ซ่อน dropdown และจำนวนเงิน
            $('#withholding-tax-rate').parent().hide();
            $('#product-withholdingTax').parent().parent().hide();
        }
        
        // แสดงอัตราภาษีถูกหัก ณ ที่จ่าย
        if (data.product_detail.withholding_tax_rate) {
            $('#withholding-tax-rate').val(data.product_detail.withholding_tax_rate);
        }
    }

}

// ฟังก์ชันสำหรับแสดงรายการไฟล์
function displayFileList(fileArray) {
    const fileContainer = $('#customerFileDisplay');
    fileContainer.empty();
    
    if (!fileArray || fileArray.length === 0) {
        fileContainer.html('<div style="color: #999; font-style: italic;">ไม่มีไฟล์แนบ</div>');
        return;
    }
    
    fileArray.forEach((file, index) => {
        const fileExtension = getFileExtension(file.new_imge_name);
        const fileSize = formatFileSize(file.size);
        const fileIcon = getFileIcon(fileExtension);
        const fileClass = getFileClass(fileExtension);
        
        const fileHtml = `
            <div class="attach-file-box-${fileClass}">
                <div class="attach-file-box-${fileClass}-img">
                    <img src="picture/${fileIcon}" alt="${fileExtension}" />
                </div>
                <div class="document-${fileClass}">${file.new_imge_name}</div>
                <div class="mb-${fileClass}">(${fileSize})</div>
            </div>
        `;
        
        fileContainer.append(fileHtml);
    });
}

// ฟังก์ชันสำหรับดึงนามสกุลไฟล์
function getFileExtension(filename) {
    return filename.split('.').pop().toLowerCase();
}

// ฟังก์ชันสำหรับจัดรูปแบบขนาดไฟล์
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// ฟังก์ชันสำหรับกำหนดไอคอนไฟล์
function getFileIcon(extension) {
    const iconMap = {
        'pdf': 'file-pdf-fill.png',
        'doc': 'file-word-fill.png',
        'docx': 'file-word-fill.png',
        'jpg': 'file-image-fill.png',
        'jpeg': 'file-image-fill.png',
        'png': 'file-image-fill.png',
        'gif': 'file-image-fill.png',
        'xls': 'xfile.png',
        'xlsx': 'xfile.png',
        'txt': 'file-text-fill.png'
    };
    return iconMap[extension] || 'file-generic-fill.png';
}

// ฟังก์ชันสำหรับกำหนด CSS class ของไฟล์
function getFileClass(extension) {
    const classMap = {
        'pdf': 'pdf',
        'doc': 'word',
        'docx': 'word',
        'jpg': 'image',
        'jpeg': 'image',
        'png': 'image',
        'gif': 'image',
        'xls': 'subtract',
        'xlsx': 'subtract',
        'txt': 'text'
    };
    return classMap[extension] || 'generic';
}

// ฟังก์ชันสำหรับจัดการการแสดงปุ่มตามสถานะ
function handleButtonDisplayByStatus(docStatus) {
    console.log('Handling button display for status:', docStatus);
    
    if (docStatus === 'approved') {
        // ถ้าอนุมัติแล้ว ให้ซ่อนปุ่มแก้ไขและอนุมัติ แสดงปุ่มกลับ
        $('#btnEdit').hide();
        $('#btnApprove').hide();
        $('#goBack').show();
        
        // เปลี่ยนหัวข้อเป็น "อนุมัติใบเสนอราคา"
        $('#quotationTitle').hide();
        $('#approveTitle').show();
        $('#historyTitle').hide();
        
        // ซ่อนปุ่มใน navbar
        $('#btnnone').hide();
        
    } else {
        // ถ้ายังรออนุมัติ ให้แสดงปุ่มแก้ไขและอนุมัติ ซ่อนปุ่มกลับ
        $('#btnEdit').show();
        $('#btnApprove').show();
        $('#goBack').show();
        
        // แสดงหัวข้อปกติ
        $('#quotationTitle').show();
        $('#approveTitle').hide();
        $('#historyTitle').hide();
        
        // แสดงปุ่มใน navbar
        $('#btnnone').show();

        
    } 
    // else if (docStatus === 'rejected') {
    //     // ถ้าไม่อนุมัติ ให้ซ่อนปุ่มอนุมัติ แสดงปุ่มแก้ไขและกลับ
    //     $('#btnEdit').show();
    //     $('#btnApprove').hide();
    //     $('#goBack').show();
        
    //     // เปลี่ยนหัวข้อเป็น "ไม่อนุมัติใบเสนอราคา"
    //     $('#quotationTitle').hide();
    //     $('#approveTitle').hide();
    //     $('#historyTitle').text('ไม่อนุมัติใบเสนอราคา').show();
}

// ฟังก์ชันสำหรับแปลงรูปแบบวันที่สำหรับแสดงผล
function formatDateForDisplay(dateStr) {
    if (!dateStr) return '-';
    
    // ถ้าเป็นรูปแบบ DD/MM/YY หรือ DD/MM/YYYY
    if (dateStr.includes('/')) {
        return dateStr;
    }
    
    // ถ้าเป็นรูปแบบ YYYY-MM-DD
    if (dateStr.includes('-') && dateStr.split('-')[0].length === 4) {
        const [year, month, day] = dateStr.split('-');
        return `${day}/${month}/${year}`;
    }
    
    return dateStr;
}

// ฟังก์ชันสำหรับแปลงรูปแบบเงิน
function formatCurrency(amount) {
    if (!amount) return '0.00';
    return new Intl.NumberFormat('en-US', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    }).format(amount);
}

// ฟังก์ชันสำหรับแก้ไขใบเสนอราคา
function editQuotation() {
    // ดึง ID จาก URL parameter
    const urlParams = new URLSearchParams(window.location.search);
    const quotationId = urlParams.get('id');
    
    // ตรวจสอบว่ามีข้อมูลใน localStorage หรือไม่
    const localQuotationData = localStorage.getItem('quotationData');
    
    if (quotationId) {
        // ถ้ามี ID ใน URL ให้โหลดข้อมูลจากฐานข้อมูล
        console.log('Loading quotation data for editing, ID:', quotationId);
        
        $.ajax({
            url: `${endpoint}/api/get_quotation_by_id`,
            method: 'POST',
            dataType: 'json',
            data: {
                id: quotationId,
                com_id: localStorage.getItem('com_id') || 1
            },
            success: function(response) {
                console.log('Quotation edit API Response:', response);
                if (response.code === 200) {
                    // เก็บข้อมูลสำหรับการแก้ไข
                    localStorage.setItem('editQuotationId', quotationId);
                    localStorage.setItem('editQuotationData', JSON.stringify(response.result));
                    
                    // ไปยังหน้าแก้ไข
                    window.location.href = 'create-quotation.html';
                } else {
                    console.error('Error loading quotation data for editing:', response.result);
                    // ถ้าโหลดจาก API ไม่ได้ ให้ลองใช้ข้อมูลจาก localStorage
                    if (localQuotationData) {
                        console.log('Falling back to localStorage data for editing');
                        const parsedData = JSON.parse(localQuotationData);
                        localStorage.setItem('editQuotationId', quotationId);
                        localStorage.setItem('editQuotationData', JSON.stringify(parsedData));
                        window.location.href = 'create-quotation.html';
                    } else {
                        alert('ไม่พบข้อมูลใบเสนอราคาสำหรับการแก้ไข');
                    }
                }
            },
            error: function(xhr, status, error) {
                console.error('Error loading quotation data for editing:', error);
                // ถ้าโหลดจาก API ไม่ได้ ให้ลองใช้ข้อมูลจาก localStorage
                if (localQuotationData) {
                    console.log('Falling back to localStorage data for editing due to API error');
                    const parsedData = JSON.parse(localQuotationData);
                    localStorage.setItem('editQuotationId', quotationId);
                    localStorage.setItem('editQuotationData', JSON.stringify(parsedData));
                    window.location.href = 'create-quotation.html';
                } else {
                    alert('เกิดข้อผิดพลาดในการโหลดข้อมูลสำหรับการแก้ไข');
                }
            }
        });
    } else if (localQuotationData) {
        // ถ้าไม่มี ID ใน URL แต่มีข้อมูลใน localStorage ให้ใช้ข้อมูลจาก localStorage
        console.log('Using localStorage data for editing');
        const parsedData = JSON.parse(localQuotationData);
        const localQuotationId = localStorage.getItem('quotationId');
        
        localStorage.setItem('editQuotationId', localQuotationId || '');
        localStorage.setItem('editQuotationData', JSON.stringify(parsedData));
        window.location.href = 'create-quotation.html';
    } else {
        console.error('No quotation ID found in URL and no data in localStorage for editing');
        alert('ไม่พบข้อมูลใบเสนอราคาสำหรับการแก้ไข');
    }
}

// ฟังก์ชันสำหรับอัปเดต timeline เมื่อมีการแก้ไข
function updateTimelineOnEdit() {
    const urlParams = new URLSearchParams(window.location.search);
    const quotationId = urlParams.get('id');
    
    if (!quotationId) {
        console.log('No quotation ID found for timeline update');
        return;
    }
    
    // บันทึกข้อมูลการแก้ไขลงฐานข้อมูล
    $.ajax({
        url: `${endpoint}/api/create_quotation_timeline`,
        method: 'POST',
        dataType: 'json',
        contentType: 'application/json',
        data: JSON.stringify({
            id: quotationId,
            action_type: 'edit',
            note: '',
            com_id: localStorage.getItem('com_id') || 1
        }),
        success: function(response) {
            console.log('Timeline edit API Response:', response);
            if (response.code === 200) {
                // อัปเดต timeline ใหม่จากฐานข้อมูลทันที
                createQuotationTimeline();
                console.log('Timeline updated after edit');
            } else {
                console.error('Error creating timeline entry:', response.result);
            }
        },
        error: function(xhr, status, error) {
            console.error('Error creating timeline entry:', error);
        }
    });
}

// ฟังก์ชันสำหรับอัปเดต timeline เมื่อมีการอนุมัติ
function updateTimelineOnApprove() {
    const urlParams = new URLSearchParams(window.location.search);
    const quotationId = urlParams.get('id');
    
    if (!quotationId) {
        console.log('No quotation ID found for timeline update');
        return;
    }
    
    // บันทึกข้อมูลการอนุมัติลงฐานข้อมูล
    $.ajax({
        url: `${endpoint}/api/create_quotation_timeline`,
        method: 'POST',
        dataType: 'json',
        contentType: 'application/json',
        data: JSON.stringify({
            id: quotationId,
            action_type: 'approve',
            note: 'หมายเหตุ: รอเอกสารเพิ่มเติมจากลูกค้า',
            com_id: localStorage.getItem('com_id') || 1
        }),
        success: function(response) {
            console.log('Timeline approve API Response:', response);
            if (response.code === 200) {
                // อัปเดต timeline ใหม่จากฐานข้อมูลทันที
                createQuotationTimeline();
                console.log('Timeline updated after approve');
            } else {
                console.error('Error creating timeline entry:', response.result);
            }
        },
        error: function(xhr, status, error) {
            console.error('Error creating timeline entry:', error);
        }
    });
}

// ฟังก์ชันสำหรับสร้าง timeline entry เมื่อสร้างใบเสนอราคาใหม่
function createTimelineEntry(quotationId, actionType, note = '') {
    if (!quotationId) {
        console.log('No quotation ID found for timeline entry creation');
        return;
    }
    
    $.ajax({
        url: `${endpoint}/api/create_quotation_timeline`,
        method: 'POST',
        dataType: 'json',
        contentType: 'application/json',
        data: JSON.stringify({
            quotation_id: quotationId,
            action_type: actionType,
            note: note,
            com_id: localStorage.getItem('com_id') || 1
        }),
        success: function(response) {
            console.log('Timeline entry created:', response);
        },
        error: function(xhr, status, error) {
            console.error('Error creating timeline entry:', error);
        }
    });
}

// ฟังก์ชันสำหรับอนุมัติใบเสนอราคา
function approveQuotation() {
    // ยืนยันการอนุมัติ
    // if (!confirm('คุณต้องการอนุมัติใบเสนอราคานี้หรือไม่?')) {
    //     return;
    // }
    
    // ดึง ID จาก URL parameter
    const urlParams = new URLSearchParams(window.location.search);
    const quotationId = urlParams.get('id');
    
    if (!quotationId) {
        alert('ไม่พบ ID ของใบเสนอราคา');
        return;
    }
    
    console.log('Approving quotation, ID:', quotationId);
    
    // ส่งข้อมูลไปยัง API เพื่ออัปเดตสถานะเป็น approved
    $.ajax({
        url: `${endpoint}/api/update_quotation_status`,
        method: 'POST',
        dataType: 'json',
        contentType: 'application/json',
        data: JSON.stringify({
            id: quotationId,
            doc_status: 'approved',
            com_id: localStorage.getItem('com_id') || 1
        }),
        success: function(response) {
            console.log('Quotation approval API Response:', response);
            if (response.code === 200) {
                // alert('อนุมัติใบเสนอราคาเรียบร้อยแล้ว');
                
                // อัปเดตสถานะในหน้าแสดงผล
                $('#customerStatusDisplay').text(response.result.status);
                
                // ซ่อนปุ่มอนุมัติและแสดงปุ่มกลับ
                $('#btnApprove').hide();
                $('#goBack').show();
                
                // อัปเดตหัวข้อ
                $('#quotationTitle').hide();
                $('#approveTitle').show();
                
                // อัปเดต timeline ทันทีโดยไม่ต้องรีเฟรช
                createQuotationTimeline();
                
            } else {
                console.error('Error approving quotation:', response.result);
                alert('เกิดข้อผิดพลาดในการอนุมัติ: ' + (response.result || 'ไม่ทราบสาเหตุ'));
            }
        },
        error: function(xhr, status, error) {
            console.error('Error approving quotation:', error);
            alert('เกิดข้อผิดพลาดในการเชื่อมต่อกับเซิร์ฟเวอร์');
        }
    });
}

// ฟังก์ชันสำหรับไปยังหน้า paperdepositreceiptSPV.html พร้อมส่ง ID
function goToPaperDepositReceipt() {
    // ดึง ID จาก URL parameter
    const urlParams = new URLSearchParams(window.location.search);
    const quotationId = urlParams.get('id');
    
    // ดึงชื่อผู้จัดทำจากหน้าเว็บ
    const creatorName = document.getElementById('name-Creator').textContent;
    
    // ดึงสถานะ checkbox
    const notShowName = document.getElementById('not-show-name').checked;
    const signatureOption = document.getElementById('signature-option').checked;
    
    // เก็บข้อมูลใน localStorage
    localStorage.setItem('quotationCreatorName', creatorName);
    localStorage.setItem('quotationNotShowName', notShowName);
    localStorage.setItem('quotationSignatureOption', signatureOption);
    
    // เปิดหน้าใหม่ paperquotationSPV.html พร้อมส่ง ID
    window.open(`paperquotationSPV.html?id=${quotationId}`, '_blank');
}

// ฟังก์ชันสำหรับดาวน์โหลด PDF โดยตรง
function downloadQuotationPDF() {
    // ดึง quotationId จาก URL parameter
    const urlParams = new URLSearchParams(window.location.search);
    const quotationId = urlParams.get('id');
    
    if (!quotationId) {
        alert('ไม่พบ ID ของใบเสนอราคา');
        return;
    }
    
    
    // ดึงข้อมูลจาก API
        $.ajax({
            url: `${endpoint}/api/get_quotation_by_id`,
            method: 'POST',
            dataType: 'json',
            contentType: 'application/json',
            data: JSON.stringify({
                id: quotationId,
                com_id: localStorage.getItem('com_id') || 1
            }),
            success: function(response) {
                console.log('API Response:', response);
                if (response.code === 200) {
                    // สร้าง PDF จากข้อมูล
                    generateQuotationPDF(response.result);
                } else {
                    alert('ไม่สามารถดึงข้อมูลได้: ' + (response.result || 'ไม่ทราบสาเหตุ'));
                }
            },
            error: function(xhr, status, error) {
                console.error('เกิดข้อผิดพลาดในการเชื่อมต่อ:', error);
                console.error('Response:', xhr.responseText);
                alert('เกิดข้อผิดพลาดในการเชื่อมต่อกับเซิร์ฟเวอร์: ' + error);
            }
        });
    }

    function generateQuotationPDF(data) {
        // สร้าง HTML content สำหรับใบเสนอราคา
        const htmlContent = createQuotationHTML(data);
        
        // สร้าง PDF
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p', 'mm', 'a4');
        
        // ใช้ html2canvas เพื่อแปลง HTML เป็น PDF
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = htmlContent;
        tempDiv.style.position = 'absolute';
        tempDiv.style.left = '-9999px';
        document.body.appendChild(tempDiv);
        
        // เรียกใช้ฟังก์ชันสร้างหน้าเพิ่มเติม
        createNewPage(data, tempDiv);
        
            // ดึงทุกหน้า
            const pages = tempDiv.querySelectorAll('.a4-sheet');
            
            // สร้าง PDF สำหรับทุกหน้า
            let pageIndex = 0;
            
            function processNextPage() {
                if (pageIndex >= pages.length) {
                    // บันทึกไฟล์
                    const filename = `ใบเสนอราคา${data.tx}.pdf`;
                    pdf.save(filename);
                    
                    // ลบ tempDiv
                    document.body.removeChild(tempDiv);
                    return;
                }
                
                const element = pages[pageIndex];
                
                html2canvas(element, {
                    scale: 2,
                    useCORS: true,
                    allowTaint: true,
                    scrollX: 0,
                    scrollY: 0,
                    height: 1200,
                    windowHeight: 1200
                }).then(function(canvas) {
                    const imgData = canvas.toDataURL('image/jpeg', 1.0);
                    const imgWidth = 210;
                    const pageHeight = 297;
                    const imgHeight = (canvas.height * imgWidth) / canvas.width;
                    
                    // ถ้าไม่ใช่หน้าแรก ให้เพิ่มหน้าใหม่ใน PDF
                    if (pageIndex > 0) {
                        pdf.addPage();
                    }
                    
                    pdf.addImage(imgData, 'JPEG', 0, 0, imgWidth, imgHeight);
                    
                    pageIndex++;
                    processNextPage();
                });
            }
            
            processNextPage();
    }
    

    function createQuotationHTML(data) {
        // แบ่งที่อยู่จาก customerAddress
        var fullAddress = data.cus_detail.cus_addr || '';
        
        // หาตำแหน่งของคำสำคัญในที่อยู่
        var tambonIndex = fullAddress.search(/ต\.|ตำบล|แขวง/);
        var amphoeIndex = fullAddress.search(/อ\.|อำเภอ|เขต/);
        var provinceIndex = fullAddress.search(/จ\.|จังหวัด|กรุงเทพมหานคร|กรุงเทพฯ|กรุงเทพ ฯ/);
        
        let address1 = '', address2 = '', address3 = '';
        
        if (tambonIndex !== -1) {
            address1 = fullAddress.substring(0, tambonIndex).trim();
            
            if (provinceIndex !== -1) {
                address2 = fullAddress.substring(tambonIndex, provinceIndex).trim();
                address3 = fullAddress.substring(provinceIndex).trim();
            }
        }
        
        // ข้อมูลสินค้า (จำกัด 10 รายการต่อหน้า)
        const items = data.product_byuser.slice(0, 10);
        
        // สร้างรายการสินค้า
        let itemsHTML = '';
        
        // เพิ่มรายการสินค้าจริง
        items.forEach((item, index) => {
            itemsHTML += `
                <tr>
                    <td style="border-left: 1px solid black; height:40px;text-align: center;font-size: 11px;">${index + 1}</td>
                    <td style="border-left: 1px solid black;padding: 0 10px; border-left: 1px solid black;font-size: 11px;">${item.desc_product}</td>
                    <td style="border-left: 1px solid black;text-align: center;font-size: 11px;">${parseFloat(item.qty).toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0})}</td>
                    <td style="border-left: 1px solid black;font-size: 11px;text-align: right;padding: 0 10px;">${parseFloat(item.price).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                    <td style="border-left: 1px solid black;font-size: 11px;text-align: right;padding: 0 10px;">${parseFloat(item.discount).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                    <td style="border-left: 1px solid black;border-right: 1px solid black;font-size: 11px;text-align: right;padding: 0 10px;">${parseFloat(item.total).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                </tr>
            `;
        });
        
        // เพิ่มแถวว่างจนครบ 10 แถว
        for (let i = items.length; i < 10; i++) {
            itemsHTML += `
                <tr>
                    <td style="border-left: 1px solid black; height:40px;text-align: center;font-size: 11px;"></td>
                    <td style="border-left: 1px solid black;padding: 0 10px; border-left: 1px solid black;font-size: 11px;">&nbsp;</td>
                    <td style="border-left: 1px solid black;text-align: center;font-size: 11px;">&nbsp;</td>
                    <td style="border-left: 1px solid black;font-size: 11px;text-align: right;padding: 0 10px;">&nbsp;</td>
                    <td style="border-left: 1px solid black;font-size: 11px;text-align: right;padding: 0 10px;">&nbsp;</td>
                    <td style="border-left: 1px solid black;border-right: 1px solid black;font-size: 11px;text-align: right;padding: 0 10px;">&nbsp;</td>
                </tr>
            `;
        }
        
        
        // คำนวณยอดรวม (แสดงยอดรวมจริงทั้งหมด)
        const subtotal = parseFloat(data.product_detail.product_totalAllProducts).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        const totalDiscount = parseFloat(data.product_detail.product_totalDiscount).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        const afterDiscount = parseFloat(data.product_detail.product_totalAfterDiscount).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        const vatAmount = parseFloat(data.product_detail.product_totalTax).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        
        // รวม withholdingTax ทั้ง 3 อัน
        const withholdingTax1 = parseFloat(data.product_detail.product_withholdingTax) || 0;
        const withholdingTax2 = parseFloat(data.product_detail.product_withholdingTax2) || 0;
        const withholdingTax3 = parseFloat(data.product_detail.product_withholdingTax3) || 0;
        const totalWithholdingTax = withholdingTax1 + withholdingTax2 + withholdingTax3;
        const taxAmount = totalWithholdingTax.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        
        const grandTotal = parseFloat(data.product_detail.product_totalAll).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        
        // แปลงตัวเลขเป็นตัวอักษรไทย
        const grandTotalAmount = parseFloat(data.product_detail.product_totalAll);
        const thaiText = convertToThaiText(grandTotalAmount);
        
        // สร้าง HTML content สำหรับใบเสนอราคา
        const htmlContent = `
            <div class="a4-sheet">

    <table role="presentation" cellspacing="0" cellpadding="0" style="width:190mm;margin:12mm auto;border-collapse:collapse;background:#fff;color:#111827;">
        
    <!-- แถวบน: โลโก้ (ซ้าย) + หัวบริษัท (ขวา)  == จบโซนโลโก้ที่นี่ -->
    <tr>
      <!-- ซ้าย: โลโก้ -->
      <td style="width:15%;vertical-align:top;">
        <table cellspacing="0" cellpadding="0" style="width:100%;border-collapse:collapse;">
          <tr>
            <td style="padding:4px 0;">
              <table cellspacing="0" cellpadding="0" style="width:30mm;height:20mm;">
                <tr><td style="text-align:center;font-size:12px;color:#6b7280;">LOGO</td></tr>
              </table>
            </td>
          </tr>
        </table>
      </td>

      <!-- ขวา: ข้อมูลบริษัท -->
      <td colspan="2" style="width:85%;vertical-align:middle;">
        <table cellspacing="0" cellpadding="0" style="width:100%;border-collapse:collapse;">
          <tr>
            <td style="font-size:20px;line-height:1.25;font-weight:700;padding:2px 8px 6px 8px;">
              บริษัท เอสพีวี คอน โกลเมอเรท จำกัด
            </td>
          </tr>
          <tr>
            <td style="padding:6px 0 0 0;">
              <table cellspacing="0" cellpadding="0" style="width:100%;border-collapse:collapse;table-layout:fixed;">
                <tr>
                  <td style="width:40%;font-size:11px;padding:0 5px;text-align:left;">
                    45 หมู่ 8 ตำบลมิตรภาพ อำเภอมวกเหล็ก จังหวัดสระบุรี 18180
                  </td>
                  <td style="width:36%;font-size:11px;text-align:center;">
                    Tel. 089-6689380&nbsp;&nbsp;Fax. 036-342146
                  </td>
                  <td style="width:34%;font-size:11px;padding:0 5px;text-align:right;">
                    E-Mail : saipanresort@gmail.com
                  </td>
                </tr>
              </table>
            </td>
          </tr>
        </table>
      </td>
    </tr>
    <tr>
      <td colspan="3">
        <!-- วาง “โค้ดอื่น” ที่ต้องการต่อจากนี้ทั้งหมดได้อย่างปลอดภัย -->
        <!-- ตัวอย่าง: 3–4 คอลัมน์ที่คุณทำไว้ -->
        <table cellspacing="0" cellpadding="0" style="width:100%; border-collapse:collapse; table-layout:fixed;">
        <!-- แถวล่าง 3 (4 คอลัมน์) -->
        <tr style="line-height:1.15;">
            <td style="width:11%; font-size:11px; padding:0 6px; text-align: right;">
              เลขประจำตัวผู้เสียภาษี/ Tax ID
            </td>
            <td style="width:4%; font-size:11px; padding:0 6px; text-align:left;">
              1100110011001
            </td>
            <td style="width:4%; font-size:11px; padding:0 6px;">
              สำนักงานใหญ่
            </td>
            <td style="width:11%; font-size:20px; padding:0 6px; text-align:center;"></td>
          </tr>

          <!-- แถวล่าง 4 (4 คอลัมน์) -->
          <tr style="line-height:1.15;">
            <td style="width:10%; font-size:11px; padding:0 6px; text-align: right;"></td>
            <td style="width:3%; font-size:11px; padding:0 6px; text-align:left;"></td>
            <td style="width:3%; font-size:11px; padding:0 6px;"></td>
            <td style="width:11%; font-size:20px; padding:0 6px; text-align:center;">
                ใบเสนอราคา/Quotation
            </td>
          </tr>
        </table>

<!-- กล่องข้อมูลลูกค้า + เงื่อนไขบิล (ขนาดเท่ากัน + มุมโค้ง 28px) -->
<!-- กล่องข้อมูลลูกค้า + เงื่อนไขบิล (ขอบตรง + ขนาดเท่ากัน) -->
<table cellspacing="0" cellpadding="0" style="width:100%; border-collapse:collapse; table-layout:fixed; margin-top:8px;    margin-bottom: 10px;">
  <tr>
    <!-- ซ้าย: กล่องลูกค้า -->
<td style="width:49%; vertical-align:top;">
  <table cellspacing="0" cellpadding="0" style="width:100%; border-collapse:collapse;">
    <tr>
      <!-- กล่องตามภาพ: มุมมน เลย์เอาต์ซ้ายชิด -->
      <td style="height: 187px;border:1px solid #000; border-radius:8px; padding:12px 14px; vertical-align:top;">
        <table cellspacing="0" cellpadding="0" style="width:100%; border-collapse:collapse; table-layout:fixed;">
          <!-- บรรทัด "ถึง" -->
          <tr>
            <td style="font-size:12px; padding:2px 0;">ถึง</td>
          </tr>

          <!-- ชื่อและที่อยู่ (หลายบรรทัด) -->
            <tr><td style="font-size:11px; padding:2px 0; padding-left:14px;">${data.cus_name}</td></tr>
            <tr><td style="font-size:11px; padding:2px 0; padding-left:14px;">${address1}</td></tr>
            <tr><td style="font-size:11px; padding:2px 0; padding-left:14px;">${address2}</td></tr>
            <tr><td style="font-size:11px; padding:2px 0; padding-left:14px;">${address3}</td></tr>
        <!-- เว้นระยะเล็กน้อยก่อน "โทร." -->
        <tr><td style="height:6px;"></td></tr>

        <!-- โทร. -->
        <tr>
            <td style="font-size:11px; padding:2px 0;">โทร. ${data.cus_detail.cus_phone}</td>
        </tr>

        <!-- เว้นระยะเล็กน้อยก่อน "อ้างอิง" -->
        <tr><td style="height:6px;"></td></tr>

          <!-- อ้างอิง -->
        <tr>
            <td style="font-size:12px; padding:2px 0;">
            อ้างอิง ${data.cus_detail.cus_refer}
            </td>
        </tr>
        </table>
    </td>
    </tr>
</table>
</td>


    <!-- ช่องว่างกลาง -->
    <td style="width:2%;">&nbsp;</td>

    <!-- ขวา: กล่องเลขที่/วันที่/เครดิต/ครบกำหนด -->
    <td style="width:49%; vertical-align:top;">
      <table cellspacing="0" cellpadding="0" style="width:100%; border-collapse:collapse;">
       <tr>
  <!-- ปรับเป็นขอบตรง + ความสูงเท่ากัน -->
  <td style="border:1px solid #000; border-radius:8px; padding:10px 12px;     height: 187px; vertical-align:top;">
    <!-- เลขที่ใบเสนอราคา -->
    <table cellspacing="0" cellpadding="0" style="width:100%; border-collapse:collapse; table-layout:fixed;">
      <tr>
        <td style="width:35%; font-size:11px; padding:2px 0;">เลขที่ใบเสนอราคา</td>
        <td style="font-size:11px; padding:2px 0; text-align:left;">${data.tx}</td>
      </tr>
    </table>

    <!-- spacer -->
    <table cellspacing="0" cellpadding="0" style="width:100%; border-collapse:collapse;"><tr><td style="height: 17px;;"></td></tr></table>

    <!-- เครดิต + ครบกำหนด (แยกเป็นตารางของตัวเอง) -->
    <table cellspacing="0" cellpadding="0" style="width:100%; border-collapse:collapse; table-layout:fixed;">
      <tr>
        <td style="width:12%; font-size:11px; padding:2px 0;"></td>
        <td style="width:30%; font-size:11px; padding:2px 0; text-align:left; white-space:nowrap;">
            วันที่
        </td>
        <td style="width:30%; font-size:11px; padding:2px 0;">${data.doc_date}</td>
        <td style="width:46%; font-size:11px; padding:2px 0; text-align:left;"></td>
      </tr>
    </table>
        <table cellspacing="0" cellpadding="0" style="width:100%; border-collapse:collapse;"><tr><td style="height: 17px;"></td></tr></table>

    <!-- เครดิต + ครบกำหนด (แยกเป็นตารางของตัวเอง) -->
    <table cellspacing="0" cellpadding="0" style="width:100%; border-collapse:collapse; table-layout:fixed;">
      <tr>
        <td style="width:12%; font-size:11px; padding:2px 0;    height: 17px;"></td>
        <td style="width:30%; font-size:11px; padding:2px 0; text-align:left; white-space:nowrap;    height: 17px;">
        </td>
        <td style="width:30%; font-size:11px; padding:2px 0;    height: 17px;"></td>
        <td style="width:46%; font-size:11px; padding:2px 0; text-align:left;    height: 17px;"></td>
      </tr>
    </table>
        <!-- เครดิต + ครบกำหนด (แยกเป็นตารางของตัวเอง) -->
    <table cellspacing="0" cellpadding="0" style="width:100%; border-collapse:collapse; table-layout:fixed;">
      <tr>
        <td style="width:12%; font-size:11px; padding:2px 0;    height: 17px;"></td>
        <td style="width:30%; font-size:11px; padding:2px 0; text-align:left; white-space:nowrap;    height: 17px;">
        </td>
        <td style="width:30%; font-size:11px; padding:2px 0;    height: 17px;"></td>
        <td style="width:46%; font-size:11px; padding:2px 0; text-align:left;    height: 17px;"></td>
      </tr>
    </table>

    <!-- spacer (แทน padding-top:8px ของแถวเครดิตเดิม) -->


    <!-- เครดิต + ครบกำหนด (แยกเป็นตารางของตัวเอง) -->
    <table cellspacing="0" cellpadding="0" style="width:100%; border-collapse:collapse; table-layout:fixed;">
      <tr>
        <td style="width:15%; font-size:11px; padding:2px 0;">ยืนราคา</td>
        <td style="width:15%; font-size:11px; padding:2px 0; text-align:left; white-space:nowrap;" id="quotationDueDate">
        ${data.doc_detail.deadline} &nbsp;<span style="font-size:11px;" >วัน</span>
        </td>
        <td style="width:20%; font-size:11px; padding:2px 0;">ถึงวันที่</td>
        <td style="width:30%; font-size:11px; padding:2px 0; text-align:left;" id="quotationDueDateTo">${data.due_date}</td>
      </tr>
    </table>
    <table cellspacing="0" cellpadding="0" style="width:100%; border-collapse:collapse; table-layout:fixed;">
      <tr>
        <td style="width:35%; font-size:11px; padding:2px 0;">เงื่อนไขชำระเงิน</td>
        <td style="font-size:11px; padding:2px 0; text-align:left;"></td>
      </tr>
    </table>
  </td>
</tr>
      </table>
    </td>
  </tr>
  
</table>
<table style="width:100%;    margin-bottom: 10px;">
  <tr>
    <td style="font-size: 11px;">บริษัท มีความยินดีที่จะเสนอราคาสินค้า ดังต่อไปนี้ :</td>
  </tr>
</table>
<!-- กรอบตารางตามภาพ (เส้นตรง คุมด้วย table+inline เท่านั้น) -->
<!-- ตารางโครงตามภาพ (ใช้ table ล้วน + inline style) -->
<table cellspacing="0" cellpadding="0" style="width:100%; border-collapse:collapse; table-layout:fixed; font-size:12px; color:#111;">
  <colgroup>
    <col style="width:5%;">  <!-- คอลัมน์ 1 -->
    <col style="width:38%;">  <!-- คอลัมน์ 2 (กว้างสุด) -->
    <col style="width:12%;">  <!-- คอลัมน์ 3 -->
    <col style="width:14%;">  <!-- คอลัมน์ 4 -->
    <col style="width:10%;">  <!-- คอลัมน์ 5 -->
    <col style="width:18%;">  <!-- คอลัมน์ 6 ขวาสุด -->
  </colgroup>

  <!-- แถบหัวตารางบาง ๆ ด้านบน -->
  <tr>
    <td style="border:1px solid #000; height:28px;text-align: center;">ลำดับ</td>
    <td style="border:1px solid #000;text-align: center;">รายการ</td>
    <td style="border:1px solid #000;text-align: center;">จำนวน</td>
    <td style="border:1px solid #000;text-align: center;">หน่วยละ</td>
    <td style="border:1px solid #000;text-align: center;">ส่วนลด</td>
    <td style="border:1px solid #000;padding: 0 10px;text-align: right;">ราคารวมภาษี</td>
  </tr>

  <!-- <tr>
    <td style="border-left: 1px solid black; height:40px;text-align: center;font-size: 11px;">1</td>
    <td style="border-left: 1px solid black;padding: 0 10px;    border-left: 1px solid black;font-size: 11px;">ค่าที่พักพร้อมอาหารเช้า</td>
    <td style="border-left: 1px solid black;text-align: center;font-size: 11px;">48</td>
    <td style="border-left: 1px solid black;font-size: 11px;text-align: right;padding: 0 10px;">750.000</td>
    <td style="border-left: 1px solid black;font-size: 11px;"></td>
    <td style="border-left: 1px solid black;border-right: 1px solid black;font-size: 11px;text-align: right;padding: 0 10px;"></td>
  </tr>
  </tr> -->
  
  <!-- Dynamic content will be inserted here by JavaScript -->
  <tbody id="quotationItems">
    ${itemsHTML}
  </tbody>
  <!-- แถวรองท้าย: ช่องใหญ่ยาว + ช่องแคบขวาสุด (มีเส้นตั้งแบ่ง) -->
  <tr class="summary-section">
    <!-- รวมซ้ายถึงคอลัมน์ที่ 5 -->
    <td colspan="5"
    style="border-left:1px solid #000; border-top:1px solid #000; border-bottom:1px solid #000;
           padding:8px 10px; vertical-align:top;">
  <!-- ตารางซ้อน 2 คอลัมน์ ไม่มีเส้นขั้น -->
<table cellspacing="0" cellpadding="0"
       style="width:100%; border-collapse:collapse; table-layout:fixed;">
  <colgroup>
    <col style="width:65%;">  <!-- ซ้าย: หมายเหตุ -->
    <col style="width:35%;">  <!-- ขวา: สรุปยอด -->
  </colgroup>

  <!-- แถวแรก: ซ้ายใช้ rowspan รวมเป็นช่องหมายเหตุ, ขวาเริ่มรายการ -->
  <tr>
    <!-- เปลี่ยน rowspan เป็น 6 (มี 6 แถวขวา) -->
    <td rowspan="6" style="border:0; padding:0px 10px; font-size:12px; vertical-align:top;">
      <!-- ภายในใช้ตารางที่มีความสูง 100% เพื่อให้แถวสุดท้ายชิดด้านล่าง -->
      <table cellspacing="0" cellpadding="0" style="width:100%; border-collapse:collapse; height:100%;">
        <!-- หมายเหตุ อยู่บน -->
        <tr>
          <td style="border:0; padding:2px 0; font-size:12px; vertical-align:top; height: 92px;">
            หมายเหตุ:
          </td>
        </tr>
        <!-- ช่องว่าง/รายละเอียดอื่นๆ ขยายกลาง -->
        <tr>
          <td style="border:0; padding:4px 0; font-size:12px; vertical-align:top;">
            <!-- ว่างไว้หรือใส่รายละเอียดเพิ่มเติม -->
          </td>
        </tr>
        <!-- แถวสุดท้ายในเซลล์ซ้าย ให้ชิดล่าง เพื่อให้ 'ตัวอักษร' อยู่แนวเดียวกับ 'รวมเป็นเงิน' -->
        <tr>
          <td id="totalText" style="border:0; padding:2px 0; font-size:12px; vertical-align:bottom; height:1px;">
            ตัวอักษร: (${thaiText})
          </td>
        </tr>
      </table>
    </td>

    <td style="border:0; padding:2px 0; font-size:12px;">จำนวนเงินรวมทั้งสิ้น</td>
  </tr>

  <tr>
    <td style="border:0; padding:2px 0; font-size:12px;">หัก&nbsp;&nbsp;ส่วนลด</td>
  </tr>

  <tr>
    <td style="border:0; padding:2px 0; font-size:12px;">จำนวนเงินหลังหักส่วนลด</td>
  </tr>

  <tr>
    <td style="border:0; padding:2px 0; font-size:12px;">จำนวนเงินภาษีมูลค่าเพิ่ม&nbsp;&nbsp;7.00&nbsp;&nbsp;%</td>
  </tr>

  <!-- เพิ่มบรรทัด: ภาษีหัก ณ ที่จ่าย -->
  <tr>
    <td style="border:0; padding:2px 0; font-size:12px;">หักภาษี ณ ที่จ่าย</td>
  </tr>

  <tr>
    <td style="border:0; padding:2px 0; font-size:12px;">รวมเป็นเงิน</td>
  </tr>
</table>

<!-- คอลัมน์ขวาสุดแยกเป็นช่องเล็ก (5 แถว) -->
<td style="border:1px solid #000; padding:0;">
  <table cellspacing="0" cellpadding="0"style="width:100%; height:100%; border-collapse:collapse; table-layout:fixed; font-size:12px;">
    <tr>
      <td id="subtotal" style=" text-align:right;padding: 0 10px;    height: 20.19px;">${subtotal}</td>
    </tr>
    <tr>
      <td id="totalDiscount" style="text-align:right;padding: 0 10px;    height: 20.19px;">${totalDiscount}</td>
    </tr>
    <tr>
      <td id="afterDiscount" style="text-align:right;padding: 0 10px;    height: 20.19px;">${afterDiscount}</td>
    </tr>
    <tr>
      <td id="vatAmount" style="text-align:right;padding: 0 10px;    height: 20.19px;">${vatAmount}</td>
    </tr>
    <tr>
      <td id="taxAmount" style="text-align:right;padding: 0 10px;    height: 20.25px;">${taxAmount}</td>
    </tr>
    <tr>
      <td id="grandTotal" style="text-align:right;padding: 0 10px;    height: 20.25px;">${grandTotal}</td>
    </tr>
  </table>
</td>

<!-- แถวล่างสุด: แบ่ง 3 ฝั่ง 40 / 20 (โลโก้) / 40 -->
<tr class="summary-section">
  <td colspan="6" style="border:1px solid #000; border-radius:10px; padding:12px;">
    <table cellspacing="0" cellpadding="0" style="width:100%; border-collapse:collapse; table-layout:fixed;">
      <colgroup>
        <col style="width:40%;">
        <col style="width:20%;">
        <col style="width:40%;">
      </colgroup>
      <tr>
        <!-- ซ้าย -->
        <td style="border:0; padding:2px 10px; font-size:12px; vertical-align:top; text-align:center;">
          ข้าพเจ้าขอยอมรับการเสนอราคาตามดังกล่าวข้างต้น
        </td>

        <!-- กลาง (โลโก้) ครอบ 3 แถว -->
        <td rowspan="3" style="border:0; padding:0 8px; vertical-align:middle; text-align:center;">
          <table cellspacing="0" cellpadding="0" style="width:100%; border-collapse:collapse;">
            <tr>
              <td style=" height:28mm; border-radius:6px; text-align:center; vertical-align:middle;">
                ${(data.cus_detail.cus_visits === true || data.cus_detail.cus_visits === 'true') ? 
                  '<img src="picture/unit-logo.png" style="max-width:100%; max-height:28mm;" id="unitLogo">' : 
                  ''}
              </td>
            </tr>
          </table>
        </td>

        <!-- ขวา -->
        <td style="border:0; padding:2px 10px; font-size:12px; vertical-align:top; text-align:center;">
          ขอแสดงความนับถือ
        </td>
      </tr>

      <tr>
        <!-- เว้นที่ลายเซ็น/ชื่อ -->
        <td style="border:0; height:50px; text-align:center;"></td>
        <td style="border:0; height:50px; text-align:center;" id="creatorName">
          ${(document.getElementById('not-show-name') && document.getElementById('not-show-name').checked) ? 
            '' : 
            (document.getElementById('name-Creator') ? document.getElementById('name-Creator').textContent : '')}
        </td>
      </tr>

      <tr>
        <!-- ลายเซ็น ฝั่งซ้าย -->
        <td style="border:0; padding:0 10px 2px 10px; vertical-align:top; text-align:center;">
          <table cellspacing="0" cellpadding="0" style="width:60%; margin:0 auto; border-collapse:collapse;">
            <tr><td style="border-top:1px solid #000; height:1px;">&nbsp;</td></tr>
          </table>
          <div style="font-size:12px; padding-top:6px;">ประทับตราบริษัท (ถ้ามี)</div>
          <div style="font-size:12px; padding-top:6px;">วันที่&nbsp;........../........../............</div>
        </td>

        <!-- ลายเซ็น ฝั่งขวา -->
        <td style="border:0; padding:0 10px 2px 10px; vertical-align:top; text-align:center;">
          <table cellspacing="0" cellpadding="0" style="width:60%; margin:0 auto; border-collapse:collapse;">
            <tr><td style="border-top:1px solid #000; height:1px;">&nbsp;</td></tr>
          </table>
          <div style="font-size:12px; padding-top:6px;">ผู้เสนอราคา</div>
          <div style="font-size:12px; padding-top:6px;">วันที่&nbsp;........../........../............</div>
        </td>
      </tr>
    </table>
  </td>
</tr>



</table>

    </td>
  </tr>
    </table>

</div>
        `;

    return htmlContent;
}

// ฟังก์ชันสำหรับสร้างหลายหน้า
function createNewPage(data, container) {
  const items = data.product_byuser;
  
  // ถ้ามีรายการเกิน 10 รายการ ให้สร้างหน้าใหม่
  if (items.length > 10) {
    const totalPages = Math.ceil(items.length / 10);
    
    // ตั้งค่าหน้าแสดงยอดรวมหน้าแรก
    const firstPage = container.querySelector('.a4-sheet');
    if (firstPage) {
      const subtotalEl = firstPage.querySelector('#subtotal');
      const totalDiscountEl = firstPage.querySelector('#totalDiscount');
      const afterDiscountEl = firstPage.querySelector('#afterDiscount');
      const vatAmountEl = firstPage.querySelector('#vatAmount');
      const taxAmountEl = firstPage.querySelector('#taxAmount');
      const grandTotalEl = firstPage.querySelector('#grandTotal');
      const totalTextEl = firstPage.querySelector('#totalText');
      
      if (subtotalEl) subtotalEl.textContent = '0.00';
      if (totalDiscountEl) totalDiscountEl.textContent = '0.00';
      if (afterDiscountEl) afterDiscountEl.textContent = '0.00';
      if (vatAmountEl) vatAmountEl.textContent = '0.00';
      if (taxAmountEl) taxAmountEl.textContent = '0.00';
      if (grandTotalEl) grandTotalEl.textContent = '0.00';
      if (totalTextEl) totalTextEl.textContent = 'ตัวอักษร: (ศูนย์บาทถ้วน)';
    }
    
    for (let pageIndex = 1; pageIndex < totalPages; pageIndex++) {
      const startIndex = pageIndex * 10;
      const endIndex = Math.min(startIndex + 10, items.length);
      const pageItems = items.slice(startIndex, endIndex);
      const isLastPage = (pageIndex === totalPages - 1);
      
      // สร้าง div ใหม่สำหรับหน้าใหม่
      const newPageDiv = document.createElement('div');
      newPageDiv.className = 'a4-sheet';
      
      // คัดลอกโครงสร้างจากหน้าแรก
      const originalDiv = container.querySelector('.a4-sheet');
      newPageDiv.innerHTML = originalDiv.innerHTML;
      
      // ลบรายการสินค้าเก่าออก
      const tbody = newPageDiv.querySelector('#quotationItems');
      tbody.innerHTML = '';
      
      // เพิ่มรายการสินค้าสำหรับหน้านี้
      const emptyRows = [];
      
      // เพิ่มแถวว่างจนครบ 10 แถว
      for (let i = pageItems.length; i < 10; i++) {
        emptyRows.push(`
          <tr>
            <td style="border-left: 1px solid black; height:40px;text-align: center;font-size: 11px;"></td>
            <td style="border-left: 1px solid black;padding: 0 10px; border-left: 1px solid black;font-size: 11px;">&nbsp;</td>
            <td style="border-left: 1px solid black;text-align: center;font-size: 11px;">&nbsp;</td>
            <td style="border-left: 1px solid black;font-size: 11px;text-align: right;padding: 0 10px;">&nbsp;</td>
            <td style="border-left: 1px solid black;font-size: 11px;text-align: right;padding: 0 10px;">&nbsp;</td>
            <td style="border-left: 1px solid black;border-right: 1px solid black;font-size: 11px;text-align: right;padding: 0 10px;">&nbsp;</td>
          </tr>
        `);
      }
      
      tbody.innerHTML = [
        ...pageItems.map((item, index) => `
          <tr>
            <td style="border-left: 1px solid black; height:40px;text-align: center;font-size: 11px;">${startIndex + index + 1}</td>
            <td style="border-left: 1px solid black;padding: 0 10px; border-left: 1px solid black;font-size: 11px;">${item.desc_product}</td>
            <td style="border-left: 1px solid black;text-align: center;font-size: 11px;">${parseFloat(item.qty).toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0})}</td>
            <td style="border-left: 1px solid black;font-size: 11px;text-align: right;padding: 0 10px;">${parseFloat(item.price).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
            <td style="border-left: 1px solid black;font-size: 11px;text-align: right;padding: 0 10px;">${parseFloat(item.discount).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
            <td style="border-left: 1px solid black;border-right: 1px solid black;font-size: 11px;text-align: right;padding: 0 10px;">${parseFloat(item.total).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
          </tr>
        `),
        ...emptyRows
      ].join('');
      
      // ตั้งค่ายอดรวมสำหรับหน้านี้
      if (isLastPage) {
        // หน้าสุดท้าย: แสดงยอดรวมจริง
        newPageDiv.querySelector('#subtotal').textContent = parseFloat(data.product_detail.product_totalAllProducts).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        newPageDiv.querySelector('#totalDiscount').textContent = parseFloat(data.product_detail.product_totalDiscount).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        newPageDiv.querySelector('#afterDiscount').textContent = parseFloat(data.product_detail.product_totalAfterDiscount).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        newPageDiv.querySelector('#vatAmount').textContent = parseFloat(data.product_detail.product_totalTax).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        
        // รวม withholdingTax ทั้ง 3 อัน
        const withholdingTax1 = parseFloat(data.product_detail.product_withholdingTax) || 0;
        const withholdingTax2 = parseFloat(data.product_detail.product_withholdingTax2) || 0;
        const withholdingTax3 = parseFloat(data.product_detail.product_withholdingTax3) || 0;
        const totalWithholdingTax = withholdingTax1 + withholdingTax2 + withholdingTax3;
        newPageDiv.querySelector('#taxAmount').textContent = totalWithholdingTax.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        
        newPageDiv.querySelector('#grandTotal').textContent = parseFloat(data.product_detail.product_totalAll).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        
        // แสดงตัวอักษรเฉพาะหน้าสุดท้าย
        const grandTotalAmount = parseFloat(data.product_detail.product_totalAll);
        const thaiText = convertToThaiText(grandTotalAmount);
        newPageDiv.querySelector('#totalText').textContent = `ตัวอักษร: (${thaiText})`;
      } else {
        // หน้าก่อนหน้า: แสดงยอดรวมเป็น 0.00
        newPageDiv.querySelector('#subtotal').textContent = '0.00';
        newPageDiv.querySelector('#totalDiscount').textContent = '0.00';
        newPageDiv.querySelector('#afterDiscount').textContent = '0.00';
        newPageDiv.querySelector('#vatAmount').textContent = '0.00';
        newPageDiv.querySelector('#taxAmount').textContent = '0.00';
        newPageDiv.querySelector('#grandTotal').textContent = '0.00';
      }
      
      // เพิ่มหน้าใหม่ลงใน container
      container.appendChild(newPageDiv);
    }
  }
}

    // ฟังก์ชันแปลงตัวเลขเป็นตัวอักษรไทย
    function convertToThaiText(number) {
        const thaiNumbers = ['ศูนย์', 'หนึ่ง', 'สอง', 'สาม', 'สี่', 'ห้า', 'หก', 'เจ็ด', 'แปด', 'เก้า'];
        const thaiUnits = ['', 'สิบ', 'ร้อย', 'พัน', 'หมื่น', 'แสน', 'ล้าน'];
        
        if (number === 0) return 'ศูนย์บาทถ้วน';
        
        const integerPart = Math.floor(number);
        const decimalPart = Math.round((number - integerPart) * 100);
        
        let result = '';
        
        // แปลงส่วนจำนวนเต็ม
        if (integerPart > 0) {
            const numStr = integerPart.toString();
            const len = numStr.length;
            
            for (let i = 0; i < len; i++) {
                const digit = parseInt(numStr[i]);
                const position = len - i - 1;
                
                if (digit !== 0) {
                    if (position === 1 && digit === 1 && len > 1) {
                        result += 'สิบ';
                    } else if (position === 1 && digit === 2) {
                        result += 'ยี่สิบ';
                    } else if (position === 0 && digit === 1 && len > 1) {
                        result += 'เอ็ด';
                    } else {
                        result += thaiNumbers[digit];
                        if (position > 0) {
                            result += thaiUnits[position];
                        }
                    }
                }
            }
            result += 'บาท';
        }
        
        // แปลงส่วนทศนิยม
        if (decimalPart > 0) {
            const decimalStr = decimalPart.toString();
            for (let i = 0; i < decimalStr.length; i++) {
                const digit = parseInt(decimalStr[i]);
                if (digit !== 0) {
                    result += thaiNumbers[digit];
                    if (i === 0) result += 'สิบ';
                }
            }
            result += 'สตางค์';
        } else {
            result += 'ถ้วน';
        }
        
        return result;
    }


</script>
</body>
</html>